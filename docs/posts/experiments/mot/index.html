<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.42">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="dcterms.date" content="2024-02-20">

<title>Which Car is Best ? Analysing and Predicting MOT Test Results – Pedro Leitão</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script><script src="../../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../../">
<link href="../../../_static/logo.png" rel="icon" type="image/png">
<script src="../../../site_libs/quarto-html/quarto.js"></script>
<script src="../../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../../site_libs/quarto-html/quarto-syntax-highlighting-a185852c63625fd9ffbdc57047c9a77e.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../../site_libs/bootstrap/bootstrap-9143d267086697ee6a9fbeed7f968a66.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script src="../../../site_libs/quarto-contrib/glightbox/glightbox.min.js"></script>
<link href="../../../site_libs/quarto-contrib/glightbox/glightbox.min.css" rel="stylesheet">
<link href="../../../site_libs/quarto-contrib/glightbox/lightbox.css" rel="stylesheet">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="../../../styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a href="../../../index.html" class="navbar-brand navbar-brand-logo">
    <img src="../../../_static/logo.png" alt="" class="navbar-logo">
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../../index.html"> 
<span class="menu-text">Bio</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../about.html"> 
<span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../posts.html"> 
<span class="menu-text">All posts</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../experiments.html"> 
<span class="menu-text">Experiments</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../thoughts.html"> 
<span class="menu-text">Thoughts</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../howtos.html"> 
<span class="menu-text">Howto’s</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/pedro-leitao"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://linkedin.com/in/nunoleitao"> <i class="bi bi-linkedin" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="../../../posts.xml"> <i class="bi bi-rss" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Which Car is Best ? Analysing and Predicting MOT Test Results</h1>
            <p class="subtitle lead">dive deeper into data analysis using a real-world dataset</p>
                                <div class="quarto-categories">
                <div class="quarto-category">Machine Learning</div>
                <div class="quarto-category">Data Science</div>
                <div class="quarto-category">Experiments</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">February 20, 2024</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#pre-processing" id="toc-pre-processing" class="nav-link active" data-scroll-target="#pre-processing">Pre-processing</a></li>
  <li><a href="#correlation-matrix" id="toc-correlation-matrix" class="nav-link" data-scroll-target="#correlation-matrix">Correlation matrix</a></li>
  <li><a href="#exploratory-analysis" id="toc-exploratory-analysis" class="nav-link" data-scroll-target="#exploratory-analysis">Exploratory analysis</a></li>
  <li><a href="#understanding-geographic-distribution" id="toc-understanding-geographic-distribution" class="nav-link" data-scroll-target="#understanding-geographic-distribution">Understanding geographic distribution</a></li>
  <li><a href="#developing-a-classification-model" id="toc-developing-a-classification-model" class="nav-link" data-scroll-target="#developing-a-classification-model">Developing a classification model</a></li>
  <li><a href="#analysis-of-training-results" id="toc-analysis-of-training-results" class="nav-link" data-scroll-target="#analysis-of-training-results">Analysis of training results</a></li>
  <li><a href="#final-remarks" id="toc-final-remarks" class="nav-link" data-scroll-target="#final-remarks">Final remarks</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">





<p>In this experiment, we will be analysing the MOT test results of cars in the UK. The MOT test is an annual test of vehicle safety, roadworthiness aspects and exhaust emissions required in the United Kingdom for most vehicles over three years old. The MOT test is designed to ensure that a vehicle is roadworthy and safe to drive. The test checks the vehicle against a number of criteria, including the condition of the vehicle’s brakes, lights, tyres, exhaust emissions, and more.</p>
<p>The dataset we will be using in this experiment is the <a href="https://www.data.gov.uk/dataset/e3939ef8-30c7-4ca8-9c7c-ad9475cc9b2f/anonymised-mot-tests-and-results">UK MOT test results dataset</a> for 2023. Information includes the make, model, and year of the car, as well as the overal test result.</p>
<p>Let us start by loading the dataset and taking a look at the first few rows.</p>
<div id="f12be255" class="cell" data-execution_count="2">
<details class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="f12be255"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="f12be255-1"><a href="#f12be255-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load .data/mot/test_results.csv as a dataframe</span></span>
<span id="f12be255-2"><a href="#f12be255-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="f12be255-3"><a href="#f12be255-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="f12be255-4"><a href="#f12be255-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="f12be255-5"><a href="#f12be255-5" aria-hidden="true" tabindex="-1"></a>mot <span class="op">=</span> pd.read_csv(<span class="st">".data/test_result.csv"</span>, sep<span class="op">=</span><span class="st">"|"</span>)</span>
<span id="f12be255-6"><a href="#f12be255-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="f12be255-7"><a href="#f12be255-7" aria-hidden="true" tabindex="-1"></a><span class="co"># drop the test_id and vehicle_id columns</span></span>
<span id="f12be255-8"><a href="#f12be255-8" aria-hidden="true" tabindex="-1"></a>mot <span class="op">=</span> mot.drop([<span class="st">"test_id"</span>], axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="f12be255-9"><a href="#f12be255-9" aria-hidden="true" tabindex="-1"></a>mot</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="1">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">vehicle_id</th>
<th data-quarto-table-cell-role="th">test_date</th>
<th data-quarto-table-cell-role="th">test_class_id</th>
<th data-quarto-table-cell-role="th">test_type</th>
<th data-quarto-table-cell-role="th">test_result</th>
<th data-quarto-table-cell-role="th">test_mileage</th>
<th data-quarto-table-cell-role="th">postcode_area</th>
<th data-quarto-table-cell-role="th">make</th>
<th data-quarto-table-cell-role="th">model</th>
<th data-quarto-table-cell-role="th">colour</th>
<th data-quarto-table-cell-role="th">fuel_type</th>
<th data-quarto-table-cell-role="th">cylinder_capacity</th>
<th data-quarto-table-cell-role="th">first_use_date</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>838565361</td>
<td>2023-01-02</td>
<td>4</td>
<td>NT</td>
<td>P</td>
<td>179357.0</td>
<td>NW</td>
<td>TOYOTA</td>
<td>PRIUS +</td>
<td>WHITE</td>
<td>HY</td>
<td>1798.0</td>
<td>2016-06-17</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>484499974</td>
<td>2023-01-01</td>
<td>4</td>
<td>NT</td>
<td>P</td>
<td>300072.0</td>
<td>B</td>
<td>TOYOTA</td>
<td>PRIUS</td>
<td>RED</td>
<td>HY</td>
<td>1500.0</td>
<td>2008-09-13</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>53988366</td>
<td>2023-01-02</td>
<td>4</td>
<td>NT</td>
<td>PRS</td>
<td>307888.0</td>
<td>HA</td>
<td>TOYOTA</td>
<td>PRIUS</td>
<td>GREY</td>
<td>HY</td>
<td>1497.0</td>
<td>2010-01-15</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>606755010</td>
<td>2023-01-02</td>
<td>4</td>
<td>NT</td>
<td>F</td>
<td>65810.0</td>
<td>SE</td>
<td>TOYOTA</td>
<td>PRIUS</td>
<td>SILVER</td>
<td>HY</td>
<td>1497.0</td>
<td>2007-03-28</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>606755010</td>
<td>2023-01-02</td>
<td>4</td>
<td>RT</td>
<td>P</td>
<td>65810.0</td>
<td>SE</td>
<td>TOYOTA</td>
<td>PRIUS</td>
<td>SILVER</td>
<td>HY</td>
<td>1497.0</td>
<td>2007-03-28</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">42216716</td>
<td>1401380910</td>
<td>2023-12-31</td>
<td>4</td>
<td>NT</td>
<td>P</td>
<td>85583.0</td>
<td>EN</td>
<td>HONDA</td>
<td>BEAT</td>
<td>SILVER</td>
<td>PE</td>
<td>660.0</td>
<td>1999-10-01</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">42216717</td>
<td>625178603</td>
<td>2023-12-31</td>
<td>7</td>
<td>NT</td>
<td>P</td>
<td>227563.0</td>
<td>SK</td>
<td>RENAULT</td>
<td>MASTER</td>
<td>WHITE</td>
<td>DI</td>
<td>2298.0</td>
<td>2016-09-01</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">42216718</td>
<td>820545620</td>
<td>2023-12-31</td>
<td>4</td>
<td>NT</td>
<td>P</td>
<td>120115.0</td>
<td>S</td>
<td>PEUGEOT</td>
<td>207</td>
<td>SILVER</td>
<td>DI</td>
<td>1560.0</td>
<td>2010-01-21</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">42216719</td>
<td>941704896</td>
<td>2023-12-31</td>
<td>4</td>
<td>NT</td>
<td>P</td>
<td>141891.0</td>
<td>S</td>
<td>NISSAN</td>
<td>MICRA</td>
<td>RED</td>
<td>PE</td>
<td>1240.0</td>
<td>2009-06-25</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">42216720</td>
<td>5225492</td>
<td>2023-12-31</td>
<td>4</td>
<td>NT</td>
<td>P</td>
<td>157901.0</td>
<td>S</td>
<td>VAUXHALL</td>
<td>VECTRA</td>
<td>SILVER</td>
<td>PE</td>
<td>1796.0</td>
<td>2006-12-31</td>
</tr>
</tbody>
</table>

<p>42216721 rows × 13 columns</p>
</div>
</div>
</div>
<p>Let us also load a few lookup tables that will help us in our analysis, and merge them with the main dataset.</p>
<div id="121f060f" class="cell" data-execution_count="3">
<details class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="121f060f"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="121f060f-1"><a href="#121f060f-1" aria-hidden="true" tabindex="-1"></a>fuel_types <span class="op">=</span> pd.read_csv(<span class="st">".data/mdr_fuel_types.csv"</span>, sep<span class="op">=</span><span class="st">"|"</span>)</span>
<span id="121f060f-2"><a href="#121f060f-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="121f060f-3"><a href="#121f060f-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge the two dataframes on the fuel_type column</span></span>
<span id="121f060f-4"><a href="#121f060f-4" aria-hidden="true" tabindex="-1"></a>mot <span class="op">=</span> pd.merge(</span>
<span id="121f060f-5"><a href="#121f060f-5" aria-hidden="true" tabindex="-1"></a>    mot,</span>
<span id="121f060f-6"><a href="#121f060f-6" aria-hidden="true" tabindex="-1"></a>    fuel_types,</span>
<span id="121f060f-7"><a href="#121f060f-7" aria-hidden="true" tabindex="-1"></a>    left_on<span class="op">=</span><span class="st">"fuel_type"</span>,</span>
<span id="121f060f-8"><a href="#121f060f-8" aria-hidden="true" tabindex="-1"></a>    right_on<span class="op">=</span><span class="st">"type_code"</span>,</span>
<span id="121f060f-9"><a href="#121f060f-9" aria-hidden="true" tabindex="-1"></a>    how<span class="op">=</span><span class="st">"left"</span>,</span>
<span id="121f060f-10"><a href="#121f060f-10" aria-hidden="true" tabindex="-1"></a>    suffixes<span class="op">=</span>(<span class="st">""</span>, <span class="st">"_desc"</span>),</span>
<span id="121f060f-11"><a href="#121f060f-11" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="121f060f-12"><a href="#121f060f-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="121f060f-13"><a href="#121f060f-13" aria-hidden="true" tabindex="-1"></a>test_outcome <span class="op">=</span> pd.read_csv(<span class="st">".data/mdr_test_outcome.csv"</span>, sep<span class="op">=</span><span class="st">"|"</span>)</span>
<span id="121f060f-14"><a href="#121f060f-14" aria-hidden="true" tabindex="-1"></a>mot <span class="op">=</span> pd.merge(</span>
<span id="121f060f-15"><a href="#121f060f-15" aria-hidden="true" tabindex="-1"></a>    mot,</span>
<span id="121f060f-16"><a href="#121f060f-16" aria-hidden="true" tabindex="-1"></a>    test_outcome,</span>
<span id="121f060f-17"><a href="#121f060f-17" aria-hidden="true" tabindex="-1"></a>    left_on<span class="op">=</span><span class="st">"test_result"</span>,</span>
<span id="121f060f-18"><a href="#121f060f-18" aria-hidden="true" tabindex="-1"></a>    right_on<span class="op">=</span><span class="st">"result_code"</span>,</span>
<span id="121f060f-19"><a href="#121f060f-19" aria-hidden="true" tabindex="-1"></a>    how<span class="op">=</span><span class="st">"left"</span>,</span>
<span id="121f060f-20"><a href="#121f060f-20" aria-hidden="true" tabindex="-1"></a>    suffixes<span class="op">=</span>(<span class="st">""</span>, <span class="st">"_desc"</span>),</span>
<span id="121f060f-21"><a href="#121f060f-21" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="121f060f-22"><a href="#121f060f-22" aria-hidden="true" tabindex="-1"></a>mot.drop([<span class="st">"type_code"</span>, <span class="st">"result_code"</span>], axis<span class="op">=</span><span class="dv">1</span>, inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="121f060f-23"><a href="#121f060f-23" aria-hidden="true" tabindex="-1"></a>mot.rename(columns<span class="op">=</span>{<span class="st">"result"</span>: <span class="st">"test_result_desc"</span>}, inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="121f060f-24"><a href="#121f060f-24" aria-hidden="true" tabindex="-1"></a>mot</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="2">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">vehicle_id</th>
<th data-quarto-table-cell-role="th">test_date</th>
<th data-quarto-table-cell-role="th">test_class_id</th>
<th data-quarto-table-cell-role="th">test_type</th>
<th data-quarto-table-cell-role="th">test_result</th>
<th data-quarto-table-cell-role="th">test_mileage</th>
<th data-quarto-table-cell-role="th">postcode_area</th>
<th data-quarto-table-cell-role="th">make</th>
<th data-quarto-table-cell-role="th">model</th>
<th data-quarto-table-cell-role="th">colour</th>
<th data-quarto-table-cell-role="th">fuel_type</th>
<th data-quarto-table-cell-role="th">cylinder_capacity</th>
<th data-quarto-table-cell-role="th">first_use_date</th>
<th data-quarto-table-cell-role="th">fuel_type_desc</th>
<th data-quarto-table-cell-role="th">test_result_desc</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>838565361</td>
<td>2023-01-02</td>
<td>4</td>
<td>NT</td>
<td>P</td>
<td>179357.0</td>
<td>NW</td>
<td>TOYOTA</td>
<td>PRIUS +</td>
<td>WHITE</td>
<td>HY</td>
<td>1798.0</td>
<td>2016-06-17</td>
<td>Hybrid Electric (Clean)</td>
<td>Passed</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>484499974</td>
<td>2023-01-01</td>
<td>4</td>
<td>NT</td>
<td>P</td>
<td>300072.0</td>
<td>B</td>
<td>TOYOTA</td>
<td>PRIUS</td>
<td>RED</td>
<td>HY</td>
<td>1500.0</td>
<td>2008-09-13</td>
<td>Hybrid Electric (Clean)</td>
<td>Passed</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>53988366</td>
<td>2023-01-02</td>
<td>4</td>
<td>NT</td>
<td>PRS</td>
<td>307888.0</td>
<td>HA</td>
<td>TOYOTA</td>
<td>PRIUS</td>
<td>GREY</td>
<td>HY</td>
<td>1497.0</td>
<td>2010-01-15</td>
<td>Hybrid Electric (Clean)</td>
<td>Pass with Rectification at Station</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>606755010</td>
<td>2023-01-02</td>
<td>4</td>
<td>NT</td>
<td>F</td>
<td>65810.0</td>
<td>SE</td>
<td>TOYOTA</td>
<td>PRIUS</td>
<td>SILVER</td>
<td>HY</td>
<td>1497.0</td>
<td>2007-03-28</td>
<td>Hybrid Electric (Clean)</td>
<td>Failed</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>606755010</td>
<td>2023-01-02</td>
<td>4</td>
<td>RT</td>
<td>P</td>
<td>65810.0</td>
<td>SE</td>
<td>TOYOTA</td>
<td>PRIUS</td>
<td>SILVER</td>
<td>HY</td>
<td>1497.0</td>
<td>2007-03-28</td>
<td>Hybrid Electric (Clean)</td>
<td>Passed</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">42216716</td>
<td>1401380910</td>
<td>2023-12-31</td>
<td>4</td>
<td>NT</td>
<td>P</td>
<td>85583.0</td>
<td>EN</td>
<td>HONDA</td>
<td>BEAT</td>
<td>SILVER</td>
<td>PE</td>
<td>660.0</td>
<td>1999-10-01</td>
<td>Petrol</td>
<td>Passed</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">42216717</td>
<td>625178603</td>
<td>2023-12-31</td>
<td>7</td>
<td>NT</td>
<td>P</td>
<td>227563.0</td>
<td>SK</td>
<td>RENAULT</td>
<td>MASTER</td>
<td>WHITE</td>
<td>DI</td>
<td>2298.0</td>
<td>2016-09-01</td>
<td>Diesel</td>
<td>Passed</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">42216718</td>
<td>820545620</td>
<td>2023-12-31</td>
<td>4</td>
<td>NT</td>
<td>P</td>
<td>120115.0</td>
<td>S</td>
<td>PEUGEOT</td>
<td>207</td>
<td>SILVER</td>
<td>DI</td>
<td>1560.0</td>
<td>2010-01-21</td>
<td>Diesel</td>
<td>Passed</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">42216719</td>
<td>941704896</td>
<td>2023-12-31</td>
<td>4</td>
<td>NT</td>
<td>P</td>
<td>141891.0</td>
<td>S</td>
<td>NISSAN</td>
<td>MICRA</td>
<td>RED</td>
<td>PE</td>
<td>1240.0</td>
<td>2009-06-25</td>
<td>Petrol</td>
<td>Passed</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">42216720</td>
<td>5225492</td>
<td>2023-12-31</td>
<td>4</td>
<td>NT</td>
<td>P</td>
<td>157901.0</td>
<td>S</td>
<td>VAUXHALL</td>
<td>VECTRA</td>
<td>SILVER</td>
<td>PE</td>
<td>1796.0</td>
<td>2006-12-31</td>
<td>Petrol</td>
<td>Passed</td>
</tr>
</tbody>
</table>

<p>42216721 rows × 15 columns</p>
</div>
</div>
</div>
<p>This is a reasonably large dataset with over 41 million rows and 13 columns. For this experiment, we will be focusing on a subset of cars - the top 20 most tested cars in the dataset. We will be analysing the test results of these cars and building a machine learning model to predict the test result of a car based on its features, including make, model and mileage.</p>
<section id="pre-processing" class="level2">
<h2 class="anchored" data-anchor-id="pre-processing">Pre-processing</h2>
<p>First let us perform some simple pre-processing steps on the dataset, to remove any data that is not relevant to our analysis and to perform some basic tidying. We will also calculate a few additional columns that will be useful for our analysis.</p>
<div id="b2261fb6" class="cell" data-execution_count="4">
<details class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="b2261fb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="b2261fb6-1"><a href="#b2261fb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Drop any first_use and test_date before 1970, to avoid invalid ages due to the UNIX epoch</span></span>
<span id="b2261fb6-2"><a href="#b2261fb6-2" aria-hidden="true" tabindex="-1"></a>mot <span class="op">=</span> mot[mot[<span class="st">"first_use_date"</span>] <span class="op">&gt;=</span> <span class="st">"1970-01-01"</span>]</span>
<span id="b2261fb6-3"><a href="#b2261fb6-3" aria-hidden="true" tabindex="-1"></a>mot <span class="op">=</span> mot[mot[<span class="st">"test_date"</span>] <span class="op">&gt;=</span> <span class="st">"1970-01-01"</span>]</span>
<span id="b2261fb6-4"><a href="#b2261fb6-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="b2261fb6-5"><a href="#b2261fb6-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate an age column (in days) based on the test_date and first_use_date columns</span></span>
<span id="b2261fb6-6"><a href="#b2261fb6-6" aria-hidden="true" tabindex="-1"></a>mot[<span class="st">"test_date"</span>] <span class="op">=</span> pd.to_datetime(mot[<span class="st">"test_date"</span>])</span>
<span id="b2261fb6-7"><a href="#b2261fb6-7" aria-hidden="true" tabindex="-1"></a>mot[<span class="st">"first_use_date"</span>] <span class="op">=</span> pd.to_datetime(mot[<span class="st">"first_use_date"</span>])</span>
<span id="b2261fb6-8"><a href="#b2261fb6-8" aria-hidden="true" tabindex="-1"></a>mot[<span class="st">"age"</span>] <span class="op">=</span> (mot[<span class="st">"test_date"</span>] <span class="op">-</span> mot[<span class="st">"first_use_date"</span>]).dt.days</span>
<span id="b2261fb6-9"><a href="#b2261fb6-9" aria-hidden="true" tabindex="-1"></a>mot[<span class="st">"age_years"</span>] <span class="op">=</span> mot[<span class="st">"age"</span>] <span class="op">/</span> <span class="fl">365.25</span></span>
<span id="b2261fb6-10"><a href="#b2261fb6-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="b2261fb6-11"><a href="#b2261fb6-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine make and model into one column</span></span>
<span id="b2261fb6-12"><a href="#b2261fb6-12" aria-hidden="true" tabindex="-1"></a>mot[<span class="st">"make_model"</span>] <span class="op">=</span> (</span>
<span id="b2261fb6-13"><a href="#b2261fb6-13" aria-hidden="true" tabindex="-1"></a>    mot[<span class="st">"make"</span>] <span class="op">+</span> <span class="st">" "</span> <span class="op">+</span> mot[<span class="st">"model"</span>]</span>
<span id="b2261fb6-14"><a href="#b2261fb6-14" aria-hidden="true" tabindex="-1"></a>)  <span class="co"># Combine make and model into one column</span></span>
<span id="b2261fb6-15"><a href="#b2261fb6-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="b2261fb6-16"><a href="#b2261fb6-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Let us focus on data where cylinder capacity is between 500 and 5000</span></span>
<span id="b2261fb6-17"><a href="#b2261fb6-17" aria-hidden="true" tabindex="-1"></a>mot <span class="op">=</span> mot[(mot[<span class="st">"cylinder_capacity"</span>] <span class="op">&gt;=</span> <span class="dv">500</span>) <span class="op">&amp;</span> (mot[<span class="st">"cylinder_capacity"</span>] <span class="op">&lt;=</span> <span class="dv">5000</span>)]</span>
<span id="b2261fb6-18"><a href="#b2261fb6-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="b2261fb6-19"><a href="#b2261fb6-19" aria-hidden="true" tabindex="-1"></a><span class="co"># If test_result_desc is 'Passed', or 'Pass with Rectification at Station', test_result_class is 'Pass'</span></span>
<span id="b2261fb6-20"><a href="#b2261fb6-20" aria-hidden="true" tabindex="-1"></a><span class="co"># If test_result_desc is 'Failed', test_result_class is 'Fail'</span></span>
<span id="b2261fb6-21"><a href="#b2261fb6-21" aria-hidden="true" tabindex="-1"></a><span class="co"># If anything else, test_result_class is 'Other'</span></span>
<span id="b2261fb6-22"><a href="#b2261fb6-22" aria-hidden="true" tabindex="-1"></a>mot[<span class="st">"test_result_class"</span>] <span class="op">=</span> <span class="st">"Other"</span></span>
<span id="b2261fb6-23"><a href="#b2261fb6-23" aria-hidden="true" tabindex="-1"></a>mot.loc[</span>
<span id="b2261fb6-24"><a href="#b2261fb6-24" aria-hidden="true" tabindex="-1"></a>    mot[<span class="st">"test_result_desc"</span>].isin([<span class="st">"Passed"</span>, <span class="st">"Pass with Rectification at Station"</span>]),</span>
<span id="b2261fb6-25"><a href="#b2261fb6-25" aria-hidden="true" tabindex="-1"></a>    <span class="st">"test_result_class"</span>,</span>
<span id="b2261fb6-26"><a href="#b2261fb6-26" aria-hidden="true" tabindex="-1"></a>] <span class="op">=</span> <span class="st">"Pass"</span></span>
<span id="b2261fb6-27"><a href="#b2261fb6-27" aria-hidden="true" tabindex="-1"></a>mot.loc[mot[<span class="st">"test_result_desc"</span>] <span class="op">==</span> <span class="st">"Failed"</span>, <span class="st">"test_result_class"</span>] <span class="op">=</span> <span class="st">"Fail"</span></span>
<span id="b2261fb6-28"><a href="#b2261fb6-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="b2261fb6-29"><a href="#b2261fb6-29" aria-hidden="true" tabindex="-1"></a><span class="co"># Drop any negative ages, as they are likely to be errors</span></span>
<span id="b2261fb6-30"><a href="#b2261fb6-30" aria-hidden="true" tabindex="-1"></a>mot <span class="op">=</span> mot[mot[<span class="st">"age"</span>] <span class="op">&gt;=</span> <span class="dv">0</span>]</span>
<span id="b2261fb6-31"><a href="#b2261fb6-31" aria-hidden="true" tabindex="-1"></a>mot</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="3">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">vehicle_id</th>
<th data-quarto-table-cell-role="th">test_date</th>
<th data-quarto-table-cell-role="th">test_class_id</th>
<th data-quarto-table-cell-role="th">test_type</th>
<th data-quarto-table-cell-role="th">test_result</th>
<th data-quarto-table-cell-role="th">test_mileage</th>
<th data-quarto-table-cell-role="th">postcode_area</th>
<th data-quarto-table-cell-role="th">make</th>
<th data-quarto-table-cell-role="th">model</th>
<th data-quarto-table-cell-role="th">colour</th>
<th data-quarto-table-cell-role="th">fuel_type</th>
<th data-quarto-table-cell-role="th">cylinder_capacity</th>
<th data-quarto-table-cell-role="th">first_use_date</th>
<th data-quarto-table-cell-role="th">fuel_type_desc</th>
<th data-quarto-table-cell-role="th">test_result_desc</th>
<th data-quarto-table-cell-role="th">age</th>
<th data-quarto-table-cell-role="th">age_years</th>
<th data-quarto-table-cell-role="th">make_model</th>
<th data-quarto-table-cell-role="th">test_result_class</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>838565361</td>
<td>2023-01-02</td>
<td>4</td>
<td>NT</td>
<td>P</td>
<td>179357.0</td>
<td>NW</td>
<td>TOYOTA</td>
<td>PRIUS +</td>
<td>WHITE</td>
<td>HY</td>
<td>1798.0</td>
<td>2016-06-17</td>
<td>Hybrid Electric (Clean)</td>
<td>Passed</td>
<td>2390</td>
<td>6.543463</td>
<td>TOYOTA PRIUS +</td>
<td>Pass</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>484499974</td>
<td>2023-01-01</td>
<td>4</td>
<td>NT</td>
<td>P</td>
<td>300072.0</td>
<td>B</td>
<td>TOYOTA</td>
<td>PRIUS</td>
<td>RED</td>
<td>HY</td>
<td>1500.0</td>
<td>2008-09-13</td>
<td>Hybrid Electric (Clean)</td>
<td>Passed</td>
<td>5223</td>
<td>14.299795</td>
<td>TOYOTA PRIUS</td>
<td>Pass</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>53988366</td>
<td>2023-01-02</td>
<td>4</td>
<td>NT</td>
<td>PRS</td>
<td>307888.0</td>
<td>HA</td>
<td>TOYOTA</td>
<td>PRIUS</td>
<td>GREY</td>
<td>HY</td>
<td>1497.0</td>
<td>2010-01-15</td>
<td>Hybrid Electric (Clean)</td>
<td>Pass with Rectification at Station</td>
<td>4735</td>
<td>12.963723</td>
<td>TOYOTA PRIUS</td>
<td>Pass</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>606755010</td>
<td>2023-01-02</td>
<td>4</td>
<td>NT</td>
<td>F</td>
<td>65810.0</td>
<td>SE</td>
<td>TOYOTA</td>
<td>PRIUS</td>
<td>SILVER</td>
<td>HY</td>
<td>1497.0</td>
<td>2007-03-28</td>
<td>Hybrid Electric (Clean)</td>
<td>Failed</td>
<td>5759</td>
<td>15.767283</td>
<td>TOYOTA PRIUS</td>
<td>Fail</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>606755010</td>
<td>2023-01-02</td>
<td>4</td>
<td>RT</td>
<td>P</td>
<td>65810.0</td>
<td>SE</td>
<td>TOYOTA</td>
<td>PRIUS</td>
<td>SILVER</td>
<td>HY</td>
<td>1497.0</td>
<td>2007-03-28</td>
<td>Hybrid Electric (Clean)</td>
<td>Passed</td>
<td>5759</td>
<td>15.767283</td>
<td>TOYOTA PRIUS</td>
<td>Pass</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">42216716</td>
<td>1401380910</td>
<td>2023-12-31</td>
<td>4</td>
<td>NT</td>
<td>P</td>
<td>85583.0</td>
<td>EN</td>
<td>HONDA</td>
<td>BEAT</td>
<td>SILVER</td>
<td>PE</td>
<td>660.0</td>
<td>1999-10-01</td>
<td>Petrol</td>
<td>Passed</td>
<td>8857</td>
<td>24.249144</td>
<td>HONDA BEAT</td>
<td>Pass</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">42216717</td>
<td>625178603</td>
<td>2023-12-31</td>
<td>7</td>
<td>NT</td>
<td>P</td>
<td>227563.0</td>
<td>SK</td>
<td>RENAULT</td>
<td>MASTER</td>
<td>WHITE</td>
<td>DI</td>
<td>2298.0</td>
<td>2016-09-01</td>
<td>Diesel</td>
<td>Passed</td>
<td>2677</td>
<td>7.329227</td>
<td>RENAULT MASTER</td>
<td>Pass</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">42216718</td>
<td>820545620</td>
<td>2023-12-31</td>
<td>4</td>
<td>NT</td>
<td>P</td>
<td>120115.0</td>
<td>S</td>
<td>PEUGEOT</td>
<td>207</td>
<td>SILVER</td>
<td>DI</td>
<td>1560.0</td>
<td>2010-01-21</td>
<td>Diesel</td>
<td>Passed</td>
<td>5092</td>
<td>13.941136</td>
<td>PEUGEOT 207</td>
<td>Pass</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">42216719</td>
<td>941704896</td>
<td>2023-12-31</td>
<td>4</td>
<td>NT</td>
<td>P</td>
<td>141891.0</td>
<td>S</td>
<td>NISSAN</td>
<td>MICRA</td>
<td>RED</td>
<td>PE</td>
<td>1240.0</td>
<td>2009-06-25</td>
<td>Petrol</td>
<td>Passed</td>
<td>5302</td>
<td>14.516085</td>
<td>NISSAN MICRA</td>
<td>Pass</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">42216720</td>
<td>5225492</td>
<td>2023-12-31</td>
<td>4</td>
<td>NT</td>
<td>P</td>
<td>157901.0</td>
<td>S</td>
<td>VAUXHALL</td>
<td>VECTRA</td>
<td>SILVER</td>
<td>PE</td>
<td>1796.0</td>
<td>2006-12-31</td>
<td>Petrol</td>
<td>Passed</td>
<td>6209</td>
<td>16.999316</td>
<td>VAUXHALL VECTRA</td>
<td>Pass</td>
</tr>
</tbody>
</table>

<p>41457322 rows × 19 columns</p>
</div>
</div>
</div>
<p>That’s looking better, and we now have a couple of more columns - a combined make and model column, and a column for the age of the car based on the first use date and the actual test date. Now let us sample the top 20 most tested cars from the dataset, we will also filter for only ‘NT’ (Normal Test) test types, as overall we only want to consider normal tests and not retests.</p>
<div id="ebe7ed5c" class="cell" data-execution_count="5">
<details class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="ebe7ed5c"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="ebe7ed5c-1"><a href="#ebe7ed5c-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Drop any rows where test_type is not 'NT'</span></span>
<span id="ebe7ed5c-2"><a href="#ebe7ed5c-2" aria-hidden="true" tabindex="-1"></a>mot <span class="op">=</span> mot[mot[<span class="st">"test_type"</span>] <span class="op">==</span> <span class="st">"NT"</span>]</span>
<span id="ebe7ed5c-3"><a href="#ebe7ed5c-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="ebe7ed5c-4"><a href="#ebe7ed5c-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Sample the data for only the top 20 make and model combinations</span></span>
<span id="ebe7ed5c-5"><a href="#ebe7ed5c-5" aria-hidden="true" tabindex="-1"></a>top_20 <span class="op">=</span> mot[<span class="st">"make_model"</span>].value_counts().head(<span class="dv">20</span>).index</span>
<span id="ebe7ed5c-6"><a href="#ebe7ed5c-6" aria-hidden="true" tabindex="-1"></a>mot <span class="op">=</span> mot[mot[<span class="st">"make_model"</span>].isin(top_20)]</span>
<span id="ebe7ed5c-7"><a href="#ebe7ed5c-7" aria-hidden="true" tabindex="-1"></a>mot</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="4">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">vehicle_id</th>
<th data-quarto-table-cell-role="th">test_date</th>
<th data-quarto-table-cell-role="th">test_class_id</th>
<th data-quarto-table-cell-role="th">test_type</th>
<th data-quarto-table-cell-role="th">test_result</th>
<th data-quarto-table-cell-role="th">test_mileage</th>
<th data-quarto-table-cell-role="th">postcode_area</th>
<th data-quarto-table-cell-role="th">make</th>
<th data-quarto-table-cell-role="th">model</th>
<th data-quarto-table-cell-role="th">colour</th>
<th data-quarto-table-cell-role="th">fuel_type</th>
<th data-quarto-table-cell-role="th">cylinder_capacity</th>
<th data-quarto-table-cell-role="th">first_use_date</th>
<th data-quarto-table-cell-role="th">fuel_type_desc</th>
<th data-quarto-table-cell-role="th">test_result_desc</th>
<th data-quarto-table-cell-role="th">age</th>
<th data-quarto-table-cell-role="th">age_years</th>
<th data-quarto-table-cell-role="th">make_model</th>
<th data-quarto-table-cell-role="th">test_result_class</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">21</td>
<td>1493398641</td>
<td>2023-01-01</td>
<td>4</td>
<td>NT</td>
<td>P</td>
<td>41682.0</td>
<td>SR</td>
<td>NISSAN</td>
<td>JUKE</td>
<td>GREY</td>
<td>DI</td>
<td>1461.0</td>
<td>2016-05-13</td>
<td>Diesel</td>
<td>Passed</td>
<td>2424</td>
<td>6.636550</td>
<td>NISSAN JUKE</td>
<td>Pass</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">25</td>
<td>1200062230</td>
<td>2023-01-01</td>
<td>4</td>
<td>NT</td>
<td>P</td>
<td>91473.0</td>
<td>G</td>
<td>VOLKSWAGEN</td>
<td>GOLF</td>
<td>SILVER</td>
<td>DI</td>
<td>1598.0</td>
<td>2010-03-20</td>
<td>Diesel</td>
<td>Passed</td>
<td>4670</td>
<td>12.785763</td>
<td>VOLKSWAGEN GOLF</td>
<td>Pass</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">26</td>
<td>1237843361</td>
<td>2023-01-01</td>
<td>4</td>
<td>NT</td>
<td>PRS</td>
<td>162891.0</td>
<td>B</td>
<td>VOLKSWAGEN</td>
<td>TRANSPORTER</td>
<td>WHITE</td>
<td>DI</td>
<td>1968.0</td>
<td>2012-10-01</td>
<td>Diesel</td>
<td>Pass with Rectification at Station</td>
<td>3744</td>
<td>10.250513</td>
<td>VOLKSWAGEN TRANSPORTER</td>
<td>Pass</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">28</td>
<td>1324341521</td>
<td>2023-01-01</td>
<td>4</td>
<td>NT</td>
<td>P</td>
<td>151830.0</td>
<td>WF</td>
<td>AUDI</td>
<td>A4</td>
<td>GREY</td>
<td>DI</td>
<td>1968.0</td>
<td>2014-03-05</td>
<td>Diesel</td>
<td>Passed</td>
<td>3224</td>
<td>8.826831</td>
<td>AUDI A4</td>
<td>Pass</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">30</td>
<td>922055125</td>
<td>2023-01-01</td>
<td>4</td>
<td>NT</td>
<td>P</td>
<td>21153.0</td>
<td>CO</td>
<td>FORD</td>
<td>FOCUS</td>
<td>BLACK</td>
<td>PE</td>
<td>999.0</td>
<td>2020-01-31</td>
<td>Petrol</td>
<td>Passed</td>
<td>1066</td>
<td>2.918549</td>
<td>FORD FOCUS</td>
<td>Pass</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">42216698</td>
<td>1349094589</td>
<td>2023-12-31</td>
<td>4</td>
<td>NT</td>
<td>P</td>
<td>149031.0</td>
<td>EH</td>
<td>HONDA</td>
<td>CIVIC</td>
<td>BLACK</td>
<td>DI</td>
<td>2199.0</td>
<td>2013-09-13</td>
<td>Diesel</td>
<td>Passed</td>
<td>3761</td>
<td>10.297057</td>
<td>HONDA CIVIC</td>
<td>Pass</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">42216701</td>
<td>700228101</td>
<td>2023-12-31</td>
<td>4</td>
<td>NT</td>
<td>PRS</td>
<td>105679.0</td>
<td>LU</td>
<td>NISSAN</td>
<td>JUKE</td>
<td>WHITE</td>
<td>PE</td>
<td>1598.0</td>
<td>2014-03-24</td>
<td>Petrol</td>
<td>Pass with Rectification at Station</td>
<td>3569</td>
<td>9.771389</td>
<td>NISSAN JUKE</td>
<td>Pass</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">42216705</td>
<td>677896545</td>
<td>2023-12-31</td>
<td>4</td>
<td>NT</td>
<td>P</td>
<td>169683.0</td>
<td>SA</td>
<td>AUDI</td>
<td>A3</td>
<td>RED</td>
<td>PE</td>
<td>1395.0</td>
<td>2014-12-16</td>
<td>Petrol</td>
<td>Passed</td>
<td>3302</td>
<td>9.040383</td>
<td>AUDI A3</td>
<td>Pass</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">42216709</td>
<td>541766398</td>
<td>2023-12-31</td>
<td>4</td>
<td>NT</td>
<td>P</td>
<td>79328.0</td>
<td>SP</td>
<td>VAUXHALL</td>
<td>ASTRA</td>
<td>BLACK</td>
<td>PE</td>
<td>1796.0</td>
<td>2008-03-06</td>
<td>Petrol</td>
<td>Passed</td>
<td>5778</td>
<td>15.819302</td>
<td>VAUXHALL ASTRA</td>
<td>Pass</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">42216710</td>
<td>144320145</td>
<td>2023-12-31</td>
<td>4</td>
<td>NT</td>
<td>P</td>
<td>53210.0</td>
<td>G</td>
<td>VAUXHALL</td>
<td>CORSA</td>
<td>RED</td>
<td>PE</td>
<td>1398.0</td>
<td>2019-05-31</td>
<td>Petrol</td>
<td>Passed</td>
<td>1675</td>
<td>4.585900</td>
<td>VAUXHALL CORSA</td>
<td>Pass</td>
</tr>
</tbody>
</table>

<p>10701774 rows × 19 columns</p>
</div>
</div>
</div>
<p>We are now down to just over 10 million rows, quite more manageable! This also means that our model will be able to focus on the most popular cars in the dataset, which <em>should</em> help improve its accuracy.</p>
</section>
<section id="correlation-matrix" class="level2">
<h2 class="anchored" data-anchor-id="correlation-matrix">Correlation matrix</h2>
<p>As another step, let us calculate the correlation matrix for the dataset. This will help us understand the relationships between the different features, and will help us identify which features are most important in predicting the test result.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
About Correlation Matrixes
</div>
</div>
<div class="callout-body-container callout-body">
<p>In statistics, correlation values are used to quantify the strength and direction of the relationship between two variables. These values range from -1 to +1, with their sign indicating the direction of the relationship and their magnitude reflecting the strength.</p>
<p><strong>Positive Correlation</strong>: A positive correlation value indicates that as one variable increases, the other variable also increases. Similarly, as one variable decreases, the other variable decreases. This kind of relationship implies that both variables move in tandem. A perfect positive correlation, with a coefficient of +1, means that for every incremental increase in one variable, there is a proportional increase in the other variable. An example might be the relationship between height and weight; generally, taller people tend to weigh more. In real-world data, perfect correlations are rare, but strong positive correlations often indicate a significant linear relationship.</p>
<p><strong>Negative Correlation</strong>: Conversely, a negative correlation value suggests that as one variable increases, the other decreases, and vice versa. This inverse relationship means that the variables move in opposite directions. A perfect negative correlation, with a coefficient of -1, means that an increase in one variable corresponds to a proportional decrease in the other. For instance, the amount of time spent driving in traffic might be negatively correlated with overall daily productivity. Just like with positive correlations, perfect negative correlations are unusual in practice, but strong negative correlations can be highly informative about the dynamics between variables.</p>
<p>Both positive and negative correlation values provide insights into the variables being studied, helping to understand whether and how variables influence each other.</p>
</div>
</div>
<div id="4942de46" class="cell" data-execution_count="6">
<details class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="4942de46"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="4942de46-1"><a href="#4942de46-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="4942de46-2"><a href="#4942de46-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="4942de46-3"><a href="#4942de46-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.preprocessing <span class="im">import</span> LabelEncoder</span>
<span id="4942de46-4"><a href="#4942de46-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="4942de46-5"><a href="#4942de46-5" aria-hidden="true" tabindex="-1"></a>mot_temp <span class="op">=</span> mot.copy()</span>
<span id="4942de46-6"><a href="#4942de46-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="4942de46-7"><a href="#4942de46-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Drop columns that are not to be included in the correlation matrix</span></span>
<span id="4942de46-8"><a href="#4942de46-8" aria-hidden="true" tabindex="-1"></a>columns_to_exclude <span class="op">=</span> [</span>
<span id="4942de46-9"><a href="#4942de46-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">"vehicle_id"</span>,</span>
<span id="4942de46-10"><a href="#4942de46-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">"test_type"</span>,</span>
<span id="4942de46-11"><a href="#4942de46-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">"age"</span>,</span>
<span id="4942de46-12"><a href="#4942de46-12" aria-hidden="true" tabindex="-1"></a>    <span class="st">"age_years"</span>,</span>
<span id="4942de46-13"><a href="#4942de46-13" aria-hidden="true" tabindex="-1"></a>    <span class="st">"make_model"</span>,</span>
<span id="4942de46-14"><a href="#4942de46-14" aria-hidden="true" tabindex="-1"></a>    <span class="st">"test_result_class"</span>,</span>
<span id="4942de46-15"><a href="#4942de46-15" aria-hidden="true" tabindex="-1"></a>    <span class="st">"test_result_desc"</span>,</span>
<span id="4942de46-16"><a href="#4942de46-16" aria-hidden="true" tabindex="-1"></a>    <span class="st">"fuel_type_desc"</span>,</span>
<span id="4942de46-17"><a href="#4942de46-17" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="4942de46-18"><a href="#4942de46-18" aria-hidden="true" tabindex="-1"></a>mot_temp <span class="op">=</span> mot_temp.drop(columns<span class="op">=</span>columns_to_exclude, errors<span class="op">=</span><span class="st">"ignore"</span>)</span>
<span id="4942de46-19"><a href="#4942de46-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="4942de46-20"><a href="#4942de46-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Encode non-numeric attributes</span></span>
<span id="4942de46-21"><a href="#4942de46-21" aria-hidden="true" tabindex="-1"></a>label_encoders <span class="op">=</span> {}</span>
<span id="4942de46-22"><a href="#4942de46-22" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> column <span class="kw">in</span> mot_temp.columns:</span>
<span id="4942de46-23"><a href="#4942de46-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> mot_temp[column].dtype <span class="op">==</span> <span class="bu">object</span>:  <span class="co"># Column has non-numeric data</span></span>
<span id="4942de46-24"><a href="#4942de46-24" aria-hidden="true" tabindex="-1"></a>        le <span class="op">=</span> LabelEncoder()</span>
<span id="4942de46-25"><a href="#4942de46-25" aria-hidden="true" tabindex="-1"></a>        mot_temp[column] <span class="op">=</span> le.fit_transform(</span>
<span id="4942de46-26"><a href="#4942de46-26" aria-hidden="true" tabindex="-1"></a>            mot_temp[column].astype(<span class="bu">str</span>)</span>
<span id="4942de46-27"><a href="#4942de46-27" aria-hidden="true" tabindex="-1"></a>        )  <span class="co"># Convert and encode</span></span>
<span id="4942de46-28"><a href="#4942de46-28" aria-hidden="true" tabindex="-1"></a>        label_encoders[column] <span class="op">=</span> le  <span class="co"># Store the encoder if needed later</span></span>
<span id="4942de46-29"><a href="#4942de46-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="4942de46-30"><a href="#4942de46-30" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute the correlation matrix</span></span>
<span id="4942de46-31"><a href="#4942de46-31" aria-hidden="true" tabindex="-1"></a>correlation_matrix <span class="op">=</span> mot_temp.corr()</span>
<span id="4942de46-32"><a href="#4942de46-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="4942de46-33"><a href="#4942de46-33" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the correlation matrix</span></span>
<span id="4942de46-34"><a href="#4942de46-34" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="dv">6</span>))</span>
<span id="4942de46-35"><a href="#4942de46-35" aria-hidden="true" tabindex="-1"></a>sns.heatmap(</span>
<span id="4942de46-36"><a href="#4942de46-36" aria-hidden="true" tabindex="-1"></a>    correlation_matrix, annot<span class="op">=</span><span class="va">True</span>, cmap<span class="op">=</span><span class="st">"summer_r"</span>, fmt<span class="op">=</span><span class="st">".2f"</span>, linewidths<span class="op">=</span><span class="dv">2</span></span>
<span id="4942de46-37"><a href="#4942de46-37" aria-hidden="true" tabindex="-1"></a>).set_title(<span class="st">"Correlation Heatmap Excluding Specific Columns"</span>)</span>
<span id="4942de46-38"><a href="#4942de46-38" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><a href="index_files/figure-html/cell-6-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-1"><img src="index_files/figure-html/cell-6-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<p>Notice that except for some obvious correlations (for example, <code>test_mileage</code> vs <code>first_use_date</code>), most of the correlations are reasonably weak. This means that the variables in the dataset do not have strong linear relationships with one another. When correlations are weak, it suggests that changes in one variable are not consistently associated with changes in another in a way that could be described using a simple linear equation. For analytical purposes, this can have several implications:</p>
<p><strong>Complex Relationships</strong>: The weak correlations imply that if relationships do exist between the variables, they may be complex and not easily modeled by linear regression. Non-linear models or advanced statistical techniques such as decision trees or random forests might be more appropriate to capture the underlying patterns in the data.</p>
<p><strong>Multivariate Analysis</strong>: In cases where correlations are weak, it might be useful to look at multivariate relationships, considering the impact of multiple variables at once rather than pairs of variables. Techniques such as Principal Component Analysis (PCA) or multiple regression could reveal combined effects of variables that are not apparent when looking at pairwise correlations alone.</p>
<p><strong>Data Transformation</strong>: Sometimes, transforming the data can reveal underlying patterns that are not visible in the original scale or format. For example, applying a logarithmic or square root transformation to skewed data might expose stronger correlations that were not initially apparent.</p>
<p><strong>Exploring Causality</strong>: Weak correlations also suggest caution when inferring causality. Correlation does not imply causation, and in the absence of strong correlations, even speculative causal relationships should be considered with greater skepticism. It may be necessary to use controlled experiments or causal inference models to explore if and how variables influence each other.</p>
<p><strong>Revisiting Data Collection</strong>: Finally, weak correlations may indicate that important variables are missing from the analysis, and additional data collection might be needed. It might also suggest revisiting the data collection methodology to ensure that all relevant variables are accurately captured and that the data quality is sufficient to detect the underlying relationships.</p>
</section>
<section id="exploratory-analysis" class="level2">
<h2 class="anchored" data-anchor-id="exploratory-analysis">Exploratory analysis</h2>
<p>Let’s try and gather some insights from the data. We will start by looking at the most common make/model combinations available.</p>
<div id="d4695b67" class="cell" data-execution_count="7">
<details class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="d4695b67"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="d4695b67-1"><a href="#d4695b67-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the top 10 most common make-model combinations</span></span>
<span id="d4695b67-2"><a href="#d4695b67-2" aria-hidden="true" tabindex="-1"></a>top_vehicles <span class="op">=</span> mot[<span class="st">"make_model"</span>].value_counts().head(<span class="dv">10</span>)</span>
<span id="d4695b67-3"><a href="#d4695b67-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="d4695b67-4"><a href="#d4695b67-4" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="dv">6</span>))</span>
<span id="d4695b67-5"><a href="#d4695b67-5" aria-hidden="true" tabindex="-1"></a>top_vehicles.plot(kind<span class="op">=</span><span class="st">"bar"</span>, color<span class="op">=</span><span class="st">"green"</span>, edgecolor<span class="op">=</span><span class="st">"darkgreen"</span>)</span>
<span id="d4695b67-6"><a href="#d4695b67-6" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Top 10 Vehicle Make-Model Combinations"</span>)</span>
<span id="d4695b67-7"><a href="#d4695b67-7" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"Make-Model"</span>)</span>
<span id="d4695b67-8"><a href="#d4695b67-8" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"Tests"</span>)</span>
<span id="d4695b67-9"><a href="#d4695b67-9" aria-hidden="true" tabindex="-1"></a>plt.xticks(rotation<span class="op">=</span><span class="dv">45</span>)</span>
<span id="d4695b67-10"><a href="#d4695b67-10" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><a href="index_files/figure-html/cell-7-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-2"><img src="index_files/figure-html/cell-7-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<p>That’s interesting! The most common make/model combination is the Ford Fiesta, followed by the Ford Focus and the Vauxhall Corsa. These are all popular cars in the UK, so it makes sense that they are the most tested. Note that we are measuring <em>the number of tests</em> and not the number of cars, so it is possible that some cars have been tested multiple times.</p>
<p>Let’s now perform a different visualisation which might be a bit more interesting, we will first show the distribution of car makes in relative terms as a treemap. In this case, let us remove any vehicle duplicates, so we only have one test per vehicle and therefore are comparing actual number of vehicles.</p>
<div id="ebbb492d" class="cell" data-execution_count="8">
<details class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="ebbb492d"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="ebbb492d-1"><a href="#ebbb492d-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> squarify</span>
<span id="ebbb492d-2"><a href="#ebbb492d-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="ebbb492d-3"><a href="#ebbb492d-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the top vehicle makes, while deduplicating for vehicle_id</span></span>
<span id="ebbb492d-4"><a href="#ebbb492d-4" aria-hidden="true" tabindex="-1"></a>counts <span class="op">=</span> mot.drop_duplicates(<span class="st">"vehicle_id"</span>)[<span class="st">"make"</span>].value_counts()</span>
<span id="ebbb492d-5"><a href="#ebbb492d-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="ebbb492d-6"><a href="#ebbb492d-6" aria-hidden="true" tabindex="-1"></a>labels <span class="op">=</span> counts.index</span>
<span id="ebbb492d-7"><a href="#ebbb492d-7" aria-hidden="true" tabindex="-1"></a>sizes <span class="op">=</span> counts.values</span>
<span id="ebbb492d-8"><a href="#ebbb492d-8" aria-hidden="true" tabindex="-1"></a>colors <span class="op">=</span> plt.cm.Spectral_r(sizes <span class="op">/</span> <span class="bu">max</span>(sizes))  <span class="co"># Color coding by size</span></span>
<span id="ebbb492d-9"><a href="#ebbb492d-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="ebbb492d-10"><a href="#ebbb492d-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Creating the treemap</span></span>
<span id="ebbb492d-11"><a href="#ebbb492d-11" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="dv">6</span>))</span>
<span id="ebbb492d-12"><a href="#ebbb492d-12" aria-hidden="true" tabindex="-1"></a>squarify.plot(</span>
<span id="ebbb492d-13"><a href="#ebbb492d-13" aria-hidden="true" tabindex="-1"></a>    sizes<span class="op">=</span>sizes, label<span class="op">=</span>labels, color<span class="op">=</span>colors, alpha<span class="op">=</span><span class="fl">0.8</span>, text_kwargs<span class="op">=</span>{<span class="st">"fontsize"</span>: <span class="dv">8</span>}</span>
<span id="ebbb492d-14"><a href="#ebbb492d-14" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="ebbb492d-15"><a href="#ebbb492d-15" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Treemap of Vehicle Makes"</span>)</span>
<span id="ebbb492d-16"><a href="#ebbb492d-16" aria-hidden="true" tabindex="-1"></a>plt.axis(<span class="st">"off"</span>)  <span class="co"># Remove axes</span></span>
<span id="ebbb492d-17"><a href="#ebbb492d-17" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><a href="index_files/figure-html/cell-8-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-3"><img src="index_files/figure-html/cell-8-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<div id="c448a132" class="cell" data-execution_count="9">
<details class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="c448a132"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="c448a132-1"><a href="#c448a132-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the top vehicle models, while deduplicating for vehicle_id</span></span>
<span id="c448a132-2"><a href="#c448a132-2" aria-hidden="true" tabindex="-1"></a>counts <span class="op">=</span> mot.drop_duplicates(<span class="st">"vehicle_id"</span>)[<span class="st">"model"</span>].value_counts()</span>
<span id="c448a132-3"><a href="#c448a132-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="c448a132-4"><a href="#c448a132-4" aria-hidden="true" tabindex="-1"></a>labels <span class="op">=</span> counts.index</span>
<span id="c448a132-5"><a href="#c448a132-5" aria-hidden="true" tabindex="-1"></a>sizes <span class="op">=</span> counts.values</span>
<span id="c448a132-6"><a href="#c448a132-6" aria-hidden="true" tabindex="-1"></a>colors <span class="op">=</span> plt.cm.Spectral_r(sizes <span class="op">/</span> <span class="bu">max</span>(sizes))  <span class="co"># Color coding by size</span></span>
<span id="c448a132-7"><a href="#c448a132-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="c448a132-8"><a href="#c448a132-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Creating the treemap</span></span>
<span id="c448a132-9"><a href="#c448a132-9" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="dv">6</span>))</span>
<span id="c448a132-10"><a href="#c448a132-10" aria-hidden="true" tabindex="-1"></a>squarify.plot(</span>
<span id="c448a132-11"><a href="#c448a132-11" aria-hidden="true" tabindex="-1"></a>    sizes<span class="op">=</span>sizes, label<span class="op">=</span>labels, color<span class="op">=</span>colors, alpha<span class="op">=</span><span class="fl">0.8</span>, text_kwargs<span class="op">=</span>{<span class="st">"fontsize"</span>: <span class="dv">8</span>}</span>
<span id="c448a132-12"><a href="#c448a132-12" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="c448a132-13"><a href="#c448a132-13" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Treemap of Vehicle Models"</span>)</span>
<span id="c448a132-14"><a href="#c448a132-14" aria-hidden="true" tabindex="-1"></a>plt.axis(<span class="st">"off"</span>)  <span class="co"># Remove axes</span></span>
<span id="c448a132-15"><a href="#c448a132-15" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><a href="index_files/figure-html/cell-9-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-4"><img src="index_files/figure-html/cell-9-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<p>This is quite informative! We can easily see the relative popularity of different models, and the color coding gives a great visual representation of the distribution of both makes and models.</p>
<p>Now let us look at how vehicle age, make and model is distributed - this will help us get a better picture of the test results for each make and model. First let us understand the overal distribution of vehicle age in the dataset, as an histogram.</p>
<div id="22a930d3" class="cell" data-execution_count="10">
<details class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="22a930d3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="22a930d3-1"><a href="#22a930d3-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="22a930d3-2"><a href="#22a930d3-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="22a930d3-3"><a href="#22a930d3-3" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="dv">6</span>))</span>
<span id="22a930d3-4"><a href="#22a930d3-4" aria-hidden="true" tabindex="-1"></a>sns.histplot(mot.drop_duplicates(<span class="st">"vehicle_id"</span>)[<span class="st">"age_years"</span>], color<span class="op">=</span><span class="st">"skyblue"</span>)</span>
<span id="22a930d3-5"><a href="#22a930d3-5" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Distribution of Vehicle Age"</span>)</span>
<span id="22a930d3-6"><a href="#22a930d3-6" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"Age in Years"</span>)</span>
<span id="22a930d3-7"><a href="#22a930d3-7" aria-hidden="true" tabindex="-1"></a>plt.xticks(rotation<span class="op">=</span><span class="dv">45</span>)</span>
<span id="22a930d3-8"><a href="#22a930d3-8" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"Number of Vehicles"</span>)</span>
<span id="22a930d3-9"><a href="#22a930d3-9" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><a href="index_files/figure-html/cell-10-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-5"><img src="index_files/figure-html/cell-10-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Q&amp;A
</div>
</div>
<div class="callout-body-container callout-body">
<p>What do you think the spikes in the histogram represent?</p>
</div>
</div>
<p>Again, super informative. It would however be interesting to understand this as percentiles as well, so let us add that.</p>
<div id="17ba562a" class="cell" data-execution_count="11">
<details class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="17ba562a"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="17ba562a-1"><a href="#17ba562a-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate and plot percentiles for the age_years column</span></span>
<span id="17ba562a-2"><a href="#17ba562a-2" aria-hidden="true" tabindex="-1"></a>percentiles <span class="op">=</span> mot.drop_duplicates(<span class="st">"vehicle_id"</span>)[<span class="st">"age_years"</span>].quantile(</span>
<span id="17ba562a-3"><a href="#17ba562a-3" aria-hidden="true" tabindex="-1"></a>    [<span class="fl">0.25</span>, <span class="fl">0.5</span>, <span class="fl">0.75</span>, <span class="fl">0.95</span>]</span>
<span id="17ba562a-4"><a href="#17ba562a-4" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="17ba562a-5"><a href="#17ba562a-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(percentiles)</span>
<span id="17ba562a-6"><a href="#17ba562a-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="17ba562a-7"><a href="#17ba562a-7" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="dv">6</span>))</span>
<span id="17ba562a-8"><a href="#17ba562a-8" aria-hidden="true" tabindex="-1"></a>sns.histplot(mot[<span class="st">"age_years"</span>], color<span class="op">=</span><span class="st">"skyblue"</span>)</span>
<span id="17ba562a-9"><a href="#17ba562a-9" aria-hidden="true" tabindex="-1"></a>plt.axvline(percentiles.iloc[<span class="dv">0</span>], color<span class="op">=</span><span class="st">"red"</span>, linestyle<span class="op">=</span><span class="st">"--"</span>, label<span class="op">=</span><span class="st">"25%"</span>)</span>
<span id="17ba562a-10"><a href="#17ba562a-10" aria-hidden="true" tabindex="-1"></a>plt.axvline(percentiles.iloc[<span class="dv">1</span>], color<span class="op">=</span><span class="st">"green"</span>, linestyle<span class="op">=</span><span class="st">"--"</span>, label<span class="op">=</span><span class="st">"50%"</span>)</span>
<span id="17ba562a-11"><a href="#17ba562a-11" aria-hidden="true" tabindex="-1"></a>plt.axvline(percentiles.iloc[<span class="dv">2</span>], color<span class="op">=</span><span class="st">"blue"</span>, linestyle<span class="op">=</span><span class="st">"--"</span>, label<span class="op">=</span><span class="st">"75%"</span>)</span>
<span id="17ba562a-12"><a href="#17ba562a-12" aria-hidden="true" tabindex="-1"></a>plt.axvline(percentiles.iloc[<span class="dv">3</span>], color<span class="op">=</span><span class="st">"black"</span>, linestyle<span class="op">=</span><span class="st">"--"</span>, label<span class="op">=</span><span class="st">"95%"</span>)</span>
<span id="17ba562a-13"><a href="#17ba562a-13" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Distribution of Vehicle Age"</span>)</span>
<span id="17ba562a-14"><a href="#17ba562a-14" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"Age in Years"</span>)</span>
<span id="17ba562a-15"><a href="#17ba562a-15" aria-hidden="true" tabindex="-1"></a>plt.xticks(rotation<span class="op">=</span><span class="dv">45</span>)</span>
<span id="17ba562a-16"><a href="#17ba562a-16" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"Number of Vehicles"</span>)</span>
<span id="17ba562a-17"><a href="#17ba562a-17" aria-hidden="true" tabindex="-1"></a>plt.legend()</span>
<span id="17ba562a-18"><a href="#17ba562a-18" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>0.25     7.000684
0.50    10.151951
0.75    14.078029
0.95    19.403149
Name: age_years, dtype: float64</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><a href="index_files/figure-html/cell-11-output-2.png" class="lightbox" data-gallery="quarto-lightbox-gallery-6"><img src="index_files/figure-html/cell-11-output-2.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<p>We conclude that only 25% of cars are newer than 7 years, and 50% newer than 10. Let us perform a similar analysis, but for mileage instead of age.</p>
<div id="3ab8423f" class="cell" data-execution_count="12">
<details class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="3ab8423f"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="3ab8423f-1"><a href="#3ab8423f-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate and plot percentiles for the test_mileage column</span></span>
<span id="3ab8423f-2"><a href="#3ab8423f-2" aria-hidden="true" tabindex="-1"></a>percentiles <span class="op">=</span> mot.drop_duplicates(<span class="st">"vehicle_id"</span>)[<span class="st">"test_mileage"</span>].quantile(</span>
<span id="3ab8423f-3"><a href="#3ab8423f-3" aria-hidden="true" tabindex="-1"></a>    [<span class="fl">0.25</span>, <span class="fl">0.5</span>, <span class="fl">0.75</span>, <span class="fl">0.95</span>]</span>
<span id="3ab8423f-4"><a href="#3ab8423f-4" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="3ab8423f-5"><a href="#3ab8423f-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(percentiles)</span>
<span id="3ab8423f-6"><a href="#3ab8423f-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="3ab8423f-7"><a href="#3ab8423f-7" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="dv">6</span>))</span>
<span id="3ab8423f-8"><a href="#3ab8423f-8" aria-hidden="true" tabindex="-1"></a>sns.histplot(mot[<span class="st">"test_mileage"</span>], color<span class="op">=</span><span class="st">"skyblue"</span>)</span>
<span id="3ab8423f-9"><a href="#3ab8423f-9" aria-hidden="true" tabindex="-1"></a>plt.axvline(percentiles.iloc[<span class="dv">0</span>], color<span class="op">=</span><span class="st">"red"</span>, linestyle<span class="op">=</span><span class="st">"--"</span>, label<span class="op">=</span><span class="st">"25%"</span>)</span>
<span id="3ab8423f-10"><a href="#3ab8423f-10" aria-hidden="true" tabindex="-1"></a>plt.axvline(percentiles.iloc[<span class="dv">1</span>], color<span class="op">=</span><span class="st">"green"</span>, linestyle<span class="op">=</span><span class="st">"--"</span>, label<span class="op">=</span><span class="st">"50%"</span>)</span>
<span id="3ab8423f-11"><a href="#3ab8423f-11" aria-hidden="true" tabindex="-1"></a>plt.axvline(percentiles.iloc[<span class="dv">2</span>], color<span class="op">=</span><span class="st">"blue"</span>, linestyle<span class="op">=</span><span class="st">"--"</span>, label<span class="op">=</span><span class="st">"75%"</span>)</span>
<span id="3ab8423f-12"><a href="#3ab8423f-12" aria-hidden="true" tabindex="-1"></a>plt.axvline(percentiles.iloc[<span class="dv">3</span>], color<span class="op">=</span><span class="st">"black"</span>, linestyle<span class="op">=</span><span class="st">"--"</span>, label<span class="op">=</span><span class="st">"95%"</span>)</span>
<span id="3ab8423f-13"><a href="#3ab8423f-13" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Distribution of Vehicle Mileage"</span>)</span>
<span id="3ab8423f-14"><a href="#3ab8423f-14" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"Mileage"</span>)</span>
<span id="3ab8423f-15"><a href="#3ab8423f-15" aria-hidden="true" tabindex="-1"></a>plt.xticks(rotation<span class="op">=</span><span class="dv">45</span>)</span>
<span id="3ab8423f-16"><a href="#3ab8423f-16" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"Number of Vehicles"</span>)</span>
<span id="3ab8423f-17"><a href="#3ab8423f-17" aria-hidden="true" tabindex="-1"></a>plt.legend()</span>
<span id="3ab8423f-18"><a href="#3ab8423f-18" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>0.25     44724.0
0.50     71417.0
0.75    103510.0
0.95    159279.0
Name: test_mileage, dtype: float64</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><a href="index_files/figure-html/cell-12-output-2.png" class="lightbox" data-gallery="quarto-lightbox-gallery-7"><img src="index_files/figure-html/cell-12-output-2.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<p>Lots of information here. We can see that only 25% of cars have a mileage of less than aproximately 44000 miles, and half the cars have over 70000 miles on the clock! This is quite a lot of mileage, and it will be interesting to see how this affects the test results.</p>
<p>Let us now visually try to understand these distributions of age and mileage for each make and model. We are only ilustrating the visualisation technique, so let us look at age only - we could easily do the same for mileage. We will use a stacked histogram, where the <code>y</code> axis is the percentage of cars in each age group, and the <code>x</code> axis is the age of the car.</p>
<div id="9a89d65a" class="cell" data-execution_count="13">
<details class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="9a89d65a"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="9a89d65a-1"><a href="#9a89d65a-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot a matrix of histograms per make of the age of vehicles in years</span></span>
<span id="9a89d65a-2"><a href="#9a89d65a-2" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="dv">6</span>))</span>
<span id="9a89d65a-3"><a href="#9a89d65a-3" aria-hidden="true" tabindex="-1"></a>sns.histplot(data<span class="op">=</span>mot, x<span class="op">=</span><span class="st">"age_years"</span>, hue<span class="op">=</span><span class="st">"make"</span>, multiple<span class="op">=</span><span class="st">"fill"</span>, palette<span class="op">=</span><span class="st">"tab20"</span>)</span>
<span id="9a89d65a-4"><a href="#9a89d65a-4" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Histogram of Vehicle Age by Make"</span>)</span>
<span id="9a89d65a-5"><a href="#9a89d65a-5" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"Age (years)"</span>)</span>
<span id="9a89d65a-6"><a href="#9a89d65a-6" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"Frequency"</span>)</span>
<span id="9a89d65a-7"><a href="#9a89d65a-7" aria-hidden="true" tabindex="-1"></a>plt.xticks(rotation<span class="op">=</span><span class="dv">45</span>)</span>
<span id="9a89d65a-8"><a href="#9a89d65a-8" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><a href="index_files/figure-html/cell-13-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-8"><img src="index_files/figure-html/cell-13-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<p>There are <em>a lot</em> of old Volkswagens out on the road! This is quite interesting, and we can see that the distribution of ages for different makes is very different, ilustrating the popularity of different makes over time, a little bit like reading tree rings!</p>
<p>Let us perform the same analysis, but for models instead of makes.</p>
<div id="e52bf723" class="cell" data-execution_count="14">
<details class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="e52bf723"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="e52bf723-1"><a href="#e52bf723-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot a matrix of histograms per model of the age of vehicles in years</span></span>
<span id="e52bf723-2"><a href="#e52bf723-2" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="dv">6</span>))</span>
<span id="e52bf723-3"><a href="#e52bf723-3" aria-hidden="true" tabindex="-1"></a>sns.histplot(data<span class="op">=</span>mot, x<span class="op">=</span><span class="st">"age_years"</span>, hue<span class="op">=</span><span class="st">"model"</span>, multiple<span class="op">=</span><span class="st">"fill"</span>, palette<span class="op">=</span><span class="st">"tab20"</span>)</span>
<span id="e52bf723-4"><a href="#e52bf723-4" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Histogram of Vehicle Age by Model"</span>)</span>
<span id="e52bf723-5"><a href="#e52bf723-5" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"Age (years)"</span>)</span>
<span id="e52bf723-6"><a href="#e52bf723-6" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"Frequency"</span>)</span>
<span id="e52bf723-7"><a href="#e52bf723-7" aria-hidden="true" tabindex="-1"></a>plt.xticks(rotation<span class="op">=</span><span class="dv">45</span>)</span>
<span id="e52bf723-8"><a href="#e52bf723-8" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><a href="index_files/figure-html/cell-14-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-9"><img src="index_files/figure-html/cell-14-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<p>The number of Golf’s and Transporter vans helps to explain the make distribution we saw before. The effect we see is quite striking, and just like car makers before, it ilustrates the popularity of different models over time.</p>
<div id="268799d8" class="cell" data-execution_count="15">
<details class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="268799d8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="268799d8-1"><a href="#268799d8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the average test mileage</span></span>
<span id="268799d8-2"><a href="#268799d8-2" aria-hidden="true" tabindex="-1"></a>avg_mileage <span class="op">=</span> mot.groupby([<span class="st">"model"</span>, <span class="st">"make"</span>])[<span class="st">"test_mileage"</span>].mean().reset_index()</span>
<span id="268799d8-3"><a href="#268799d8-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="268799d8-4"><a href="#268799d8-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the average age in years for each model as a proxy for size</span></span>
<span id="268799d8-5"><a href="#268799d8-5" aria-hidden="true" tabindex="-1"></a>avg_age_years <span class="op">=</span> mot.groupby([<span class="st">"model"</span>, <span class="st">"make"</span>])[<span class="st">"age_years"</span>].mean().reset_index()</span>
<span id="268799d8-6"><a href="#268799d8-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="268799d8-7"><a href="#268799d8-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the average cylinder capacity for each model</span></span>
<span id="268799d8-8"><a href="#268799d8-8" aria-hidden="true" tabindex="-1"></a>avg_capacity <span class="op">=</span> mot.groupby([<span class="st">"model"</span>, <span class="st">"make"</span>])[<span class="st">"cylinder_capacity"</span>].mean().reset_index()</span>
<span id="268799d8-9"><a href="#268799d8-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="268799d8-10"><a href="#268799d8-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge the average mileage data with the average age years</span></span>
<span id="268799d8-11"><a href="#268799d8-11" aria-hidden="true" tabindex="-1"></a>merged_data <span class="op">=</span> avg_mileage.merge(avg_age_years, on<span class="op">=</span>[<span class="st">"model"</span>, <span class="st">"make"</span>])</span>
<span id="268799d8-12"><a href="#268799d8-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="268799d8-13"><a href="#268799d8-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge the merged data with the average capacity</span></span>
<span id="268799d8-14"><a href="#268799d8-14" aria-hidden="true" tabindex="-1"></a>merged_data <span class="op">=</span> merged_data.merge(avg_capacity, on<span class="op">=</span>[<span class="st">"model"</span>, <span class="st">"make"</span>])</span>
<span id="268799d8-15"><a href="#268799d8-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="268799d8-16"><a href="#268799d8-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Sort the data by average mileage</span></span>
<span id="268799d8-17"><a href="#268799d8-17" aria-hidden="true" tabindex="-1"></a>top_avg_mileage <span class="op">=</span> merged_data.sort_values(by<span class="op">=</span><span class="st">"test_mileage"</span>, ascending<span class="op">=</span><span class="va">False</span>)</span>
<span id="268799d8-18"><a href="#268799d8-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="268799d8-19"><a href="#268799d8-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a scatter plot</span></span>
<span id="268799d8-20"><a href="#268799d8-20" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="dv">6</span>))  <span class="co"># Set the figure size</span></span>
<span id="268799d8-21"><a href="#268799d8-21" aria-hidden="true" tabindex="-1"></a>scatter <span class="op">=</span> plt.scatter(</span>
<span id="268799d8-22"><a href="#268799d8-22" aria-hidden="true" tabindex="-1"></a>    <span class="st">"model"</span>,  <span class="co"># x-axis</span></span>
<span id="268799d8-23"><a href="#268799d8-23" aria-hidden="true" tabindex="-1"></a>    <span class="st">"test_mileage"</span>,  <span class="co"># y-axis</span></span>
<span id="268799d8-24"><a href="#268799d8-24" aria-hidden="true" tabindex="-1"></a>    c<span class="op">=</span>top_avg_mileage[<span class="st">"age_years"</span>],</span>
<span id="268799d8-25"><a href="#268799d8-25" aria-hidden="true" tabindex="-1"></a>    s<span class="op">=</span>top_avg_mileage[<span class="st">"cylinder_capacity"</span>]</span>
<span id="268799d8-26"><a href="#268799d8-26" aria-hidden="true" tabindex="-1"></a>    <span class="op">/</span> <span class="dv">10</span>,  <span class="co"># Bubble size based on average cilinder capacity</span></span>
<span id="268799d8-27"><a href="#268799d8-27" aria-hidden="true" tabindex="-1"></a>    cmap<span class="op">=</span><span class="st">"Spectral"</span>,  <span class="co"># Color map</span></span>
<span id="268799d8-28"><a href="#268799d8-28" aria-hidden="true" tabindex="-1"></a>    data<span class="op">=</span>top_avg_mileage,  <span class="co"># Data source</span></span>
<span id="268799d8-29"><a href="#268799d8-29" aria-hidden="true" tabindex="-1"></a>    alpha<span class="op">=</span><span class="fl">0.6</span>,  <span class="co"># Transparency of the bubbles</span></span>
<span id="268799d8-30"><a href="#268799d8-30" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="268799d8-31"><a href="#268799d8-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="268799d8-32"><a href="#268799d8-32" aria-hidden="true" tabindex="-1"></a><span class="co"># Add titles and labels</span></span>
<span id="268799d8-33"><a href="#268799d8-33" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Average Test Mileage by Model with Average Age"</span>)</span>
<span id="268799d8-34"><a href="#268799d8-34" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"Model"</span>)</span>
<span id="268799d8-35"><a href="#268799d8-35" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"Average Test Mileage"</span>)</span>
<span id="268799d8-36"><a href="#268799d8-36" aria-hidden="true" tabindex="-1"></a>plt.xticks(rotation<span class="op">=</span><span class="dv">90</span>)  <span class="co"># Rotate x-axis labels for better readability</span></span>
<span id="268799d8-37"><a href="#268799d8-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="268799d8-38"><a href="#268799d8-38" aria-hidden="true" tabindex="-1"></a><span class="co"># Create colorbar</span></span>
<span id="268799d8-39"><a href="#268799d8-39" aria-hidden="true" tabindex="-1"></a>plt.colorbar(scatter, label<span class="op">=</span><span class="st">"Average Age in Years"</span>)</span>
<span id="268799d8-40"><a href="#268799d8-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="268799d8-41"><a href="#268799d8-41" aria-hidden="true" tabindex="-1"></a><span class="co"># Show the plot</span></span>
<span id="268799d8-42"><a href="#268799d8-42" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="268799d8-43"><a href="#268799d8-43" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><a href="index_files/figure-html/cell-15-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-10"><img src="index_files/figure-html/cell-15-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<p>We could also analyze the ‘Pass’ ratio for each make and model, represented by the percentage of successful tests per make and model. This metric will provide insights into the reliability of different vehicles. Note that our focus is solely on ‘NT’ (Normal Test) test types to gauge general performance without considering retests.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
About Pass Ratio
</div>
</div>
<div class="callout-body-container callout-body">
<p>This measure is a very simplistic proxy for reliability. In practice, we would need to consider other factors, such as the number of retests, the type of failures, etc.</p>
</div>
</div>
<div id="34c0ec77" class="cell" data-execution_count="16">
<details class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="34c0ec77"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="34c0ec77-1"><a href="#34c0ec77-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Find the makes with the highest ratio of test_result = P</span></span>
<span id="34c0ec77-2"><a href="#34c0ec77-2" aria-hidden="true" tabindex="-1"></a>make_counts <span class="op">=</span> mot[<span class="st">"make"</span>].value_counts()</span>
<span id="34c0ec77-3"><a href="#34c0ec77-3" aria-hidden="true" tabindex="-1"></a>make_p_counts <span class="op">=</span> mot[mot[<span class="st">"test_result"</span>] <span class="op">==</span> <span class="st">"P"</span>][<span class="st">"make"</span>].value_counts()</span>
<span id="34c0ec77-4"><a href="#34c0ec77-4" aria-hidden="true" tabindex="-1"></a>make_p_ratio <span class="op">=</span> make_p_counts <span class="op">/</span> make_counts</span>
<span id="34c0ec77-5"><a href="#34c0ec77-5" aria-hidden="true" tabindex="-1"></a>make_p_ratio <span class="op">=</span> make_p_ratio.sort_values(ascending<span class="op">=</span><span class="va">False</span>)</span>
<span id="34c0ec77-6"><a href="#34c0ec77-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="34c0ec77-7"><a href="#34c0ec77-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert the Series to DataFrame for plotting</span></span>
<span id="34c0ec77-8"><a href="#34c0ec77-8" aria-hidden="true" tabindex="-1"></a>make_p_ratio_df <span class="op">=</span> make_p_ratio.reset_index()</span>
<span id="34c0ec77-9"><a href="#34c0ec77-9" aria-hidden="true" tabindex="-1"></a>make_p_ratio_df.columns <span class="op">=</span> [<span class="st">"Make"</span>, <span class="st">"Test Result P Ratio"</span>]</span>
<span id="34c0ec77-10"><a href="#34c0ec77-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="34c0ec77-11"><a href="#34c0ec77-11" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="dv">6</span>))</span>
<span id="34c0ec77-12"><a href="#34c0ec77-12" aria-hidden="true" tabindex="-1"></a>barplot <span class="op">=</span> sns.barplot(</span>
<span id="34c0ec77-13"><a href="#34c0ec77-13" aria-hidden="true" tabindex="-1"></a>    y<span class="op">=</span><span class="st">"Make"</span>,  <span class="co"># Now 'Make' is on the y-axis</span></span>
<span id="34c0ec77-14"><a href="#34c0ec77-14" aria-hidden="true" tabindex="-1"></a>    x<span class="op">=</span><span class="st">"Test Result P Ratio"</span>,  <span class="co"># And 'Test Result P Ratio' on the x-axis</span></span>
<span id="34c0ec77-15"><a href="#34c0ec77-15" aria-hidden="true" tabindex="-1"></a>    data<span class="op">=</span>make_p_ratio_df,</span>
<span id="34c0ec77-16"><a href="#34c0ec77-16" aria-hidden="true" tabindex="-1"></a>    color<span class="op">=</span><span class="st">"skyblue"</span>,</span>
<span id="34c0ec77-17"><a href="#34c0ec77-17" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="34c0ec77-18"><a href="#34c0ec77-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="34c0ec77-19"><a href="#34c0ec77-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Adding a title and labels</span></span>
<span id="34c0ec77-20"><a href="#34c0ec77-20" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Makes with the Highest Ratio of Test Result P (Pass)"</span>)</span>
<span id="34c0ec77-21"><a href="#34c0ec77-21" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"Make"</span>)  <span class="co"># Now this is the y-axis label</span></span>
<span id="34c0ec77-22"><a href="#34c0ec77-22" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"Test Result P Ratio"</span>)  <span class="co"># And this is the x-axis label</span></span>
<span id="34c0ec77-23"><a href="#34c0ec77-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="34c0ec77-24"><a href="#34c0ec77-24" aria-hidden="true" tabindex="-1"></a>plt.xticks(rotation<span class="op">=</span><span class="dv">45</span>)</span>
<span id="34c0ec77-25"><a href="#34c0ec77-25" aria-hidden="true" tabindex="-1"></a>plt.yticks(rotation<span class="op">=</span><span class="dv">0</span>)  <span class="co"># You can adjust the rotation for readability if needed</span></span>
<span id="34c0ec77-26"><a href="#34c0ec77-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="34c0ec77-27"><a href="#34c0ec77-27" aria-hidden="true" tabindex="-1"></a><span class="co"># Add value labels next to the bars</span></span>
<span id="34c0ec77-28"><a href="#34c0ec77-28" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> p <span class="kw">in</span> barplot.patches:</span>
<span id="34c0ec77-29"><a href="#34c0ec77-29" aria-hidden="true" tabindex="-1"></a>    barplot.annotate(</span>
<span id="34c0ec77-30"><a href="#34c0ec77-30" aria-hidden="true" tabindex="-1"></a>        <span class="bu">format</span>(</span>
<span id="34c0ec77-31"><a href="#34c0ec77-31" aria-hidden="true" tabindex="-1"></a>            p.get_width(), <span class="st">".2f"</span></span>
<span id="34c0ec77-32"><a href="#34c0ec77-32" aria-hidden="true" tabindex="-1"></a>        ),  <span class="co"># Change to get_width() because width is the measure now</span></span>
<span id="34c0ec77-33"><a href="#34c0ec77-33" aria-hidden="true" tabindex="-1"></a>        (</span>
<span id="34c0ec77-34"><a href="#34c0ec77-34" aria-hidden="true" tabindex="-1"></a>            p.get_width(),</span>
<span id="34c0ec77-35"><a href="#34c0ec77-35" aria-hidden="true" tabindex="-1"></a>            p.get_y() <span class="op">+</span> p.get_height() <span class="op">/</span> <span class="fl">2.0</span>,</span>
<span id="34c0ec77-36"><a href="#34c0ec77-36" aria-hidden="true" tabindex="-1"></a>        ),  <span class="co"># Adjust position to be at the end of the bar</span></span>
<span id="34c0ec77-37"><a href="#34c0ec77-37" aria-hidden="true" tabindex="-1"></a>        ha<span class="op">=</span><span class="st">"left"</span>,</span>
<span id="34c0ec77-38"><a href="#34c0ec77-38" aria-hidden="true" tabindex="-1"></a>        va<span class="op">=</span><span class="st">"center"</span>,  <span class="co"># Align text to the left of the endpoint</span></span>
<span id="34c0ec77-39"><a href="#34c0ec77-39" aria-hidden="true" tabindex="-1"></a>        xytext<span class="op">=</span>(<span class="dv">9</span>, <span class="dv">0</span>),  <span class="co"># Move text to the right a bit</span></span>
<span id="34c0ec77-40"><a href="#34c0ec77-40" aria-hidden="true" tabindex="-1"></a>        textcoords<span class="op">=</span><span class="st">"offset points"</span>,</span>
<span id="34c0ec77-41"><a href="#34c0ec77-41" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="34c0ec77-42"><a href="#34c0ec77-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="34c0ec77-43"><a href="#34c0ec77-43" aria-hidden="true" tabindex="-1"></a>barplot.set_facecolor(<span class="st">"white"</span>)</span>
<span id="34c0ec77-44"><a href="#34c0ec77-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="34c0ec77-45"><a href="#34c0ec77-45" aria-hidden="true" tabindex="-1"></a><span class="co"># Show the plot</span></span>
<span id="34c0ec77-46"><a href="#34c0ec77-46" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><a href="index_files/figure-html/cell-16-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-11"><img src="index_files/figure-html/cell-16-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<p>And now a similar analysis, but for models instead of makes.</p>
<div id="9bcf4777" class="cell" data-execution_count="17">
<details class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="9bcf4777"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="9bcf4777-1"><a href="#9bcf4777-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Find the models with the highest ratio of test_result = P</span></span>
<span id="9bcf4777-2"><a href="#9bcf4777-2" aria-hidden="true" tabindex="-1"></a>model_counts <span class="op">=</span> mot[<span class="st">"model"</span>].value_counts()</span>
<span id="9bcf4777-3"><a href="#9bcf4777-3" aria-hidden="true" tabindex="-1"></a>model_p_counts <span class="op">=</span> mot[mot[<span class="st">"test_result"</span>] <span class="op">==</span> <span class="st">"P"</span>][<span class="st">"model"</span>].value_counts()</span>
<span id="9bcf4777-4"><a href="#9bcf4777-4" aria-hidden="true" tabindex="-1"></a>model_p_ratio <span class="op">=</span> model_p_counts <span class="op">/</span> model_counts</span>
<span id="9bcf4777-5"><a href="#9bcf4777-5" aria-hidden="true" tabindex="-1"></a>model_p_ratio <span class="op">=</span> model_p_ratio.sort_values(ascending<span class="op">=</span><span class="va">False</span>)</span>
<span id="9bcf4777-6"><a href="#9bcf4777-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="9bcf4777-7"><a href="#9bcf4777-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert the Series to DataFrame for plotting</span></span>
<span id="9bcf4777-8"><a href="#9bcf4777-8" aria-hidden="true" tabindex="-1"></a>model_p_ratio_df <span class="op">=</span> model_p_ratio.reset_index()</span>
<span id="9bcf4777-9"><a href="#9bcf4777-9" aria-hidden="true" tabindex="-1"></a>model_p_ratio_df.columns <span class="op">=</span> [<span class="st">"Model"</span>, <span class="st">"Test Result P Ratio"</span>]</span>
<span id="9bcf4777-10"><a href="#9bcf4777-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="9bcf4777-11"><a href="#9bcf4777-11" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="dv">6</span>))</span>
<span id="9bcf4777-12"><a href="#9bcf4777-12" aria-hidden="true" tabindex="-1"></a>barplot <span class="op">=</span> sns.barplot(</span>
<span id="9bcf4777-13"><a href="#9bcf4777-13" aria-hidden="true" tabindex="-1"></a>    y<span class="op">=</span><span class="st">"Model"</span>,  <span class="co"># 'Model' is now on the y-axis</span></span>
<span id="9bcf4777-14"><a href="#9bcf4777-14" aria-hidden="true" tabindex="-1"></a>    x<span class="op">=</span><span class="st">"Test Result P Ratio"</span>,  <span class="co"># 'Test Result P Ratio' is on the x-axis</span></span>
<span id="9bcf4777-15"><a href="#9bcf4777-15" aria-hidden="true" tabindex="-1"></a>    data<span class="op">=</span>model_p_ratio_df,</span>
<span id="9bcf4777-16"><a href="#9bcf4777-16" aria-hidden="true" tabindex="-1"></a>    color<span class="op">=</span><span class="st">"skyblue"</span>,</span>
<span id="9bcf4777-17"><a href="#9bcf4777-17" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="9bcf4777-18"><a href="#9bcf4777-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="9bcf4777-19"><a href="#9bcf4777-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Adding a title and labels</span></span>
<span id="9bcf4777-20"><a href="#9bcf4777-20" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Models with the Highest Ratio of Test Result P (Pass)"</span>)</span>
<span id="9bcf4777-21"><a href="#9bcf4777-21" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"Model"</span>)  <span class="co"># y-axis label is now 'Model'</span></span>
<span id="9bcf4777-22"><a href="#9bcf4777-22" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"Test Result P Ratio"</span>)  <span class="co"># x-axis label is 'Test Result P Ratio'</span></span>
<span id="9bcf4777-23"><a href="#9bcf4777-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="9bcf4777-24"><a href="#9bcf4777-24" aria-hidden="true" tabindex="-1"></a>plt.xticks(rotation<span class="op">=</span><span class="dv">45</span>)</span>
<span id="9bcf4777-25"><a href="#9bcf4777-25" aria-hidden="true" tabindex="-1"></a>plt.yticks(rotation<span class="op">=</span><span class="dv">0</span>)</span>
<span id="9bcf4777-26"><a href="#9bcf4777-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="9bcf4777-27"><a href="#9bcf4777-27" aria-hidden="true" tabindex="-1"></a><span class="co"># Add value labels next to the bars</span></span>
<span id="9bcf4777-28"><a href="#9bcf4777-28" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> p <span class="kw">in</span> barplot.patches:</span>
<span id="9bcf4777-29"><a href="#9bcf4777-29" aria-hidden="true" tabindex="-1"></a>    barplot.annotate(</span>
<span id="9bcf4777-30"><a href="#9bcf4777-30" aria-hidden="true" tabindex="-1"></a>        <span class="bu">format</span>(p.get_width(), <span class="st">".2f"</span>),  <span class="co"># Using get_width() for horizontal bars</span></span>
<span id="9bcf4777-31"><a href="#9bcf4777-31" aria-hidden="true" tabindex="-1"></a>        (</span>
<span id="9bcf4777-32"><a href="#9bcf4777-32" aria-hidden="true" tabindex="-1"></a>            p.get_width(),</span>
<span id="9bcf4777-33"><a href="#9bcf4777-33" aria-hidden="true" tabindex="-1"></a>            p.get_y() <span class="op">+</span> p.get_height() <span class="op">/</span> <span class="fl">2.0</span>,</span>
<span id="9bcf4777-34"><a href="#9bcf4777-34" aria-hidden="true" tabindex="-1"></a>        ),  <span class="co"># Position at the end of the bar</span></span>
<span id="9bcf4777-35"><a href="#9bcf4777-35" aria-hidden="true" tabindex="-1"></a>        ha<span class="op">=</span><span class="st">"left"</span>,</span>
<span id="9bcf4777-36"><a href="#9bcf4777-36" aria-hidden="true" tabindex="-1"></a>        va<span class="op">=</span><span class="st">"center"</span>,  <span class="co"># Align text to the left of the endpoint</span></span>
<span id="9bcf4777-37"><a href="#9bcf4777-37" aria-hidden="true" tabindex="-1"></a>        xytext<span class="op">=</span>(<span class="dv">9</span>, <span class="dv">0</span>),  <span class="co"># Move text to the right a bit</span></span>
<span id="9bcf4777-38"><a href="#9bcf4777-38" aria-hidden="true" tabindex="-1"></a>        textcoords<span class="op">=</span><span class="st">"offset points"</span>,</span>
<span id="9bcf4777-39"><a href="#9bcf4777-39" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="9bcf4777-40"><a href="#9bcf4777-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="9bcf4777-41"><a href="#9bcf4777-41" aria-hidden="true" tabindex="-1"></a>barplot.set_facecolor(<span class="st">"white"</span>)</span>
<span id="9bcf4777-42"><a href="#9bcf4777-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="9bcf4777-43"><a href="#9bcf4777-43" aria-hidden="true" tabindex="-1"></a><span class="co"># Show the plot</span></span>
<span id="9bcf4777-44"><a href="#9bcf4777-44" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><a href="index_files/figure-html/cell-17-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-12"><img src="index_files/figure-html/cell-17-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<p>It could also be interesting to have a look at how the pass ratio is distributed by fuel type.</p>
<div id="b75c7133" class="cell" data-execution_count="18">
<details class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="b75c7133"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="b75c7133-1"><a href="#b75c7133-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate counts and ratios as before, change to grouping by 'make'</span></span>
<span id="b75c7133-2"><a href="#b75c7133-2" aria-hidden="true" tabindex="-1"></a>make_fuel_counts <span class="op">=</span> mot.groupby([<span class="st">"make"</span>, <span class="st">"fuel_type_desc"</span>]).size()</span>
<span id="b75c7133-3"><a href="#b75c7133-3" aria-hidden="true" tabindex="-1"></a>make_p_fuel_counts <span class="op">=</span> (</span>
<span id="b75c7133-4"><a href="#b75c7133-4" aria-hidden="true" tabindex="-1"></a>    mot[mot[<span class="st">"test_result"</span>] <span class="op">==</span> <span class="st">"P"</span>].groupby([<span class="st">"make"</span>, <span class="st">"fuel_type_desc"</span>]).size()</span>
<span id="b75c7133-5"><a href="#b75c7133-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="b75c7133-6"><a href="#b75c7133-6" aria-hidden="true" tabindex="-1"></a>make_p_ratio <span class="op">=</span> make_p_fuel_counts <span class="op">/</span> make_fuel_counts</span>
<span id="b75c7133-7"><a href="#b75c7133-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="b75c7133-8"><a href="#b75c7133-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Resetting the index to turn the multi-index Series into a DataFrame</span></span>
<span id="b75c7133-9"><a href="#b75c7133-9" aria-hidden="true" tabindex="-1"></a>make_p_ratio_df <span class="op">=</span> make_p_ratio.reset_index()</span>
<span id="b75c7133-10"><a href="#b75c7133-10" aria-hidden="true" tabindex="-1"></a>make_p_ratio_df.columns <span class="op">=</span> [<span class="st">"Make"</span>, <span class="st">"Fuel Type"</span>, <span class="st">"Test Result P Ratio"</span>]</span>
<span id="b75c7133-11"><a href="#b75c7133-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="b75c7133-12"><a href="#b75c7133-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a scatter plot</span></span>
<span id="b75c7133-13"><a href="#b75c7133-13" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="dv">6</span>))</span>
<span id="b75c7133-14"><a href="#b75c7133-14" aria-hidden="true" tabindex="-1"></a>scatter_plot <span class="op">=</span> sns.scatterplot(</span>
<span id="b75c7133-15"><a href="#b75c7133-15" aria-hidden="true" tabindex="-1"></a>    x<span class="op">=</span><span class="st">"Fuel Type"</span>,</span>
<span id="b75c7133-16"><a href="#b75c7133-16" aria-hidden="true" tabindex="-1"></a>    y<span class="op">=</span><span class="st">"Test Result P Ratio"</span>,</span>
<span id="b75c7133-17"><a href="#b75c7133-17" aria-hidden="true" tabindex="-1"></a>    hue<span class="op">=</span><span class="st">"Make"</span>,  <span class="co"># Differentiate by make</span></span>
<span id="b75c7133-18"><a href="#b75c7133-18" aria-hidden="true" tabindex="-1"></a>    data<span class="op">=</span>make_p_ratio_df,</span>
<span id="b75c7133-19"><a href="#b75c7133-19" aria-hidden="true" tabindex="-1"></a>    palette<span class="op">=</span><span class="st">"tab20"</span>,  <span class="co"># Color palette</span></span>
<span id="b75c7133-20"><a href="#b75c7133-20" aria-hidden="true" tabindex="-1"></a>    s<span class="op">=</span><span class="dv">100</span>,  <span class="co"># Size of the markers</span></span>
<span id="b75c7133-21"><a href="#b75c7133-21" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="b75c7133-22"><a href="#b75c7133-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="b75c7133-23"><a href="#b75c7133-23" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Scatter Plot of Test Result P Ratios by Make and Fuel Type"</span>)</span>
<span id="b75c7133-24"><a href="#b75c7133-24" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"Fuel Type"</span>)</span>
<span id="b75c7133-25"><a href="#b75c7133-25" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"Test Result P Ratio"</span>)</span>
<span id="b75c7133-26"><a href="#b75c7133-26" aria-hidden="true" tabindex="-1"></a>plt.xticks(rotation<span class="op">=</span><span class="dv">90</span>)  <span class="co"># Rotate x-axis labels for better readability</span></span>
<span id="b75c7133-27"><a href="#b75c7133-27" aria-hidden="true" tabindex="-1"></a>plt.grid(<span class="va">True</span>)  <span class="co"># Add grid for easier visual alignment</span></span>
<span id="b75c7133-28"><a href="#b75c7133-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="b75c7133-29"><a href="#b75c7133-29" aria-hidden="true" tabindex="-1"></a><span class="co"># Moving the legend outside the plot area to the right</span></span>
<span id="b75c7133-30"><a href="#b75c7133-30" aria-hidden="true" tabindex="-1"></a>plt.legend(title<span class="op">=</span><span class="st">"Make"</span>, bbox_to_anchor<span class="op">=</span>(<span class="fl">1.05</span>, <span class="dv">1</span>), loc<span class="op">=</span><span class="st">"upper left"</span>)</span>
<span id="b75c7133-31"><a href="#b75c7133-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="b75c7133-32"><a href="#b75c7133-32" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()  <span class="co"># Adjust the layout to make room for the legend</span></span>
<span id="b75c7133-33"><a href="#b75c7133-33" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><a href="index_files/figure-html/cell-18-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-13"><img src="index_files/figure-html/cell-18-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<p>Electric vehicles display a broad spectrum of pass ratios that differ notably depending on the manufacturer. This contrasts with petrol and diesel cars, which tend to exhibit more consistent pass rates across various makes. The observed disparity in the performance of electric cars suggests underlying differences in technology or quality control among manufacturers, or variability in testing standards. This pattern is intriguing and could provide valuable insights into the reliability and engineering of electric vehicles, making it a worthwhile subject for deeper analysis.</p>
<p>It would also be nice to understand the distribution of test results for each model. Let us try a visualisation which might help - we will facet a scatter plot for each model into a single grid.</p>
<div id="737d96ea" class="cell" data-execution_count="19">
<details class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="737d96ea"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="737d96ea-1"><a href="#737d96ea-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Initialize a FacetGrid object</span></span>
<span id="737d96ea-2"><a href="#737d96ea-2" aria-hidden="true" tabindex="-1"></a>g <span class="op">=</span> sns.FacetGrid(mot, col<span class="op">=</span><span class="st">"model"</span>, col_wrap<span class="op">=</span><span class="dv">5</span>, aspect<span class="op">=</span><span class="fl">1.5</span>)</span>
<span id="737d96ea-3"><a href="#737d96ea-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="737d96ea-4"><a href="#737d96ea-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Map the scatterplot with the Spectral colormap for the 'cylinder_capacity' which affects the color</span></span>
<span id="737d96ea-5"><a href="#737d96ea-5" aria-hidden="true" tabindex="-1"></a>g.map_dataframe(</span>
<span id="737d96ea-6"><a href="#737d96ea-6" aria-hidden="true" tabindex="-1"></a>    sns.scatterplot,</span>
<span id="737d96ea-7"><a href="#737d96ea-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">"age_years"</span>,</span>
<span id="737d96ea-8"><a href="#737d96ea-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">"test_mileage"</span>,</span>
<span id="737d96ea-9"><a href="#737d96ea-9" aria-hidden="true" tabindex="-1"></a>    alpha<span class="op">=</span><span class="fl">0.6</span>,</span>
<span id="737d96ea-10"><a href="#737d96ea-10" aria-hidden="true" tabindex="-1"></a>    palette<span class="op">=</span><span class="st">"tab20"</span>,</span>
<span id="737d96ea-11"><a href="#737d96ea-11" aria-hidden="true" tabindex="-1"></a>    hue<span class="op">=</span><span class="st">"test_result_desc"</span>,</span>
<span id="737d96ea-12"><a href="#737d96ea-12" aria-hidden="true" tabindex="-1"></a>    hue_order<span class="op">=</span>[</span>
<span id="737d96ea-13"><a href="#737d96ea-13" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Passed"</span>,</span>
<span id="737d96ea-14"><a href="#737d96ea-14" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Failed"</span>,</span>
<span id="737d96ea-15"><a href="#737d96ea-15" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Pass with Rectification at Station"</span>,</span>
<span id="737d96ea-16"><a href="#737d96ea-16" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Aborted"</span>,</span>
<span id="737d96ea-17"><a href="#737d96ea-17" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Abandoned"</span>,</span>
<span id="737d96ea-18"><a href="#737d96ea-18" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Aborted by VE"</span>,</span>
<span id="737d96ea-19"><a href="#737d96ea-19" aria-hidden="true" tabindex="-1"></a>    ],</span>
<span id="737d96ea-20"><a href="#737d96ea-20" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="737d96ea-21"><a href="#737d96ea-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="737d96ea-22"><a href="#737d96ea-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Add titles and tweak adjustments</span></span>
<span id="737d96ea-23"><a href="#737d96ea-23" aria-hidden="true" tabindex="-1"></a>g.set_titles(<span class="st">"</span><span class="sc">{col_name}</span><span class="st">"</span>)  <span class="co"># Use model names as titles for each subplot</span></span>
<span id="737d96ea-24"><a href="#737d96ea-24" aria-hidden="true" tabindex="-1"></a>g.set_axis_labels(<span class="st">"Age (Years)"</span>, <span class="st">"Test Mileage"</span>)  <span class="co"># Set common axis labels</span></span>
<span id="737d96ea-25"><a href="#737d96ea-25" aria-hidden="true" tabindex="-1"></a>g.set_xticklabels(rotation<span class="op">=</span><span class="dv">45</span>)</span>
<span id="737d96ea-26"><a href="#737d96ea-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="737d96ea-27"><a href="#737d96ea-27" aria-hidden="true" tabindex="-1"></a><span class="co"># Add a legend and adjust layout</span></span>
<span id="737d96ea-28"><a href="#737d96ea-28" aria-hidden="true" tabindex="-1"></a>g.add_legend(title<span class="op">=</span><span class="st">"Test Result"</span>)</span>
<span id="737d96ea-29"><a href="#737d96ea-29" aria-hidden="true" tabindex="-1"></a>g.tight_layout()</span>
<span id="737d96ea-30"><a href="#737d96ea-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="737d96ea-31"><a href="#737d96ea-31" aria-hidden="true" tabindex="-1"></a><span class="co"># Set the overall title</span></span>
<span id="737d96ea-32"><a href="#737d96ea-32" aria-hidden="true" tabindex="-1"></a>plt.suptitle(<span class="st">"Scatterplot of Test Result by Age, Test Mileage for Each Model"</span>, y<span class="op">=</span><span class="fl">1.02</span>)</span>
<span id="737d96ea-33"><a href="#737d96ea-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="737d96ea-34"><a href="#737d96ea-34" aria-hidden="true" tabindex="-1"></a><span class="co"># Display the plots</span></span>
<span id="737d96ea-35"><a href="#737d96ea-35" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><a href="index_files/figure-html/cell-19-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-14"><img src="index_files/figure-html/cell-19-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<p>This makes for an interesting way to look at the data, even if somewhat complex to interpret visually. However it helps us understand the distribution of test results for each model, and helps paint a narrative of the data. You can think of your own ideas on how to improve this, or take whole different approaches.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
About Effective Data Visualisation
</div>
</div>
<div class="callout-body-container callout-body">
<p>A great book I highly recomment is <a href="https://www.edwardtufte.com/tufte/books_vdqi?gad_source=1&amp;gclid=Cj0KCQjwir2xBhC_ARIsAMTXk86rOtorEShrFpEEtS1Uie2aHGztvlDaQ-Qxl3coQhEr-B8X3IZQsWsaAntIEALw_wcB">“The Visual Display of Quantitative Information”</a> by Edward Tufte. It is a great resource for learning how to visualise data in a way that is both informative and visually appealing.</p>
</div>
</div>
</section>
<section id="understanding-geographic-distribution" class="level2">
<h2 class="anchored" data-anchor-id="understanding-geographic-distribution">Understanding geographic distribution</h2>
<p>It would be interesting to understand the geographic distribution of test results. Let us start by calculating a table which summarises a few key metrics for each postcode area. We will use <code>pgeocode</code> to get the latitude and longitude of each postcode area.</p>
<div id="aa6304f8" class="cell" data-execution_count="20">
<details class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="aa6304f8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="aa6304f8-1"><a href="#aa6304f8-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pgeocode</span>
<span id="aa6304f8-2"><a href="#aa6304f8-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="aa6304f8-3"><a href="#aa6304f8-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="aa6304f8-4"><a href="#aa6304f8-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Ensure you have pgeocode installed</span></span>
<span id="aa6304f8-5"><a href="#aa6304f8-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="aa6304f8-6"><a href="#aa6304f8-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Load your data into the 'mot' DataFrame</span></span>
<span id="aa6304f8-7"><a href="#aa6304f8-7" aria-hidden="true" tabindex="-1"></a><span class="co"># mot = pd.read_csv('path_to_your_data.csv')</span></span>
<span id="aa6304f8-8"><a href="#aa6304f8-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="aa6304f8-9"><a href="#aa6304f8-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Group by postcode_area, count the number of unique vehicle_ids</span></span>
<span id="aa6304f8-10"><a href="#aa6304f8-10" aria-hidden="true" tabindex="-1"></a>postcode_vehicle_counts <span class="op">=</span> mot.groupby(<span class="st">"postcode_area"</span>)[<span class="st">"vehicle_id"</span>].nunique()</span>
<span id="aa6304f8-11"><a href="#aa6304f8-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="aa6304f8-12"><a href="#aa6304f8-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Group by postcode_area, compute the average test_mileage</span></span>
<span id="aa6304f8-13"><a href="#aa6304f8-13" aria-hidden="true" tabindex="-1"></a>postcode_avg_mileage <span class="op">=</span> mot.groupby(<span class="st">"postcode_area"</span>)[<span class="st">"test_mileage"</span>].mean()</span>
<span id="aa6304f8-14"><a href="#aa6304f8-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="aa6304f8-15"><a href="#aa6304f8-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Group by postcode_area, compute the average age_years</span></span>
<span id="aa6304f8-16"><a href="#aa6304f8-16" aria-hidden="true" tabindex="-1"></a>postcode_avg_age <span class="op">=</span> mot.groupby(<span class="st">"postcode_area"</span>)[<span class="st">"age_years"</span>].mean()</span>
<span id="aa6304f8-17"><a href="#aa6304f8-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="aa6304f8-18"><a href="#aa6304f8-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Group by postcode_area, compute the average Pass ratio</span></span>
<span id="aa6304f8-19"><a href="#aa6304f8-19" aria-hidden="true" tabindex="-1"></a>postcode_pass_ratio <span class="op">=</span> (</span>
<span id="aa6304f8-20"><a href="#aa6304f8-20" aria-hidden="true" tabindex="-1"></a>    mot[mot[<span class="st">"test_result"</span>] <span class="op">==</span> <span class="st">"P"</span>].groupby(<span class="st">"postcode_area"</span>).size()</span>
<span id="aa6304f8-21"><a href="#aa6304f8-21" aria-hidden="true" tabindex="-1"></a>    <span class="op">/</span> mot.groupby(<span class="st">"postcode_area"</span>).size()</span>
<span id="aa6304f8-22"><a href="#aa6304f8-22" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="aa6304f8-23"><a href="#aa6304f8-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="aa6304f8-24"><a href="#aa6304f8-24" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge the data into a single DataFrame</span></span>
<span id="aa6304f8-25"><a href="#aa6304f8-25" aria-hidden="true" tabindex="-1"></a>postcode_data <span class="op">=</span> pd.concat(</span>
<span id="aa6304f8-26"><a href="#aa6304f8-26" aria-hidden="true" tabindex="-1"></a>    [</span>
<span id="aa6304f8-27"><a href="#aa6304f8-27" aria-hidden="true" tabindex="-1"></a>        postcode_vehicle_counts,</span>
<span id="aa6304f8-28"><a href="#aa6304f8-28" aria-hidden="true" tabindex="-1"></a>        postcode_avg_mileage,</span>
<span id="aa6304f8-29"><a href="#aa6304f8-29" aria-hidden="true" tabindex="-1"></a>        postcode_avg_age,</span>
<span id="aa6304f8-30"><a href="#aa6304f8-30" aria-hidden="true" tabindex="-1"></a>        postcode_pass_ratio,</span>
<span id="aa6304f8-31"><a href="#aa6304f8-31" aria-hidden="true" tabindex="-1"></a>    ],</span>
<span id="aa6304f8-32"><a href="#aa6304f8-32" aria-hidden="true" tabindex="-1"></a>    axis<span class="op">=</span><span class="dv">1</span>,</span>
<span id="aa6304f8-33"><a href="#aa6304f8-33" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="aa6304f8-34"><a href="#aa6304f8-34" aria-hidden="true" tabindex="-1"></a>postcode_data.columns <span class="op">=</span> [</span>
<span id="aa6304f8-35"><a href="#aa6304f8-35" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Vehicle Count"</span>,</span>
<span id="aa6304f8-36"><a href="#aa6304f8-36" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Average Mileage"</span>,</span>
<span id="aa6304f8-37"><a href="#aa6304f8-37" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Average Age"</span>,</span>
<span id="aa6304f8-38"><a href="#aa6304f8-38" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Pass Ratio"</span>,</span>
<span id="aa6304f8-39"><a href="#aa6304f8-39" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="aa6304f8-40"><a href="#aa6304f8-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="aa6304f8-41"><a href="#aa6304f8-41" aria-hidden="true" tabindex="-1"></a><span class="co"># Initialize the GeoData object for the United Kingdom ('GB' for Great Britain)</span></span>
<span id="aa6304f8-42"><a href="#aa6304f8-42" aria-hidden="true" tabindex="-1"></a>nomi <span class="op">=</span> pgeocode.Nominatim(<span class="st">"gb"</span>)</span>
<span id="aa6304f8-43"><a href="#aa6304f8-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="aa6304f8-44"><a href="#aa6304f8-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="aa6304f8-45"><a href="#aa6304f8-45" aria-hidden="true" tabindex="-1"></a><span class="co"># Define a function to find valid latitude and longitude</span></span>
<span id="aa6304f8-46"><a href="#aa6304f8-46" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_valid_lat_lon(postcode_area):</span>
<span id="aa6304f8-47"><a href="#aa6304f8-47" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Try appending numbers 1 through 9 to the postcode area</span></span>
<span id="aa6304f8-48"><a href="#aa6304f8-48" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>, <span class="dv">99</span>):</span>
<span id="aa6304f8-49"><a href="#aa6304f8-49" aria-hidden="true" tabindex="-1"></a>        postcode <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>postcode_area<span class="sc">}{</span>i<span class="sc">}</span><span class="ss">"</span></span>
<span id="aa6304f8-50"><a href="#aa6304f8-50" aria-hidden="true" tabindex="-1"></a>        location <span class="op">=</span> nomi.query_postal_code(postcode)</span>
<span id="aa6304f8-51"><a href="#aa6304f8-51" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> np.isnan(location.latitude) <span class="kw">and</span> <span class="kw">not</span> np.isnan(location.longitude):</span>
<span id="aa6304f8-52"><a href="#aa6304f8-52" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> pd.Series([location.latitude, location.longitude])</span>
<span id="aa6304f8-53"><a href="#aa6304f8-53" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> pd.Series([np.nan, np.nan])</span>
<span id="aa6304f8-54"><a href="#aa6304f8-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="aa6304f8-55"><a href="#aa6304f8-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="aa6304f8-56"><a href="#aa6304f8-56" aria-hidden="true" tabindex="-1"></a><span class="co"># Apply the function to get latitudes and longitudes</span></span>
<span id="aa6304f8-57"><a href="#aa6304f8-57" aria-hidden="true" tabindex="-1"></a>postcode_data[[<span class="st">"Latitude"</span>, <span class="st">"Longitude"</span>]] <span class="op">=</span> postcode_data.index.to_series().<span class="bu">apply</span>(</span>
<span id="aa6304f8-58"><a href="#aa6304f8-58" aria-hidden="true" tabindex="-1"></a>    get_valid_lat_lon</span>
<span id="aa6304f8-59"><a href="#aa6304f8-59" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="aa6304f8-60"><a href="#aa6304f8-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="aa6304f8-61"><a href="#aa6304f8-61" aria-hidden="true" tabindex="-1"></a><span class="co"># Display the final DataFrame</span></span>
<span id="aa6304f8-62"><a href="#aa6304f8-62" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(postcode_data.head())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>               Vehicle Count  Average Mileage  Average Age  Pass Ratio  \
postcode_area                                                            
AB                     76551     65822.427711     9.366910    0.624138   
AL                     47749     70320.249599    10.638602    0.704644   
B                     335520     82220.577839    11.066041    0.707201   
BA                     90103     83215.718267    11.618009    0.623438   
BB                     91469     84170.459654    10.723622    0.705521   

                Latitude  Longitude  
postcode_area                        
AB             57.143700  -2.098100  
AL             51.750000  -0.333300  
B              52.481400  -1.899800  
BA             51.398462  -2.361469  
BB             53.773367  -2.463333  </code></pre>
</div>
</div>
<p>Let us visualise this data per latitude and longitude, using a scatter plot, which should give us a rough aproximation of a map.</p>
<div id="64dd54cd" class="cell" data-execution_count="21">
<details class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="64dd54cd"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="64dd54cd-1"><a href="#64dd54cd-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.colors <span class="im">as</span> mcolors</span>
<span id="64dd54cd-2"><a href="#64dd54cd-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="64dd54cd-3"><a href="#64dd54cd-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Define the figure and axes</span></span>
<span id="64dd54cd-4"><a href="#64dd54cd-4" aria-hidden="true" tabindex="-1"></a>fig, axs <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">3</span>, figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="dv">4</span>))  <span class="co"># Three plots in one row</span></span>
<span id="64dd54cd-5"><a href="#64dd54cd-5" aria-hidden="true" tabindex="-1"></a>fig.suptitle(</span>
<span id="64dd54cd-6"><a href="#64dd54cd-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Geographical Distribution of Postal Data Metrics with Vehicle Count as Size"</span></span>
<span id="64dd54cd-7"><a href="#64dd54cd-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="64dd54cd-8"><a href="#64dd54cd-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="64dd54cd-9"><a href="#64dd54cd-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Set up individual color maps and normalization</span></span>
<span id="64dd54cd-10"><a href="#64dd54cd-10" aria-hidden="true" tabindex="-1"></a>norms <span class="op">=</span> {</span>
<span id="64dd54cd-11"><a href="#64dd54cd-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Average Mileage"</span>: mcolors.Normalize(</span>
<span id="64dd54cd-12"><a href="#64dd54cd-12" aria-hidden="true" tabindex="-1"></a>        vmin<span class="op">=</span>postcode_data[<span class="st">"Average Mileage"</span>].<span class="bu">min</span>(),</span>
<span id="64dd54cd-13"><a href="#64dd54cd-13" aria-hidden="true" tabindex="-1"></a>        vmax<span class="op">=</span>postcode_data[<span class="st">"Average Mileage"</span>].<span class="bu">max</span>(),</span>
<span id="64dd54cd-14"><a href="#64dd54cd-14" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="64dd54cd-15"><a href="#64dd54cd-15" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Average Age"</span>: mcolors.Normalize(</span>
<span id="64dd54cd-16"><a href="#64dd54cd-16" aria-hidden="true" tabindex="-1"></a>        vmin<span class="op">=</span>postcode_data[<span class="st">"Average Age"</span>].<span class="bu">min</span>(), vmax<span class="op">=</span>postcode_data[<span class="st">"Average Age"</span>].<span class="bu">max</span>()</span>
<span id="64dd54cd-17"><a href="#64dd54cd-17" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="64dd54cd-18"><a href="#64dd54cd-18" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Pass Ratio"</span>: mcolors.Normalize(</span>
<span id="64dd54cd-19"><a href="#64dd54cd-19" aria-hidden="true" tabindex="-1"></a>        vmin<span class="op">=</span>postcode_data[<span class="st">"Pass Ratio"</span>].<span class="bu">min</span>(), vmax<span class="op">=</span>postcode_data[<span class="st">"Pass Ratio"</span>].<span class="bu">max</span>()</span>
<span id="64dd54cd-20"><a href="#64dd54cd-20" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="64dd54cd-21"><a href="#64dd54cd-21" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="64dd54cd-22"><a href="#64dd54cd-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="64dd54cd-23"><a href="#64dd54cd-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Normalize vehicle counts for bubble sizes</span></span>
<span id="64dd54cd-24"><a href="#64dd54cd-24" aria-hidden="true" tabindex="-1"></a><span class="co"># Using a scale factor to adjust the sizes to a visually pleasing range</span></span>
<span id="64dd54cd-25"><a href="#64dd54cd-25" aria-hidden="true" tabindex="-1"></a>vehicle_count_scaled <span class="op">=</span> (</span>
<span id="64dd54cd-26"><a href="#64dd54cd-26" aria-hidden="true" tabindex="-1"></a>    postcode_data[<span class="st">"Vehicle Count"</span>] <span class="op">/</span> postcode_data[<span class="st">"Vehicle Count"</span>].<span class="bu">max</span>() <span class="op">*</span> <span class="dv">1000</span></span>
<span id="64dd54cd-27"><a href="#64dd54cd-27" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="64dd54cd-28"><a href="#64dd54cd-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="64dd54cd-29"><a href="#64dd54cd-29" aria-hidden="true" tabindex="-1"></a>metrics <span class="op">=</span> [<span class="st">"Average Mileage"</span>, <span class="st">"Average Age"</span>, <span class="st">"Pass Ratio"</span>]</span>
<span id="64dd54cd-30"><a href="#64dd54cd-30" aria-hidden="true" tabindex="-1"></a>titles <span class="op">=</span> [<span class="st">"Average Mileage"</span>, <span class="st">"Average Age"</span>, <span class="st">"Pass Ratio"</span>]</span>
<span id="64dd54cd-31"><a href="#64dd54cd-31" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i, ax <span class="kw">in</span> <span class="bu">enumerate</span>(axs):</span>
<span id="64dd54cd-32"><a href="#64dd54cd-32" aria-hidden="true" tabindex="-1"></a>    sc <span class="op">=</span> ax.scatter(</span>
<span id="64dd54cd-33"><a href="#64dd54cd-33" aria-hidden="true" tabindex="-1"></a>        postcode_data[<span class="st">"Longitude"</span>],</span>
<span id="64dd54cd-34"><a href="#64dd54cd-34" aria-hidden="true" tabindex="-1"></a>        postcode_data[<span class="st">"Latitude"</span>],</span>
<span id="64dd54cd-35"><a href="#64dd54cd-35" aria-hidden="true" tabindex="-1"></a>        s<span class="op">=</span>vehicle_count_scaled,  <span class="co"># Bubble size based on vehicle count</span></span>
<span id="64dd54cd-36"><a href="#64dd54cd-36" aria-hidden="true" tabindex="-1"></a>        c<span class="op">=</span>postcode_data[metrics[i]],</span>
<span id="64dd54cd-37"><a href="#64dd54cd-37" aria-hidden="true" tabindex="-1"></a>        norm<span class="op">=</span>norms[metrics[i]],</span>
<span id="64dd54cd-38"><a href="#64dd54cd-38" aria-hidden="true" tabindex="-1"></a>        cmap<span class="op">=</span><span class="st">"Spectral_r"</span>,</span>
<span id="64dd54cd-39"><a href="#64dd54cd-39" aria-hidden="true" tabindex="-1"></a>        alpha<span class="op">=</span><span class="fl">0.6</span>,</span>
<span id="64dd54cd-40"><a href="#64dd54cd-40" aria-hidden="true" tabindex="-1"></a>        edgecolor<span class="op">=</span><span class="st">"k"</span>,</span>
<span id="64dd54cd-41"><a href="#64dd54cd-41" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="64dd54cd-42"><a href="#64dd54cd-42" aria-hidden="true" tabindex="-1"></a>    ax.set_title(titles[i])</span>
<span id="64dd54cd-43"><a href="#64dd54cd-43" aria-hidden="true" tabindex="-1"></a>    ax.set_xlabel(<span class="st">"Longitude"</span>)</span>
<span id="64dd54cd-44"><a href="#64dd54cd-44" aria-hidden="true" tabindex="-1"></a>    ax.set_ylabel(<span class="st">"Latitude"</span>)</span>
<span id="64dd54cd-45"><a href="#64dd54cd-45" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create a colorbar for each subplot</span></span>
<span id="64dd54cd-46"><a href="#64dd54cd-46" aria-hidden="true" tabindex="-1"></a>    fig.colorbar(sc, ax<span class="op">=</span>ax, orientation<span class="op">=</span><span class="st">"vertical"</span>)</span>
<span id="64dd54cd-47"><a href="#64dd54cd-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="64dd54cd-48"><a href="#64dd54cd-48" aria-hidden="true" tabindex="-1"></a><span class="co"># Randomly select 25 postcode areas to label</span></span>
<span id="64dd54cd-49"><a href="#64dd54cd-49" aria-hidden="true" tabindex="-1"></a>random_postcodes <span class="op">=</span> np.random.choice(postcode_data.index, size<span class="op">=</span><span class="dv">25</span>, replace<span class="op">=</span><span class="va">False</span>)</span>
<span id="64dd54cd-50"><a href="#64dd54cd-50" aria-hidden="true" tabindex="-1"></a><span class="co"># Add labels for randomly selected postcodes</span></span>
<span id="64dd54cd-51"><a href="#64dd54cd-51" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i, ax <span class="kw">in</span> <span class="bu">enumerate</span>(axs):</span>
<span id="64dd54cd-52"><a href="#64dd54cd-52" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> postcode <span class="kw">in</span> random_postcodes:</span>
<span id="64dd54cd-53"><a href="#64dd54cd-53" aria-hidden="true" tabindex="-1"></a>        x, y <span class="op">=</span> (</span>
<span id="64dd54cd-54"><a href="#64dd54cd-54" aria-hidden="true" tabindex="-1"></a>            postcode_data.loc[postcode, <span class="st">"Longitude"</span>],</span>
<span id="64dd54cd-55"><a href="#64dd54cd-55" aria-hidden="true" tabindex="-1"></a>            postcode_data.loc[postcode, <span class="st">"Latitude"</span>],</span>
<span id="64dd54cd-56"><a href="#64dd54cd-56" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="64dd54cd-57"><a href="#64dd54cd-57" aria-hidden="true" tabindex="-1"></a>        ax.text(x, y, postcode, fontsize<span class="op">=</span><span class="dv">9</span>, ha<span class="op">=</span><span class="st">"right"</span>)</span>
<span id="64dd54cd-58"><a href="#64dd54cd-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="64dd54cd-59"><a href="#64dd54cd-59" aria-hidden="true" tabindex="-1"></a><span class="co"># Adjust layout to prevent overlap</span></span>
<span id="64dd54cd-60"><a href="#64dd54cd-60" aria-hidden="true" tabindex="-1"></a>plt.tight_layout(</span>
<span id="64dd54cd-61"><a href="#64dd54cd-61" aria-hidden="true" tabindex="-1"></a>    rect<span class="op">=</span>[<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="fl">0.95</span>]</span>
<span id="64dd54cd-62"><a href="#64dd54cd-62" aria-hidden="true" tabindex="-1"></a>)  <span class="co"># Adjust the rect to leave space for the main title</span></span>
<span id="64dd54cd-63"><a href="#64dd54cd-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="64dd54cd-64"><a href="#64dd54cd-64" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><a href="index_files/figure-html/cell-21-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-15"><img src="index_files/figure-html/cell-21-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<p>Can you see the rough shape of the UK in the scatter plot? This is a very simple way to visualise geographic data, and it is quite effective for a quick analysis. We can see that most of the data is concentrated in the south of the UK, which is expected as this is the most populated area.</p>
<p>Looking at the scatter plots, we can derive a few insights based on the geographical distribution of vehicle data across the UK:</p>
<p><strong>Average Mileage</strong>: The distribution suggests that vehicles in the northern regions generally have higher mileage, indicated by the larger, more intense colored circles in the north compared to the south. This might suggest longer commutes or more frequent use of vehicles in these areas.</p>
<p><strong>Average Age</strong>: There’s a clear gradient of vehicle age from north to south. The northern parts display younger vehicle ages (smaller, lighter colored circles), while the southern regions have older vehicles (larger, darker colored circles). This might indicate economic variations or preferences for newer vehicles in the north.</p>
<p><strong>Pass Ratio</strong>: The pass ratio varies significantly across different regions. The southeast appears to have higher pass ratios (darker circles), which may correlate with better vehicle maintenance or newer cars in these areas. Conversely, some northern areas show lower pass ratios (lighter circles), possibly due to the older vehicle age or higher usage affecting vehicle conditions.</p>
<p>These observations hint at regional differences in vehicle usage, maintenance, and age which could be driven by socioeconomic factors, infrastructure, or regional policies. This geographic visualization effectively highlights how vehicle conditions and usage can vary within a country, prompting further investigation into the causes behind these patterns.</p>
<p>Let us now try a similar plot, but focusing on the top/bottom postcode areas for each metric, to highlight the extremes.</p>
<div id="10873c8f" class="cell" data-execution_count="22">
<details class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="10873c8f"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="10873c8f-1"><a href="#10873c8f-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Define the figure and axes</span></span>
<span id="10873c8f-2"><a href="#10873c8f-2" aria-hidden="true" tabindex="-1"></a>fig, axs <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">3</span>, figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="dv">4</span>))  <span class="co"># Three plots in one row</span></span>
<span id="10873c8f-3"><a href="#10873c8f-3" aria-hidden="true" tabindex="-1"></a>fig.suptitle(<span class="st">"Highlighting Top and Bottom 7 Postcode Areas by Metric"</span>)</span>
<span id="10873c8f-4"><a href="#10873c8f-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="10873c8f-5"><a href="#10873c8f-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Set up individual color maps and normalization</span></span>
<span id="10873c8f-6"><a href="#10873c8f-6" aria-hidden="true" tabindex="-1"></a>norms <span class="op">=</span> {</span>
<span id="10873c8f-7"><a href="#10873c8f-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Average Mileage"</span>: mcolors.Normalize(</span>
<span id="10873c8f-8"><a href="#10873c8f-8" aria-hidden="true" tabindex="-1"></a>        vmin<span class="op">=</span>postcode_data[<span class="st">"Average Mileage"</span>].<span class="bu">min</span>(),</span>
<span id="10873c8f-9"><a href="#10873c8f-9" aria-hidden="true" tabindex="-1"></a>        vmax<span class="op">=</span>postcode_data[<span class="st">"Average Mileage"</span>].<span class="bu">max</span>(),</span>
<span id="10873c8f-10"><a href="#10873c8f-10" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="10873c8f-11"><a href="#10873c8f-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Average Age"</span>: mcolors.Normalize(</span>
<span id="10873c8f-12"><a href="#10873c8f-12" aria-hidden="true" tabindex="-1"></a>        vmin<span class="op">=</span>postcode_data[<span class="st">"Average Age"</span>].<span class="bu">min</span>(), vmax<span class="op">=</span>postcode_data[<span class="st">"Average Age"</span>].<span class="bu">max</span>()</span>
<span id="10873c8f-13"><a href="#10873c8f-13" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="10873c8f-14"><a href="#10873c8f-14" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Pass Ratio"</span>: mcolors.Normalize(</span>
<span id="10873c8f-15"><a href="#10873c8f-15" aria-hidden="true" tabindex="-1"></a>        vmin<span class="op">=</span>postcode_data[<span class="st">"Pass Ratio"</span>].<span class="bu">min</span>(), vmax<span class="op">=</span>postcode_data[<span class="st">"Pass Ratio"</span>].<span class="bu">max</span>()</span>
<span id="10873c8f-16"><a href="#10873c8f-16" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="10873c8f-17"><a href="#10873c8f-17" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="10873c8f-18"><a href="#10873c8f-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="10873c8f-19"><a href="#10873c8f-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Normalize vehicle counts for bubble sizes</span></span>
<span id="10873c8f-20"><a href="#10873c8f-20" aria-hidden="true" tabindex="-1"></a>vehicle_count_scaled <span class="op">=</span> (</span>
<span id="10873c8f-21"><a href="#10873c8f-21" aria-hidden="true" tabindex="-1"></a>    postcode_data[<span class="st">"Vehicle Count"</span>] <span class="op">/</span> postcode_data[<span class="st">"Vehicle Count"</span>].<span class="bu">max</span>() <span class="op">*</span> <span class="dv">1000</span></span>
<span id="10873c8f-22"><a href="#10873c8f-22" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="10873c8f-23"><a href="#10873c8f-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="10873c8f-24"><a href="#10873c8f-24" aria-hidden="true" tabindex="-1"></a><span class="co"># Determine top and bottom 7 postcodes for each metric</span></span>
<span id="10873c8f-25"><a href="#10873c8f-25" aria-hidden="true" tabindex="-1"></a>top_bottom_7 <span class="op">=</span> {</span>
<span id="10873c8f-26"><a href="#10873c8f-26" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Average Mileage"</span>: postcode_data[<span class="st">"Average Mileage"</span>]</span>
<span id="10873c8f-27"><a href="#10873c8f-27" aria-hidden="true" tabindex="-1"></a>    .nlargest(<span class="dv">7</span>)</span>
<span id="10873c8f-28"><a href="#10873c8f-28" aria-hidden="true" tabindex="-1"></a>    .index.union(postcode_data[<span class="st">"Average Mileage"</span>].nsmallest(<span class="dv">7</span>).index),</span>
<span id="10873c8f-29"><a href="#10873c8f-29" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Average Age"</span>: postcode_data[<span class="st">"Average Age"</span>]</span>
<span id="10873c8f-30"><a href="#10873c8f-30" aria-hidden="true" tabindex="-1"></a>    .nlargest(<span class="dv">7</span>)</span>
<span id="10873c8f-31"><a href="#10873c8f-31" aria-hidden="true" tabindex="-1"></a>    .index.union(postcode_data[<span class="st">"Average Age"</span>].nsmallest(<span class="dv">7</span>).index),</span>
<span id="10873c8f-32"><a href="#10873c8f-32" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Pass Ratio"</span>: postcode_data[<span class="st">"Pass Ratio"</span>]</span>
<span id="10873c8f-33"><a href="#10873c8f-33" aria-hidden="true" tabindex="-1"></a>    .nlargest(<span class="dv">7</span>)</span>
<span id="10873c8f-34"><a href="#10873c8f-34" aria-hidden="true" tabindex="-1"></a>    .index.union(postcode_data[<span class="st">"Pass Ratio"</span>].nsmallest(<span class="dv">7</span>).index),</span>
<span id="10873c8f-35"><a href="#10873c8f-35" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="10873c8f-36"><a href="#10873c8f-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="10873c8f-37"><a href="#10873c8f-37" aria-hidden="true" tabindex="-1"></a>metrics <span class="op">=</span> [<span class="st">"Average Mileage"</span>, <span class="st">"Average Age"</span>, <span class="st">"Pass Ratio"</span>]</span>
<span id="10873c8f-38"><a href="#10873c8f-38" aria-hidden="true" tabindex="-1"></a>titles <span class="op">=</span> [<span class="st">"Average Mileage"</span>, <span class="st">"Average Age"</span>, <span class="st">"Pass Ratio"</span>]</span>
<span id="10873c8f-39"><a href="#10873c8f-39" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i, ax <span class="kw">in</span> <span class="bu">enumerate</span>(axs):</span>
<span id="10873c8f-40"><a href="#10873c8f-40" aria-hidden="true" tabindex="-1"></a>    <span class="co"># All postcodes with lower alpha</span></span>
<span id="10873c8f-41"><a href="#10873c8f-41" aria-hidden="true" tabindex="-1"></a>    ax.scatter(</span>
<span id="10873c8f-42"><a href="#10873c8f-42" aria-hidden="true" tabindex="-1"></a>        postcode_data[<span class="st">"Longitude"</span>],</span>
<span id="10873c8f-43"><a href="#10873c8f-43" aria-hidden="true" tabindex="-1"></a>        postcode_data[<span class="st">"Latitude"</span>],</span>
<span id="10873c8f-44"><a href="#10873c8f-44" aria-hidden="true" tabindex="-1"></a>        s<span class="op">=</span>vehicle_count_scaled,</span>
<span id="10873c8f-45"><a href="#10873c8f-45" aria-hidden="true" tabindex="-1"></a>        c<span class="op">=</span>postcode_data[metrics[i]],</span>
<span id="10873c8f-46"><a href="#10873c8f-46" aria-hidden="true" tabindex="-1"></a>        alpha<span class="op">=</span><span class="fl">0.2</span>,</span>
<span id="10873c8f-47"><a href="#10873c8f-47" aria-hidden="true" tabindex="-1"></a>        cmap<span class="op">=</span><span class="st">"Spectral_r"</span>,</span>
<span id="10873c8f-48"><a href="#10873c8f-48" aria-hidden="true" tabindex="-1"></a>        norm<span class="op">=</span>norms[metrics[i]],</span>
<span id="10873c8f-49"><a href="#10873c8f-49" aria-hidden="true" tabindex="-1"></a>        edgecolor<span class="op">=</span><span class="st">"k"</span>,</span>
<span id="10873c8f-50"><a href="#10873c8f-50" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="10873c8f-51"><a href="#10873c8f-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="10873c8f-52"><a href="#10873c8f-52" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Highlight top and bottom 7 postcodes with higher alpha</span></span>
<span id="10873c8f-53"><a href="#10873c8f-53" aria-hidden="true" tabindex="-1"></a>    highlight_data <span class="op">=</span> postcode_data.loc[top_bottom_7[metrics[i]]]</span>
<span id="10873c8f-54"><a href="#10873c8f-54" aria-hidden="true" tabindex="-1"></a>    ax.scatter(</span>
<span id="10873c8f-55"><a href="#10873c8f-55" aria-hidden="true" tabindex="-1"></a>        highlight_data[<span class="st">"Longitude"</span>],</span>
<span id="10873c8f-56"><a href="#10873c8f-56" aria-hidden="true" tabindex="-1"></a>        highlight_data[<span class="st">"Latitude"</span>],</span>
<span id="10873c8f-57"><a href="#10873c8f-57" aria-hidden="true" tabindex="-1"></a>        s<span class="op">=</span>vehicle_count_scaled.loc[top_bottom_7[metrics[i]]],</span>
<span id="10873c8f-58"><a href="#10873c8f-58" aria-hidden="true" tabindex="-1"></a>        c<span class="op">=</span>highlight_data[metrics[i]],</span>
<span id="10873c8f-59"><a href="#10873c8f-59" aria-hidden="true" tabindex="-1"></a>        alpha<span class="op">=</span><span class="fl">0.8</span>,</span>
<span id="10873c8f-60"><a href="#10873c8f-60" aria-hidden="true" tabindex="-1"></a>        cmap<span class="op">=</span><span class="st">"Spectral_r"</span>,</span>
<span id="10873c8f-61"><a href="#10873c8f-61" aria-hidden="true" tabindex="-1"></a>        norm<span class="op">=</span>norms[metrics[i]],</span>
<span id="10873c8f-62"><a href="#10873c8f-62" aria-hidden="true" tabindex="-1"></a>        edgecolor<span class="op">=</span><span class="st">"k"</span>,</span>
<span id="10873c8f-63"><a href="#10873c8f-63" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="10873c8f-64"><a href="#10873c8f-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="10873c8f-65"><a href="#10873c8f-65" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Annotate top and bottom 7 postcodes, ensuring coordinates are finite</span></span>
<span id="10873c8f-66"><a href="#10873c8f-66" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> postcode <span class="kw">in</span> top_bottom_7[metrics[i]]:</span>
<span id="10873c8f-67"><a href="#10873c8f-67" aria-hidden="true" tabindex="-1"></a>        x <span class="op">=</span> postcode_data.loc[postcode, <span class="st">"Longitude"</span>]</span>
<span id="10873c8f-68"><a href="#10873c8f-68" aria-hidden="true" tabindex="-1"></a>        y <span class="op">=</span> postcode_data.loc[postcode, <span class="st">"Latitude"</span>]</span>
<span id="10873c8f-69"><a href="#10873c8f-69" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> np.isfinite(x) <span class="kw">and</span> np.isfinite(y):</span>
<span id="10873c8f-70"><a href="#10873c8f-70" aria-hidden="true" tabindex="-1"></a>            ax.text(x, y, postcode, fontsize<span class="op">=</span><span class="dv">8</span>, ha<span class="op">=</span><span class="st">"right"</span>, color<span class="op">=</span><span class="st">"black"</span>)</span>
<span id="10873c8f-71"><a href="#10873c8f-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="10873c8f-72"><a href="#10873c8f-72" aria-hidden="true" tabindex="-1"></a>    ax.set_title(titles[i])</span>
<span id="10873c8f-73"><a href="#10873c8f-73" aria-hidden="true" tabindex="-1"></a>    ax.set_xlabel(<span class="st">"Longitude"</span>)</span>
<span id="10873c8f-74"><a href="#10873c8f-74" aria-hidden="true" tabindex="-1"></a>    ax.set_ylabel(<span class="st">"Latitude"</span>)</span>
<span id="10873c8f-75"><a href="#10873c8f-75" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create a colorbar for each subplot</span></span>
<span id="10873c8f-76"><a href="#10873c8f-76" aria-hidden="true" tabindex="-1"></a>    fig.colorbar(</span>
<span id="10873c8f-77"><a href="#10873c8f-77" aria-hidden="true" tabindex="-1"></a>        plt.cm.ScalarMappable(norm<span class="op">=</span>norms[metrics[i]], cmap<span class="op">=</span><span class="st">"Spectral_r"</span>),</span>
<span id="10873c8f-78"><a href="#10873c8f-78" aria-hidden="true" tabindex="-1"></a>        ax<span class="op">=</span>ax,</span>
<span id="10873c8f-79"><a href="#10873c8f-79" aria-hidden="true" tabindex="-1"></a>        orientation<span class="op">=</span><span class="st">"vertical"</span>,</span>
<span id="10873c8f-80"><a href="#10873c8f-80" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="10873c8f-81"><a href="#10873c8f-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="10873c8f-82"><a href="#10873c8f-82" aria-hidden="true" tabindex="-1"></a><span class="co"># Adjust layout to prevent overlap</span></span>
<span id="10873c8f-83"><a href="#10873c8f-83" aria-hidden="true" tabindex="-1"></a>plt.tight_layout(</span>
<span id="10873c8f-84"><a href="#10873c8f-84" aria-hidden="true" tabindex="-1"></a>    rect<span class="op">=</span>[<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="fl">0.95</span>]</span>
<span id="10873c8f-85"><a href="#10873c8f-85" aria-hidden="true" tabindex="-1"></a>)  <span class="co"># Adjust the rect to leave space for the main title</span></span>
<span id="10873c8f-86"><a href="#10873c8f-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="10873c8f-87"><a href="#10873c8f-87" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><a href="index_files/figure-html/cell-22-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-16"><img src="index_files/figure-html/cell-22-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
</section>
<section id="developing-a-classification-model" class="level2">
<h2 class="anchored" data-anchor-id="developing-a-classification-model">Developing a classification model</h2>
<p>Let us now develop a classification model to predict the likely test result of a car based on some of its features. You might have noticed above that there is a wide disparity in the number of tests for different makes and models, as well as the test results. To ensure we have a true representation of the original distribution, we will perform stratified sampling to ensure we have a balanced dataset.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
About Stratified Sampling
</div>
</div>
<div class="callout-body-container callout-body">
<p>Stratified sampling is a statistical method used to ensure that specific subgroups within a dataset are adequately represented when taking a sample. This approach involves dividing the entire population into different subgroups known as strata, which are based on shared characteristics. Once the population is divided, a sample is drawn from each stratum.</p>
<p>The main reason for using stratified sampling is to capture the population heterogeneity in the sample. For example, if you were conducting a survey on a population consisting of both males and females and you know that their responses might vary significantly based on gender, stratified sampling allows you to ensure that both genders are properly represented in the sample according to their proportion in the full population. This method enhances the accuracy of the results since each subgroup is proportionally represented, and it also increases the overall efficiency of the sampling process because it can require fewer resources to achieve more precise results.</p>
<p>Stratified sampling is especially valuable when analysts need to ensure that smaller but important subgroups within the population are not overlooked. By ensuring that these subgroups are adequately sampled, researchers can draw more accurate and generalizable conclusions from their data analysis. This makes stratified sampling a preferred method in fields where precision in population representation is crucial, such as in medical research, market research, and social science studies.</p>
</div>
</div>
<p>We will sample on the <code>test_result_desc</code> column, as this is the target variable we are trying to predict.</p>
<div id="eb765eab" class="cell" data-execution_count="23">
<details class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="eb765eab"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="eb765eab-1"><a href="#eb765eab-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.model_selection <span class="im">import</span> train_test_split</span>
<span id="eb765eab-2"><a href="#eb765eab-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.utils <span class="im">import</span> resample</span>
<span id="eb765eab-3"><a href="#eb765eab-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="eb765eab-4"><a href="#eb765eab-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="eb765eab-5"><a href="#eb765eab-5" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> stratified_sample(data, column, fraction):</span>
<span id="eb765eab-6"><a href="#eb765eab-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Use train_test_split to perform the stratified sampling</span></span>
<span id="eb765eab-7"><a href="#eb765eab-7" aria-hidden="true" tabindex="-1"></a>    _, sampled <span class="op">=</span> train_test_split(</span>
<span id="eb765eab-8"><a href="#eb765eab-8" aria-hidden="true" tabindex="-1"></a>        data,</span>
<span id="eb765eab-9"><a href="#eb765eab-9" aria-hidden="true" tabindex="-1"></a>        test_size<span class="op">=</span>fraction,</span>
<span id="eb765eab-10"><a href="#eb765eab-10" aria-hidden="true" tabindex="-1"></a>        stratify<span class="op">=</span>data[column],  <span class="co"># Stratify by the column to keep the distribution</span></span>
<span id="eb765eab-11"><a href="#eb765eab-11" aria-hidden="true" tabindex="-1"></a>        random_state<span class="op">=</span><span class="dv">42</span>,  <span class="co"># For reproducibility</span></span>
<span id="eb765eab-12"><a href="#eb765eab-12" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="eb765eab-13"><a href="#eb765eab-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="eb765eab-14"><a href="#eb765eab-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Drop any categories with less than 100 samples</span></span>
<span id="eb765eab-15"><a href="#eb765eab-15" aria-hidden="true" tabindex="-1"></a>    sampled <span class="op">=</span> sampled.groupby(column).<span class="bu">filter</span>(<span class="kw">lambda</span> x: <span class="bu">len</span>(x) <span class="op">&gt;</span> <span class="dv">100</span>)</span>
<span id="eb765eab-16"><a href="#eb765eab-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="eb765eab-17"><a href="#eb765eab-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> sampled</span>
<span id="eb765eab-18"><a href="#eb765eab-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="eb765eab-19"><a href="#eb765eab-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="eb765eab-20"><a href="#eb765eab-20" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> balanced_sample(data, column, fraction):</span>
<span id="eb765eab-21"><a href="#eb765eab-21" aria-hidden="true" tabindex="-1"></a>    total_samples <span class="op">=</span> <span class="bu">int</span>(<span class="bu">len</span>(data) <span class="op">*</span> fraction)</span>
<span id="eb765eab-22"><a href="#eb765eab-22" aria-hidden="true" tabindex="-1"></a>    num_classes <span class="op">=</span> data[column].nunique()</span>
<span id="eb765eab-23"><a href="#eb765eab-23" aria-hidden="true" tabindex="-1"></a>    target_size_per_class <span class="op">=</span> <span class="bu">int</span>(total_samples <span class="op">/</span> num_classes)</span>
<span id="eb765eab-24"><a href="#eb765eab-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="eb765eab-25"><a href="#eb765eab-25" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Find the maximum size of any class</span></span>
<span id="eb765eab-26"><a href="#eb765eab-26" aria-hidden="true" tabindex="-1"></a>    max_class_size <span class="op">=</span> data[column].value_counts().<span class="bu">max</span>()</span>
<span id="eb765eab-27"><a href="#eb765eab-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="eb765eab-28"><a href="#eb765eab-28" aria-hidden="true" tabindex="-1"></a>    resampled_data <span class="op">=</span> pd.DataFrame()</span>
<span id="eb765eab-29"><a href="#eb765eab-29" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> class_index, group <span class="kw">in</span> data.groupby(column):</span>
<span id="eb765eab-30"><a href="#eb765eab-30" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Sample without replacement if group size is larger than the target, otherwise keep the group as is</span></span>
<span id="eb765eab-31"><a href="#eb765eab-31" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">len</span>(group) <span class="op">&gt;=</span> target_size_per_class:</span>
<span id="eb765eab-32"><a href="#eb765eab-32" aria-hidden="true" tabindex="-1"></a>            resampled_group <span class="op">=</span> resample(</span>
<span id="eb765eab-33"><a href="#eb765eab-33" aria-hidden="true" tabindex="-1"></a>                group,</span>
<span id="eb765eab-34"><a href="#eb765eab-34" aria-hidden="true" tabindex="-1"></a>                replace<span class="op">=</span><span class="va">False</span>,  <span class="co"># Sample without replacement</span></span>
<span id="eb765eab-35"><a href="#eb765eab-35" aria-hidden="true" tabindex="-1"></a>                n_samples<span class="op">=</span>target_size_per_class,</span>
<span id="eb765eab-36"><a href="#eb765eab-36" aria-hidden="true" tabindex="-1"></a>                random_state<span class="op">=</span><span class="dv">42</span>,</span>
<span id="eb765eab-37"><a href="#eb765eab-37" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="eb765eab-38"><a href="#eb765eab-38" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="eb765eab-39"><a href="#eb765eab-39" aria-hidden="true" tabindex="-1"></a>            <span class="co"># If the group size is less than the target, and also smaller than the maximum class size, do not resample</span></span>
<span id="eb765eab-40"><a href="#eb765eab-40" aria-hidden="true" tabindex="-1"></a>            resampled_group <span class="op">=</span> group  <span class="co"># keep the original group unchanged</span></span>
<span id="eb765eab-41"><a href="#eb765eab-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="eb765eab-42"><a href="#eb765eab-42" aria-hidden="true" tabindex="-1"></a>        resampled_data <span class="op">=</span> pd.concat([resampled_data, resampled_group], axis<span class="op">=</span><span class="dv">0</span>)</span>
<span id="eb765eab-43"><a href="#eb765eab-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="eb765eab-44"><a href="#eb765eab-44" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> resampled_data.reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="eb765eab-45"><a href="#eb765eab-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="eb765eab-46"><a href="#eb765eab-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="eb765eab-47"><a href="#eb765eab-47" aria-hidden="true" tabindex="-1"></a><span class="co"># Our target for prediction</span></span>
<span id="eb765eab-48"><a href="#eb765eab-48" aria-hidden="true" tabindex="-1"></a>target <span class="op">=</span> <span class="st">"test_result_class"</span></span>
<span id="eb765eab-49"><a href="#eb765eab-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="eb765eab-50"><a href="#eb765eab-50" aria-hidden="true" tabindex="-1"></a><span class="co"># Use only a fraction of the data for faster processing and less memory usage</span></span>
<span id="eb765eab-51"><a href="#eb765eab-51" aria-hidden="true" tabindex="-1"></a>mot_encoded <span class="op">=</span> stratified_sample(mot, target, <span class="fl">0.999</span>)</span>
<span id="eb765eab-52"><a href="#eb765eab-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="eb765eab-53"><a href="#eb765eab-53" aria-hidden="true" tabindex="-1"></a><span class="co"># Show the distribution of the test_result column</span></span>
<span id="eb765eab-54"><a href="#eb765eab-54" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(mot_encoded[target].value_counts())</span>
<span id="eb765eab-55"><a href="#eb765eab-55" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(mot_encoded.shape)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>test_result_class
Pass     7874347
Fail     2748469
Other      68257
Name: count, dtype: int64
(10691073, 19)</code></pre>
</div>
</div>
<p>Now we will do a number of things:</p>
<ol type="1">
<li>Since we have a number of categorical variables, and will be evaluating a <code>LightGBM</code> classification model, we will need to encode these variables.</li>
<li>We will split the data into training and testing sets, but based on a fraction of the original set (to fit on the memory constraints of my environment).</li>
<li>To ensure a balanced dataset, we will use class weights in the model parameters - in this case, we will use the <code>balanced</code> class weight strategy.</li>
<li>We will finally train the model and evaluate its performance, using <code>GridSearchCV</code> to find the best hyperparameters.</li>
</ol>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
About LightGBM
</div>
</div>
<div class="callout-body-container callout-body">
<p>LightGBM (Light Gradient Boosting Machine) is an efficient and scalable implementation of gradient boosting framework by Microsoft. It is designed to be distributed and efficient with the following advantages: faster training speed and higher efficiency, lower memory usage, better accuracy, support of parallel and GPU learning, and capable of handling large-scale data.</p>
<p>The core algorithm of LightGBM is based on decision tree algorithms and uses gradient boosting. Trees are built leaf-wise as opposed to level-wise as commonly seen in other boosting frameworks like XGBoost. This means that LightGBM will choose the leaf with max delta loss to grow during tree growth. It can reduce more loss than a level-wise algorithm, which is one of the main reasons for its efficiency.</p>
<p>Core Concepts and Techniques</p>
<p><strong>Gradient Boosting</strong>: Like other boosting methods, LightGBM converts weak learners into a strong learner in an iterative fashion. It constructs new trees that model the errors or residuals of the prior trees added together as a new prediction.</p>
<p><strong>Histogram-based Algorithms</strong>: LightGBM uses histogram-based algorithms for speed and memory efficiency. It buckets continuous feature (attribute) values into discrete bins which speeds up the training process and reduces memory usage significantly.</p>
<p><strong>Leaf-wise Tree Growth</strong>: Unlike other boosting frameworks that grow trees level-wise, LightGBM grows trees leaf-wise. It chooses the leaf that minimizes the loss, allowing for lower-loss models and thus leading to better accuracy.</p>
<p>Mathematically, the objective function that LightGBM minimizes can be described as follows:</p>
<p><span class="math display">\[
L(\Theta) = \sum_{i=1}^N l(y_i, \hat{y}_i) + \sum_{k=1}^K \Omega(f_k)
\]</span></p>
<p>where <span class="math inline">\(\mathbf{N}\)</span> is the number of data points, <span class="math inline">\(\mathbf{y_i}\)</span> is the actual label, <span class="math inline">\(\hat{y}_i\)</span> is the predicted label, <span class="math inline">\(\mathbf{l}\)</span> is the loss function, <span class="math inline">\(\mathbf{K}\)</span> is the number of trees, <span class="math inline">\(\mathbf{f_k}\)</span> is the model from tree <span class="math inline">\(\mathbf{k}\)</span>, and <span class="math inline">\(\mathbf{\Omega}\)</span> is the regularization term.</p>
<p><strong>Loss Function</strong>: The loss function <span class="math inline">\(l(y, \hat{y})\)</span> depends on the specific task (e.g., mean squared error for regression, logistic loss for binary classification).</p>
<p><strong>Regularization</strong>: LightGBM also includes regularization terms <span class="math inline">\(\Omega(f)\)</span>, which help to prevent overfitting. These terms can include L1 and L2 regularization on the weights of the leaves.</p>
<p><strong>Exclusive Feature Bundling (EFB)</strong>: This is an optimization to reduce the number of features in a dataset with many sparse features. EFB bundles mutually exclusive features (i.e., features that rarely take non-zero values simultaneously) into a single feature, thus reducing the feature dimension without hurting model accuracy.</p>
<p><strong>GOSS (Gradient-based One-Side Sampling)</strong> and <strong>DART (Dropouts meet Multiple Additive Regression Trees)</strong> are other techniques LightGBM uses to manage data samples and boost performance effectively.</p>
<p>LightGBM is highly customizable with a lot of hyper-parameters such as <code>num_leaves</code>, <code>min_data_in_leaf</code>, and <code>max_depth</code>, which control the complexity of the model. Hyper-parameter tuning plays a crucial role in harnessing the full potential of LightGBM.</p>
</div>
</div>
<p>Let us now encode all categorical features in the dataset (<code>LightGBM</code> cannot handle unencoded categories), and split the data into training and testing sets.</p>
<div id="6f8ee7cb" class="cell" data-execution_count="24">
<details class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="6f8ee7cb"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="6f8ee7cb-1"><a href="#6f8ee7cb-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Encode the categorical columns</span></span>
<span id="6f8ee7cb-2"><a href="#6f8ee7cb-2" aria-hidden="true" tabindex="-1"></a>le <span class="op">=</span> LabelEncoder()</span>
<span id="6f8ee7cb-3"><a href="#6f8ee7cb-3" aria-hidden="true" tabindex="-1"></a>categorical_features <span class="op">=</span> [</span>
<span id="6f8ee7cb-4"><a href="#6f8ee7cb-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"make"</span>,</span>
<span id="6f8ee7cb-5"><a href="#6f8ee7cb-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"model"</span>,</span>
<span id="6f8ee7cb-6"><a href="#6f8ee7cb-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">"fuel_type"</span>,</span>
<span id="6f8ee7cb-7"><a href="#6f8ee7cb-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">"postcode_area"</span>,</span>
<span id="6f8ee7cb-8"><a href="#6f8ee7cb-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">"test_result_class"</span>,</span>
<span id="6f8ee7cb-9"><a href="#6f8ee7cb-9" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="6f8ee7cb-10"><a href="#6f8ee7cb-10" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> col <span class="kw">in</span> categorical_features:</span>
<span id="6f8ee7cb-11"><a href="#6f8ee7cb-11" aria-hidden="true" tabindex="-1"></a>    mot_encoded[col] <span class="op">=</span> le.fit_transform(mot_encoded[col])</span>
<span id="6f8ee7cb-12"><a href="#6f8ee7cb-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="6f8ee7cb-13"><a href="#6f8ee7cb-13" aria-hidden="true" tabindex="-1"></a>features <span class="op">=</span> [</span>
<span id="6f8ee7cb-14"><a href="#6f8ee7cb-14" aria-hidden="true" tabindex="-1"></a>    <span class="st">"test_mileage"</span>,</span>
<span id="6f8ee7cb-15"><a href="#6f8ee7cb-15" aria-hidden="true" tabindex="-1"></a>    <span class="st">"test_class_id"</span>,</span>
<span id="6f8ee7cb-16"><a href="#6f8ee7cb-16" aria-hidden="true" tabindex="-1"></a>    <span class="st">"cylinder_capacity"</span>,</span>
<span id="6f8ee7cb-17"><a href="#6f8ee7cb-17" aria-hidden="true" tabindex="-1"></a>    <span class="st">"age_years"</span>,</span>
<span id="6f8ee7cb-18"><a href="#6f8ee7cb-18" aria-hidden="true" tabindex="-1"></a>    <span class="st">"make"</span>,</span>
<span id="6f8ee7cb-19"><a href="#6f8ee7cb-19" aria-hidden="true" tabindex="-1"></a>    <span class="st">"model"</span>,</span>
<span id="6f8ee7cb-20"><a href="#6f8ee7cb-20" aria-hidden="true" tabindex="-1"></a>    <span class="st">"fuel_type"</span>,</span>
<span id="6f8ee7cb-21"><a href="#6f8ee7cb-21" aria-hidden="true" tabindex="-1"></a>    <span class="st">"postcode_area"</span>,</span>
<span id="6f8ee7cb-22"><a href="#6f8ee7cb-22" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="6f8ee7cb-23"><a href="#6f8ee7cb-23" aria-hidden="true" tabindex="-1"></a>X <span class="op">=</span> mot_encoded[features]</span>
<span id="6f8ee7cb-24"><a href="#6f8ee7cb-24" aria-hidden="true" tabindex="-1"></a>y <span class="op">=</span> mot_encoded[target]</span>
<span id="6f8ee7cb-25"><a href="#6f8ee7cb-25" aria-hidden="true" tabindex="-1"></a>X_train, X_test, y_train, y_test <span class="op">=</span> train_test_split(</span>
<span id="6f8ee7cb-26"><a href="#6f8ee7cb-26" aria-hidden="true" tabindex="-1"></a>    X, y, test_size<span class="op">=</span><span class="fl">0.2</span>, random_state<span class="op">=</span><span class="dv">42</span></span>
<span id="6f8ee7cb-27"><a href="#6f8ee7cb-27" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>We are now ready to train the models. We will train a <code>LightGBM</code> classifier, using <code>GridSearchCV</code> to find the best hyperparameters.</p>
<div id="e2cf6bb6" class="cell" data-execution_count="25">
<details class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="e2cf6bb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="e2cf6bb6-1"><a href="#e2cf6bb6-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> lightgbm <span class="im">as</span> lgb</span>
<span id="e2cf6bb6-2"><a href="#e2cf6bb6-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.metrics <span class="im">import</span> classification_report, accuracy_score</span>
<span id="e2cf6bb6-3"><a href="#e2cf6bb6-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.model_selection <span class="im">import</span> GridSearchCV</span>
<span id="e2cf6bb6-4"><a href="#e2cf6bb6-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> time</span>
<span id="e2cf6bb6-5"><a href="#e2cf6bb6-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="e2cf6bb6-6"><a href="#e2cf6bb6-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Setting up parameter grids for each model</span></span>
<span id="e2cf6bb6-7"><a href="#e2cf6bb6-7" aria-hidden="true" tabindex="-1"></a>param_grid <span class="op">=</span> {</span>
<span id="e2cf6bb6-8"><a href="#e2cf6bb6-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">"LightGBM"</span>: {</span>
<span id="e2cf6bb6-9"><a href="#e2cf6bb6-9" aria-hidden="true" tabindex="-1"></a>        <span class="st">"model"</span>: lgb.LGBMClassifier(random_state<span class="op">=</span><span class="dv">42</span>, verbosity<span class="op">=-</span><span class="dv">1</span>),</span>
<span id="e2cf6bb6-10"><a href="#e2cf6bb6-10" aria-hidden="true" tabindex="-1"></a>        <span class="st">"params"</span>: {</span>
<span id="e2cf6bb6-11"><a href="#e2cf6bb6-11" aria-hidden="true" tabindex="-1"></a>            <span class="st">"num_leaves"</span>: [<span class="dv">31</span>, <span class="dv">62</span>, <span class="dv">128</span>],  <span class="co"># Most impactful on complexity and overfitting</span></span>
<span id="e2cf6bb6-12"><a href="#e2cf6bb6-12" aria-hidden="true" tabindex="-1"></a>            <span class="st">"n_estimators"</span>: [</span>
<span id="e2cf6bb6-13"><a href="#e2cf6bb6-13" aria-hidden="true" tabindex="-1"></a>                <span class="dv">50</span>,</span>
<span id="e2cf6bb6-14"><a href="#e2cf6bb6-14" aria-hidden="true" tabindex="-1"></a>                <span class="dv">100</span>,</span>
<span id="e2cf6bb6-15"><a href="#e2cf6bb6-15" aria-hidden="true" tabindex="-1"></a>            ],  <span class="co"># Directly impacts model performance and training time</span></span>
<span id="e2cf6bb6-16"><a href="#e2cf6bb6-16" aria-hidden="true" tabindex="-1"></a>            <span class="st">"class_weight"</span>: [<span class="va">None</span>, <span class="st">"balanced"</span>],  <span class="co"># Important for class imbalance</span></span>
<span id="e2cf6bb6-17"><a href="#e2cf6bb6-17" aria-hidden="true" tabindex="-1"></a>            <span class="st">"objective"</span>: [<span class="st">"multiclass"</span>],  <span class="co"># For multi-class classification</span></span>
<span id="e2cf6bb6-18"><a href="#e2cf6bb6-18" aria-hidden="true" tabindex="-1"></a>            <span class="st">"metric"</span>: [</span>
<span id="e2cf6bb6-19"><a href="#e2cf6bb6-19" aria-hidden="true" tabindex="-1"></a>                <span class="st">"multi_logloss"</span></span>
<span id="e2cf6bb6-20"><a href="#e2cf6bb6-20" aria-hidden="true" tabindex="-1"></a>            ],  <span class="co"># Logarithmic loss for multi-class classification</span></span>
<span id="e2cf6bb6-21"><a href="#e2cf6bb6-21" aria-hidden="true" tabindex="-1"></a>        },</span>
<span id="e2cf6bb6-22"><a href="#e2cf6bb6-22" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="e2cf6bb6-23"><a href="#e2cf6bb6-23" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="e2cf6bb6-24"><a href="#e2cf6bb6-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="e2cf6bb6-25"><a href="#e2cf6bb6-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="e2cf6bb6-26"><a href="#e2cf6bb6-26" aria-hidden="true" tabindex="-1"></a><span class="co"># Store results</span></span>
<span id="e2cf6bb6-27"><a href="#e2cf6bb6-27" aria-hidden="true" tabindex="-1"></a>results <span class="op">=</span> []</span>
<span id="e2cf6bb6-28"><a href="#e2cf6bb6-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="e2cf6bb6-29"><a href="#e2cf6bb6-29" aria-hidden="true" tabindex="-1"></a><span class="co"># Define scoring metric</span></span>
<span id="e2cf6bb6-30"><a href="#e2cf6bb6-30" aria-hidden="true" tabindex="-1"></a>scoring <span class="op">=</span> <span class="st">"balanced_accuracy"</span></span>
<span id="e2cf6bb6-31"><a href="#e2cf6bb6-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="e2cf6bb6-32"><a href="#e2cf6bb6-32" aria-hidden="true" tabindex="-1"></a><span class="co"># Run GridSearchCV for each model</span></span>
<span id="e2cf6bb6-33"><a href="#e2cf6bb6-33" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> model_name, mp <span class="kw">in</span> param_grid.items():</span>
<span id="e2cf6bb6-34"><a href="#e2cf6bb6-34" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Running GridSearchCV for </span><span class="sc">{</span>model_name<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="e2cf6bb6-35"><a href="#e2cf6bb6-35" aria-hidden="true" tabindex="-1"></a>    start_time <span class="op">=</span> time.time()</span>
<span id="e2cf6bb6-36"><a href="#e2cf6bb6-36" aria-hidden="true" tabindex="-1"></a>    clf <span class="op">=</span> GridSearchCV(mp[<span class="st">"model"</span>], mp[<span class="st">"params"</span>], scoring<span class="op">=</span>scoring, verbose<span class="op">=</span><span class="dv">1</span>, n_jobs<span class="op">=-</span><span class="dv">1</span>)</span>
<span id="e2cf6bb6-37"><a href="#e2cf6bb6-37" aria-hidden="true" tabindex="-1"></a>    clf.fit(X_train, y_train)</span>
<span id="e2cf6bb6-38"><a href="#e2cf6bb6-38" aria-hidden="true" tabindex="-1"></a>    end_time <span class="op">=</span> time.time()</span>
<span id="e2cf6bb6-39"><a href="#e2cf6bb6-39" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Finished in </span><span class="sc">{</span>end_time <span class="op">-</span> start_time<span class="sc">:.2f}</span><span class="ss"> seconds"</span>)</span>
<span id="e2cf6bb6-40"><a href="#e2cf6bb6-40" aria-hidden="true" tabindex="-1"></a>    feature_importances <span class="op">=</span> <span class="bu">dict</span>(</span>
<span id="e2cf6bb6-41"><a href="#e2cf6bb6-41" aria-hidden="true" tabindex="-1"></a>        <span class="bu">zip</span>(X_train.columns, clf.best_estimator_.feature_importances_)</span>
<span id="e2cf6bb6-42"><a href="#e2cf6bb6-42" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="e2cf6bb6-43"><a href="#e2cf6bb6-43" aria-hidden="true" tabindex="-1"></a>    results.append(</span>
<span id="e2cf6bb6-44"><a href="#e2cf6bb6-44" aria-hidden="true" tabindex="-1"></a>        {</span>
<span id="e2cf6bb6-45"><a href="#e2cf6bb6-45" aria-hidden="true" tabindex="-1"></a>            <span class="st">"model_name"</span>: model_name,</span>
<span id="e2cf6bb6-46"><a href="#e2cf6bb6-46" aria-hidden="true" tabindex="-1"></a>            <span class="st">"model"</span>: clf.best_estimator_,</span>
<span id="e2cf6bb6-47"><a href="#e2cf6bb6-47" aria-hidden="true" tabindex="-1"></a>            <span class="st">"best_score"</span>: clf.best_score_,</span>
<span id="e2cf6bb6-48"><a href="#e2cf6bb6-48" aria-hidden="true" tabindex="-1"></a>            <span class="st">"best_params"</span>: clf.best_params_,</span>
<span id="e2cf6bb6-49"><a href="#e2cf6bb6-49" aria-hidden="true" tabindex="-1"></a>            <span class="st">"train_duration"</span>: end_time <span class="op">-</span> start_time,</span>
<span id="e2cf6bb6-50"><a href="#e2cf6bb6-50" aria-hidden="true" tabindex="-1"></a>            <span class="st">"feature_importances"</span>: feature_importances,</span>
<span id="e2cf6bb6-51"><a href="#e2cf6bb6-51" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="e2cf6bb6-52"><a href="#e2cf6bb6-52" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="e2cf6bb6-53"><a href="#e2cf6bb6-53" aria-hidden="true" tabindex="-1"></a>    elapsed_time <span class="op">=</span> time.time() <span class="op">-</span> start_time  <span class="co"># Correctly compute the elapsed time</span></span>
<span id="e2cf6bb6-54"><a href="#e2cf6bb6-54" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(</span>
<span id="e2cf6bb6-55"><a href="#e2cf6bb6-55" aria-hidden="true" tabindex="-1"></a>        <span class="ss">f"</span><span class="sc">{</span>model_name<span class="sc">}</span><span class="ss"> best params: </span><span class="sc">{</span>clf<span class="sc">.</span>best_params_<span class="sc">}</span><span class="ss">, best score: </span><span class="sc">{</span>clf<span class="sc">.</span>best_score_<span class="sc">}</span><span class="ss">, time: </span><span class="sc">{</span>elapsed_time<span class="sc">}</span><span class="ss"> seconds"</span></span>
<span id="e2cf6bb6-56"><a href="#e2cf6bb6-56" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="e2cf6bb6-57"><a href="#e2cf6bb6-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="e2cf6bb6-58"><a href="#e2cf6bb6-58" aria-hidden="true" tabindex="-1"></a><span class="co"># Display results</span></span>
<span id="e2cf6bb6-59"><a href="#e2cf6bb6-59" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> result <span class="kw">in</span> results:</span>
<span id="e2cf6bb6-60"><a href="#e2cf6bb6-60" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Model: </span><span class="sc">{</span>result[<span class="st">'model_name'</span>]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="e2cf6bb6-61"><a href="#e2cf6bb6-61" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\t</span><span class="ss">Best Score: </span><span class="sc">{</span>result[<span class="st">'best_score'</span>]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="e2cf6bb6-62"><a href="#e2cf6bb6-62" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\t</span><span class="ss">Best Parameters: </span><span class="sc">{</span>result[<span class="st">'best_params'</span>]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="e2cf6bb6-63"><a href="#e2cf6bb6-63" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\t</span><span class="ss">Training Duration: </span><span class="sc">{</span>result[<span class="st">'train_duration'</span>]<span class="sc">}</span><span class="ss"> seconds"</span>)</span>
<span id="e2cf6bb6-64"><a href="#e2cf6bb6-64" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\t</span><span class="ss">Feature Importances: </span><span class="sc">{</span>result[<span class="st">'feature_importances'</span>]<span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Running GridSearchCV for LightGBM
Fitting 5 folds for each of 12 candidates, totalling 60 fits</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Finished in 713.04 seconds
LightGBM best params: {'class_weight': 'balanced', 'metric': 'multi_logloss', 'n_estimators': 100, 'num_leaves': 128, 'objective': 'multiclass'}, best score: 0.7207387359648975, time: 713.0455248355865 seconds
Model: LightGBM
    Best Score: 0.7207387359648975
    Best Parameters: {'class_weight': 'balanced', 'metric': 'multi_logloss', 'n_estimators': 100, 'num_leaves': 128, 'objective': 'multiclass'}
    Training Duration: 713.0449509620667 seconds
    Feature Importances: {'test_mileage': 8274, 'test_class_id': 554, 'cylinder_capacity': 4484, 'age_years': 9167, 'make': 2299, 'model': 3361, 'fuel_type': 560, 'postcode_area': 9401}</code></pre>
</div>
</div>
<p>Let’s look at feature importance as determined by the model.</p>
<div id="df62f787" class="cell" data-execution_count="26">
<details class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="df62f787"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="df62f787-1"><a href="#df62f787-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Find the best model from the results</span></span>
<span id="df62f787-2"><a href="#df62f787-2" aria-hidden="true" tabindex="-1"></a>best_model <span class="op">=</span> <span class="bu">max</span>(results, key<span class="op">=</span><span class="kw">lambda</span> x: x[<span class="st">"best_score"</span>])</span>
<span id="df62f787-3"><a href="#df62f787-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="df62f787-4"><a href="#df62f787-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot feature importances</span></span>
<span id="df62f787-5"><a href="#df62f787-5" aria-hidden="true" tabindex="-1"></a>lgb.plot_importance(</span>
<span id="df62f787-6"><a href="#df62f787-6" aria-hidden="true" tabindex="-1"></a>    best_model[<span class="st">"model"</span>],</span>
<span id="df62f787-7"><a href="#df62f787-7" aria-hidden="true" tabindex="-1"></a>    title<span class="op">=</span><span class="st">"Feature Importance"</span>,</span>
<span id="df62f787-8"><a href="#df62f787-8" aria-hidden="true" tabindex="-1"></a>    xlabel<span class="op">=</span><span class="st">"Feature Score"</span>,</span>
<span id="df62f787-9"><a href="#df62f787-9" aria-hidden="true" tabindex="-1"></a>    ylabel<span class="op">=</span><span class="st">"Features"</span>,</span>
<span id="df62f787-10"><a href="#df62f787-10" aria-hidden="true" tabindex="-1"></a>    figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="dv">6</span>),</span>
<span id="df62f787-11"><a href="#df62f787-11" aria-hidden="true" tabindex="-1"></a>    color<span class="op">=</span><span class="st">"skyblue"</span>,</span>
<span id="df62f787-12"><a href="#df62f787-12" aria-hidden="true" tabindex="-1"></a>    grid<span class="op">=</span><span class="va">False</span>,</span>
<span id="df62f787-13"><a href="#df62f787-13" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="df62f787-14"><a href="#df62f787-14" aria-hidden="true" tabindex="-1"></a>plt.xticks(rotation<span class="op">=</span><span class="dv">45</span>)</span>
<span id="df62f787-15"><a href="#df62f787-15" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><a href="index_files/figure-html/cell-26-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-17"><img src="index_files/figure-html/cell-26-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<p>Somewhat surprisingly, the most important feature is <code>postcode_area</code>, followed by <code>age_years</code> and <code>test_mileage</code>.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
About Feature Importance
</div>
</div>
<div class="callout-body-container callout-body">
<p><code>postcode_area</code> is probably hinting at some underlying socio-economic factors that might be influencing the test results. It is interesting to see that this is the most important feature, and it might be worth investigating further.</p>
</div>
</div>
<p>Now that we know the best performing set of hyperparameters, let’s run some predictions on the test set and evaluate the model’s performance. Note that in a real-world scenario, you would likely want to evaluate the model on a separate validation set to ensure that it generalizes well to unseen data, which is not what we are doing here.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
About Model Evaluation
</div>
</div>
<div class="callout-body-container callout-body">
<p>Selecting the right hyperparameters for a machine learning model is a crucial step in the model development process. Hyperparameters are the configuration settings used to tune the learning algorithm, and they can significantly impact the performance of the model. Using <code>GridSearchCV</code> allows you to search through a grid of hyperparameters and find the best combination that maximizes the model’s performance, as measured by a specified evaluation metric. However, it is important to note that hyperparameter tuning can be computationally expensive, especially when searching through a large grid of hyperparameters. Therefore, it is essential to balance the trade-off between computational resources and model performance when tuning hyperparameters, as well as understanding model performance to target the most impactfull hyperparameters.</p>
</div>
</div>
<div id="a59dfd1b" class="cell" data-execution_count="27">
<details class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="a59dfd1b"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="a59dfd1b-1"><a href="#a59dfd1b-1" aria-hidden="true" tabindex="-1"></a>y_pred <span class="op">=</span> best_model[<span class="st">"model"</span>].predict(X_test)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Let’s print the classification report for the model, as well as the confusion matrix.</p>
<div id="e038d5a7" class="cell" data-execution_count="28">
<details class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="e038d5a7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="e038d5a7-1"><a href="#e038d5a7-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.metrics <span class="im">import</span> confusion_matrix</span>
<span id="e038d5a7-2"><a href="#e038d5a7-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="e038d5a7-3"><a href="#e038d5a7-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Display the classification report and accuracy score, decode the labels</span></span>
<span id="e038d5a7-4"><a href="#e038d5a7-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(classification_report(y_test, y_pred, target_names<span class="op">=</span>le.classes_, zero_division<span class="op">=</span><span class="dv">1</span>))</span>
<span id="e038d5a7-5"><a href="#e038d5a7-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Accuracy: </span><span class="sc">{</span>accuracy_score(y_test, y_pred)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="e038d5a7-6"><a href="#e038d5a7-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="e038d5a7-7"><a href="#e038d5a7-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the confusion matrix</span></span>
<span id="e038d5a7-8"><a href="#e038d5a7-8" aria-hidden="true" tabindex="-1"></a>conf_matrix <span class="op">=</span> confusion_matrix(y_test, y_pred, normalize<span class="op">=</span><span class="st">"pred"</span>)</span>
<span id="e038d5a7-9"><a href="#e038d5a7-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="e038d5a7-10"><a href="#e038d5a7-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the confusion matrix</span></span>
<span id="e038d5a7-11"><a href="#e038d5a7-11" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="dv">6</span>))</span>
<span id="e038d5a7-12"><a href="#e038d5a7-12" aria-hidden="true" tabindex="-1"></a>sns.heatmap(</span>
<span id="e038d5a7-13"><a href="#e038d5a7-13" aria-hidden="true" tabindex="-1"></a>    conf_matrix,</span>
<span id="e038d5a7-14"><a href="#e038d5a7-14" aria-hidden="true" tabindex="-1"></a>    annot<span class="op">=</span><span class="va">True</span>,</span>
<span id="e038d5a7-15"><a href="#e038d5a7-15" aria-hidden="true" tabindex="-1"></a>    fmt<span class="op">=</span><span class="st">".2g"</span>,</span>
<span id="e038d5a7-16"><a href="#e038d5a7-16" aria-hidden="true" tabindex="-1"></a>    cmap<span class="op">=</span><span class="st">"Blues"</span>,</span>
<span id="e038d5a7-17"><a href="#e038d5a7-17" aria-hidden="true" tabindex="-1"></a>    xticklabels<span class="op">=</span>le.classes_,</span>
<span id="e038d5a7-18"><a href="#e038d5a7-18" aria-hidden="true" tabindex="-1"></a>    yticklabels<span class="op">=</span>le.classes_,</span>
<span id="e038d5a7-19"><a href="#e038d5a7-19" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="e038d5a7-20"><a href="#e038d5a7-20" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Confusion Matrix"</span>)</span>
<span id="e038d5a7-21"><a href="#e038d5a7-21" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"Predicted"</span>)</span>
<span id="e038d5a7-22"><a href="#e038d5a7-22" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"Actual"</span>)</span>
<span id="e038d5a7-23"><a href="#e038d5a7-23" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>              precision    recall  f1-score   support

        Fail       0.37      0.68      0.48    551359
       Other       0.70      0.89      0.78     13670
        Pass       0.84      0.59      0.70   1573186

    accuracy                           0.62   2138215
   macro avg       0.64      0.72      0.65   2138215
weighted avg       0.72      0.62      0.64   2138215

Accuracy: 0.6193039521282939</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><a href="index_files/figure-html/cell-28-output-2.png" class="lightbox" data-gallery="quarto-lightbox-gallery-18"><img src="index_files/figure-html/cell-28-output-2.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
</section>
<section id="analysis-of-training-results" class="level2">
<h2 class="anchored" data-anchor-id="analysis-of-training-results">Analysis of training results</h2>
<p>Here’s an interpretation of the metrics for each of the target classes, followed by overall model performance:</p>
<ul>
<li><strong>Fail</strong>:
<ul>
<li><strong>Precision</strong>: 37% of instances predicted as “Fail” were actually “Fail.”</li>
<li><strong>Recall</strong>: The model correctly identified 68% of all actual “Fail” instances.</li>
<li><strong>F1-Score</strong>: A harmonic mean of precision and recall, standing at 48%, indicates moderate effectiveness for this class, somewhat hindered by relatively low precision.</li>
<li><strong>Support</strong>: There are 551,359 actual instances of “Fail” in the test data.</li>
</ul></li>
<li><strong>Other</strong>:
<ul>
<li><strong>Precision</strong>: 70% of instances predicted as “Other” were correct.</li>
<li><strong>Recall</strong>: The model successfully identified 89% of all actual “Other” instances.</li>
<li><strong>F1-Score</strong>: At 78%, this score shows relatively strong performance in predicting the “Other” class, supported by both high precision and recall.</li>
<li><strong>Support</strong>: There are 13,670 actual instances of “Other” in the test data.</li>
</ul></li>
<li><strong>Pass</strong>:
<ul>
<li><strong>Precision</strong>: 84% of instances predicted as “Pass” were correct.</li>
<li><strong>Recall</strong>: The model correctly identified 59% of all actual “Pass” instances.</li>
<li><strong>F1-Score</strong>: The score is 70%, indicating good prediction power, although this is lowered by the recall being significantly less than the precision.</li>
<li><strong>Support</strong>: There are 1,573,186 actual instances of “Pass” in the test data.</li>
</ul></li>
<li><strong>Overall Model Performance</strong>:
<ul>
<li><strong>Accuracy</strong>: Overall, the model correctly predicted the class of 62% of the total cases in the dataset.</li>
<li><strong>Macro Average Precision</strong>: On average, the model has a precision of 64% across classes, which does not take class imbalance into account.</li>
<li><strong>Macro Average Recall</strong>: On average, the model has a recall of 72% across classes, indicating better sensitivity than precision.</li>
<li><strong>Macro Average F1-Score</strong>: The average F1-score across classes is 65%, reflecting a balance between precision and recall without considering class imbalance.</li>
<li><strong>Weighted Average Precision</strong>: Adjusted for class frequency, the precision is 72%, indicating a good predictive performance where it matters the most in terms of sample size.</li>
<li><strong>Weighted Average Recall</strong>: Matches the overall accuracy.</li>
<li><strong>Weighted Average F1-Score</strong>: Stands at 64%, factoring in the actual distribution of classes, showing overall model effectiveness is moderate, skewed somewhat by performance on the most populous class.</li>
</ul></li>
</ul>
<p>This report shows that while the model performs quite well in identifying “Other” and reasonably well on “Pass,” it struggles with precision for “Fail.” The recall is high for “Fail,” suggesting the model is sensitive but not precise, potentially leading to many false positives. The high macro averages relative to the accuracy indicate performance variability across classes.</p>
</section>
<section id="final-remarks" class="level2">
<h2 class="anchored" data-anchor-id="final-remarks">Final remarks</h2>
<p>In this experiment, we have analysed the MOT test results of cars in the UK, focusing on the top most tested cars in the dataset. We have performed some exploratory analysis to understand the distribution of test results, vehicle age, and mileage, and have developed a classification model to predict the likely test result of a car based on its features.</p>
<p>The model we developed is a <code>LightGBM</code> classifier, trained on a balanced dataset using stratified sampling. The model achieved an overall accuracy of 62%, with varying performance across different classes. While the model performed well in identifying the “Other” class and reasonably well on “Pass,” it struggled with precision for “Fail.” This suggests that the model may be overly sensitive in predicting “Fail,” leading to many false positives.</p>
<p>In future work, it would be interesting to explore additional features that may influence the test results. It would also be beneficial to investigate the impact of socio-economic factors, such as the area where the vehicle is registered, on the test results. Additionally, further tuning of the model hyperparameters and feature engineering could potentially improve the model’s performance.</p>


</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" id="quarto-reuse"><h2 class="anchored quarto-appendix-heading">Reuse</h2><div class="quarto-appendix-contents"><div><a rel="license" href="https://creativecommons.org/licenses/by-sa/4.0/">CC BY-SA 4.0</a></div></div></section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/pedroleitao\.nl");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
<p>© 2025 Pedro Leitão</p>
</div>   
    <div class="nav-footer-center">
      &nbsp;
    </div>
    <div class="nav-footer-right">
<p>Built with Quarto</p>
</div>
  </div>
</footer>
<script>var lightboxQuarto = GLightbox({"closeEffect":"zoom","descPosition":"bottom","loop":false,"openEffect":"zoom","selector":".lightbox"});
(function() {
  let previousOnload = window.onload;
  window.onload = () => {
    if (previousOnload) {
      previousOnload();
    }
    lightboxQuarto.on('slide_before_load', (data) => {
      const { slideIndex, slideNode, slideConfig, player, trigger } = data;
      const href = trigger.getAttribute('href');
      if (href !== null) {
        const imgEl = window.document.querySelector(`a[href="${href}"] img`);
        if (imgEl !== null) {
          const srcAttr = imgEl.getAttribute("src");
          if (srcAttr && srcAttr.startsWith("data:")) {
            slideConfig.href = srcAttr;
          }
        }
      } 
    });
  
    lightboxQuarto.on('slide_after_load', (data) => {
      const { slideIndex, slideNode, slideConfig, player, trigger } = data;
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(slideNode);
      }
    });
  
  };
  
})();
          </script>




</body></html>