<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.42">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="dcterms.date" content="2025-03-14">

<title>Adam’s Apple – Pedro Leitão</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script><script src="../../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../../">
<link href="../../../_static/logo.jpg" rel="icon" type="image/jpeg">
<script src="../../../site_libs/quarto-html/quarto.js"></script>
<script src="../../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../../site_libs/quarto-html/quarto-syntax-highlighting-a185852c63625fd9ffbdc57047c9a77e.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../../site_libs/bootstrap/bootstrap-6b5169cd70b11e3ab71bd7bb77c8208f.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script src="../../../site_libs/quarto-contrib/nutshell-1.0.7/nutshell.js"></script>
<script src="../../../site_libs/quarto-contrib/nutshell-1.0.7/nutshell_options.js"></script>
<script src="../../../site_libs/quarto-contrib/glightbox/glightbox.min.js"></script>
<link href="../../../site_libs/quarto-contrib/glightbox/glightbox.min.css" rel="stylesheet">
<link href="../../../site_libs/quarto-contrib/glightbox/lightbox.css" rel="stylesheet">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<style>

      .quarto-title-block .quarto-title-banner {
        background-image: url(../../../_static/banner-waves-partial.jpg);
background-size: cover;
      }
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>
<script src="https://unpkg.com/@jupyter-widgets/html-manager@*/dist/embed-amd.js" crossorigin="anonymous"></script>
<script data-collect-dnt="true" async="" src="https://scripts.simpleanalyticscdn.com/latest.js"></script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="../../../styles.css">
<meta property="og:title" content="Pedro Leitão">
<meta property="og:description" content="the Adam optimisation algorithm">
<meta property="og:image" content="https://pedroleitao.nl/posts/experiments/adam-optimisation/_static/logo.jpg">
<meta property="og:site_name" content="Pedro Leitão">
<meta name="twitter:title" content="Adam’s Apple – Pedro Leitão">
<meta name="twitter:description" content="the Adam optimisation algorithm">
<meta name="twitter:image" content="https://pedroleitao.nl/posts/experiments/adam-optimisation/index_files/figure-html/cell-4-output-2.png">
<meta name="twitter:image-height" content="610">
<meta name="twitter:image-width" content="451">
<meta name="twitter:card" content="summary_large_image">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a href="../../../index.html" class="navbar-brand navbar-brand-logo">
    <img src="../../../_static/logo.jpg" alt="" class="navbar-logo">
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../../index.html"> 
<span class="menu-text">Bio</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../about.html"> 
<span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../posts.html"> 
<span class="menu-text">All posts</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../experiments.html"> 
<span class="menu-text">Experiments</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../thoughts.html"> 
<span class="menu-text">Thoughts</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../howtos.html"> 
<span class="menu-text">Howto’s</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/pedro-leitao"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://linkedin.com/in/nunoleitao"> <i class="bi bi-linkedin" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="../../../posts.xml"> <i class="bi bi-rss" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Adam’s Apple</h1>
            <p class="subtitle lead">the Adam optimisation algorithm</p>
                                <div class="quarto-categories">
                <div class="quarto-category">Experiments</div>
                <div class="quarto-category">Machine Learning</div>
                <div class="quarto-category">Deep Learning</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">March 14, 2025</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#what-is-optimisation" id="toc-what-is-optimisation" class="nav-link active" data-scroll-target="#what-is-optimisation">What is optimisation?</a></li>
  <li><a href="#visualising-adam-in-action" id="toc-visualising-adam-in-action" class="nav-link" data-scroll-target="#visualising-adam-in-action">Visualising Adam in action</a></li>
  <li><a href="#teaching-a-neural-network-to-paint-with-adam" id="toc-teaching-a-neural-network-to-paint-with-adam" class="nav-link" data-scroll-target="#teaching-a-neural-network-to-paint-with-adam">Teaching a neural network to paint with Adam</a>
  <ul class="collapse">
  <li><a href="#the-model" id="toc-the-model" class="nav-link" data-scroll-target="#the-model">The model</a></li>
  <li><a href="#the-siren-model" id="toc-the-siren-model" class="nav-link" data-scroll-target="#the-siren-model">The SIREN model</a></li>
  </ul></li>
  <li><a href="#final-remarks" id="toc-final-remarks" class="nav-link" data-scroll-target="#final-remarks">Final remarks</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">





<p>A key component of training deep learning models is the choice of optimisation algorithm. There are several approaches, ranging from <a href="https://en.wikipedia.org/wiki/Stochastic_gradient_descent">:link simple stochastic gradient descent</a> (SGD) to more advanced methods like Adam. In this experiment, we’ll try to give an intuitive understanding of what optimisation means in the context of machine learning, briefly discussing the Adam algorithm.</p>
<section id="what-is-optimisation" class="level2">
<h2 class="anchored" data-anchor-id="what-is-optimisation">What is optimisation?</h2>
<p>Optimisation, in its broadest sense, is the process of finding the best solution among many possibilities, adjusting variables to maximize or minimize an objective function. Think of it like tuning a car: you adjust various settings to achieve the best performance, whether the objective is faster acceleration or higher fuel efficiency. This concept applies across fields, from engineering to economics, where you often balance trade-offs to reach an optimal outcome.</p>
<p>In machine learning, optimisation takes on a more specific role. The objective function is typically the <a href="https://en.wikipedia.org/wiki/Loss_function">:link loss (or cost)</a>, which quantifies how far off a model’s predictions are from the actual data. The goal is to adjust the model’s parameters (like weights and biases) to minimize this loss. Because the loss landscapes in machine learning can be highly complex and non-linear, algorithms like gradient descent, and variants such as Adam, are employed. These algorithms iteratively tweak model parameters, gradually moving it toward better performance.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Machine learning involves data with many parameters and high-dimensional spaces, therefore the optimisation algorithm has to navigate many local minima and <a href="https://en.wikipedia.org/wiki/Saddle_point">:link saddle points</a>. The choice of algorithm is crucial, as it determines how efficiently the model converges to the optimal solution.</p>
</div>
</div>
</section>
<section id="visualising-adam-in-action" class="level2">
<h2 class="anchored" data-anchor-id="visualising-adam-in-action">Visualising Adam in action</h2>
<p>To illustrate the optimisation process, let us take a classical function used to test optimisation algorithms: the <a href="https://en.wikipedia.org/wiki/Rosenbrock_function">:link Rosenbrock function</a>. This function is known for its narrow, curved valley, making it challenging for optimisation algorithms to converge to the global minimum. The function is typically depicted in 2D, with the <span class="math inline">\(x\)</span> and <span class="math inline">\(y\)</span> axes representing the parameters to be optimized. We will instead visualise the optimisation process in 3D, with the <span class="math inline">\(x\)</span> and <span class="math inline">\(y\)</span> axes representing the spatial coordinates and the <span class="math inline">\(z\)</span>-axis representing the function value.</p>
<p>In the code below we define the <code>rosenbrock_2d</code> function, set up the optimisation process using PyTorch and the Adam optimizer (<code>torch.optim.Adam</code>), and track the path taken by the optimizer. We then create a 3D surface plot of the function and animate the optimisation process to see how the optimiser navigates the landscape.</p>
<div id="4f484945" class="cell" data-execution_count="1">
<details class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="4f484945"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="4f484945-1"><a href="#4f484945-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch</span>
<span id="4f484945-2"><a href="#4f484945-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="4f484945-3"><a href="#4f484945-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="4f484945-4"><a href="#4f484945-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> matplotlib.animation <span class="im">import</span> FuncAnimation</span>
<span id="4f484945-5"><a href="#4f484945-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> mpl_toolkits.mplot3d <span class="im">import</span> Axes3D  <span class="co"># Ensures 3D projection is recognized</span></span>
<span id="4f484945-6"><a href="#4f484945-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="4f484945-7"><a href="#4f484945-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="4f484945-8"><a href="#4f484945-8" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> rosenbrock_2d(x, y, a<span class="op">=</span><span class="fl">1.0</span>, b<span class="op">=</span><span class="fl">100.0</span>):</span>
<span id="4f484945-9"><a href="#4f484945-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> (a <span class="op">-</span> x) <span class="op">**</span> <span class="dv">2</span> <span class="op">+</span> b <span class="op">*</span> (y <span class="op">-</span> x<span class="op">**</span><span class="dv">2</span>) <span class="op">**</span> <span class="dv">2</span></span>
<span id="4f484945-10"><a href="#4f484945-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="4f484945-11"><a href="#4f484945-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="4f484945-12"><a href="#4f484945-12" aria-hidden="true" tabindex="-1"></a><span class="co"># PyTorch setup: we'll optimize x, y to find the minimum of the Rosenbrock function</span></span>
<span id="4f484945-13"><a href="#4f484945-13" aria-hidden="true" tabindex="-1"></a>params <span class="op">=</span> torch.tensor([<span class="op">-</span><span class="fl">0.8</span>, <span class="fl">2.0</span>], requires_grad<span class="op">=</span><span class="va">True</span>)</span>
<span id="4f484945-14"><a href="#4f484945-14" aria-hidden="true" tabindex="-1"></a>optimizer <span class="op">=</span> torch.optim.Adam([params], lr<span class="op">=</span><span class="fl">0.01</span>)</span>
<span id="4f484945-15"><a href="#4f484945-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="4f484945-16"><a href="#4f484945-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Track the path: (x, y, f(x,y)) each iteration</span></span>
<span id="4f484945-17"><a href="#4f484945-17" aria-hidden="true" tabindex="-1"></a>path <span class="op">=</span> []</span>
<span id="4f484945-18"><a href="#4f484945-18" aria-hidden="true" tabindex="-1"></a>tolerance <span class="op">=</span> <span class="fl">1e-4</span></span>
<span id="4f484945-19"><a href="#4f484945-19" aria-hidden="true" tabindex="-1"></a>max_iterations <span class="op">=</span> <span class="dv">6000</span></span>
<span id="4f484945-20"><a href="#4f484945-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="4f484945-21"><a href="#4f484945-21" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(max_iterations):</span>
<span id="4f484945-22"><a href="#4f484945-22" aria-hidden="true" tabindex="-1"></a>    optimizer.zero_grad()</span>
<span id="4f484945-23"><a href="#4f484945-23" aria-hidden="true" tabindex="-1"></a>    loss <span class="op">=</span> rosenbrock_2d(params[<span class="dv">0</span>], params[<span class="dv">1</span>])</span>
<span id="4f484945-24"><a href="#4f484945-24" aria-hidden="true" tabindex="-1"></a>    loss.backward()</span>
<span id="4f484945-25"><a href="#4f484945-25" aria-hidden="true" tabindex="-1"></a>    optimizer.step()</span>
<span id="4f484945-26"><a href="#4f484945-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="4f484945-27"><a href="#4f484945-27" aria-hidden="true" tabindex="-1"></a>    x_val <span class="op">=</span> params[<span class="dv">0</span>].item()</span>
<span id="4f484945-28"><a href="#4f484945-28" aria-hidden="true" tabindex="-1"></a>    y_val <span class="op">=</span> params[<span class="dv">1</span>].item()</span>
<span id="4f484945-29"><a href="#4f484945-29" aria-hidden="true" tabindex="-1"></a>    z_val <span class="op">=</span> loss.item()</span>
<span id="4f484945-30"><a href="#4f484945-30" aria-hidden="true" tabindex="-1"></a>    path.append([x_val, y_val, z_val])</span>
<span id="4f484945-31"><a href="#4f484945-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="4f484945-32"><a href="#4f484945-32" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Stop if loss is below tolerance</span></span>
<span id="4f484945-33"><a href="#4f484945-33" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> z_val <span class="op">&lt;</span> tolerance:</span>
<span id="4f484945-34"><a href="#4f484945-34" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"Converged at iteration"</span>, i)</span>
<span id="4f484945-35"><a href="#4f484945-35" aria-hidden="true" tabindex="-1"></a>        <span class="cf">break</span></span>
<span id="4f484945-36"><a href="#4f484945-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="4f484945-37"><a href="#4f484945-37" aria-hidden="true" tabindex="-1"></a>path <span class="op">=</span> np.array(path)</span>
<span id="4f484945-38"><a href="#4f484945-38" aria-hidden="true" tabindex="-1"></a>num_frames <span class="op">=</span> <span class="bu">len</span>(path)</span>
<span id="4f484945-39"><a href="#4f484945-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="4f484945-40"><a href="#4f484945-40" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a 3D surface for the function</span></span>
<span id="4f484945-41"><a href="#4f484945-41" aria-hidden="true" tabindex="-1"></a>X <span class="op">=</span> np.linspace(<span class="op">-</span><span class="dv">2</span>, <span class="dv">2</span>, <span class="dv">200</span>)</span>
<span id="4f484945-42"><a href="#4f484945-42" aria-hidden="true" tabindex="-1"></a>Y <span class="op">=</span> np.linspace(<span class="op">-</span><span class="dv">1</span>, <span class="dv">3</span>, <span class="dv">200</span>)</span>
<span id="4f484945-43"><a href="#4f484945-43" aria-hidden="true" tabindex="-1"></a>X_mesh, Y_mesh <span class="op">=</span> np.meshgrid(X, Y)</span>
<span id="4f484945-44"><a href="#4f484945-44" aria-hidden="true" tabindex="-1"></a>Z_mesh <span class="op">=</span> rosenbrock_2d(X_mesh, Y_mesh)</span>
<span id="4f484945-45"><a href="#4f484945-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="4f484945-46"><a href="#4f484945-46" aria-hidden="true" tabindex="-1"></a>fig <span class="op">=</span> plt.figure()</span>
<span id="4f484945-47"><a href="#4f484945-47" aria-hidden="true" tabindex="-1"></a>ax <span class="op">=</span> fig.add_subplot(<span class="dv">111</span>, projection<span class="op">=</span><span class="st">"3d"</span>)</span>
<span id="4f484945-48"><a href="#4f484945-48" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="st">"Adam Optimizer on 2D Rosenbrock (3D Surface)"</span>)</span>
<span id="4f484945-49"><a href="#4f484945-49" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="st">"x"</span>)</span>
<span id="4f484945-50"><a href="#4f484945-50" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="st">"y"</span>)</span>
<span id="4f484945-51"><a href="#4f484945-51" aria-hidden="true" tabindex="-1"></a>ax.set_zlabel(<span class="st">"f(x,y)"</span>)</span>
<span id="4f484945-52"><a href="#4f484945-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="4f484945-53"><a href="#4f484945-53" aria-hidden="true" tabindex="-1"></a><span class="co"># Initial axis limits (from our grid)</span></span>
<span id="4f484945-54"><a href="#4f484945-54" aria-hidden="true" tabindex="-1"></a>init_xlim <span class="op">=</span> (<span class="op">-</span><span class="dv">2</span>, <span class="dv">2</span>)</span>
<span id="4f484945-55"><a href="#4f484945-55" aria-hidden="true" tabindex="-1"></a>init_ylim <span class="op">=</span> (<span class="op">-</span><span class="dv">1</span>, <span class="dv">3</span>)</span>
<span id="4f484945-56"><a href="#4f484945-56" aria-hidden="true" tabindex="-1"></a>init_zlim <span class="op">=</span> (np.<span class="bu">min</span>(Z_mesh), np.<span class="bu">max</span>(Z_mesh))</span>
<span id="4f484945-57"><a href="#4f484945-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="4f484945-58"><a href="#4f484945-58" aria-hidden="true" tabindex="-1"></a>center_x, center_y, center_z <span class="op">=</span> <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span></span>
<span id="4f484945-59"><a href="#4f484945-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="4f484945-60"><a href="#4f484945-60" aria-hidden="true" tabindex="-1"></a><span class="co"># Set initial limits</span></span>
<span id="4f484945-61"><a href="#4f484945-61" aria-hidden="true" tabindex="-1"></a>ax.set_xlim(init_xlim)</span>
<span id="4f484945-62"><a href="#4f484945-62" aria-hidden="true" tabindex="-1"></a>ax.set_ylim(init_ylim)</span>
<span id="4f484945-63"><a href="#4f484945-63" aria-hidden="true" tabindex="-1"></a>ax.set_zlim(init_zlim)</span>
<span id="4f484945-64"><a href="#4f484945-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="4f484945-65"><a href="#4f484945-65" aria-hidden="true" tabindex="-1"></a>ax.plot_surface(X_mesh, Y_mesh, Z_mesh, alpha<span class="op">=</span><span class="fl">0.6</span>)</span>
<span id="4f484945-66"><a href="#4f484945-66" aria-hidden="true" tabindex="-1"></a>ax.plot([<span class="dv">1</span>], [<span class="dv">1</span>], [<span class="dv">0</span>], marker<span class="op">=</span><span class="st">"o"</span>, markersize<span class="op">=</span><span class="dv">5</span>)  <span class="co"># Global minimum reference</span></span>
<span id="4f484945-67"><a href="#4f484945-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="4f484945-68"><a href="#4f484945-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="4f484945-69"><a href="#4f484945-69" aria-hidden="true" tabindex="-1"></a><span class="co"># Animation: plot the path and adjust axis limits to zoom</span></span>
<span id="4f484945-70"><a href="#4f484945-70" aria-hidden="true" tabindex="-1"></a>(point,) <span class="op">=</span> ax.plot([], [], [], <span class="st">"ro"</span>)  <span class="co"># Current position marker</span></span>
<span id="4f484945-71"><a href="#4f484945-71" aria-hidden="true" tabindex="-1"></a>(line,) <span class="op">=</span> ax.plot([], [], [], <span class="st">"r-"</span>)  <span class="co"># Path line</span></span>
<span id="4f484945-72"><a href="#4f484945-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="4f484945-73"><a href="#4f484945-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="4f484945-74"><a href="#4f484945-74" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> init():</span>
<span id="4f484945-75"><a href="#4f484945-75" aria-hidden="true" tabindex="-1"></a>    point.set_data([], [])</span>
<span id="4f484945-76"><a href="#4f484945-76" aria-hidden="true" tabindex="-1"></a>    point.set_3d_properties([])</span>
<span id="4f484945-77"><a href="#4f484945-77" aria-hidden="true" tabindex="-1"></a>    line.set_data([], [])</span>
<span id="4f484945-78"><a href="#4f484945-78" aria-hidden="true" tabindex="-1"></a>    line.set_3d_properties([])</span>
<span id="4f484945-79"><a href="#4f484945-79" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> point, line</span>
<span id="4f484945-80"><a href="#4f484945-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="4f484945-81"><a href="#4f484945-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="4f484945-82"><a href="#4f484945-82" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> update(frame):</span>
<span id="4f484945-83"><a href="#4f484945-83" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Update point and path</span></span>
<span id="4f484945-84"><a href="#4f484945-84" aria-hidden="true" tabindex="-1"></a>    x_val <span class="op">=</span> path[frame, <span class="dv">0</span>]</span>
<span id="4f484945-85"><a href="#4f484945-85" aria-hidden="true" tabindex="-1"></a>    y_val <span class="op">=</span> path[frame, <span class="dv">1</span>]</span>
<span id="4f484945-86"><a href="#4f484945-86" aria-hidden="true" tabindex="-1"></a>    z_val <span class="op">=</span> path[frame, <span class="dv">2</span>]</span>
<span id="4f484945-87"><a href="#4f484945-87" aria-hidden="true" tabindex="-1"></a>    point.set_data([x_val], [y_val])</span>
<span id="4f484945-88"><a href="#4f484945-88" aria-hidden="true" tabindex="-1"></a>    point.set_3d_properties([z_val])</span>
<span id="4f484945-89"><a href="#4f484945-89" aria-hidden="true" tabindex="-1"></a>    line.set_data(path[: frame <span class="op">+</span> <span class="dv">1</span>, <span class="dv">0</span>], path[: frame <span class="op">+</span> <span class="dv">1</span>, <span class="dv">1</span>])</span>
<span id="4f484945-90"><a href="#4f484945-90" aria-hidden="true" tabindex="-1"></a>    line.set_3d_properties(path[: frame <span class="op">+</span> <span class="dv">1</span>, <span class="dv">2</span>])</span>
<span id="4f484945-91"><a href="#4f484945-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="4f484945-92"><a href="#4f484945-92" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> point, line</span>
<span id="4f484945-93"><a href="#4f484945-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="4f484945-94"><a href="#4f484945-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="4f484945-95"><a href="#4f484945-95" aria-hidden="true" tabindex="-1"></a>ani <span class="op">=</span> FuncAnimation(</span>
<span id="4f484945-96"><a href="#4f484945-96" aria-hidden="true" tabindex="-1"></a>    fig, update, frames<span class="op">=</span>num_frames, init_func<span class="op">=</span>init, interval<span class="op">=</span><span class="dv">100</span>, blit<span class="op">=</span><span class="va">True</span></span>
<span id="4f484945-97"><a href="#4f484945-97" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="4f484945-98"><a href="#4f484945-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="4f484945-99"><a href="#4f484945-99" aria-hidden="true" tabindex="-1"></a>ani.save(<span class="st">"adam_rosenbrock.mp4"</span>, writer<span class="op">=</span><span class="st">"ffmpeg"</span>, fps<span class="op">=</span><span class="dv">48</span>)</span>
<span id="4f484945-100"><a href="#4f484945-100" aria-hidden="true" tabindex="-1"></a>plt.close(fig)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Adam uses adaptive learning rates for each parameter, which can help it converge faster than traditional gradient descent methods. This is why in the animation you see the optimizer move at different speeds in different directions. The slower the convergence, the more the optimizer is “exploring” the landscape to find the optimal path to the global minimum. This adaptability is one of the key strengths of Adam, as it can handle different learning rates for each parameter, making it more robust to various optimisation problems.</p>
<video width="100%" controls="">
<source src="adam_rosenbrock.mp4" type="video/mp4">
Your browser does not support the video tag.

</video>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
The mathematics of Adam
</div>
</div>
<div class="callout-body-container callout-body">
<p>Adam (Adaptive Moment Estimation) combines ideas from momentum and <a href="https://optimization.cbe.cornell.edu/index.php?title=RMSProp">:link RMSProp</a> to adaptively adjust the learning rates of model parameters. At its core, Adam computes two moving averages: one for the gradients (the first moment) and one for the squared gradients (the second moment). Given the gradient <span class="math inline">\(g_t\)</span> at iteration <span class="math inline">\(t\)</span>, these are updated as:</p>
<p><span class="math display">\[
m_t = \beta_1 m_{t-1} + (1-\beta_1) g_t
\]</span></p>
<p><span class="math display">\[
v_t = \beta_2 v_{t-1} + (1-\beta_2) g_t^2
\]</span></p>
<p>Here, <span class="math inline">\(\beta_1\)</span> and <span class="math inline">\(\beta_2\)</span> are decay rates (typically around 0.9 and 0.999, respectively) that determine how much of the past gradients and squared gradients are retained.</p>
<p>Since the moving averages <span class="math inline">\(m_t\)</span> and <span class="math inline">\(v_t\)</span> are initialized at zero, they are biased toward zero in the initial steps. To correct this bias, Adam computes bias-corrected estimates:</p>
<p><span class="math display">\[
\hat{m}_t = \frac{m_t}{1 - \beta_1^t}
\]</span></p>
<p><span class="math display">\[
\hat{v}_t = \frac{v_t}{1 - \beta_2^t}
\]</span></p>
<p>Finally, the parameters ( ) are updated using these bias-corrected estimates according to the rule:</p>
<p><span class="math display">\[
\theta_{t+1} = \theta_t - \alpha \frac{\hat{m}_t}{\sqrt{\hat{v}_t} + \epsilon}
\]</span></p>
<p>In this formula, <span class="math inline">\(\alpha\)</span> is the learning rate and <span class="math inline">\(\epsilon\)</span> is a small constant (such as <span class="math inline">\(10^{-8}\)</span>) to avoid division by zero. This update rule allows Adam to automatically adjust the step size for each parameter, effectively handling sparse gradients and noisy objectives, which often results in faster convergence and improved performance over traditional stochastic gradient descent methods.</p>
</div>
</div>
</section>
<section id="teaching-a-neural-network-to-paint-with-adam" class="level2">
<h2 class="anchored" data-anchor-id="teaching-a-neural-network-to-paint-with-adam">Teaching a neural network to paint with Adam</h2>
<p>Another great way to show Adam in action is by training a neural network to paint an image. We’ll use a simple Multi-Layer Perceptron (MLP) and a more advanced architecture called <a href="https://arxiv.org/abs/2006.09661">:link Sinusoidal Representation Networks (SIREN)</a> to illustrate this. The goal is to predict the RGB values of each pixel in an image based on its spatial coordinates. We’ll my favourite painting, “The Arnolfini Portrait” by Jan van Eyck as our target image.</p>
<p>First we need to setup a few hyperparameters and load the image. We are setting up a network with 4 hidden layers, each with 512 hidden units. We’ll train the model, saving display frames every 100 epochs and animation frames every 10 epochs. We’ll use the Adam optimizer with a learning rate of <span class="math inline">\(10^{-4}\)</span> and early stopping patience of 500 epochs.</p>
<div id="f7e697eb" class="cell" data-execution_count="2">
<details class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="f7e697eb"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="f7e697eb-1"><a href="#f7e697eb-1" aria-hidden="true" tabindex="-1"></a>image_path <span class="op">=</span> <span class="st">"The_Arnolfini_portrait.jpg"</span></span>
<span id="f7e697eb-2"><a href="#f7e697eb-2" aria-hidden="true" tabindex="-1"></a>num_epochs <span class="op">=</span> <span class="dv">30000</span></span>
<span id="f7e697eb-3"><a href="#f7e697eb-3" aria-hidden="true" tabindex="-1"></a>display_interval <span class="op">=</span> <span class="dv">1000</span></span>
<span id="f7e697eb-4"><a href="#f7e697eb-4" aria-hidden="true" tabindex="-1"></a>animation_interval <span class="op">=</span> <span class="dv">20</span></span>
<span id="f7e697eb-5"><a href="#f7e697eb-5" aria-hidden="true" tabindex="-1"></a>learning_rate <span class="op">=</span> <span class="fl">1e-4</span></span>
<span id="f7e697eb-6"><a href="#f7e697eb-6" aria-hidden="true" tabindex="-1"></a>create_animation <span class="op">=</span> <span class="va">True</span></span>
<span id="f7e697eb-7"><a href="#f7e697eb-7" aria-hidden="true" tabindex="-1"></a>patience <span class="op">=</span> <span class="dv">500</span></span>
<span id="f7e697eb-8"><a href="#f7e697eb-8" aria-hidden="true" tabindex="-1"></a>hidden_features <span class="op">=</span> <span class="dv">512</span></span>
<span id="f7e697eb-9"><a href="#f7e697eb-9" aria-hidden="true" tabindex="-1"></a>hidden_layers <span class="op">=</span> <span class="dv">4</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Let us load the image and display it to see what the model is working with.</p>
<div id="3ea38964" class="cell" data-execution_count="3">
<details class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="3ea38964"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="3ea38964-1"><a href="#3ea38964-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="3ea38964-2"><a href="#3ea38964-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="3ea38964-3"><a href="#3ea38964-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> PIL <span class="im">import</span> Image</span>
<span id="3ea38964-4"><a href="#3ea38964-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="3ea38964-5"><a href="#3ea38964-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="3ea38964-6"><a href="#3ea38964-6" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> load_and_preprocess_image(image_path):</span>
<span id="3ea38964-7"><a href="#3ea38964-7" aria-hidden="true" tabindex="-1"></a>    img <span class="op">=</span> Image.<span class="bu">open</span>(image_path).convert(<span class="st">"RGB"</span>)</span>
<span id="3ea38964-8"><a href="#3ea38964-8" aria-hidden="true" tabindex="-1"></a>    img <span class="op">=</span> np.array(img) <span class="op">/</span> <span class="fl">255.0</span></span>
<span id="3ea38964-9"><a href="#3ea38964-9" aria-hidden="true" tabindex="-1"></a>    H, W, _ <span class="op">=</span> img.shape</span>
<span id="3ea38964-10"><a href="#3ea38964-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> img, H, W</span>
<span id="3ea38964-11"><a href="#3ea38964-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="3ea38964-12"><a href="#3ea38964-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="3ea38964-13"><a href="#3ea38964-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Load and display image</span></span>
<span id="3ea38964-14"><a href="#3ea38964-14" aria-hidden="true" tabindex="-1"></a>img, H, W <span class="op">=</span> load_and_preprocess_image(image_path)</span>
<span id="3ea38964-15"><a href="#3ea38964-15" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Image shape: </span><span class="sc">{</span>img<span class="sc">.</span>shape<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="3ea38964-16"><a href="#3ea38964-16" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="dv">8</span>))</span>
<span id="3ea38964-17"><a href="#3ea38964-17" aria-hidden="true" tabindex="-1"></a>plt.imshow(img)</span>
<span id="3ea38964-18"><a href="#3ea38964-18" aria-hidden="true" tabindex="-1"></a>plt.axis(<span class="st">"off"</span>)</span>
<span id="3ea38964-19"><a href="#3ea38964-19" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Image shape: (800, 585, 3)</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><a href="index_files/figure-html/cell-4-output-2.png" class="lightbox" data-gallery="quarto-lightbox-gallery-1"><img src="index_files/figure-html/cell-4-output-2.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<p>In my case, I am using Apple Silicon to run this code, so we check for the presence of MPS so PyTorch uses the GPU. If you are running this on a different platform, you may need to adjust the device accordingly.</p>
<div id="6df74973" class="cell" data-execution_count="4">
<details class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="6df74973"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="6df74973-1"><a href="#6df74973-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch</span>
<span id="6df74973-2"><a href="#6df74973-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="6df74973-3"><a href="#6df74973-3" aria-hidden="true" tabindex="-1"></a>device <span class="op">=</span> torch.device(<span class="st">"mps"</span> <span class="cf">if</span> torch.backends.mps.is_available() <span class="cf">else</span> <span class="st">"cpu"</span>)</span>
<span id="6df74973-4"><a href="#6df74973-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Using device: </span><span class="sc">{</span>device<span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Using device: mps</code></pre>
</div>
</div>
<p>We also need to create a coordinate grid that represents the spatial coordinates of each pixel in the image. This grid will be the input to our neural network, and the target will be the RGB values of the corresponding pixels in the image. We’ll use the coordinate grid to train the model to predict the RGB values based on spatial location.</p>
<p>This grid looks as the following, notice that the image is inverted in the <em>y</em>-axis compared to the usual image representation. This is because the origin <span class="math inline">\((0,0)\)</span> is at the top-left corner in the image, while in the Cartesian coordinate system it is at the bottom-left corner.</p>
<div id="02d89e09" class="cell" data-execution_count="5">
<details class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="02d89e09"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="02d89e09-1"><a href="#02d89e09-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> create_coordinate_grid(H, W, device):</span>
<span id="02d89e09-2"><a href="#02d89e09-2" aria-hidden="true" tabindex="-1"></a>    x <span class="op">=</span> np.linspace(<span class="dv">0</span>, <span class="dv">1</span>, W)</span>
<span id="02d89e09-3"><a href="#02d89e09-3" aria-hidden="true" tabindex="-1"></a>    y <span class="op">=</span> np.linspace(<span class="dv">0</span>, <span class="dv">1</span>, H)</span>
<span id="02d89e09-4"><a href="#02d89e09-4" aria-hidden="true" tabindex="-1"></a>    xx, yy <span class="op">=</span> np.meshgrid(x, y)</span>
<span id="02d89e09-5"><a href="#02d89e09-5" aria-hidden="true" tabindex="-1"></a>    coords <span class="op">=</span> np.stack([xx, yy], axis<span class="op">=-</span><span class="dv">1</span>).reshape(<span class="op">-</span><span class="dv">1</span>, <span class="dv">2</span>)</span>
<span id="02d89e09-6"><a href="#02d89e09-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> torch.FloatTensor(coords).to(device)</span>
<span id="02d89e09-7"><a href="#02d89e09-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="02d89e09-8"><a href="#02d89e09-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="02d89e09-9"><a href="#02d89e09-9" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> create_target_tensor(img, device):</span>
<span id="02d89e09-10"><a href="#02d89e09-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> torch.FloatTensor(img.reshape(<span class="op">-</span><span class="dv">1</span>, <span class="dv">3</span>)).to(device)</span>
<span id="02d89e09-11"><a href="#02d89e09-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="02d89e09-12"><a href="#02d89e09-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="02d89e09-13"><a href="#02d89e09-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Prepare coordinate grid and target tensor</span></span>
<span id="02d89e09-14"><a href="#02d89e09-14" aria-hidden="true" tabindex="-1"></a>coords <span class="op">=</span> create_coordinate_grid(H, W, device)</span>
<span id="02d89e09-15"><a href="#02d89e09-15" aria-hidden="true" tabindex="-1"></a>target <span class="op">=</span> create_target_tensor(img, device)</span>
<span id="02d89e09-16"><a href="#02d89e09-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="02d89e09-17"><a href="#02d89e09-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot coordinate grid and target tensor</span></span>
<span id="02d89e09-18"><a href="#02d89e09-18" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="dv">8</span>))</span>
<span id="02d89e09-19"><a href="#02d89e09-19" aria-hidden="true" tabindex="-1"></a>plt.scatter(coords.cpu()[:, <span class="dv">0</span>], coords.cpu()[:, <span class="dv">1</span>], s<span class="op">=</span><span class="dv">1</span>, c<span class="op">=</span>target.cpu())</span>
<span id="02d89e09-20"><a href="#02d89e09-20" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><a href="index_files/figure-html/cell-6-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-2"><img src="index_files/figure-html/cell-6-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<p>We also need to create directories to store the display and animation frames, this way we don’t have to store all the frames in memory. We’ll use these to save the model’s predictions at different epochs during training, which we will later use to create an animation of the training process.</p>
<div id="2fc3f854" class="cell" data-execution_count="6">
<details class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="2fc3f854"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="2fc3f854-1"><a href="#2fc3f854-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="2fc3f854-2"><a href="#2fc3f854-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="2fc3f854-3"><a href="#2fc3f854-3" aria-hidden="true" tabindex="-1"></a>display_dir <span class="op">=</span> <span class="st">"display_frames"</span></span>
<span id="2fc3f854-4"><a href="#2fc3f854-4" aria-hidden="true" tabindex="-1"></a>anim_dir <span class="op">=</span> <span class="st">"animation_frames"</span></span>
<span id="2fc3f854-5"><a href="#2fc3f854-5" aria-hidden="true" tabindex="-1"></a>os.makedirs(display_dir, exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="2fc3f854-6"><a href="#2fc3f854-6" aria-hidden="true" tabindex="-1"></a>os.makedirs(anim_dir, exist_ok<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<section id="the-model" class="level3">
<h3 class="anchored" data-anchor-id="the-model">The model</h3>
<p>As mentioned before, we will use a Multi-Layer Perceptron (MLP) model. It features an input layer that accepts <span class="math inline">\((x,y)\)</span> coordinates, three hidden layers with <a href="https://en.wikipedia.org/wiki/Rectifier_(neural_networks)">:link ReLU</a> activation functions, and an output layer that produces the predicted RGB values. While an MLP is a basic neural network that may not capture complex spatial patterns as well as more advanced architectures, this very limitation helps visually highlight the optimizer’s struggle to learn the image, and how Adam adapts as it traverses the loss landscape.</p>
<div id="8cc9591f" class="cell" data-execution_count="7">
<details class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="8cc9591f"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="8cc9591f-1"><a href="#8cc9591f-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> torch <span class="im">import</span> nn</span>
<span id="8cc9591f-2"><a href="#8cc9591f-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="8cc9591f-3"><a href="#8cc9591f-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="8cc9591f-4"><a href="#8cc9591f-4" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> MLP(nn.Module):</span>
<span id="8cc9591f-5"><a href="#8cc9591f-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(</span>
<span id="8cc9591f-6"><a href="#8cc9591f-6" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>, in_features<span class="op">=</span><span class="dv">2</span>, hidden_features<span class="op">=</span><span class="dv">512</span>, hidden_layers<span class="op">=</span><span class="dv">3</span>, out_features<span class="op">=</span><span class="dv">3</span></span>
<span id="8cc9591f-7"><a href="#8cc9591f-7" aria-hidden="true" tabindex="-1"></a>    ):</span>
<span id="8cc9591f-8"><a href="#8cc9591f-8" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>(MLP, <span class="va">self</span>).<span class="fu">__init__</span>()</span>
<span id="8cc9591f-9"><a href="#8cc9591f-9" aria-hidden="true" tabindex="-1"></a>        layers <span class="op">=</span> [nn.Linear(in_features, hidden_features), nn.ReLU()]</span>
<span id="8cc9591f-10"><a href="#8cc9591f-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> _ <span class="kw">in</span> <span class="bu">range</span>(hidden_layers):</span>
<span id="8cc9591f-11"><a href="#8cc9591f-11" aria-hidden="true" tabindex="-1"></a>            layers.append(nn.Linear(hidden_features, hidden_features))</span>
<span id="8cc9591f-12"><a href="#8cc9591f-12" aria-hidden="true" tabindex="-1"></a>            layers.append(nn.ReLU())</span>
<span id="8cc9591f-13"><a href="#8cc9591f-13" aria-hidden="true" tabindex="-1"></a>        layers.append(nn.Linear(hidden_features, out_features))</span>
<span id="8cc9591f-14"><a href="#8cc9591f-14" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.net <span class="op">=</span> nn.Sequential(<span class="op">*</span>layers)</span>
<span id="8cc9591f-15"><a href="#8cc9591f-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="8cc9591f-16"><a href="#8cc9591f-16" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> forward(<span class="va">self</span>, x):</span>
<span id="8cc9591f-17"><a href="#8cc9591f-17" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>.net(x)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Note the model doesn’t have enough parameters to fully memorize the image and will struggle to capture the details of the painting pixel by pixel. This limitation will be evident in the animation, where the model’s predictions will be a blurry approximation of the original image. You can think of it as the model having to compress information into a lower-dimensional space and then reconstruct it, losing detail in the process. To produce an image that closely resembles the original, we would need a more complex architecture, a different approach, or lots of epochs to capture enough detail.</p>
<div id="fe5ee71e" class="cell" data-execution_count="8">
<details class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="fe5ee71e"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="fe5ee71e-1"><a href="#fe5ee71e-1" aria-hidden="true" tabindex="-1"></a>model_mlp <span class="op">=</span> MLP(</span>
<span id="fe5ee71e-2"><a href="#fe5ee71e-2" aria-hidden="true" tabindex="-1"></a>    in_features<span class="op">=</span><span class="dv">2</span>,</span>
<span id="fe5ee71e-3"><a href="#fe5ee71e-3" aria-hidden="true" tabindex="-1"></a>    hidden_features<span class="op">=</span>hidden_features,</span>
<span id="fe5ee71e-4"><a href="#fe5ee71e-4" aria-hidden="true" tabindex="-1"></a>    hidden_layers<span class="op">=</span>hidden_layers,</span>
<span id="fe5ee71e-5"><a href="#fe5ee71e-5" aria-hidden="true" tabindex="-1"></a>    out_features<span class="op">=</span><span class="dv">3</span>,</span>
<span id="fe5ee71e-6"><a href="#fe5ee71e-6" aria-hidden="true" tabindex="-1"></a>).to(device)</span>
<span id="fe5ee71e-7"><a href="#fe5ee71e-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="fe5ee71e-8"><a href="#fe5ee71e-8" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(model_mlp)</span>
<span id="fe5ee71e-9"><a href="#fe5ee71e-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(</span>
<span id="fe5ee71e-10"><a href="#fe5ee71e-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Number of parameters:"</span>,</span>
<span id="fe5ee71e-11"><a href="#fe5ee71e-11" aria-hidden="true" tabindex="-1"></a>    <span class="bu">sum</span>(p.numel() <span class="cf">for</span> p <span class="kw">in</span> model_mlp.parameters() <span class="cf">if</span> p.requires_grad),</span>
<span id="fe5ee71e-12"><a href="#fe5ee71e-12" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>MLP(
  (net): Sequential(
    (0): Linear(in_features=2, out_features=512, bias=True)
    (1): ReLU()
    (2): Linear(in_features=512, out_features=512, bias=True)
    (3): ReLU()
    (4): Linear(in_features=512, out_features=512, bias=True)
    (5): ReLU()
    (6): Linear(in_features=512, out_features=512, bias=True)
    (7): ReLU()
    (8): Linear(in_features=512, out_features=512, bias=True)
    (9): ReLU()
    (10): Linear(in_features=512, out_features=3, bias=True)
  )
)
Number of parameters: 1053699</code></pre>
</div>
</div>
<p>Finally we define the Adam optimiser and the Mean Squared Error (MSE) loss function. Remember the optimiser is responsible for updating the model’s parameters towards minimizing the loss function, while the MSE loss measures the difference between the model’s predictions and the target values (the original pixels), which we aim to minimize during training.</p>
<div id="869e7c2b" class="cell" data-execution_count="9">
<details class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="869e7c2b"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="869e7c2b-1"><a href="#869e7c2b-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch.optim <span class="im">as</span> optim</span>
<span id="869e7c2b-2"><a href="#869e7c2b-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="869e7c2b-3"><a href="#869e7c2b-3" aria-hidden="true" tabindex="-1"></a>optimizer <span class="op">=</span> optim.Adam(model_mlp.parameters(), lr<span class="op">=</span>learning_rate)</span>
<span id="869e7c2b-4"><a href="#869e7c2b-4" aria-hidden="true" tabindex="-1"></a>criterion <span class="op">=</span> nn.MSELoss()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>With this out of the way, let us train the model and save the display and animation frames. We’ll also implement early stopping based on the <code>patience</code> hyper-parameter, which stops training if the loss does not improve for a certain number of epochs. If you decide to try this yourself, keep in mind that depending on your hardware, training may take a while (hours) due to the necessary large number of epochs and the complexity of the model.</p>
<div id="1022a79c" class="cell" data-execution_count="10">
<details class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="1022a79c"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="1022a79c-1"><a href="#1022a79c-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tqdm.notebook <span class="im">import</span> tqdm</span>
<span id="1022a79c-2"><a href="#1022a79c-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="1022a79c-3"><a href="#1022a79c-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="1022a79c-4"><a href="#1022a79c-4" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> save_frame(frame, folder, prefix, epoch):</span>
<span id="1022a79c-5"><a href="#1022a79c-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Save a frame (as an image) to the given folder."""</span></span>
<span id="1022a79c-6"><a href="#1022a79c-6" aria-hidden="true" tabindex="-1"></a>    frame_path <span class="op">=</span> os.path.join(folder, <span class="ss">f"</span><span class="sc">{</span>prefix<span class="sc">}</span><span class="ss">_</span><span class="sc">{</span>epoch<span class="sc">:04d}</span><span class="ss">.png"</span>)</span>
<span id="1022a79c-7"><a href="#1022a79c-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># If frame is grayscale, use cmap; otherwise, display as color</span></span>
<span id="1022a79c-8"><a href="#1022a79c-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> frame.ndim <span class="op">==</span> <span class="dv">2</span> <span class="kw">or</span> frame.shape[<span class="op">-</span><span class="dv">1</span>] <span class="op">==</span> <span class="dv">1</span>:</span>
<span id="1022a79c-9"><a href="#1022a79c-9" aria-hidden="true" tabindex="-1"></a>        plt.imsave(frame_path, frame.astype(np.float32), cmap<span class="op">=</span><span class="st">"gray"</span>)</span>
<span id="1022a79c-10"><a href="#1022a79c-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="1022a79c-11"><a href="#1022a79c-11" aria-hidden="true" tabindex="-1"></a>        plt.imsave(frame_path, frame.astype(np.float32))</span>
<span id="1022a79c-12"><a href="#1022a79c-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="1022a79c-13"><a href="#1022a79c-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="1022a79c-14"><a href="#1022a79c-14" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> train_model(</span>
<span id="1022a79c-15"><a href="#1022a79c-15" aria-hidden="true" tabindex="-1"></a>    model,</span>
<span id="1022a79c-16"><a href="#1022a79c-16" aria-hidden="true" tabindex="-1"></a>    coords,</span>
<span id="1022a79c-17"><a href="#1022a79c-17" aria-hidden="true" tabindex="-1"></a>    target,</span>
<span id="1022a79c-18"><a href="#1022a79c-18" aria-hidden="true" tabindex="-1"></a>    H,</span>
<span id="1022a79c-19"><a href="#1022a79c-19" aria-hidden="true" tabindex="-1"></a>    W,</span>
<span id="1022a79c-20"><a href="#1022a79c-20" aria-hidden="true" tabindex="-1"></a>    num_epochs,</span>
<span id="1022a79c-21"><a href="#1022a79c-21" aria-hidden="true" tabindex="-1"></a>    display_interval,</span>
<span id="1022a79c-22"><a href="#1022a79c-22" aria-hidden="true" tabindex="-1"></a>    animation_interval,</span>
<span id="1022a79c-23"><a href="#1022a79c-23" aria-hidden="true" tabindex="-1"></a>    patience,</span>
<span id="1022a79c-24"><a href="#1022a79c-24" aria-hidden="true" tabindex="-1"></a>    optimizer,</span>
<span id="1022a79c-25"><a href="#1022a79c-25" aria-hidden="true" tabindex="-1"></a>    criterion,</span>
<span id="1022a79c-26"><a href="#1022a79c-26" aria-hidden="true" tabindex="-1"></a>    display_dir,</span>
<span id="1022a79c-27"><a href="#1022a79c-27" aria-hidden="true" tabindex="-1"></a>    anim_dir,</span>
<span id="1022a79c-28"><a href="#1022a79c-28" aria-hidden="true" tabindex="-1"></a>    create_animation,</span>
<span id="1022a79c-29"><a href="#1022a79c-29" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="1022a79c-30"><a href="#1022a79c-30" aria-hidden="true" tabindex="-1"></a>    best_loss <span class="op">=</span> <span class="bu">float</span>(<span class="st">"inf"</span>)</span>
<span id="1022a79c-31"><a href="#1022a79c-31" aria-hidden="true" tabindex="-1"></a>    patience_counter <span class="op">=</span> <span class="dv">0</span></span>
<span id="1022a79c-32"><a href="#1022a79c-32" aria-hidden="true" tabindex="-1"></a>    display_epochs <span class="op">=</span> []</span>
<span id="1022a79c-33"><a href="#1022a79c-33" aria-hidden="true" tabindex="-1"></a>    display_losses <span class="op">=</span> []</span>
<span id="1022a79c-34"><a href="#1022a79c-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="1022a79c-35"><a href="#1022a79c-35" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> epoch <span class="kw">in</span> tqdm(<span class="bu">range</span>(num_epochs), desc<span class="op">=</span><span class="st">"Training"</span>):</span>
<span id="1022a79c-36"><a href="#1022a79c-36" aria-hidden="true" tabindex="-1"></a>        optimizer.zero_grad()</span>
<span id="1022a79c-37"><a href="#1022a79c-37" aria-hidden="true" tabindex="-1"></a>        pred <span class="op">=</span> model(coords)</span>
<span id="1022a79c-38"><a href="#1022a79c-38" aria-hidden="true" tabindex="-1"></a>        loss <span class="op">=</span> criterion(pred, target)</span>
<span id="1022a79c-39"><a href="#1022a79c-39" aria-hidden="true" tabindex="-1"></a>        loss.backward()</span>
<span id="1022a79c-40"><a href="#1022a79c-40" aria-hidden="true" tabindex="-1"></a>        optimizer.step()</span>
<span id="1022a79c-41"><a href="#1022a79c-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="1022a79c-42"><a href="#1022a79c-42" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> loss.item() <span class="op">&lt;</span> best_loss:</span>
<span id="1022a79c-43"><a href="#1022a79c-43" aria-hidden="true" tabindex="-1"></a>            best_loss <span class="op">=</span> loss.item()</span>
<span id="1022a79c-44"><a href="#1022a79c-44" aria-hidden="true" tabindex="-1"></a>            patience_counter <span class="op">=</span> <span class="dv">0</span></span>
<span id="1022a79c-45"><a href="#1022a79c-45" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="1022a79c-46"><a href="#1022a79c-46" aria-hidden="true" tabindex="-1"></a>            patience_counter <span class="op">+=</span> <span class="dv">1</span></span>
<span id="1022a79c-47"><a href="#1022a79c-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="1022a79c-48"><a href="#1022a79c-48" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> patience_counter <span class="op">&gt;=</span> patience:</span>
<span id="1022a79c-49"><a href="#1022a79c-49" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"Early stopping at epoch </span><span class="sc">{</span>epoch<span class="sc">}</span><span class="ss">, best loss: </span><span class="sc">{</span>best_loss<span class="sc">:.6f}</span><span class="ss">"</span>)</span>
<span id="1022a79c-50"><a href="#1022a79c-50" aria-hidden="true" tabindex="-1"></a>            <span class="cf">break</span></span>
<span id="1022a79c-51"><a href="#1022a79c-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="1022a79c-52"><a href="#1022a79c-52" aria-hidden="true" tabindex="-1"></a>        <span class="cf">with</span> torch.no_grad():</span>
<span id="1022a79c-53"><a href="#1022a79c-53" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Reshape prediction to (H, W, 3) for a color image</span></span>
<span id="1022a79c-54"><a href="#1022a79c-54" aria-hidden="true" tabindex="-1"></a>            pred_img <span class="op">=</span> pred.detach().cpu().numpy().astype(np.float16).reshape(H, W, <span class="dv">3</span>)</span>
<span id="1022a79c-55"><a href="#1022a79c-55" aria-hidden="true" tabindex="-1"></a>            frame <span class="op">=</span> np.clip(pred_img, <span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="1022a79c-56"><a href="#1022a79c-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="1022a79c-57"><a href="#1022a79c-57" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> create_animation <span class="kw">and</span> epoch <span class="op">%</span> animation_interval <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="1022a79c-58"><a href="#1022a79c-58" aria-hidden="true" tabindex="-1"></a>                save_frame(frame, anim_dir, <span class="st">"frame"</span>, epoch)</span>
<span id="1022a79c-59"><a href="#1022a79c-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="1022a79c-60"><a href="#1022a79c-60" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> epoch <span class="op">%</span> display_interval <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="1022a79c-61"><a href="#1022a79c-61" aria-hidden="true" tabindex="-1"></a>                save_frame(frame, display_dir, <span class="st">"display"</span>, epoch)</span>
<span id="1022a79c-62"><a href="#1022a79c-62" aria-hidden="true" tabindex="-1"></a>                display_epochs.append(epoch)</span>
<span id="1022a79c-63"><a href="#1022a79c-63" aria-hidden="true" tabindex="-1"></a>                display_losses.append(loss.item())</span>
<span id="1022a79c-64"><a href="#1022a79c-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="1022a79c-65"><a href="#1022a79c-65" aria-hidden="true" tabindex="-1"></a>        <span class="kw">del</span> pred</span>
<span id="1022a79c-66"><a href="#1022a79c-66" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> best_loss, display_epochs, display_losses</span>
<span id="1022a79c-67"><a href="#1022a79c-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="1022a79c-68"><a href="#1022a79c-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="1022a79c-69"><a href="#1022a79c-69" aria-hidden="true" tabindex="-1"></a>best_loss_mlp, display_epochs_mlp, display_losses_mlp <span class="op">=</span> train_model(</span>
<span id="1022a79c-70"><a href="#1022a79c-70" aria-hidden="true" tabindex="-1"></a>    model_mlp,</span>
<span id="1022a79c-71"><a href="#1022a79c-71" aria-hidden="true" tabindex="-1"></a>    coords,</span>
<span id="1022a79c-72"><a href="#1022a79c-72" aria-hidden="true" tabindex="-1"></a>    target,</span>
<span id="1022a79c-73"><a href="#1022a79c-73" aria-hidden="true" tabindex="-1"></a>    H,</span>
<span id="1022a79c-74"><a href="#1022a79c-74" aria-hidden="true" tabindex="-1"></a>    W,</span>
<span id="1022a79c-75"><a href="#1022a79c-75" aria-hidden="true" tabindex="-1"></a>    num_epochs,</span>
<span id="1022a79c-76"><a href="#1022a79c-76" aria-hidden="true" tabindex="-1"></a>    display_interval,</span>
<span id="1022a79c-77"><a href="#1022a79c-77" aria-hidden="true" tabindex="-1"></a>    animation_interval,</span>
<span id="1022a79c-78"><a href="#1022a79c-78" aria-hidden="true" tabindex="-1"></a>    patience,</span>
<span id="1022a79c-79"><a href="#1022a79c-79" aria-hidden="true" tabindex="-1"></a>    optimizer,</span>
<span id="1022a79c-80"><a href="#1022a79c-80" aria-hidden="true" tabindex="-1"></a>    criterion,</span>
<span id="1022a79c-81"><a href="#1022a79c-81" aria-hidden="true" tabindex="-1"></a>    display_dir,</span>
<span id="1022a79c-82"><a href="#1022a79c-82" aria-hidden="true" tabindex="-1"></a>    anim_dir,</span>
<span id="1022a79c-83"><a href="#1022a79c-83" aria-hidden="true" tabindex="-1"></a>    create_animation,</span>
<span id="1022a79c-84"><a href="#1022a79c-84" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"5189dac430124753bed44ef22bb804ef","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
</div>
<p>With the training complete, we can display the saved frames to get a sense of how the model’s predictions evolved over time. They show the model’s output at different epochs, with the epoch number and loss value displayed with each image. This visualisation helps us understand how the model learns to approximate the original image pixel by pixel.</p>
<div id="76d0df4f" class="cell" data-execution_count="11">
<details class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="76d0df4f"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="76d0df4f-1"><a href="#76d0df4f-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> glob</span>
<span id="76d0df4f-2"><a href="#76d0df4f-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> math</span>
<span id="76d0df4f-3"><a href="#76d0df4f-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> re</span>
<span id="76d0df4f-4"><a href="#76d0df4f-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="76d0df4f-5"><a href="#76d0df4f-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="76d0df4f-6"><a href="#76d0df4f-6" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> extract_number(f):</span>
<span id="76d0df4f-7"><a href="#76d0df4f-7" aria-hidden="true" tabindex="-1"></a>    s <span class="op">=</span> os.path.basename(f)</span>
<span id="76d0df4f-8"><a href="#76d0df4f-8" aria-hidden="true" tabindex="-1"></a>    match <span class="op">=</span> re.search(<span class="vs">r"(\d+)"</span>, s)</span>
<span id="76d0df4f-9"><a href="#76d0df4f-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="bu">int</span>(match.group(<span class="dv">1</span>)) <span class="cf">if</span> match <span class="cf">else</span> <span class="op">-</span><span class="dv">1</span></span>
<span id="76d0df4f-10"><a href="#76d0df4f-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="76d0df4f-11"><a href="#76d0df4f-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="76d0df4f-12"><a href="#76d0df4f-12" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> grid_display(display_dir, display_epochs, display_losses, num_cols<span class="op">=</span><span class="dv">5</span>):</span>
<span id="76d0df4f-13"><a href="#76d0df4f-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Use the custom key for natural sorting of filenames</span></span>
<span id="76d0df4f-14"><a href="#76d0df4f-14" aria-hidden="true" tabindex="-1"></a>    display_files <span class="op">=</span> <span class="bu">sorted</span>(</span>
<span id="76d0df4f-15"><a href="#76d0df4f-15" aria-hidden="true" tabindex="-1"></a>        glob.glob(os.path.join(display_dir, <span class="st">"*.png"</span>)), key<span class="op">=</span>extract_number</span>
<span id="76d0df4f-16"><a href="#76d0df4f-16" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="76d0df4f-17"><a href="#76d0df4f-17" aria-hidden="true" tabindex="-1"></a>    num_images <span class="op">=</span> <span class="bu">len</span>(display_files)</span>
<span id="76d0df4f-18"><a href="#76d0df4f-18" aria-hidden="true" tabindex="-1"></a>    num_rows <span class="op">=</span> math.ceil(num_images <span class="op">/</span> num_cols)</span>
<span id="76d0df4f-19"><a href="#76d0df4f-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="76d0df4f-20"><a href="#76d0df4f-20" aria-hidden="true" tabindex="-1"></a>    fig, axes <span class="op">=</span> plt.subplots(num_rows, num_cols, figsize<span class="op">=</span>(num_cols <span class="op">*</span> <span class="dv">3</span>, num_rows <span class="op">*</span> <span class="dv">3</span>))</span>
<span id="76d0df4f-21"><a href="#76d0df4f-21" aria-hidden="true" tabindex="-1"></a>    axes <span class="op">=</span> axes.flatten() <span class="cf">if</span> num_images <span class="op">&gt;</span> <span class="dv">1</span> <span class="cf">else</span> [axes]</span>
<span id="76d0df4f-22"><a href="#76d0df4f-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i, ax <span class="kw">in</span> <span class="bu">enumerate</span>(axes):</span>
<span id="76d0df4f-23"><a href="#76d0df4f-23" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> i <span class="op">&lt;</span> num_images:</span>
<span id="76d0df4f-24"><a href="#76d0df4f-24" aria-hidden="true" tabindex="-1"></a>            img_disp <span class="op">=</span> plt.imread(display_files[i])</span>
<span id="76d0df4f-25"><a href="#76d0df4f-25" aria-hidden="true" tabindex="-1"></a>            ax.imshow(</span>
<span id="76d0df4f-26"><a href="#76d0df4f-26" aria-hidden="true" tabindex="-1"></a>                img_disp <span class="cf">if</span> img_disp.ndim <span class="op">==</span> <span class="dv">3</span> <span class="cf">else</span> img_disp,</span>
<span id="76d0df4f-27"><a href="#76d0df4f-27" aria-hidden="true" tabindex="-1"></a>                cmap<span class="op">=</span><span class="va">None</span> <span class="cf">if</span> img_disp.ndim <span class="op">==</span> <span class="dv">3</span> <span class="cf">else</span> <span class="st">"gray"</span>,</span>
<span id="76d0df4f-28"><a href="#76d0df4f-28" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="76d0df4f-29"><a href="#76d0df4f-29" aria-hidden="true" tabindex="-1"></a>            ax.set_title(<span class="ss">f"Epoch </span><span class="sc">{</span>display_epochs[i]<span class="sc">}</span><span class="ch">\n</span><span class="ss">Loss: </span><span class="sc">{</span>display_losses[i]<span class="sc">:.6f}</span><span class="ss">"</span>)</span>
<span id="76d0df4f-30"><a href="#76d0df4f-30" aria-hidden="true" tabindex="-1"></a>            ax.axis(<span class="st">"off"</span>)</span>
<span id="76d0df4f-31"><a href="#76d0df4f-31" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="76d0df4f-32"><a href="#76d0df4f-32" aria-hidden="true" tabindex="-1"></a>            ax.axis(<span class="st">"off"</span>)</span>
<span id="76d0df4f-33"><a href="#76d0df4f-33" aria-hidden="true" tabindex="-1"></a>    plt.tight_layout()</span>
<span id="76d0df4f-34"><a href="#76d0df4f-34" aria-hidden="true" tabindex="-1"></a>    plt.show()</span>
<span id="76d0df4f-35"><a href="#76d0df4f-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="76d0df4f-36"><a href="#76d0df4f-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="76d0df4f-37"><a href="#76d0df4f-37" aria-hidden="true" tabindex="-1"></a>grid_display(display_dir, display_epochs_mlp, display_losses_mlp)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><a href="index_files/figure-html/cell-12-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-3"><img src="index_files/figure-html/cell-12-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<div id="debffc65" class="cell" data-execution_count="12">
<details class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="debffc65"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="debffc65-1"><a href="#debffc65-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> cleanup_frames(directory):</span>
<span id="debffc65-2"><a href="#debffc65-2" aria-hidden="true" tabindex="-1"></a>    files <span class="op">=</span> glob.glob(os.path.join(directory, <span class="st">"*.png"</span>))</span>
<span id="debffc65-3"><a href="#debffc65-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="bu">file</span> <span class="kw">in</span> files:</span>
<span id="debffc65-4"><a href="#debffc65-4" aria-hidden="true" tabindex="-1"></a>        os.remove(<span class="bu">file</span>)</span>
<span id="debffc65-5"><a href="#debffc65-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="debffc65-6"><a href="#debffc65-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="debffc65-7"><a href="#debffc65-7" aria-hidden="true" tabindex="-1"></a>cleanup_frames(display_dir)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>To get an even better intuition, let us create an animation which shows predictions at different epochs. This animation will give us a dynamic view of the training process, illustrating how the model’s output evolves over time. We’ll use the <code>imageio</code> library to create an MP4 video from the saved frames.</p>
<div id="abe16648" class="cell" data-execution_count="13">
<details class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="abe16648"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="abe16648-1"><a href="#abe16648-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> PIL <span class="im">import</span> Image, ImageDraw, ImageFont</span>
<span id="abe16648-2"><a href="#abe16648-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> imageio.v2 <span class="im">as</span> imageio</span>
<span id="abe16648-3"><a href="#abe16648-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> glob</span>
<span id="abe16648-4"><a href="#abe16648-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="abe16648-5"><a href="#abe16648-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="abe16648-6"><a href="#abe16648-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="abe16648-7"><a href="#abe16648-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="abe16648-8"><a href="#abe16648-8" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> create_mp4_from_frames(anim_dir, mp4_filename, fps<span class="op">=</span><span class="dv">10</span>):</span>
<span id="abe16648-9"><a href="#abe16648-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Use the custom sort key to ensure natural sorting of filenames</span></span>
<span id="abe16648-10"><a href="#abe16648-10" aria-hidden="true" tabindex="-1"></a>    anim_files <span class="op">=</span> <span class="bu">sorted</span>(glob.glob(os.path.join(anim_dir, <span class="st">"*.png"</span>)), key<span class="op">=</span>extract_number)</span>
<span id="abe16648-11"><a href="#abe16648-11" aria-hidden="true" tabindex="-1"></a>    frames <span class="op">=</span> []</span>
<span id="abe16648-12"><a href="#abe16648-12" aria-hidden="true" tabindex="-1"></a>    font_size <span class="op">=</span> <span class="dv">32</span></span>
<span id="abe16648-13"><a href="#abe16648-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="abe16648-14"><a href="#abe16648-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="abe16648-15"><a href="#abe16648-15" aria-hidden="true" tabindex="-1"></a>        font <span class="op">=</span> ImageFont.truetype(<span class="vs">r"OpenSans-Bold.ttf"</span>, font_size)</span>
<span id="abe16648-16"><a href="#abe16648-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">IOError</span>:</span>
<span id="abe16648-17"><a href="#abe16648-17" aria-hidden="true" tabindex="-1"></a>        font <span class="op">=</span> ImageFont.load_default()</span>
<span id="abe16648-18"><a href="#abe16648-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="abe16648-19"><a href="#abe16648-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="bu">file</span> <span class="kw">in</span> anim_files:</span>
<span id="abe16648-20"><a href="#abe16648-20" aria-hidden="true" tabindex="-1"></a>        base <span class="op">=</span> os.path.basename(<span class="bu">file</span>)</span>
<span id="abe16648-21"><a href="#abe16648-21" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span>:</span>
<span id="abe16648-22"><a href="#abe16648-22" aria-hidden="true" tabindex="-1"></a>            parts <span class="op">=</span> base.split(<span class="st">"_"</span>)</span>
<span id="abe16648-23"><a href="#abe16648-23" aria-hidden="true" tabindex="-1"></a>            iteration <span class="op">=</span> parts[<span class="op">-</span><span class="dv">1</span>].split(<span class="st">"."</span>)[<span class="dv">0</span>]</span>
<span id="abe16648-24"><a href="#abe16648-24" aria-hidden="true" tabindex="-1"></a>        <span class="cf">except</span> <span class="pp">Exception</span>:</span>
<span id="abe16648-25"><a href="#abe16648-25" aria-hidden="true" tabindex="-1"></a>            iteration <span class="op">=</span> <span class="st">"N/A"</span></span>
<span id="abe16648-26"><a href="#abe16648-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="abe16648-27"><a href="#abe16648-27" aria-hidden="true" tabindex="-1"></a>        frame_array <span class="op">=</span> imageio.imread(<span class="bu">file</span>)</span>
<span id="abe16648-28"><a href="#abe16648-28" aria-hidden="true" tabindex="-1"></a>        image <span class="op">=</span> Image.fromarray(frame_array)</span>
<span id="abe16648-29"><a href="#abe16648-29" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Ensure image is in RGB mode for drawing colored text</span></span>
<span id="abe16648-30"><a href="#abe16648-30" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> image.mode <span class="op">!=</span> <span class="st">"RGB"</span>:</span>
<span id="abe16648-31"><a href="#abe16648-31" aria-hidden="true" tabindex="-1"></a>            image <span class="op">=</span> image.convert(<span class="st">"RGB"</span>)</span>
<span id="abe16648-32"><a href="#abe16648-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="abe16648-33"><a href="#abe16648-33" aria-hidden="true" tabindex="-1"></a>        draw <span class="op">=</span> ImageDraw.Draw(image)</span>
<span id="abe16648-34"><a href="#abe16648-34" aria-hidden="true" tabindex="-1"></a>        text <span class="op">=</span> <span class="bu">str</span>(iteration)</span>
<span id="abe16648-35"><a href="#abe16648-35" aria-hidden="true" tabindex="-1"></a>        textwidth <span class="op">=</span> draw.textlength(text, font)</span>
<span id="abe16648-36"><a href="#abe16648-36" aria-hidden="true" tabindex="-1"></a>        textheight <span class="op">=</span> font_size</span>
<span id="abe16648-37"><a href="#abe16648-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="abe16648-38"><a href="#abe16648-38" aria-hidden="true" tabindex="-1"></a>        width, height <span class="op">=</span> image.size</span>
<span id="abe16648-39"><a href="#abe16648-39" aria-hidden="true" tabindex="-1"></a>        x <span class="op">=</span> width <span class="op">-</span> textwidth <span class="op">-</span> <span class="dv">10</span></span>
<span id="abe16648-40"><a href="#abe16648-40" aria-hidden="true" tabindex="-1"></a>        y <span class="op">=</span> height <span class="op">-</span> textheight <span class="op">-</span> <span class="dv">10</span></span>
<span id="abe16648-41"><a href="#abe16648-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="abe16648-42"><a href="#abe16648-42" aria-hidden="true" tabindex="-1"></a>        <span class="co"># For RGB images, white is (255, 255, 255)</span></span>
<span id="abe16648-43"><a href="#abe16648-43" aria-hidden="true" tabindex="-1"></a>        draw.text((x, y), text, font<span class="op">=</span>font, fill<span class="op">=</span>(<span class="dv">255</span>, <span class="dv">255</span>, <span class="dv">255</span>))</span>
<span id="abe16648-44"><a href="#abe16648-44" aria-hidden="true" tabindex="-1"></a>        frames.append(np.array(image))</span>
<span id="abe16648-45"><a href="#abe16648-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="abe16648-46"><a href="#abe16648-46" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Write frames to an MP4 video file with the ffmpeg writer</span></span>
<span id="abe16648-47"><a href="#abe16648-47" aria-hidden="true" tabindex="-1"></a>    writer <span class="op">=</span> imageio.get_writer(mp4_filename, fps<span class="op">=</span>fps, codec<span class="op">=</span><span class="st">"libx264"</span>, <span class="bu">format</span><span class="op">=</span><span class="st">"ffmpeg"</span>)</span>
<span id="abe16648-48"><a href="#abe16648-48" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> frame <span class="kw">in</span> frames:</span>
<span id="abe16648-49"><a href="#abe16648-49" aria-hidden="true" tabindex="-1"></a>        writer.append_data(frame)</span>
<span id="abe16648-50"><a href="#abe16648-50" aria-hidden="true" tabindex="-1"></a>    writer.close()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="6aeb3599" class="cell" data-execution_count="14">
<details class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="6aeb3599"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="6aeb3599-1"><a href="#6aeb3599-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> create_animation:</span>
<span id="6aeb3599-2"><a href="#6aeb3599-2" aria-hidden="true" tabindex="-1"></a>    create_mp4_from_frames(anim_dir, <span class="st">"The_Arnolfini_portrait_RGB_MLP.mp4"</span>, fps<span class="op">=</span><span class="dv">24</span>)</span>
<span id="6aeb3599-3"><a href="#6aeb3599-3" aria-hidden="true" tabindex="-1"></a>    cleanup_frames(anim_dir)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<video width="80%" controls="">
<source src="The_Arnolfini_portrait_RGB_MLP.mp4" type="video/mp4">
Your browser does not support the video tag.

</video>
<p>We can clearly see the model slowly learn the details of the painting over time, starting from a verry blurry approximation and gradually refining its predictions. The role of the optimiser, is to guide the model towards “guessing” the details of the painting, such as textures, colours, and shapes. The “wiggles” in the animation represent the model’s attempt to find the optimal parameters that minimize the loss function, which in turn helps it produce more accurate predictions, just like when a person tries to find the optimal path around a complex maze by trial and error.</p>
</section>
<section id="the-siren-model" class="level3">
<h3 class="anchored" data-anchor-id="the-siren-model">The SIREN model</h3>
<p>MLPs, when used with standard activation functions like ReLU, tend to create piecewise linear approximations of the target function. This works well for many problems, but it can lead to over-smoothing when modeling complex spatial patterns, especially in images. Essentially, an MLP struggles to capture high-frequency details or subtle variations in an image because its architecture is inherently limited by its smooth, global parameterization.</p>
<p>On the other hand, a SIREN model, short for <em>Sinusoidal Representation Networks</em>, employs periodic activation functions (typically sine functions) instead of ReLU. The sinusoidal activations allow the network to naturally capture high-frequency details, as they can represent oscillatory patterns much more effectively. This means that it will be better suited for representing complex, detailed signals with fine variations, making it a strong candidate for tasks such as image reconstruction or any problem where precise spatial detail is critical. It will also help the optimizer converge much faster and more accurately to the target image.</p>
<div id="c15d753f" class="cell" data-execution_count="15">
<details class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="c15d753f"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="c15d753f-1"><a href="#c15d753f-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="c15d753f-2"><a href="#c15d753f-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="c15d753f-3"><a href="#c15d753f-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="c15d753f-4"><a href="#c15d753f-4" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> np.linspace(<span class="op">-</span><span class="dv">2</span> <span class="op">*</span> np.pi, <span class="dv">2</span> <span class="op">*</span> np.pi, <span class="dv">1000</span>)</span>
<span id="c15d753f-5"><a href="#c15d753f-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="c15d753f-6"><a href="#c15d753f-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="c15d753f-7"><a href="#c15d753f-7" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> relu(x):</span>
<span id="c15d753f-8"><a href="#c15d753f-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> np.maximum(<span class="dv">0</span>, x)</span>
<span id="c15d753f-9"><a href="#c15d753f-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="c15d753f-10"><a href="#c15d753f-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="c15d753f-11"><a href="#c15d753f-11" aria-hidden="true" tabindex="-1"></a>omega0 <span class="op">=</span> <span class="fl">5.0</span>  <span class="co"># frequency scaling factor</span></span>
<span id="c15d753f-12"><a href="#c15d753f-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="c15d753f-13"><a href="#c15d753f-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="c15d753f-14"><a href="#c15d753f-14" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> siren(x):</span>
<span id="c15d753f-15"><a href="#c15d753f-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> np.sin(omega0 <span class="op">*</span> x)</span>
<span id="c15d753f-16"><a href="#c15d753f-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="c15d753f-17"><a href="#c15d753f-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="c15d753f-18"><a href="#c15d753f-18" aria-hidden="true" tabindex="-1"></a>fig, (ax1, ax2) <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="dv">4</span>))</span>
<span id="c15d753f-19"><a href="#c15d753f-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="c15d753f-20"><a href="#c15d753f-20" aria-hidden="true" tabindex="-1"></a>ax1.plot(x, relu(x), label<span class="op">=</span><span class="st">"MLP (ReLU)"</span>, color<span class="op">=</span><span class="st">"blue"</span>)</span>
<span id="c15d753f-21"><a href="#c15d753f-21" aria-hidden="true" tabindex="-1"></a>ax1.set_title(<span class="st">"ReLU Activation"</span>)</span>
<span id="c15d753f-22"><a href="#c15d753f-22" aria-hidden="true" tabindex="-1"></a>ax1.set_xlabel(<span class="st">"x"</span>)</span>
<span id="c15d753f-23"><a href="#c15d753f-23" aria-hidden="true" tabindex="-1"></a>ax1.set_ylabel(<span class="st">"f(x)"</span>)</span>
<span id="c15d753f-24"><a href="#c15d753f-24" aria-hidden="true" tabindex="-1"></a>ax1.axhline(<span class="dv">0</span>, color<span class="op">=</span><span class="st">"black"</span>, linewidth<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="c15d753f-25"><a href="#c15d753f-25" aria-hidden="true" tabindex="-1"></a>ax1.axvline(<span class="dv">0</span>, color<span class="op">=</span><span class="st">"black"</span>, linewidth<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="c15d753f-26"><a href="#c15d753f-26" aria-hidden="true" tabindex="-1"></a>ax1.grid(<span class="va">True</span>)</span>
<span id="c15d753f-27"><a href="#c15d753f-27" aria-hidden="true" tabindex="-1"></a>ax1.legend()</span>
<span id="c15d753f-28"><a href="#c15d753f-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="c15d753f-29"><a href="#c15d753f-29" aria-hidden="true" tabindex="-1"></a>ax2.plot(x, siren(x), label<span class="op">=</span><span class="st">"SIREN (sin activation)"</span>, color<span class="op">=</span><span class="st">"red"</span>)</span>
<span id="c15d753f-30"><a href="#c15d753f-30" aria-hidden="true" tabindex="-1"></a>ax2.set_title(<span class="st">"Sine Activation"</span>)</span>
<span id="c15d753f-31"><a href="#c15d753f-31" aria-hidden="true" tabindex="-1"></a>ax2.set_xlabel(<span class="st">"x"</span>)</span>
<span id="c15d753f-32"><a href="#c15d753f-32" aria-hidden="true" tabindex="-1"></a>ax2.set_ylabel(<span class="st">"f(x)"</span>)</span>
<span id="c15d753f-33"><a href="#c15d753f-33" aria-hidden="true" tabindex="-1"></a>ax2.axhline(<span class="dv">0</span>, color<span class="op">=</span><span class="st">"black"</span>, linewidth<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="c15d753f-34"><a href="#c15d753f-34" aria-hidden="true" tabindex="-1"></a>ax2.axvline(<span class="dv">0</span>, color<span class="op">=</span><span class="st">"black"</span>, linewidth<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="c15d753f-35"><a href="#c15d753f-35" aria-hidden="true" tabindex="-1"></a>ax2.grid(<span class="va">True</span>)</span>
<span id="c15d753f-36"><a href="#c15d753f-36" aria-hidden="true" tabindex="-1"></a>ax2.legend()</span>
<span id="c15d753f-37"><a href="#c15d753f-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="c15d753f-38"><a href="#c15d753f-38" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="c15d753f-39"><a href="#c15d753f-39" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><a href="index_files/figure-html/cell-16-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-4"><img src="index_files/figure-html/cell-16-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<p>Here’s how SIREN is defined in PyTorch. The key difference is the use of the <code>SineLayer</code> class, which replaces the standard linear layers in the MLP. The <code>SineLayer</code> applies a sine function to the output of a linear layer, with a frequency controlled by the <code>omega_0</code> parameter. The <code>SIREN</code> class then stacks multiple <code>SineLayer</code> instances to create a deep network with sinusoidal activations. The choice of <code>omega_0</code> determines the frequency of the sine functions and can be tuned to capture different spatial frequencies in the data.</p>
<div id="9cb37295" class="cell" data-execution_count="16">
<details class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="9cb37295"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="9cb37295-1"><a href="#9cb37295-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> SineLayer(nn.Module):</span>
<span id="9cb37295-2"><a href="#9cb37295-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(</span>
<span id="9cb37295-3"><a href="#9cb37295-3" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>, in_features, out_features, bias<span class="op">=</span><span class="va">True</span>, is_first<span class="op">=</span><span class="va">False</span>, omega_0<span class="op">=</span><span class="dv">30</span></span>
<span id="9cb37295-4"><a href="#9cb37295-4" aria-hidden="true" tabindex="-1"></a>    ):</span>
<span id="9cb37295-5"><a href="#9cb37295-5" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>().<span class="fu">__init__</span>()</span>
<span id="9cb37295-6"><a href="#9cb37295-6" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.in_features <span class="op">=</span> in_features</span>
<span id="9cb37295-7"><a href="#9cb37295-7" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.is_first <span class="op">=</span> is_first</span>
<span id="9cb37295-8"><a href="#9cb37295-8" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.omega_0 <span class="op">=</span> omega_0</span>
<span id="9cb37295-9"><a href="#9cb37295-9" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.linear <span class="op">=</span> nn.Linear(in_features, out_features, bias<span class="op">=</span>bias)</span>
<span id="9cb37295-10"><a href="#9cb37295-10" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.init_weights()</span>
<span id="9cb37295-11"><a href="#9cb37295-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="9cb37295-12"><a href="#9cb37295-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> init_weights(<span class="va">self</span>):</span>
<span id="9cb37295-13"><a href="#9cb37295-13" aria-hidden="true" tabindex="-1"></a>        <span class="cf">with</span> torch.no_grad():</span>
<span id="9cb37295-14"><a href="#9cb37295-14" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="va">self</span>.is_first:</span>
<span id="9cb37295-15"><a href="#9cb37295-15" aria-hidden="true" tabindex="-1"></a>                <span class="va">self</span>.linear.weight.uniform_(<span class="op">-</span><span class="dv">1</span> <span class="op">/</span> <span class="va">self</span>.in_features, <span class="dv">1</span> <span class="op">/</span> <span class="va">self</span>.in_features)</span>
<span id="9cb37295-16"><a href="#9cb37295-16" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="9cb37295-17"><a href="#9cb37295-17" aria-hidden="true" tabindex="-1"></a>                <span class="va">self</span>.linear.weight.uniform_(</span>
<span id="9cb37295-18"><a href="#9cb37295-18" aria-hidden="true" tabindex="-1"></a>                    <span class="op">-</span>math.sqrt(<span class="dv">6</span> <span class="op">/</span> <span class="va">self</span>.in_features) <span class="op">/</span> <span class="va">self</span>.omega_0,</span>
<span id="9cb37295-19"><a href="#9cb37295-19" aria-hidden="true" tabindex="-1"></a>                    math.sqrt(<span class="dv">6</span> <span class="op">/</span> <span class="va">self</span>.in_features) <span class="op">/</span> <span class="va">self</span>.omega_0,</span>
<span id="9cb37295-20"><a href="#9cb37295-20" aria-hidden="true" tabindex="-1"></a>                )</span>
<span id="9cb37295-21"><a href="#9cb37295-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="9cb37295-22"><a href="#9cb37295-22" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> forward(<span class="va">self</span>, <span class="bu">input</span>):</span>
<span id="9cb37295-23"><a href="#9cb37295-23" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> torch.sin(<span class="va">self</span>.omega_0 <span class="op">*</span> <span class="va">self</span>.linear(<span class="bu">input</span>))</span>
<span id="9cb37295-24"><a href="#9cb37295-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="9cb37295-25"><a href="#9cb37295-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="9cb37295-26"><a href="#9cb37295-26" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> SIREN(nn.Module):</span>
<span id="9cb37295-27"><a href="#9cb37295-27" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(</span>
<span id="9cb37295-28"><a href="#9cb37295-28" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>, in_features, hidden_features, hidden_layers, out_features, omega_0<span class="op">=</span><span class="dv">30</span></span>
<span id="9cb37295-29"><a href="#9cb37295-29" aria-hidden="true" tabindex="-1"></a>    ):</span>
<span id="9cb37295-30"><a href="#9cb37295-30" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>().<span class="fu">__init__</span>()</span>
<span id="9cb37295-31"><a href="#9cb37295-31" aria-hidden="true" tabindex="-1"></a>        layers <span class="op">=</span> [</span>
<span id="9cb37295-32"><a href="#9cb37295-32" aria-hidden="true" tabindex="-1"></a>            SineLayer(in_features, hidden_features, is_first<span class="op">=</span><span class="va">True</span>, omega_0<span class="op">=</span>omega_0)</span>
<span id="9cb37295-33"><a href="#9cb37295-33" aria-hidden="true" tabindex="-1"></a>        ]</span>
<span id="9cb37295-34"><a href="#9cb37295-34" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> _ <span class="kw">in</span> <span class="bu">range</span>(hidden_layers):</span>
<span id="9cb37295-35"><a href="#9cb37295-35" aria-hidden="true" tabindex="-1"></a>            layers.append(</span>
<span id="9cb37295-36"><a href="#9cb37295-36" aria-hidden="true" tabindex="-1"></a>                SineLayer(</span>
<span id="9cb37295-37"><a href="#9cb37295-37" aria-hidden="true" tabindex="-1"></a>                    hidden_features, hidden_features, is_first<span class="op">=</span><span class="va">False</span>, omega_0<span class="op">=</span>omega_0</span>
<span id="9cb37295-38"><a href="#9cb37295-38" aria-hidden="true" tabindex="-1"></a>                )</span>
<span id="9cb37295-39"><a href="#9cb37295-39" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="9cb37295-40"><a href="#9cb37295-40" aria-hidden="true" tabindex="-1"></a>        final_linear <span class="op">=</span> nn.Linear(hidden_features, out_features)</span>
<span id="9cb37295-41"><a href="#9cb37295-41" aria-hidden="true" tabindex="-1"></a>        <span class="cf">with</span> torch.no_grad():</span>
<span id="9cb37295-42"><a href="#9cb37295-42" aria-hidden="true" tabindex="-1"></a>            final_linear.weight.uniform_(</span>
<span id="9cb37295-43"><a href="#9cb37295-43" aria-hidden="true" tabindex="-1"></a>                <span class="op">-</span>math.sqrt(<span class="dv">6</span> <span class="op">/</span> hidden_features) <span class="op">/</span> omega_0,</span>
<span id="9cb37295-44"><a href="#9cb37295-44" aria-hidden="true" tabindex="-1"></a>                math.sqrt(<span class="dv">6</span> <span class="op">/</span> hidden_features) <span class="op">/</span> omega_0,</span>
<span id="9cb37295-45"><a href="#9cb37295-45" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="9cb37295-46"><a href="#9cb37295-46" aria-hidden="true" tabindex="-1"></a>        layers.append(final_linear)</span>
<span id="9cb37295-47"><a href="#9cb37295-47" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.net <span class="op">=</span> nn.Sequential(<span class="op">*</span>layers)</span>
<span id="9cb37295-48"><a href="#9cb37295-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="9cb37295-49"><a href="#9cb37295-49" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> forward(<span class="va">self</span>, x):</span>
<span id="9cb37295-50"><a href="#9cb37295-50" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>.net(x)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Together with the model, we also recreate the optimizer with the same hyper-parameters as before.</p>
<div id="16a45dc2" class="cell" data-execution_count="17">
<details class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="16a45dc2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="16a45dc2-1"><a href="#16a45dc2-1" aria-hidden="true" tabindex="-1"></a>model_siren <span class="op">=</span> SIREN(</span>
<span id="16a45dc2-2"><a href="#16a45dc2-2" aria-hidden="true" tabindex="-1"></a>    in_features<span class="op">=</span><span class="dv">2</span>,</span>
<span id="16a45dc2-3"><a href="#16a45dc2-3" aria-hidden="true" tabindex="-1"></a>    hidden_features<span class="op">=</span>hidden_features,</span>
<span id="16a45dc2-4"><a href="#16a45dc2-4" aria-hidden="true" tabindex="-1"></a>    hidden_layers<span class="op">=</span>hidden_layers,</span>
<span id="16a45dc2-5"><a href="#16a45dc2-5" aria-hidden="true" tabindex="-1"></a>    out_features<span class="op">=</span><span class="dv">3</span>,</span>
<span id="16a45dc2-6"><a href="#16a45dc2-6" aria-hidden="true" tabindex="-1"></a>).to(device)</span>
<span id="16a45dc2-7"><a href="#16a45dc2-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="16a45dc2-8"><a href="#16a45dc2-8" aria-hidden="true" tabindex="-1"></a>optimizer <span class="op">=</span> optim.Adam(model_siren.parameters(), lr<span class="op">=</span>learning_rate)</span>
<span id="16a45dc2-9"><a href="#16a45dc2-9" aria-hidden="true" tabindex="-1"></a>criterion <span class="op">=</span> nn.MSELoss()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Finally, we run training and save the display and animation frames. This time we should see convergence being achieved faster, and more detailed predictions compared to the MLP, thanks to SIREN’s ability to capture high-frequency spatial patterns more effectively.</p>
<div id="4f7e6272" class="cell" data-execution_count="18">
<details class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="4f7e6272"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="4f7e6272-1"><a href="#4f7e6272-1" aria-hidden="true" tabindex="-1"></a>animation_interval <span class="op">=</span> <span class="dv">5</span>  <span class="co"># SIREN converges much faster</span></span>
<span id="4f7e6272-2"><a href="#4f7e6272-2" aria-hidden="true" tabindex="-1"></a>display_interval <span class="op">=</span> <span class="dv">200</span></span>
<span id="4f7e6272-3"><a href="#4f7e6272-3" aria-hidden="true" tabindex="-1"></a>patience <span class="op">=</span> <span class="dv">200</span></span>
<span id="4f7e6272-4"><a href="#4f7e6272-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="4f7e6272-5"><a href="#4f7e6272-5" aria-hidden="true" tabindex="-1"></a>best_loss_siren, display_epochs_siren, display_losses_siren <span class="op">=</span> train_model(</span>
<span id="4f7e6272-6"><a href="#4f7e6272-6" aria-hidden="true" tabindex="-1"></a>    model_siren,</span>
<span id="4f7e6272-7"><a href="#4f7e6272-7" aria-hidden="true" tabindex="-1"></a>    coords,</span>
<span id="4f7e6272-8"><a href="#4f7e6272-8" aria-hidden="true" tabindex="-1"></a>    target,</span>
<span id="4f7e6272-9"><a href="#4f7e6272-9" aria-hidden="true" tabindex="-1"></a>    H,</span>
<span id="4f7e6272-10"><a href="#4f7e6272-10" aria-hidden="true" tabindex="-1"></a>    W,</span>
<span id="4f7e6272-11"><a href="#4f7e6272-11" aria-hidden="true" tabindex="-1"></a>    num_epochs,</span>
<span id="4f7e6272-12"><a href="#4f7e6272-12" aria-hidden="true" tabindex="-1"></a>    display_interval,</span>
<span id="4f7e6272-13"><a href="#4f7e6272-13" aria-hidden="true" tabindex="-1"></a>    animation_interval,</span>
<span id="4f7e6272-14"><a href="#4f7e6272-14" aria-hidden="true" tabindex="-1"></a>    patience,</span>
<span id="4f7e6272-15"><a href="#4f7e6272-15" aria-hidden="true" tabindex="-1"></a>    optimizer,</span>
<span id="4f7e6272-16"><a href="#4f7e6272-16" aria-hidden="true" tabindex="-1"></a>    criterion,</span>
<span id="4f7e6272-17"><a href="#4f7e6272-17" aria-hidden="true" tabindex="-1"></a>    display_dir,</span>
<span id="4f7e6272-18"><a href="#4f7e6272-18" aria-hidden="true" tabindex="-1"></a>    anim_dir,</span>
<span id="4f7e6272-19"><a href="#4f7e6272-19" aria-hidden="true" tabindex="-1"></a>    create_animation,</span>
<span id="4f7e6272-20"><a href="#4f7e6272-20" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"6b05cb7caa244ec2aaca6ed67c82e079","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Early stopping at epoch 2059, best loss: 0.000206</code></pre>
</div>
</div>
<p>As before let us see the display frames to get an idea of how the model’s predictions evolved over time before converging.</p>
<div id="57ea976a" class="cell" data-execution_count="19">
<details class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="57ea976a"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="57ea976a-1"><a href="#57ea976a-1" aria-hidden="true" tabindex="-1"></a>grid_display(display_dir, display_epochs_siren, display_losses_siren)</span>
<span id="57ea976a-2"><a href="#57ea976a-2" aria-hidden="true" tabindex="-1"></a>cleanup_frames(display_dir)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><a href="index_files/figure-html/cell-20-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-5"><img src="index_files/figure-html/cell-20-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<p>And finally stich the animation frames together to create a video that shows the training process of the SIREN model.</p>
<div id="98f14b1f" class="cell" data-execution_count="20">
<details class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="98f14b1f"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="98f14b1f-1"><a href="#98f14b1f-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> create_animation:</span>
<span id="98f14b1f-2"><a href="#98f14b1f-2" aria-hidden="true" tabindex="-1"></a>    create_mp4_from_frames(anim_dir, <span class="st">"The_Arnolfini_portrait_RGB_SIREN.mp4"</span>, fps<span class="op">=</span><span class="dv">12</span>)</span>
<span id="98f14b1f-3"><a href="#98f14b1f-3" aria-hidden="true" tabindex="-1"></a>    cleanup_frames(anim_dir)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<video width="80%" controls="">
<source src="The_Arnolfini_portrait_RGB_SIREN.mp4" type="video/mp4">
Your browser does not support the video tag.

</video>
<p>Notice how this time SIREN captures fine details much faster and accurately than the MLP. It has almost memorized the training data, showing the effectiveness of SIREN in high-frequency function representation. The Adam optimizer, in this case, has an easier time navigating the loss landscape, converging to the target image much faster and with more precision.</p>
</section>
</section>
<section id="final-remarks" class="level2">
<h2 class="anchored" data-anchor-id="final-remarks">Final remarks</h2>
<p>Hopefully this experiment has given you a better understanding of the role of optimisation in machine learning, it is a crucial aspect that affects how well models perform and converge during training, and despite the somewhat complex nature of the algorithms employed, it is possible for anyone to get a rough intuition of how they work.</p>


</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" id="quarto-reuse"><h2 class="anchored quarto-appendix-heading">Reuse</h2><div class="quarto-appendix-contents"><div>This work is licensed under CC BY <a rel="license" href="https://creativecommons.org/licenses/by/4.0/">(View License)</a></div></div></section></div></main> <!-- /main -->
<script type="application/vnd.jupyter.widget-state+json">
{"state":{"0055a27fbb904b708427fc12b0747b77":{"model_module":"@jupyter-widgets/base","model_module_version":"2.0.0","model_name":"LayoutModel","state":{"_model_module":"@jupyter-widgets/base","_model_module_version":"2.0.0","_model_name":"LayoutModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"2.0.0","_view_name":"LayoutView","align_content":null,"align_items":null,"align_self":null,"border_bottom":null,"border_left":null,"border_right":null,"border_top":null,"bottom":null,"display":null,"flex":null,"flex_flow":null,"grid_area":null,"grid_auto_columns":null,"grid_auto_flow":null,"grid_auto_rows":null,"grid_column":null,"grid_gap":null,"grid_row":null,"grid_template_areas":null,"grid_template_columns":null,"grid_template_rows":null,"height":null,"justify_content":null,"justify_items":null,"left":null,"margin":null,"max_height":null,"max_width":null,"min_height":null,"min_width":null,"object_fit":null,"object_position":null,"order":null,"overflow":null,"padding":null,"right":null,"top":null,"visibility":null,"width":null}},"0bd95522ad014ac9830500866389493a":{"model_module":"@jupyter-widgets/base","model_module_version":"2.0.0","model_name":"LayoutModel","state":{"_model_module":"@jupyter-widgets/base","_model_module_version":"2.0.0","_model_name":"LayoutModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"2.0.0","_view_name":"LayoutView","align_content":null,"align_items":null,"align_self":null,"border_bottom":null,"border_left":null,"border_right":null,"border_top":null,"bottom":null,"display":null,"flex":null,"flex_flow":null,"grid_area":null,"grid_auto_columns":null,"grid_auto_flow":null,"grid_auto_rows":null,"grid_column":null,"grid_gap":null,"grid_row":null,"grid_template_areas":null,"grid_template_columns":null,"grid_template_rows":null,"height":null,"justify_content":null,"justify_items":null,"left":null,"margin":null,"max_height":null,"max_width":null,"min_height":null,"min_width":null,"object_fit":null,"object_position":null,"order":null,"overflow":null,"padding":null,"right":null,"top":null,"visibility":null,"width":null}},"1b009024a2af4217b237c23e9b7dcfc2":{"model_module":"@jupyter-widgets/controls","model_module_version":"2.0.0","model_name":"FloatProgressModel","state":{"_dom_classes":[],"_model_module":"@jupyter-widgets/controls","_model_module_version":"2.0.0","_model_name":"FloatProgressModel","_view_count":null,"_view_module":"@jupyter-widgets/controls","_view_module_version":"2.0.0","_view_name":"ProgressView","bar_style":"success","description":"","description_allow_html":false,"layout":"IPY_MODEL_848202aa555c429389654deab495a9c1","max":30000,"min":0,"orientation":"horizontal","style":"IPY_MODEL_ca34a39402be474ebe77bc65812c8169","tabbable":null,"tooltip":null,"value":30000}},"2dad8e0443bf42a3a126ca5e372caee7":{"model_module":"@jupyter-widgets/base","model_module_version":"2.0.0","model_name":"LayoutModel","state":{"_model_module":"@jupyter-widgets/base","_model_module_version":"2.0.0","_model_name":"LayoutModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"2.0.0","_view_name":"LayoutView","align_content":null,"align_items":null,"align_self":null,"border_bottom":null,"border_left":null,"border_right":null,"border_top":null,"bottom":null,"display":null,"flex":null,"flex_flow":null,"grid_area":null,"grid_auto_columns":null,"grid_auto_flow":null,"grid_auto_rows":null,"grid_column":null,"grid_gap":null,"grid_row":null,"grid_template_areas":null,"grid_template_columns":null,"grid_template_rows":null,"height":null,"justify_content":null,"justify_items":null,"left":null,"margin":null,"max_height":null,"max_width":null,"min_height":null,"min_width":null,"object_fit":null,"object_position":null,"order":null,"overflow":null,"padding":null,"right":null,"top":null,"visibility":null,"width":null}},"31662c7ab7db49a1b369d2795898d504":{"model_module":"@jupyter-widgets/base","model_module_version":"2.0.0","model_name":"LayoutModel","state":{"_model_module":"@jupyter-widgets/base","_model_module_version":"2.0.0","_model_name":"LayoutModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"2.0.0","_view_name":"LayoutView","align_content":null,"align_items":null,"align_self":null,"border_bottom":null,"border_left":null,"border_right":null,"border_top":null,"bottom":null,"display":null,"flex":null,"flex_flow":null,"grid_area":null,"grid_auto_columns":null,"grid_auto_flow":null,"grid_auto_rows":null,"grid_column":null,"grid_gap":null,"grid_row":null,"grid_template_areas":null,"grid_template_columns":null,"grid_template_rows":null,"height":null,"justify_content":null,"justify_items":null,"left":null,"margin":null,"max_height":null,"max_width":null,"min_height":null,"min_width":null,"object_fit":null,"object_position":null,"order":null,"overflow":null,"padding":null,"right":null,"top":null,"visibility":null,"width":null}},"394b9c20f68e412198e42a6c64c8edee":{"model_module":"@jupyter-widgets/controls","model_module_version":"2.0.0","model_name":"FloatProgressModel","state":{"_dom_classes":[],"_model_module":"@jupyter-widgets/controls","_model_module_version":"2.0.0","_model_name":"FloatProgressModel","_view_count":null,"_view_module":"@jupyter-widgets/controls","_view_module_version":"2.0.0","_view_name":"ProgressView","bar_style":"danger","description":"","description_allow_html":false,"layout":"IPY_MODEL_2dad8e0443bf42a3a126ca5e372caee7","max":30000,"min":0,"orientation":"horizontal","style":"IPY_MODEL_439f82ddb9b948448baf4bda73c9d251","tabbable":null,"tooltip":null,"value":2059}},"439f82ddb9b948448baf4bda73c9d251":{"model_module":"@jupyter-widgets/controls","model_module_version":"2.0.0","model_name":"ProgressStyleModel","state":{"_model_module":"@jupyter-widgets/controls","_model_module_version":"2.0.0","_model_name":"ProgressStyleModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"2.0.0","_view_name":"StyleView","bar_color":null,"description_width":""}},"472dbd6d4bd842c1a1803a775979953c":{"model_module":"@jupyter-widgets/controls","model_module_version":"2.0.0","model_name":"HTMLModel","state":{"_dom_classes":[],"_model_module":"@jupyter-widgets/controls","_model_module_version":"2.0.0","_model_name":"HTMLModel","_view_count":null,"_view_module":"@jupyter-widgets/controls","_view_module_version":"2.0.0","_view_name":"HTMLView","description":"","description_allow_html":false,"layout":"IPY_MODEL_b025a87a6336425698edc8ce9d4caa57","placeholder":"​","style":"IPY_MODEL_9bbcd55aa3ed48a6a9e8615317eaa1da","tabbable":null,"tooltip":null,"value":"Training:   7%"}},"5189dac430124753bed44ef22bb804ef":{"model_module":"@jupyter-widgets/controls","model_module_version":"2.0.0","model_name":"HBoxModel","state":{"_dom_classes":[],"_model_module":"@jupyter-widgets/controls","_model_module_version":"2.0.0","_model_name":"HBoxModel","_view_count":null,"_view_module":"@jupyter-widgets/controls","_view_module_version":"2.0.0","_view_name":"HBoxView","box_style":"","children":["IPY_MODEL_64d57f1db97d41a5969379d8fc273f1f","IPY_MODEL_1b009024a2af4217b237c23e9b7dcfc2","IPY_MODEL_97c8dd6cfd7b4135a08399404ead2198"],"layout":"IPY_MODEL_0055a27fbb904b708427fc12b0747b77","tabbable":null,"tooltip":null}},"64d57f1db97d41a5969379d8fc273f1f":{"model_module":"@jupyter-widgets/controls","model_module_version":"2.0.0","model_name":"HTMLModel","state":{"_dom_classes":[],"_model_module":"@jupyter-widgets/controls","_model_module_version":"2.0.0","_model_name":"HTMLModel","_view_count":null,"_view_module":"@jupyter-widgets/controls","_view_module_version":"2.0.0","_view_name":"HTMLView","description":"","description_allow_html":false,"layout":"IPY_MODEL_31662c7ab7db49a1b369d2795898d504","placeholder":"​","style":"IPY_MODEL_6646498fdc2c4ca6b2194068967bff6b","tabbable":null,"tooltip":null,"value":"Training: 100%"}},"6646498fdc2c4ca6b2194068967bff6b":{"model_module":"@jupyter-widgets/controls","model_module_version":"2.0.0","model_name":"HTMLStyleModel","state":{"_model_module":"@jupyter-widgets/controls","_model_module_version":"2.0.0","_model_name":"HTMLStyleModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"2.0.0","_view_name":"StyleView","background":null,"description_width":"","font_size":null,"text_color":null}},"6b05cb7caa244ec2aaca6ed67c82e079":{"model_module":"@jupyter-widgets/controls","model_module_version":"2.0.0","model_name":"HBoxModel","state":{"_dom_classes":[],"_model_module":"@jupyter-widgets/controls","_model_module_version":"2.0.0","_model_name":"HBoxModel","_view_count":null,"_view_module":"@jupyter-widgets/controls","_view_module_version":"2.0.0","_view_name":"HBoxView","box_style":"","children":["IPY_MODEL_472dbd6d4bd842c1a1803a775979953c","IPY_MODEL_394b9c20f68e412198e42a6c64c8edee","IPY_MODEL_ae408a0c484446878ebcc73b080b0027"],"layout":"IPY_MODEL_9b76d48dbc264248ab4a082bc7991a9a","tabbable":null,"tooltip":null}},"848202aa555c429389654deab495a9c1":{"model_module":"@jupyter-widgets/base","model_module_version":"2.0.0","model_name":"LayoutModel","state":{"_model_module":"@jupyter-widgets/base","_model_module_version":"2.0.0","_model_name":"LayoutModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"2.0.0","_view_name":"LayoutView","align_content":null,"align_items":null,"align_self":null,"border_bottom":null,"border_left":null,"border_right":null,"border_top":null,"bottom":null,"display":null,"flex":null,"flex_flow":null,"grid_area":null,"grid_auto_columns":null,"grid_auto_flow":null,"grid_auto_rows":null,"grid_column":null,"grid_gap":null,"grid_row":null,"grid_template_areas":null,"grid_template_columns":null,"grid_template_rows":null,"height":null,"justify_content":null,"justify_items":null,"left":null,"margin":null,"max_height":null,"max_width":null,"min_height":null,"min_width":null,"object_fit":null,"object_position":null,"order":null,"overflow":null,"padding":null,"right":null,"top":null,"visibility":null,"width":null}},"9449c8a723c54afa950796d478485ffe":{"model_module":"@jupyter-widgets/base","model_module_version":"2.0.0","model_name":"LayoutModel","state":{"_model_module":"@jupyter-widgets/base","_model_module_version":"2.0.0","_model_name":"LayoutModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"2.0.0","_view_name":"LayoutView","align_content":null,"align_items":null,"align_self":null,"border_bottom":null,"border_left":null,"border_right":null,"border_top":null,"bottom":null,"display":null,"flex":null,"flex_flow":null,"grid_area":null,"grid_auto_columns":null,"grid_auto_flow":null,"grid_auto_rows":null,"grid_column":null,"grid_gap":null,"grid_row":null,"grid_template_areas":null,"grid_template_columns":null,"grid_template_rows":null,"height":null,"justify_content":null,"justify_items":null,"left":null,"margin":null,"max_height":null,"max_width":null,"min_height":null,"min_width":null,"object_fit":null,"object_position":null,"order":null,"overflow":null,"padding":null,"right":null,"top":null,"visibility":null,"width":null}},"97c8dd6cfd7b4135a08399404ead2198":{"model_module":"@jupyter-widgets/controls","model_module_version":"2.0.0","model_name":"HTMLModel","state":{"_dom_classes":[],"_model_module":"@jupyter-widgets/controls","_model_module_version":"2.0.0","_model_name":"HTMLModel","_view_count":null,"_view_module":"@jupyter-widgets/controls","_view_module_version":"2.0.0","_view_name":"HTMLView","description":"","description_allow_html":false,"layout":"IPY_MODEL_0bd95522ad014ac9830500866389493a","placeholder":"​","style":"IPY_MODEL_9f4979a3df444655acf2c756a733b46c","tabbable":null,"tooltip":null,"value":" 30000/30000 [3:55:50&lt;00:00,  2.16it/s]"}},"9b76d48dbc264248ab4a082bc7991a9a":{"model_module":"@jupyter-widgets/base","model_module_version":"2.0.0","model_name":"LayoutModel","state":{"_model_module":"@jupyter-widgets/base","_model_module_version":"2.0.0","_model_name":"LayoutModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"2.0.0","_view_name":"LayoutView","align_content":null,"align_items":null,"align_self":null,"border_bottom":null,"border_left":null,"border_right":null,"border_top":null,"bottom":null,"display":null,"flex":null,"flex_flow":null,"grid_area":null,"grid_auto_columns":null,"grid_auto_flow":null,"grid_auto_rows":null,"grid_column":null,"grid_gap":null,"grid_row":null,"grid_template_areas":null,"grid_template_columns":null,"grid_template_rows":null,"height":null,"justify_content":null,"justify_items":null,"left":null,"margin":null,"max_height":null,"max_width":null,"min_height":null,"min_width":null,"object_fit":null,"object_position":null,"order":null,"overflow":null,"padding":null,"right":null,"top":null,"visibility":null,"width":null}},"9bbcd55aa3ed48a6a9e8615317eaa1da":{"model_module":"@jupyter-widgets/controls","model_module_version":"2.0.0","model_name":"HTMLStyleModel","state":{"_model_module":"@jupyter-widgets/controls","_model_module_version":"2.0.0","_model_name":"HTMLStyleModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"2.0.0","_view_name":"StyleView","background":null,"description_width":"","font_size":null,"text_color":null}},"9f4979a3df444655acf2c756a733b46c":{"model_module":"@jupyter-widgets/controls","model_module_version":"2.0.0","model_name":"HTMLStyleModel","state":{"_model_module":"@jupyter-widgets/controls","_model_module_version":"2.0.0","_model_name":"HTMLStyleModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"2.0.0","_view_name":"StyleView","background":null,"description_width":"","font_size":null,"text_color":null}},"ae408a0c484446878ebcc73b080b0027":{"model_module":"@jupyter-widgets/controls","model_module_version":"2.0.0","model_name":"HTMLModel","state":{"_dom_classes":[],"_model_module":"@jupyter-widgets/controls","_model_module_version":"2.0.0","_model_name":"HTMLModel","_view_count":null,"_view_module":"@jupyter-widgets/controls","_view_module_version":"2.0.0","_view_name":"HTMLView","description":"","description_allow_html":false,"layout":"IPY_MODEL_9449c8a723c54afa950796d478485ffe","placeholder":"​","style":"IPY_MODEL_dbe652449a404fbbb620756ffa56cf44","tabbable":null,"tooltip":null,"value":" 2059/30000 [19:39&lt;4:20:53,  1.78it/s]"}},"b025a87a6336425698edc8ce9d4caa57":{"model_module":"@jupyter-widgets/base","model_module_version":"2.0.0","model_name":"LayoutModel","state":{"_model_module":"@jupyter-widgets/base","_model_module_version":"2.0.0","_model_name":"LayoutModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"2.0.0","_view_name":"LayoutView","align_content":null,"align_items":null,"align_self":null,"border_bottom":null,"border_left":null,"border_right":null,"border_top":null,"bottom":null,"display":null,"flex":null,"flex_flow":null,"grid_area":null,"grid_auto_columns":null,"grid_auto_flow":null,"grid_auto_rows":null,"grid_column":null,"grid_gap":null,"grid_row":null,"grid_template_areas":null,"grid_template_columns":null,"grid_template_rows":null,"height":null,"justify_content":null,"justify_items":null,"left":null,"margin":null,"max_height":null,"max_width":null,"min_height":null,"min_width":null,"object_fit":null,"object_position":null,"order":null,"overflow":null,"padding":null,"right":null,"top":null,"visibility":null,"width":null}},"ca34a39402be474ebe77bc65812c8169":{"model_module":"@jupyter-widgets/controls","model_module_version":"2.0.0","model_name":"ProgressStyleModel","state":{"_model_module":"@jupyter-widgets/controls","_model_module_version":"2.0.0","_model_name":"ProgressStyleModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"2.0.0","_view_name":"StyleView","bar_color":null,"description_width":""}},"dbe652449a404fbbb620756ffa56cf44":{"model_module":"@jupyter-widgets/controls","model_module_version":"2.0.0","model_name":"HTMLStyleModel","state":{"_model_module":"@jupyter-widgets/controls","_model_module_version":"2.0.0","_model_name":"HTMLStyleModel","_view_count":null,"_view_module":"@jupyter-widgets/base","_view_module_version":"2.0.0","_view_name":"StyleView","background":null,"description_width":"","font_size":null,"text_color":null}}},"version_major":2,"version_minor":0}
</script>
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/pedroleitao\.nl");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
<p>Written with love, take time to think and ponder.</p>
</div>   
    <div class="nav-footer-center">
      &nbsp;
    </div>
    <div class="nav-footer-right">
      <ul class="footer-items list-unstyled">
    <li class="nav-item compact">
    <a class="nav-link" href="https://quarto.org">
      <i class="bi bi-arrow-through-heart" role="img">
</i> 
    </a>
  </li>  
    <li class="nav-item compact">
    <a class="nav-link" href="http://www.frankscanteen.com">
      <i class="bi bi-cup-hot" role="img">
</i> 
    </a>
  </li>  
    <li class="nav-item compact">
    <a class="nav-link" href="https://www.instagram.com/bilhanovarestaurante">
      <i class="bi bi-egg-fried" role="img">
</i> 
    </a>
  </li>  
</ul>
    </div>
  </div>
</footer>
<script>var lightboxQuarto = GLightbox({"closeEffect":"zoom","descPosition":"bottom","loop":false,"openEffect":"zoom","selector":".lightbox"});
(function() {
  let previousOnload = window.onload;
  window.onload = () => {
    if (previousOnload) {
      previousOnload();
    }
    lightboxQuarto.on('slide_before_load', (data) => {
      const { slideIndex, slideNode, slideConfig, player, trigger } = data;
      const href = trigger.getAttribute('href');
      if (href !== null) {
        const imgEl = window.document.querySelector(`a[href="${href}"] img`);
        if (imgEl !== null) {
          const srcAttr = imgEl.getAttribute("src");
          if (srcAttr && srcAttr.startsWith("data:")) {
            slideConfig.href = srcAttr;
          }
        }
      } 
    });
  
    lightboxQuarto.on('slide_after_load', (data) => {
      const { slideIndex, slideNode, slideConfig, player, trigger } = data;
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(slideNode);
      }
    });
  
  };
  
})();
          </script>




</body></html>