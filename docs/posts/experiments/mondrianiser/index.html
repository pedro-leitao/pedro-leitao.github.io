<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.42">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="dcterms.date" content="2025-03-17">
<meta name="description" content="an example of generative models using a variational autoencoder">

<title>Mondrianiser: Image Inpainting with VAEs – Pedro Leitão</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../../">
<link href="../../../_static/logo.jpg" rel="icon" type="image/jpeg">
<script src="../../../site_libs/quarto-html/quarto.js"></script>
<script src="../../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../../site_libs/quarto-html/quarto-syntax-highlighting-a185852c63625fd9ffbdc57047c9a77e.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../../site_libs/bootstrap/bootstrap-6b5169cd70b11e3ab71bd7bb77c8208f.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script src="../../../site_libs/quarto-contrib/nutshell-1.0.7/nutshell.js"></script>
<script src="../../../site_libs/quarto-contrib/nutshell-1.0.7/nutshell_options.js"></script>
<script src="../../../site_libs/quarto-contrib/glightbox/glightbox.min.js"></script>
<link href="../../../site_libs/quarto-contrib/glightbox/glightbox.min.css" rel="stylesheet">
<link href="../../../site_libs/quarto-contrib/glightbox/lightbox.css" rel="stylesheet">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<style>

      .quarto-title-block .quarto-title-banner {
        background-image: url(../../../_static/banner-waves-partial.jpg);
background-size: cover;
      }
</style>
<script data-collect-dnt="true" async="" src="https://scripts.simpleanalyticscdn.com/latest.js"></script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="../../../styles.css">
<meta property="og:title" content="Mondrianiser: Image Inpainting with VAEs – Pedro Leitão">
<meta property="og:description" content="an example of generative models using a variational autoencoder">
<meta property="og:image" content="https://pedroleitao.nl/_static/logo.jpg">
<meta property="og:site_name" content="Pedro Leitão">
<meta name="twitter:title" content="Mondrianiser: Image Inpainting with VAEs – Pedro Leitão">
<meta name="twitter:description" content="an example of generative models using a variational autoencoder">
<meta name="twitter:image" content="https://pedroleitao.nl/posts/experiments/mondrianiser/index_files/figure-html/cell-3-output-1.png">
<meta name="twitter:image-height" content="610">
<meta name="twitter:image-width" content="612">
<meta name="twitter:card" content="summary_large_image">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a href="../../../index.html" class="navbar-brand navbar-brand-logo">
    <img src="../../../_static/logo.jpg" alt="" class="navbar-logo">
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../../index.html"> 
<span class="menu-text">Bio</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../about.html"> 
<span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../posts.html"> 
<span class="menu-text">All posts</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../experiments.html"> 
<span class="menu-text">Experiments</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../thoughts.html"> 
<span class="menu-text">Thoughts</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../howtos.html"> 
<span class="menu-text">Howto’s</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/pedro-leitao"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://linkedin.com/in/nunoleitao"> <i class="bi bi-linkedin" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="../../../posts.xml"> <i class="bi bi-rss" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Mondrianiser: Image Inpainting with VAEs</h1>
                  <div>
        <div class="description">
          an example of generative models using a variational autoencoder
        </div>
      </div>
                          <div class="quarto-categories">
                <div class="quarto-category">Experiments</div>
                <div class="quarto-category">Machine Learning</div>
                <div class="quarto-category">Deep Learning</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">March 17, 2025</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#the-architecture-of-a-variational-autoencoder" id="toc-the-architecture-of-a-variational-autoencoder" class="nav-link active" data-scroll-target="#the-architecture-of-a-variational-autoencoder">The architecture of a Variational Autoencoder</a></li>
  <li><a href="#mondrian" id="toc-mondrian" class="nav-link" data-scroll-target="#mondrian">Mondrian</a></li>
  <li><a href="#the-dataset-generator" id="toc-the-dataset-generator" class="nav-link" data-scroll-target="#the-dataset-generator">The dataset generator</a></li>
  <li><a href="#the-vae-model" id="toc-the-vae-model" class="nav-link" data-scroll-target="#the-vae-model">The VAE model</a>
  <ul class="collapse">
  <li><a href="#encoding" id="toc-encoding" class="nav-link" data-scroll-target="#encoding">Encoding</a></li>
  <li><a href="#decoding" id="toc-decoding" class="nav-link" data-scroll-target="#decoding">Decoding</a></li>
  <li><a href="#the-model" id="toc-the-model" class="nav-link" data-scroll-target="#the-model">The model</a></li>
  <li><a href="#annealing-the-kl-divergence" id="toc-annealing-the-kl-divergence" class="nav-link" data-scroll-target="#annealing-the-kl-divergence">Annealing the KL divergence</a></li>
  <li><a href="#the-loss-function" id="toc-the-loss-function" class="nav-link" data-scroll-target="#the-loss-function">The loss function</a></li>
  <li><a href="#the-training-loop" id="toc-the-training-loop" class="nav-link" data-scroll-target="#the-training-loop">The training loop</a></li>
  <li><a href="#inference" id="toc-inference" class="nav-link" data-scroll-target="#inference">Inference</a></li>
  </ul></li>
  <li><a href="#putting-it-all-together" id="toc-putting-it-all-together" class="nav-link" data-scroll-target="#putting-it-all-together">Putting it all together</a></li>
  <li><a href="#producing-an-entirely-new-image" id="toc-producing-an-entirely-new-image" class="nav-link" data-scroll-target="#producing-an-entirely-new-image">Producing an entirely new image</a></li>
  <li><a href="#final-remarks" id="toc-final-remarks" class="nav-link" data-scroll-target="#final-remarks">Final remarks</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">





<p>Besides classification and regression tasks, deep learning models can also be used for generative tasks, where the goal is to generate new data samples that can mimic the distribution of the training data. Generative models have a wide range of applications, including image generation, style transfer, image inpainting, and more.</p>
<p>In this experiment, we’ll explore the use of a <a href="https://en.wikipedia.org/wiki/Variational_autoencoder">:link Variational Autoencoder</a> (VAE) to inpaint missing regions in images. The task of inpainting involves filling in unknown regions, which can be useful for image restoration, editing, and other applications. For example, your phone camera likely has a feature that can remove unwanted objects from a photo by inpainting the missing regions - the way it achieves this is by using generative models like VAEs.</p>
<section id="the-architecture-of-a-variational-autoencoder" class="level1">
<h1>The architecture of a Variational Autoencoder</h1>
<p>The VAE is a type of generative model which learns a <em>latent</em> representation of the input data. What latent in this context means is that the model transforms the original data into a compressed, hidden form that captures its most important features. This latent space is not directly observable but serves as an internal representation from which the model can reconstruct or generate new data.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>A similar concept exists with text embeddings. When processing text, models convert words or sentences into numerical vectors that capture the underlying meaning, relationships, and context. These embeddings are like a latent space for language, they’re not meant to be read directly but provide a simplified and efficient representation of the text’s core information. This parallel shows that whether dealing with images or text, many models rely on hidden representations to manage and manipulate complex data.</p>
</div>
</div>
<p>Once the model has learned this compressed representation, it can use it to create variations or entirely new examples that resemble the original inputs. By working in this latent space, the VAE is able to simplify complex data into a more manageable format while still retaining the core characteristics needed for effective reconstruction and generation.</p>
<div class="cell" data-layout-align="default">
<div class="cell-output-display">
<div>
<p></p><figure class="figure"><p></p>
<div>
<svg width="672" height="480" viewbox="0.00 0.00 684.00 230.00" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" style="; max-width: none; max-height: none">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 226)">
<title>VAE</title>
<polygon fill="white" stroke="transparent" points="-4,4 -4,-226 680,-226 680,4 -4,4"></polygon>
<g id="clust1" class="cluster">
<title>cluster_encoder</title>
<polygon fill="none" stroke="gray" stroke-dasharray="5,2" points="136,-8 136,-214 274,-214 274,-8 136,-8"></polygon>
<text text-anchor="middle" x="205" y="-197.4" font-family="Times,serif" font-size="14.00">Encoder</text>
</g>
<g id="clust2" class="cluster">
<title>cluster_latent</title>
<polygon fill="none" stroke="gray" stroke-dasharray="5,2" points="294,-8 294,-214 382,-214 382,-8 294,-8"></polygon>
<text text-anchor="middle" x="338" y="-197.4" font-family="Times,serif" font-size="14.00">Latent Space</text>
</g>
<g id="clust3" class="cluster">
<title>cluster_decoder</title>
<polygon fill="none" stroke="gray" stroke-dasharray="5,2" points="402,-8 402,-214 540,-214 540,-8 402,-8"></polygon>
<text text-anchor="middle" x="471" y="-197.4" font-family="Times,serif" font-size="14.00">Decoder</text>
</g>
<!-- input -->
<g id="node1" class="node">
<title>input</title>
<polygon fill="white" stroke="black" points="108,-117 0,-117 0,-81 108,-81 108,-117"></polygon>
<text text-anchor="middle" x="54" y="-94.8" font-family="Times,serif" font-size="14.00">Original</text>
</g>
<!-- E1_1 -->
<g id="node3" class="node">
<title>E1_1</title>
<ellipse fill="#c8e6c9" stroke="#2e7d32" cx="165.5" cy="-38" rx="21.5" ry="21.5"></ellipse>
</g>
<!-- input&#45;&gt;E1_1 -->
<g id="edge1" class="edge">
<title>input-&gt;E1_1</title>
<path fill="none" stroke="black" d="M87.56,-80.86C103.43,-72.02 122.29,-61.51 137.37,-53.11"></path>
<polygon fill="black" stroke="black" points="139.18,-56.11 146.21,-48.19 135.77,-50 139.18,-56.11"></polygon>
</g>
<!-- E1_2 -->
<g id="node4" class="node">
<title>E1_2</title>
<ellipse fill="#c8e6c9" stroke="#2e7d32" cx="165.5" cy="-160" rx="21.5" ry="21.5"></ellipse>
</g>
<!-- input&#45;&gt;E1_2 -->
<g id="edge2" class="edge">
<title>input-&gt;E1_2</title>
<path fill="none" stroke="black" d="M87.56,-117.14C103.43,-125.98 122.29,-136.49 137.37,-144.89"></path>
<polygon fill="black" stroke="black" points="135.77,-148 146.21,-149.81 139.18,-141.89 135.77,-148"></polygon>
</g>
<!-- E1_3 -->
<g id="node5" class="node">
<title>E1_3</title>
<ellipse fill="#c8e6c9" stroke="#2e7d32" cx="165.5" cy="-99" rx="21.5" ry="21.5"></ellipse>
</g>
<!-- input&#45;&gt;E1_3 -->
<g id="edge3" class="edge">
<title>input-&gt;E1_3</title>
<path fill="none" stroke="black" d="M108.15,-99C116.91,-99 125.73,-99 133.71,-99"></path>
<polygon fill="black" stroke="black" points="133.98,-102.5 143.98,-99 133.98,-95.5 133.98,-102.5"></polygon>
</g>
<!-- output -->
<g id="node2" class="node">
<title>output</title>
<polygon fill="white" stroke="black" points="676,-117 568,-117 568,-81 676,-81 676,-117"></polygon>
<text text-anchor="middle" x="622" y="-94.8" font-family="Times,serif" font-size="14.00">Reconstructed</text>
</g>
<!-- E2_1 -->
<g id="node6" class="node">
<title>E2_1</title>
<ellipse fill="#c8e6c9" stroke="#2e7d32" cx="244.5" cy="-99" rx="21.5" ry="21.5"></ellipse>
</g>
<!-- E1_1&#45;&gt;E2_1 -->
<g id="edge4" class="edge">
<title>E1_1-&gt;E2_1</title>
<path fill="none" stroke="black" d="M182.83,-50.94C193.34,-59.27 207.21,-70.25 219.03,-79.61"></path>
<polygon fill="black" stroke="black" points="217.18,-82.62 227.19,-86.08 221.53,-77.13 217.18,-82.62"></polygon>
</g>
<!-- E2_2 -->
<g id="node7" class="node">
<title>E2_2</title>
<ellipse fill="#c8e6c9" stroke="#2e7d32" cx="244.5" cy="-160" rx="21.5" ry="21.5"></ellipse>
</g>
<!-- E1_1&#45;&gt;E2_2 -->
<g id="edge5" class="edge">
<title>E1_1-&gt;E2_2</title>
<path fill="none" stroke="black" d="M177.7,-55.74C190.64,-76.25 212.07,-110.2 226.94,-133.77"></path>
<polygon fill="black" stroke="black" points="223.99,-135.65 232.29,-142.24 229.91,-131.91 223.99,-135.65"></polygon>
</g>
<!-- E2_3 -->
<g id="node8" class="node">
<title>E2_3</title>
<ellipse fill="#c8e6c9" stroke="#2e7d32" cx="244.5" cy="-38" rx="21.5" ry="21.5"></ellipse>
</g>
<!-- E1_1&#45;&gt;E2_3 -->
<g id="edge6" class="edge">
<title>E1_1-&gt;E2_3</title>
<path fill="none" stroke="black" d="M187.13,-38C194.99,-38 204.12,-38 212.71,-38"></path>
<polygon fill="black" stroke="black" points="212.81,-41.5 222.81,-38 212.81,-34.5 212.81,-41.5"></polygon>
</g>
<!-- E1_2&#45;&gt;E2_1 -->
<g id="edge7" class="edge">
<title>E1_2-&gt;E2_1</title>
<path fill="none" stroke="black" d="M182.83,-147.06C193.34,-138.73 207.21,-127.75 219.03,-118.39"></path>
<polygon fill="black" stroke="black" points="221.53,-120.87 227.19,-111.92 217.18,-115.38 221.53,-120.87"></polygon>
</g>
<!-- E1_2&#45;&gt;E2_2 -->
<g id="edge8" class="edge">
<title>E1_2-&gt;E2_2</title>
<path fill="none" stroke="black" d="M187.13,-160C194.99,-160 204.12,-160 212.71,-160"></path>
<polygon fill="black" stroke="black" points="212.81,-163.5 222.81,-160 212.81,-156.5 212.81,-163.5"></polygon>
</g>
<!-- E1_2&#45;&gt;E2_3 -->
<g id="edge9" class="edge">
<title>E1_2-&gt;E2_3</title>
<path fill="none" stroke="black" d="M177.7,-142.26C190.64,-121.75 212.07,-87.8 226.94,-64.23"></path>
<polygon fill="black" stroke="black" points="229.91,-66.09 232.29,-55.76 223.99,-62.35 229.91,-66.09"></polygon>
</g>
<!-- E1_3&#45;&gt;E2_1 -->
<g id="edge10" class="edge">
<title>E1_3-&gt;E2_1</title>
<path fill="none" stroke="black" d="M187.13,-99C194.99,-99 204.12,-99 212.71,-99"></path>
<polygon fill="black" stroke="black" points="212.81,-102.5 222.81,-99 212.81,-95.5 212.81,-102.5"></polygon>
</g>
<!-- E1_3&#45;&gt;E2_2 -->
<g id="edge11" class="edge">
<title>E1_3-&gt;E2_2</title>
<path fill="none" stroke="black" d="M182.83,-111.94C193.34,-120.27 207.21,-131.25 219.03,-140.61"></path>
<polygon fill="black" stroke="black" points="217.18,-143.62 227.19,-147.08 221.53,-138.13 217.18,-143.62"></polygon>
</g>
<!-- E1_3&#45;&gt;E2_3 -->
<g id="edge12" class="edge">
<title>E1_3-&gt;E2_3</title>
<path fill="none" stroke="black" d="M182.83,-86.06C193.34,-77.73 207.21,-66.75 219.03,-57.39"></path>
<polygon fill="black" stroke="black" points="221.53,-59.87 227.19,-50.92 217.18,-54.38 221.53,-59.87"></polygon>
</g>
<!-- L1 -->
<g id="node9" class="node">
<title>L1</title>
<ellipse fill="#212121" stroke="#212121" cx="337.5" cy="-38" rx="21.5" ry="21.5"></ellipse>
</g>
<!-- E2_1&#45;&gt;L1 -->
<g id="edge13" class="edge">
<title>E2_1-&gt;L1</title>
<path fill="none" stroke="black" d="M263.05,-87.24C276.6,-78.15 295.56,-65.44 310.83,-55.21"></path>
<polygon fill="black" stroke="black" points="312.96,-57.99 319.32,-49.52 309.06,-52.18 312.96,-57.99"></polygon>
</g>
<!-- L2 -->
<g id="node10" class="node">
<title>L2</title>
<ellipse fill="#212121" stroke="#212121" cx="337.5" cy="-160" rx="21.5" ry="21.5"></ellipse>
</g>
<!-- E2_1&#45;&gt;L2 -->
<g id="edge14" class="edge">
<title>E2_1-&gt;L2</title>
<path fill="none" stroke="black" d="M263.05,-110.76C276.6,-119.85 295.56,-132.56 310.83,-142.79"></path>
<polygon fill="black" stroke="black" points="309.06,-145.82 319.32,-148.48 312.96,-140.01 309.06,-145.82"></polygon>
</g>
<!-- L3 -->
<g id="node11" class="node">
<title>L3</title>
<ellipse fill="#212121" stroke="#212121" cx="337.5" cy="-99" rx="21.5" ry="21.5"></ellipse>
</g>
<!-- E2_1&#45;&gt;L3 -->
<g id="edge15" class="edge">
<title>E2_1-&gt;L3</title>
<path fill="none" stroke="black" d="M266.15,-99C277.9,-99 292.84,-99 305.93,-99"></path>
<polygon fill="black" stroke="black" points="305.93,-102.5 315.93,-99 305.93,-95.5 305.93,-102.5"></polygon>
</g>
<!-- E2_2&#45;&gt;L1 -->
<g id="edge16" class="edge">
<title>E2_2-&gt;L1</title>
<path fill="none" stroke="black" d="M258.15,-143.04C273.64,-122.28 299.99,-86.95 317.81,-63.06"></path>
<polygon fill="black" stroke="black" points="320.78,-64.93 323.95,-54.82 315.17,-60.74 320.78,-64.93"></polygon>
</g>
<!-- E2_2&#45;&gt;L2 -->
<g id="edge17" class="edge">
<title>E2_2-&gt;L2</title>
<path fill="none" stroke="black" d="M266.15,-160C277.9,-160 292.84,-160 305.93,-160"></path>
<polygon fill="black" stroke="black" points="305.93,-163.5 315.93,-160 305.93,-156.5 305.93,-163.5"></polygon>
</g>
<!-- E2_2&#45;&gt;L3 -->
<g id="edge18" class="edge">
<title>E2_2-&gt;L3</title>
<path fill="none" stroke="black" d="M263.05,-148.24C276.6,-139.15 295.56,-126.44 310.83,-116.21"></path>
<polygon fill="black" stroke="black" points="312.96,-118.99 319.32,-110.52 309.06,-113.18 312.96,-118.99"></polygon>
</g>
<!-- E2_3&#45;&gt;L1 -->
<g id="edge19" class="edge">
<title>E2_3-&gt;L1</title>
<path fill="none" stroke="black" d="M266.15,-38C277.9,-38 292.84,-38 305.93,-38"></path>
<polygon fill="black" stroke="black" points="305.93,-41.5 315.93,-38 305.93,-34.5 305.93,-41.5"></polygon>
</g>
<!-- E2_3&#45;&gt;L2 -->
<g id="edge20" class="edge">
<title>E2_3-&gt;L2</title>
<path fill="none" stroke="black" d="M258.15,-54.96C273.64,-75.72 299.99,-111.05 317.81,-134.94"></path>
<polygon fill="black" stroke="black" points="315.17,-137.26 323.95,-143.18 320.78,-133.07 315.17,-137.26"></polygon>
</g>
<!-- E2_3&#45;&gt;L3 -->
<g id="edge21" class="edge">
<title>E2_3-&gt;L3</title>
<path fill="none" stroke="black" d="M263.05,-49.76C276.6,-58.85 295.56,-71.56 310.83,-81.79"></path>
<polygon fill="black" stroke="black" points="309.06,-84.82 319.32,-87.48 312.96,-79.01 309.06,-84.82"></polygon>
</g>
<!-- D1_1 -->
<g id="node12" class="node">
<title>D1_1</title>
<ellipse fill="#bbdefb" stroke="#1e88e5" cx="431.5" cy="-38" rx="21.5" ry="21.5"></ellipse>
</g>
<!-- L1&#45;&gt;D1_1 -->
<g id="edge22" class="edge">
<title>L1-&gt;D1_1</title>
<path fill="none" stroke="black" d="M359.38,-38C371.26,-38 386.36,-38 399.59,-38"></path>
<polygon fill="black" stroke="black" points="399.71,-41.5 409.71,-38 399.71,-34.5 399.71,-41.5"></polygon>
</g>
<!-- D1_2 -->
<g id="node13" class="node">
<title>D1_2</title>
<ellipse fill="#bbdefb" stroke="#1e88e5" cx="431.5" cy="-160" rx="21.5" ry="21.5"></ellipse>
</g>
<!-- L1&#45;&gt;D1_2 -->
<g id="edge23" class="edge">
<title>L1-&gt;D1_2</title>
<path fill="none" stroke="black" d="M351.1,-54.71C366.7,-75.4 393.43,-110.84 411.52,-134.83"></path>
<polygon fill="black" stroke="black" points="408.94,-137.23 417.76,-143.1 414.53,-133.01 408.94,-137.23"></polygon>
</g>
<!-- D1_3 -->
<g id="node14" class="node">
<title>D1_3</title>
<ellipse fill="#bbdefb" stroke="#1e88e5" cx="431.5" cy="-99" rx="21.5" ry="21.5"></ellipse>
</g>
<!-- L1&#45;&gt;D1_3 -->
<g id="edge24" class="edge">
<title>L1-&gt;D1_3</title>
<path fill="none" stroke="black" d="M355.8,-49.47C369.55,-58.59 389,-71.48 404.6,-81.83"></path>
<polygon fill="black" stroke="black" points="403,-84.97 413.27,-87.58 406.87,-79.13 403,-84.97"></polygon>
</g>
<!-- L2&#45;&gt;D1_1 -->
<g id="edge25" class="edge">
<title>L2-&gt;D1_1</title>
<path fill="none" stroke="black" d="M351.1,-143.29C366.7,-122.6 393.43,-87.16 411.52,-63.17"></path>
<polygon fill="black" stroke="black" points="414.53,-64.99 417.76,-54.9 408.94,-60.77 414.53,-64.99"></polygon>
</g>
<!-- L2&#45;&gt;D1_2 -->
<g id="edge26" class="edge">
<title>L2-&gt;D1_2</title>
<path fill="none" stroke="black" d="M359.38,-160C371.26,-160 386.36,-160 399.59,-160"></path>
<polygon fill="black" stroke="black" points="399.71,-163.5 409.71,-160 399.71,-156.5 399.71,-163.5"></polygon>
</g>
<!-- L2&#45;&gt;D1_3 -->
<g id="edge27" class="edge">
<title>L2-&gt;D1_3</title>
<path fill="none" stroke="black" d="M355.8,-148.53C369.55,-139.41 389,-126.52 404.6,-116.17"></path>
<polygon fill="black" stroke="black" points="406.87,-118.87 413.27,-110.42 403,-113.03 406.87,-118.87"></polygon>
</g>
<!-- L3&#45;&gt;D1_1 -->
<g id="edge28" class="edge">
<title>L3-&gt;D1_1</title>
<path fill="none" stroke="black" d="M355.8,-87.53C369.55,-78.41 389,-65.52 404.6,-55.17"></path>
<polygon fill="black" stroke="black" points="406.87,-57.87 413.27,-49.42 403,-52.03 406.87,-57.87"></polygon>
</g>
<!-- L3&#45;&gt;D1_2 -->
<g id="edge29" class="edge">
<title>L3-&gt;D1_2</title>
<path fill="none" stroke="black" d="M355.8,-110.47C369.55,-119.59 389,-132.48 404.6,-142.83"></path>
<polygon fill="black" stroke="black" points="403,-145.97 413.27,-148.58 406.87,-140.13 403,-145.97"></polygon>
</g>
<!-- L3&#45;&gt;D1_3 -->
<g id="edge30" class="edge">
<title>L3-&gt;D1_3</title>
<path fill="none" stroke="black" d="M359.38,-99C371.26,-99 386.36,-99 399.59,-99"></path>
<polygon fill="black" stroke="black" points="399.71,-102.5 409.71,-99 399.71,-95.5 399.71,-102.5"></polygon>
</g>
<!-- D2_1 -->
<g id="node15" class="node">
<title>D2_1</title>
<ellipse fill="#bbdefb" stroke="#1e88e5" cx="510.5" cy="-99" rx="21.5" ry="21.5"></ellipse>
</g>
<!-- D1_1&#45;&gt;D2_1 -->
<g id="edge31" class="edge">
<title>D1_1-&gt;D2_1</title>
<path fill="none" stroke="black" d="M448.83,-50.94C459.34,-59.27 473.21,-70.25 485.03,-79.61"></path>
<polygon fill="black" stroke="black" points="483.18,-82.62 493.19,-86.08 487.53,-77.13 483.18,-82.62"></polygon>
</g>
<!-- D2_2 -->
<g id="node16" class="node">
<title>D2_2</title>
<ellipse fill="#bbdefb" stroke="#1e88e5" cx="510.5" cy="-160" rx="21.5" ry="21.5"></ellipse>
</g>
<!-- D1_1&#45;&gt;D2_2 -->
<g id="edge32" class="edge">
<title>D1_1-&gt;D2_2</title>
<path fill="none" stroke="black" d="M443.7,-55.74C456.64,-76.25 478.07,-110.2 492.94,-133.77"></path>
<polygon fill="black" stroke="black" points="489.99,-135.65 498.29,-142.24 495.91,-131.91 489.99,-135.65"></polygon>
</g>
<!-- D2_3 -->
<g id="node17" class="node">
<title>D2_3</title>
<ellipse fill="#bbdefb" stroke="#1e88e5" cx="510.5" cy="-38" rx="21.5" ry="21.5"></ellipse>
</g>
<!-- D1_1&#45;&gt;D2_3 -->
<g id="edge33" class="edge">
<title>D1_1-&gt;D2_3</title>
<path fill="none" stroke="black" d="M453.13,-38C460.99,-38 470.12,-38 478.71,-38"></path>
<polygon fill="black" stroke="black" points="478.81,-41.5 488.81,-38 478.81,-34.5 478.81,-41.5"></polygon>
</g>
<!-- D1_2&#45;&gt;D2_1 -->
<g id="edge34" class="edge">
<title>D1_2-&gt;D2_1</title>
<path fill="none" stroke="black" d="M448.83,-147.06C459.34,-138.73 473.21,-127.75 485.03,-118.39"></path>
<polygon fill="black" stroke="black" points="487.53,-120.87 493.19,-111.92 483.18,-115.38 487.53,-120.87"></polygon>
</g>
<!-- D1_2&#45;&gt;D2_2 -->
<g id="edge35" class="edge">
<title>D1_2-&gt;D2_2</title>
<path fill="none" stroke="black" d="M453.13,-160C460.99,-160 470.12,-160 478.71,-160"></path>
<polygon fill="black" stroke="black" points="478.81,-163.5 488.81,-160 478.81,-156.5 478.81,-163.5"></polygon>
</g>
<!-- D1_2&#45;&gt;D2_3 -->
<g id="edge36" class="edge">
<title>D1_2-&gt;D2_3</title>
<path fill="none" stroke="black" d="M443.7,-142.26C456.64,-121.75 478.07,-87.8 492.94,-64.23"></path>
<polygon fill="black" stroke="black" points="495.91,-66.09 498.29,-55.76 489.99,-62.35 495.91,-66.09"></polygon>
</g>
<!-- D1_3&#45;&gt;D2_1 -->
<g id="edge37" class="edge">
<title>D1_3-&gt;D2_1</title>
<path fill="none" stroke="black" d="M453.13,-99C460.99,-99 470.12,-99 478.71,-99"></path>
<polygon fill="black" stroke="black" points="478.81,-102.5 488.81,-99 478.81,-95.5 478.81,-102.5"></polygon>
</g>
<!-- D1_3&#45;&gt;D2_2 -->
<g id="edge38" class="edge">
<title>D1_3-&gt;D2_2</title>
<path fill="none" stroke="black" d="M448.83,-111.94C459.34,-120.27 473.21,-131.25 485.03,-140.61"></path>
<polygon fill="black" stroke="black" points="483.18,-143.62 493.19,-147.08 487.53,-138.13 483.18,-143.62"></polygon>
</g>
<!-- D1_3&#45;&gt;D2_3 -->
<g id="edge39" class="edge">
<title>D1_3-&gt;D2_3</title>
<path fill="none" stroke="black" d="M448.83,-86.06C459.34,-77.73 473.21,-66.75 485.03,-57.39"></path>
<polygon fill="black" stroke="black" points="487.53,-59.87 493.19,-50.92 483.18,-54.38 487.53,-59.87"></polygon>
</g>
<!-- D2_1&#45;&gt;output -->
<g id="edge40" class="edge">
<title>D2_1-&gt;output</title>
<path fill="none" stroke="black" d="M532.1,-99C539.56,-99 548.43,-99 557.63,-99"></path>
<polygon fill="black" stroke="black" points="557.7,-102.5 567.7,-99 557.7,-95.5 557.7,-102.5"></polygon>
</g>
<!-- D2_2&#45;&gt;output -->
<g id="edge41" class="edge">
<title>D2_2-&gt;output</title>
<path fill="none" stroke="black" d="M529.58,-149.93C543.13,-142.38 562.23,-131.74 579.47,-122.13"></path>
<polygon fill="black" stroke="black" points="581.25,-125.15 588.28,-117.23 577.84,-119.04 581.25,-125.15"></polygon>
</g>
<!-- D2_3&#45;&gt;output -->
<g id="edge42" class="edge">
<title>D2_3-&gt;output</title>
<path fill="none" stroke="black" d="M529.58,-48.07C543.13,-55.62 562.23,-66.26 579.47,-75.87"></path>
<polygon fill="black" stroke="black" points="577.84,-78.96 588.28,-80.77 581.25,-72.85 577.84,-78.96"></polygon>
</g>
</g>
</svg>
</div>
<p></p></figure><p></p>
</div>
</div>
</div>
</section>
<section id="mondrian" class="level1">
<h1>Mondrian</h1>
<p>Training a VAE for an inpainting task requires a dataset of images for the model to learn from. For this experiment, we will use a simple Mondrian image generator to create a dataset of images with missing regions. The Mondrian images are inspired by the works of <a href="https://en.wikipedia.org/wiki/Piet_Mondrian">:link Piet Mondrian</a>, a Dutch painter known for his abstract compositions of lines and colors.</p>
<p>These images are created by recursively splitting the canvas into smaller regions, each filled with a random color. The Mondrian images will serve as our training data, with a square mask applied to each image to simulate the missing regions that need to be inpainted. They are simple enough to generate programmatically, and for a relatively simple model to learn from without requiring a large dataset of images (like for example, the <a href="https://mmlab.ie.cuhk.edu.hk/projects/CelebA.html">CelebA dataset</a>).</p>
<p>Let us start by creating a Mondrian image generator, which we will then use to create a dataset for training our VAE model.</p>
<div id="f1f7cdce" class="cell" data-execution_count="2">
<details class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="f1f7cdce"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="f1f7cdce-1"><a href="#f1f7cdce-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> random</span>
<span id="f1f7cdce-2"><a href="#f1f7cdce-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="f1f7cdce-3"><a href="#f1f7cdce-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="f1f7cdce-4"><a href="#f1f7cdce-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="f1f7cdce-5"><a href="#f1f7cdce-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Mondrian image generator</span></span>
<span id="f1f7cdce-6"><a href="#f1f7cdce-6" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> generate_mondrian(</span>
<span id="f1f7cdce-7"><a href="#f1f7cdce-7" aria-hidden="true" tabindex="-1"></a>    width,</span>
<span id="f1f7cdce-8"><a href="#f1f7cdce-8" aria-hidden="true" tabindex="-1"></a>    height,</span>
<span id="f1f7cdce-9"><a href="#f1f7cdce-9" aria-hidden="true" tabindex="-1"></a>    border_thickness<span class="op">=</span><span class="dv">3</span>,</span>
<span id="f1f7cdce-10"><a href="#f1f7cdce-10" aria-hidden="true" tabindex="-1"></a>    split_prob<span class="op">=</span><span class="fl">0.7</span>,</span>
<span id="f1f7cdce-11"><a href="#f1f7cdce-11" aria-hidden="true" tabindex="-1"></a>    black_line_thickness<span class="op">=</span><span class="dv">2</span>,</span>
<span id="f1f7cdce-12"><a href="#f1f7cdce-12" aria-hidden="true" tabindex="-1"></a>    min_depth<span class="op">=</span><span class="dv">2</span>,</span>
<span id="f1f7cdce-13"><a href="#f1f7cdce-13" aria-hidden="true" tabindex="-1"></a>    max_depth<span class="op">=</span><span class="dv">5</span>,</span>
<span id="f1f7cdce-14"><a href="#f1f7cdce-14" aria-hidden="true" tabindex="-1"></a>    overall_border_thickness<span class="op">=</span><span class="dv">6</span>,</span>
<span id="f1f7cdce-15"><a href="#f1f7cdce-15" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="f1f7cdce-16"><a href="#f1f7cdce-16" aria-hidden="true" tabindex="-1"></a>    img <span class="op">=</span> np.ones((height, width, <span class="dv">3</span>), dtype<span class="op">=</span>np.uint8) <span class="op">*</span> <span class="dv">255</span></span>
<span id="f1f7cdce-17"><a href="#f1f7cdce-17" aria-hidden="true" tabindex="-1"></a>    colors <span class="op">=</span> [</span>
<span id="f1f7cdce-18"><a href="#f1f7cdce-18" aria-hidden="true" tabindex="-1"></a>        (<span class="dv">255</span>, <span class="dv">0</span>, <span class="dv">0</span>),  <span class="co"># red</span></span>
<span id="f1f7cdce-19"><a href="#f1f7cdce-19" aria-hidden="true" tabindex="-1"></a>        (<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">255</span>),  <span class="co"># blue</span></span>
<span id="f1f7cdce-20"><a href="#f1f7cdce-20" aria-hidden="true" tabindex="-1"></a>        (<span class="dv">255</span>, <span class="dv">255</span>, <span class="dv">0</span>),  <span class="co"># yellow</span></span>
<span id="f1f7cdce-21"><a href="#f1f7cdce-21" aria-hidden="true" tabindex="-1"></a>        (<span class="dv">255</span>, <span class="dv">255</span>, <span class="dv">255</span>),  <span class="co"># white</span></span>
<span id="f1f7cdce-22"><a href="#f1f7cdce-22" aria-hidden="true" tabindex="-1"></a>        (<span class="dv">255</span>, <span class="dv">165</span>, <span class="dv">0</span>),  <span class="co"># orange</span></span>
<span id="f1f7cdce-23"><a href="#f1f7cdce-23" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="f1f7cdce-24"><a href="#f1f7cdce-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="f1f7cdce-25"><a href="#f1f7cdce-25" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> fill_region(x, y, w, h):</span>
<span id="f1f7cdce-26"><a href="#f1f7cdce-26" aria-hidden="true" tabindex="-1"></a>        fill_color <span class="op">=</span> random.choice(colors)</span>
<span id="f1f7cdce-27"><a href="#f1f7cdce-27" aria-hidden="true" tabindex="-1"></a>        img[y : y <span class="op">+</span> h, x : x <span class="op">+</span> w] <span class="op">=</span> fill_color</span>
<span id="f1f7cdce-28"><a href="#f1f7cdce-28" aria-hidden="true" tabindex="-1"></a>        img[y : y <span class="op">+</span> border_thickness, x : x <span class="op">+</span> w] <span class="op">=</span> <span class="dv">255</span></span>
<span id="f1f7cdce-29"><a href="#f1f7cdce-29" aria-hidden="true" tabindex="-1"></a>        img[y <span class="op">+</span> h <span class="op">-</span> border_thickness : y <span class="op">+</span> h, x : x <span class="op">+</span> w] <span class="op">=</span> <span class="dv">255</span></span>
<span id="f1f7cdce-30"><a href="#f1f7cdce-30" aria-hidden="true" tabindex="-1"></a>        img[y : y <span class="op">+</span> h, x : x <span class="op">+</span> border_thickness] <span class="op">=</span> <span class="dv">255</span></span>
<span id="f1f7cdce-31"><a href="#f1f7cdce-31" aria-hidden="true" tabindex="-1"></a>        img[y : y <span class="op">+</span> h, x <span class="op">+</span> w <span class="op">-</span> border_thickness : x <span class="op">+</span> w] <span class="op">=</span> <span class="dv">255</span></span>
<span id="f1f7cdce-32"><a href="#f1f7cdce-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="f1f7cdce-33"><a href="#f1f7cdce-33" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> split_region(x, y, w, h, depth<span class="op">=</span><span class="dv">0</span>):</span>
<span id="f1f7cdce-34"><a href="#f1f7cdce-34" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> w <span class="op">&lt;</span> <span class="dv">50</span> <span class="kw">or</span> h <span class="op">&lt;</span> <span class="dv">50</span>:</span>
<span id="f1f7cdce-35"><a href="#f1f7cdce-35" aria-hidden="true" tabindex="-1"></a>            fill_region(x, y, w, h)</span>
<span id="f1f7cdce-36"><a href="#f1f7cdce-36" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span></span>
<span id="f1f7cdce-37"><a href="#f1f7cdce-37" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> depth <span class="op">&gt;=</span> max_depth:</span>
<span id="f1f7cdce-38"><a href="#f1f7cdce-38" aria-hidden="true" tabindex="-1"></a>            fill_region(x, y, w, h)</span>
<span id="f1f7cdce-39"><a href="#f1f7cdce-39" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span></span>
<span id="f1f7cdce-40"><a href="#f1f7cdce-40" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> depth <span class="op">&gt;=</span> min_depth <span class="kw">and</span> random.random() <span class="op">&gt;</span> split_prob:</span>
<span id="f1f7cdce-41"><a href="#f1f7cdce-41" aria-hidden="true" tabindex="-1"></a>            fill_region(x, y, w, h)</span>
<span id="f1f7cdce-42"><a href="#f1f7cdce-42" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span></span>
<span id="f1f7cdce-43"><a href="#f1f7cdce-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="f1f7cdce-44"><a href="#f1f7cdce-44" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> w <span class="op">&gt;</span> h:</span>
<span id="f1f7cdce-45"><a href="#f1f7cdce-45" aria-hidden="true" tabindex="-1"></a>            split_x <span class="op">=</span> random.randint(x <span class="op">+</span> <span class="bu">int</span>(<span class="fl">0.3</span> <span class="op">*</span> w), x <span class="op">+</span> <span class="bu">int</span>(<span class="fl">0.7</span> <span class="op">*</span> w))</span>
<span id="f1f7cdce-46"><a href="#f1f7cdce-46" aria-hidden="true" tabindex="-1"></a>            white_start <span class="op">=</span> split_x <span class="op">-</span> border_thickness <span class="op">//</span> <span class="dv">2</span></span>
<span id="f1f7cdce-47"><a href="#f1f7cdce-47" aria-hidden="true" tabindex="-1"></a>            white_end <span class="op">=</span> split_x <span class="op">+</span> border_thickness <span class="op">//</span> <span class="dv">2</span></span>
<span id="f1f7cdce-48"><a href="#f1f7cdce-48" aria-hidden="true" tabindex="-1"></a>            img[y : y <span class="op">+</span> h, white_start:white_end] <span class="op">=</span> <span class="dv">255</span></span>
<span id="f1f7cdce-49"><a href="#f1f7cdce-49" aria-hidden="true" tabindex="-1"></a>            bl_start <span class="op">=</span> split_x <span class="op">-</span> black_line_thickness <span class="op">//</span> <span class="dv">2</span></span>
<span id="f1f7cdce-50"><a href="#f1f7cdce-50" aria-hidden="true" tabindex="-1"></a>            bl_end <span class="op">=</span> split_x <span class="op">+</span> black_line_thickness <span class="op">//</span> <span class="dv">2</span> <span class="op">+</span> (black_line_thickness <span class="op">%</span> <span class="dv">2</span>)</span>
<span id="f1f7cdce-51"><a href="#f1f7cdce-51" aria-hidden="true" tabindex="-1"></a>            img[y : y <span class="op">+</span> h, bl_start:bl_end] <span class="op">=</span> (<span class="dv">75</span>, <span class="dv">75</span>, <span class="dv">75</span>)</span>
<span id="f1f7cdce-52"><a href="#f1f7cdce-52" aria-hidden="true" tabindex="-1"></a>            left_width <span class="op">=</span> white_start <span class="op">-</span> x</span>
<span id="f1f7cdce-53"><a href="#f1f7cdce-53" aria-hidden="true" tabindex="-1"></a>            right_width <span class="op">=</span> (x <span class="op">+</span> w) <span class="op">-</span> white_end</span>
<span id="f1f7cdce-54"><a href="#f1f7cdce-54" aria-hidden="true" tabindex="-1"></a>            split_region(x, y, left_width, h, depth <span class="op">+</span> <span class="dv">1</span>)</span>
<span id="f1f7cdce-55"><a href="#f1f7cdce-55" aria-hidden="true" tabindex="-1"></a>            split_region(white_end, y, right_width, h, depth <span class="op">+</span> <span class="dv">1</span>)</span>
<span id="f1f7cdce-56"><a href="#f1f7cdce-56" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="f1f7cdce-57"><a href="#f1f7cdce-57" aria-hidden="true" tabindex="-1"></a>            split_y <span class="op">=</span> random.randint(y <span class="op">+</span> <span class="bu">int</span>(<span class="fl">0.3</span> <span class="op">*</span> h), y <span class="op">+</span> <span class="bu">int</span>(<span class="fl">0.7</span> <span class="op">*</span> h))</span>
<span id="f1f7cdce-58"><a href="#f1f7cdce-58" aria-hidden="true" tabindex="-1"></a>            white_start <span class="op">=</span> split_y <span class="op">-</span> border_thickness <span class="op">//</span> <span class="dv">2</span></span>
<span id="f1f7cdce-59"><a href="#f1f7cdce-59" aria-hidden="true" tabindex="-1"></a>            white_end <span class="op">=</span> split_y <span class="op">+</span> border_thickness <span class="op">//</span> <span class="dv">2</span></span>
<span id="f1f7cdce-60"><a href="#f1f7cdce-60" aria-hidden="true" tabindex="-1"></a>            img[white_start:white_end, x : x <span class="op">+</span> w] <span class="op">=</span> <span class="dv">255</span></span>
<span id="f1f7cdce-61"><a href="#f1f7cdce-61" aria-hidden="true" tabindex="-1"></a>            bl_start <span class="op">=</span> split_y <span class="op">-</span> black_line_thickness <span class="op">//</span> <span class="dv">2</span></span>
<span id="f1f7cdce-62"><a href="#f1f7cdce-62" aria-hidden="true" tabindex="-1"></a>            bl_end <span class="op">=</span> split_y <span class="op">+</span> black_line_thickness <span class="op">//</span> <span class="dv">2</span> <span class="op">+</span> (black_line_thickness <span class="op">%</span> <span class="dv">2</span>)</span>
<span id="f1f7cdce-63"><a href="#f1f7cdce-63" aria-hidden="true" tabindex="-1"></a>            img[bl_start:bl_end, x : x <span class="op">+</span> w] <span class="op">=</span> (<span class="dv">75</span>, <span class="dv">75</span>, <span class="dv">75</span>)</span>
<span id="f1f7cdce-64"><a href="#f1f7cdce-64" aria-hidden="true" tabindex="-1"></a>            top_height <span class="op">=</span> white_start <span class="op">-</span> y</span>
<span id="f1f7cdce-65"><a href="#f1f7cdce-65" aria-hidden="true" tabindex="-1"></a>            bottom_height <span class="op">=</span> (y <span class="op">+</span> h) <span class="op">-</span> white_end</span>
<span id="f1f7cdce-66"><a href="#f1f7cdce-66" aria-hidden="true" tabindex="-1"></a>            split_region(x, y, w, top_height, depth <span class="op">+</span> <span class="dv">1</span>)</span>
<span id="f1f7cdce-67"><a href="#f1f7cdce-67" aria-hidden="true" tabindex="-1"></a>            split_region(x, white_end, w, bottom_height, depth <span class="op">+</span> <span class="dv">1</span>)</span>
<span id="f1f7cdce-68"><a href="#f1f7cdce-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="f1f7cdce-69"><a href="#f1f7cdce-69" aria-hidden="true" tabindex="-1"></a>    split_region(<span class="dv">0</span>, <span class="dv">0</span>, width, height)</span>
<span id="f1f7cdce-70"><a href="#f1f7cdce-70" aria-hidden="true" tabindex="-1"></a>    img[<span class="dv">0</span>:overall_border_thickness, :] <span class="op">=</span> (<span class="dv">75</span>, <span class="dv">75</span>, <span class="dv">75</span>)</span>
<span id="f1f7cdce-71"><a href="#f1f7cdce-71" aria-hidden="true" tabindex="-1"></a>    img[<span class="op">-</span>overall_border_thickness:, :] <span class="op">=</span> (<span class="dv">75</span>, <span class="dv">75</span>, <span class="dv">75</span>)</span>
<span id="f1f7cdce-72"><a href="#f1f7cdce-72" aria-hidden="true" tabindex="-1"></a>    img[:, <span class="dv">0</span>:overall_border_thickness] <span class="op">=</span> (<span class="dv">75</span>, <span class="dv">75</span>, <span class="dv">75</span>)</span>
<span id="f1f7cdce-73"><a href="#f1f7cdce-73" aria-hidden="true" tabindex="-1"></a>    img[:, <span class="op">-</span>overall_border_thickness:] <span class="op">=</span> (<span class="dv">75</span>, <span class="dv">75</span>, <span class="dv">75</span>)</span>
<span id="f1f7cdce-74"><a href="#f1f7cdce-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="f1f7cdce-75"><a href="#f1f7cdce-75" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> img</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>This function creates Mondrian like images, such as the following examples.</p>
<div id="1a9b03de" class="cell" data-execution_count="3">
<details class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="1a9b03de"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="1a9b03de-1"><a href="#1a9b03de-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="1a9b03de-2"><a href="#1a9b03de-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="1a9b03de-3"><a href="#1a9b03de-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate a 2x2 grid of Mondrian images</span></span>
<span id="1a9b03de-4"><a href="#1a9b03de-4" aria-hidden="true" tabindex="-1"></a>fig, axs <span class="op">=</span> plt.subplots(<span class="dv">2</span>, <span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="dv">8</span>))</span>
<span id="1a9b03de-5"><a href="#1a9b03de-5" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">2</span>):</span>
<span id="1a9b03de-6"><a href="#1a9b03de-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> j <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">2</span>):</span>
<span id="1a9b03de-7"><a href="#1a9b03de-7" aria-hidden="true" tabindex="-1"></a>        img <span class="op">=</span> generate_mondrian(<span class="dv">256</span>, <span class="dv">256</span>)</span>
<span id="1a9b03de-8"><a href="#1a9b03de-8" aria-hidden="true" tabindex="-1"></a>        axs[i, j].imshow(img)</span>
<span id="1a9b03de-9"><a href="#1a9b03de-9" aria-hidden="true" tabindex="-1"></a>        axs[i, j].axis(<span class="st">"off"</span>)</span>
<span id="1a9b03de-10"><a href="#1a9b03de-10" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><a href="index_files/figure-html/cell-3-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-1"><img src="index_files/figure-html/cell-3-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
</section>
<section id="the-dataset-generator" class="level1">
<h1>The dataset generator</h1>
<p>To train our VAE model, we need a dataset of Mondrian images with masked regions. We will create a <code>PyTorch</code> dataset class that generates images and applies a random square mask to each one. The dataset will return the original image, the masked image, and the mask itself as the training samples. Note that we normalize the pixel values to the range <span class="math inline">\([0, 1]\)</span> to facilitate training, as neural networks typically perform better with inputs in this range.</p>
<p>The model will use the <code>Dataset</code> class to load the training data in batches during training, with inputs being passed to the model as needed. Notice that the masked image is created by setting the pixel values in the masked region to zero, effectively removing that part (this is why the image generator sets a <code>(75, 75, 75)</code> grey border and lines, so the model doesn’t confuse the mask with black areas of the original).</p>
<div id="f1c40f64" class="cell" data-execution_count="4">
<details class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="f1c40f64"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="f1c40f64-1"><a href="#f1c40f64-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch</span>
<span id="f1c40f64-2"><a href="#f1c40f64-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> torch.utils.data <span class="im">import</span> Dataset, DataLoader</span>
<span id="f1c40f64-3"><a href="#f1c40f64-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="f1c40f64-4"><a href="#f1c40f64-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="f1c40f64-5"><a href="#f1c40f64-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Dataset generator</span></span>
<span id="f1c40f64-6"><a href="#f1c40f64-6" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> MondrianDataset(Dataset):</span>
<span id="f1c40f64-7"><a href="#f1c40f64-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, num_samples<span class="op">=</span><span class="dv">1000</span>, width<span class="op">=</span><span class="dv">256</span>, height<span class="op">=</span><span class="dv">256</span>, mask_size<span class="op">=</span><span class="dv">64</span>):</span>
<span id="f1c40f64-8"><a href="#f1c40f64-8" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.num_samples <span class="op">=</span> num_samples</span>
<span id="f1c40f64-9"><a href="#f1c40f64-9" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.width <span class="op">=</span> width</span>
<span id="f1c40f64-10"><a href="#f1c40f64-10" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.height <span class="op">=</span> height</span>
<span id="f1c40f64-11"><a href="#f1c40f64-11" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.mask_size <span class="op">=</span> mask_size</span>
<span id="f1c40f64-12"><a href="#f1c40f64-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="f1c40f64-13"><a href="#f1c40f64-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__len__</span>(<span class="va">self</span>):</span>
<span id="f1c40f64-14"><a href="#f1c40f64-14" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>.num_samples</span>
<span id="f1c40f64-15"><a href="#f1c40f64-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="f1c40f64-16"><a href="#f1c40f64-16" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__getitem__</span>(<span class="va">self</span>, idx):</span>
<span id="f1c40f64-17"><a href="#f1c40f64-17" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Generate a Mondrian image and normalize to [0,1]</span></span>
<span id="f1c40f64-18"><a href="#f1c40f64-18" aria-hidden="true" tabindex="-1"></a>        img <span class="op">=</span> generate_mondrian(<span class="va">self</span>.width, <span class="va">self</span>.height)</span>
<span id="f1c40f64-19"><a href="#f1c40f64-19" aria-hidden="true" tabindex="-1"></a>        img <span class="op">=</span> img.astype(np.float32) <span class="op">/</span> <span class="fl">255.0</span></span>
<span id="f1c40f64-20"><a href="#f1c40f64-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="f1c40f64-21"><a href="#f1c40f64-21" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Create a random square mask</span></span>
<span id="f1c40f64-22"><a href="#f1c40f64-22" aria-hidden="true" tabindex="-1"></a>        x <span class="op">=</span> random.randint(<span class="dv">0</span>, <span class="va">self</span>.width <span class="op">-</span> <span class="va">self</span>.mask_size)</span>
<span id="f1c40f64-23"><a href="#f1c40f64-23" aria-hidden="true" tabindex="-1"></a>        y <span class="op">=</span> random.randint(<span class="dv">0</span>, <span class="va">self</span>.height <span class="op">-</span> <span class="va">self</span>.mask_size)</span>
<span id="f1c40f64-24"><a href="#f1c40f64-24" aria-hidden="true" tabindex="-1"></a>        mask <span class="op">=</span> np.zeros((<span class="va">self</span>.height, <span class="va">self</span>.width, <span class="dv">1</span>), dtype<span class="op">=</span>np.float32)</span>
<span id="f1c40f64-25"><a href="#f1c40f64-25" aria-hidden="true" tabindex="-1"></a>        mask[y : y <span class="op">+</span> <span class="va">self</span>.mask_size, x : x <span class="op">+</span> <span class="va">self</span>.mask_size] <span class="op">=</span> <span class="fl">1.0</span></span>
<span id="f1c40f64-26"><a href="#f1c40f64-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="f1c40f64-27"><a href="#f1c40f64-27" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Create masked image: set the masked region to 0</span></span>
<span id="f1c40f64-28"><a href="#f1c40f64-28" aria-hidden="true" tabindex="-1"></a>        masked_img <span class="op">=</span> np.copy(img)</span>
<span id="f1c40f64-29"><a href="#f1c40f64-29" aria-hidden="true" tabindex="-1"></a>        masked_img[y : y <span class="op">+</span> <span class="va">self</span>.mask_size, x : x <span class="op">+</span> <span class="va">self</span>.mask_size, :] <span class="op">=</span> <span class="fl">0.0</span></span>
<span id="f1c40f64-30"><a href="#f1c40f64-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="f1c40f64-31"><a href="#f1c40f64-31" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Convert HWC to CHW tensors</span></span>
<span id="f1c40f64-32"><a href="#f1c40f64-32" aria-hidden="true" tabindex="-1"></a>        masked_img <span class="op">=</span> torch.from_numpy(masked_img).permute(<span class="dv">2</span>, <span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="f1c40f64-33"><a href="#f1c40f64-33" aria-hidden="true" tabindex="-1"></a>        img <span class="op">=</span> torch.from_numpy(img).permute(<span class="dv">2</span>, <span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="f1c40f64-34"><a href="#f1c40f64-34" aria-hidden="true" tabindex="-1"></a>        mask <span class="op">=</span> torch.from_numpy(mask).permute(<span class="dv">2</span>, <span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="f1c40f64-35"><a href="#f1c40f64-35" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> masked_img, mask, img</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="the-vae-model" class="level1">
<h1>The VAE model</h1>
<p>With the dataset and generator in place, let us move to looking into the architecture of the Variational Autoencoder model. Previously we mentioned the <em>encoder</em> and <em>decoder</em> - we will organise our model by separating both functions clearly, and then bringing it together into a single model class.</p>
<p>We will not go too deep into an explanation of how a VAE works, but will provide a high-level overview of the model’s components so that readers can understand the overall architecture without getting bogged down in the details or the math.</p>
<section id="encoding" class="level2">
<h2 class="anchored" data-anchor-id="encoding">Encoding</h2>
<p>The encoder is responsible for transforming the input image into a latent representation. In our VAE model, the encoder consists of several <a href="https://en.wikipedia.org/wiki/Convolutional_layer">:link convolutional layers</a> that downsample the input image, capturing its features at different levels of abstraction. The encoder outputs the mean (<code>mu</code>) and log variance (<code>logvar</code>) of the latent distribution, which are used to sample the latent vector during training.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>For the mathematically inclined, <code>mu</code> (<span class="math inline">\(\mu\)</span>) and <code>logvar</code> are the parameters of a Gaussian distribution that approximates the true posterior distribution of the latent space. The encoder learns to map the input image to the parameters of this distribution, which allows the model to sample latent vectors during training. The Gaussian distribution is chosen for its simplicity and differentiability, which makes it easier to train the model using backpropagation.</p>
<p>The encoder outputs two vectors—one for the mean <span class="math inline">\(\mu\)</span> and one for the log-variance <span class="math inline">\(\log \sigma^2\)</span>, typically computed as:</p>
<p><span class="math display">\[
\mu = W_{\mu} \cdot x + b_{\mu}
\]</span></p>
<p><span class="math display">\[
\log \sigma^2 = W_{\log \sigma^2} \cdot x + b_{\log \sigma^2}
\]</span></p>
<p>Here, <span class="math inline">\(x\)</span> represents the features extracted from the input by earlier layers, and <span class="math inline">\(W\)</span> and <span class="math inline">\(b\)</span> are learned parameters.</p>
<p>Once you have <span class="math inline">\(\mu\)</span> and <span class="math inline">\(\log \sigma^2\)</span>, you can obtain the standard deviation by taking:</p>
<p><span class="math display">\[
\sigma = \exp\left(\frac{1}{2} \log \sigma^2\right)
\]</span></p>
<p>This formulation is critical for the reparameterization trick, which allows for backpropagation through the sampling process. Specifically, a latent vector <span class="math inline">\(z\)</span> is sampled as:</p>
<p><span class="math display">\[
z = \mu + \sigma \odot \epsilon
\]</span></p>
<p>with <span class="math inline">\(\epsilon \sim \mathcal{N}(0, I)\)</span>.</p>
<p>This approach ensures that the sampling is differentiable, making the VAE training stable.</p>
</div>
</div>
<p>Encoding in practice captures parts of the image that are important for reconstruction, such as edges, textures and shapes. The encoder’s output is a compressed representation of the input image that can be used to reconstruct the original image or generate new samples.</p>
<div id="a5d3c16f" class="cell" data-execution_count="5">
<details class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="a5d3c16f"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="a5d3c16f-1"><a href="#a5d3c16f-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> torch <span class="im">import</span> nn</span>
<span id="a5d3c16f-2"><a href="#a5d3c16f-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch.nn.functional <span class="im">as</span> F</span>
<span id="a5d3c16f-3"><a href="#a5d3c16f-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="a5d3c16f-4"><a href="#a5d3c16f-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="a5d3c16f-5"><a href="#a5d3c16f-5" aria-hidden="true" tabindex="-1"></a><span class="co"># U-NET style VAE encoder</span></span>
<span id="a5d3c16f-6"><a href="#a5d3c16f-6" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Encoder(nn.Module):</span>
<span id="a5d3c16f-7"><a href="#a5d3c16f-7" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Downsampling encoder that captures intermediate features for skip connections."""</span></span>
<span id="a5d3c16f-8"><a href="#a5d3c16f-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="a5d3c16f-9"><a href="#a5d3c16f-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, latent_dim<span class="op">=</span><span class="dv">128</span>):</span>
<span id="a5d3c16f-10"><a href="#a5d3c16f-10" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>(Encoder, <span class="va">self</span>).<span class="fu">__init__</span>()</span>
<span id="a5d3c16f-11"><a href="#a5d3c16f-11" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.enc1 <span class="op">=</span> nn.Sequential(</span>
<span id="a5d3c16f-12"><a href="#a5d3c16f-12" aria-hidden="true" tabindex="-1"></a>            nn.Conv2d(<span class="dv">3</span>, <span class="dv">32</span>, kernel_size<span class="op">=</span><span class="dv">4</span>, stride<span class="op">=</span><span class="dv">2</span>, padding<span class="op">=</span><span class="dv">1</span>),  <span class="co"># 256 -&gt; 128</span></span>
<span id="a5d3c16f-13"><a href="#a5d3c16f-13" aria-hidden="true" tabindex="-1"></a>            nn.ReLU(),</span>
<span id="a5d3c16f-14"><a href="#a5d3c16f-14" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="a5d3c16f-15"><a href="#a5d3c16f-15" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.enc2 <span class="op">=</span> nn.Sequential(</span>
<span id="a5d3c16f-16"><a href="#a5d3c16f-16" aria-hidden="true" tabindex="-1"></a>            nn.Conv2d(<span class="dv">32</span>, <span class="dv">64</span>, kernel_size<span class="op">=</span><span class="dv">4</span>, stride<span class="op">=</span><span class="dv">2</span>, padding<span class="op">=</span><span class="dv">1</span>),  <span class="co"># 128 -&gt; 64</span></span>
<span id="a5d3c16f-17"><a href="#a5d3c16f-17" aria-hidden="true" tabindex="-1"></a>            nn.ReLU(),</span>
<span id="a5d3c16f-18"><a href="#a5d3c16f-18" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="a5d3c16f-19"><a href="#a5d3c16f-19" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.enc3 <span class="op">=</span> nn.Sequential(</span>
<span id="a5d3c16f-20"><a href="#a5d3c16f-20" aria-hidden="true" tabindex="-1"></a>            nn.Conv2d(<span class="dv">64</span>, <span class="dv">128</span>, kernel_size<span class="op">=</span><span class="dv">4</span>, stride<span class="op">=</span><span class="dv">2</span>, padding<span class="op">=</span><span class="dv">1</span>),  <span class="co"># 64 -&gt; 32</span></span>
<span id="a5d3c16f-21"><a href="#a5d3c16f-21" aria-hidden="true" tabindex="-1"></a>            nn.ReLU(),</span>
<span id="a5d3c16f-22"><a href="#a5d3c16f-22" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="a5d3c16f-23"><a href="#a5d3c16f-23" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.enc4 <span class="op">=</span> nn.Sequential(</span>
<span id="a5d3c16f-24"><a href="#a5d3c16f-24" aria-hidden="true" tabindex="-1"></a>            nn.Conv2d(<span class="dv">128</span>, <span class="dv">256</span>, kernel_size<span class="op">=</span><span class="dv">4</span>, stride<span class="op">=</span><span class="dv">2</span>, padding<span class="op">=</span><span class="dv">1</span>),  <span class="co"># 32 -&gt; 16</span></span>
<span id="a5d3c16f-25"><a href="#a5d3c16f-25" aria-hidden="true" tabindex="-1"></a>            nn.ReLU(),</span>
<span id="a5d3c16f-26"><a href="#a5d3c16f-26" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="a5d3c16f-27"><a href="#a5d3c16f-27" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.fc_mu <span class="op">=</span> nn.Linear(<span class="dv">256</span> <span class="op">*</span> <span class="dv">16</span> <span class="op">*</span> <span class="dv">16</span>, latent_dim)</span>
<span id="a5d3c16f-28"><a href="#a5d3c16f-28" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.fc_logvar <span class="op">=</span> nn.Linear(<span class="dv">256</span> <span class="op">*</span> <span class="dv">16</span> <span class="op">*</span> <span class="dv">16</span>, latent_dim)</span>
<span id="a5d3c16f-29"><a href="#a5d3c16f-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="a5d3c16f-30"><a href="#a5d3c16f-30" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> forward(<span class="va">self</span>, x):</span>
<span id="a5d3c16f-31"><a href="#a5d3c16f-31" aria-hidden="true" tabindex="-1"></a>        f1 <span class="op">=</span> <span class="va">self</span>.enc1(x)  <span class="co"># [B, 32, 128, 128]</span></span>
<span id="a5d3c16f-32"><a href="#a5d3c16f-32" aria-hidden="true" tabindex="-1"></a>        f2 <span class="op">=</span> <span class="va">self</span>.enc2(f1)  <span class="co"># [B, 64, 64, 64]</span></span>
<span id="a5d3c16f-33"><a href="#a5d3c16f-33" aria-hidden="true" tabindex="-1"></a>        f3 <span class="op">=</span> <span class="va">self</span>.enc3(f2)  <span class="co"># [B, 128, 32, 32]</span></span>
<span id="a5d3c16f-34"><a href="#a5d3c16f-34" aria-hidden="true" tabindex="-1"></a>        f4 <span class="op">=</span> <span class="va">self</span>.enc4(f3)  <span class="co"># [B, 256, 16, 16]</span></span>
<span id="a5d3c16f-35"><a href="#a5d3c16f-35" aria-hidden="true" tabindex="-1"></a>        flat <span class="op">=</span> f4.view(f4.size(<span class="dv">0</span>), <span class="op">-</span><span class="dv">1</span>)</span>
<span id="a5d3c16f-36"><a href="#a5d3c16f-36" aria-hidden="true" tabindex="-1"></a>        mu <span class="op">=</span> <span class="va">self</span>.fc_mu(flat)</span>
<span id="a5d3c16f-37"><a href="#a5d3c16f-37" aria-hidden="true" tabindex="-1"></a>        logvar <span class="op">=</span> <span class="va">self</span>.fc_logvar(flat)</span>
<span id="a5d3c16f-38"><a href="#a5d3c16f-38" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> f1, f2, f3, f4, mu, logvar</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>You might be tempted to think of the VAE encoder as similar to a hash function (like SHA256 for example), but there are key differences. A hash function is a one-way transformation that maps any input to a fixed-size output. It’s designed for tasks like data integrity checks, where even a tiny change in the input leads to a completely different hash. In contrast, the encoder in a VAE is a learnable function that compresses input data into a latent space. This latent representation retains the core features of the original data so that it can later be used to reconstruct or, even generate new, similar data.</p>
<p>The VAE encoder doesn’t produce a single deterministic output like a hash function does. Instead, it outputs parameters, the mean and variance of a probability distribution in the latent space. This allows for controlled randomness, enabling smooth transitions and meaningful variations when sampling from the latent space. While both methods reduce the dimensionality of data, the VAE encoder is built to preserve the underlying structure and semantics necessary for generating or reconstructing data, rather than just providing a unique fingerprint of the input, like a hash function does.</p>
</section>
<section id="decoding" class="level2">
<h2 class="anchored" data-anchor-id="decoding">Decoding</h2>
<p>The VAE decoder essentially reverses the output of the encoder. It takes the latent vector, sampled from a distribution defined by the encoder’s mean and variance, and maps it back to the original data space. In the case of images, the decoder is usually composed of a series of transposed convolutional (or deconvolutional) layers that gradually upsample the latent representation. This process reconstructs the image by piecing together the key features, such as edges, textures, and colors, that the encoder originally captured in its compressed form.</p>
<div id="e7a1a6f1" class="cell" data-execution_count="6">
<details class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="e7a1a6f1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="e7a1a6f1-1"><a href="#e7a1a6f1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># VAE decoder</span></span>
<span id="e7a1a6f1-2"><a href="#e7a1a6f1-2" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Decoder(nn.Module):</span>
<span id="e7a1a6f1-3"><a href="#e7a1a6f1-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Upsampling decoder that uses skip connections from the encoder."""</span></span>
<span id="e7a1a6f1-4"><a href="#e7a1a6f1-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="e7a1a6f1-5"><a href="#e7a1a6f1-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, latent_dim<span class="op">=</span><span class="dv">128</span>):</span>
<span id="e7a1a6f1-6"><a href="#e7a1a6f1-6" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>(Decoder, <span class="va">self</span>).<span class="fu">__init__</span>()</span>
<span id="e7a1a6f1-7"><a href="#e7a1a6f1-7" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.fc_dec <span class="op">=</span> nn.Linear(latent_dim, <span class="dv">256</span> <span class="op">*</span> <span class="dv">16</span> <span class="op">*</span> <span class="dv">16</span>)</span>
<span id="e7a1a6f1-8"><a href="#e7a1a6f1-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="e7a1a6f1-9"><a href="#e7a1a6f1-9" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Up 1: f4 -&gt; (B,256,16,16) -&gt; upsample -&gt; (B,256,32,32) + skip f3 -&gt; conv -&gt; (B,128,32,32)</span></span>
<span id="e7a1a6f1-10"><a href="#e7a1a6f1-10" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.up4 <span class="op">=</span> nn.ConvTranspose2d(<span class="dv">256</span>, <span class="dv">256</span>, kernel_size<span class="op">=</span><span class="dv">4</span>, stride<span class="op">=</span><span class="dv">2</span>, padding<span class="op">=</span><span class="dv">1</span>)</span>
<span id="e7a1a6f1-11"><a href="#e7a1a6f1-11" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.conv4 <span class="op">=</span> nn.Sequential(</span>
<span id="e7a1a6f1-12"><a href="#e7a1a6f1-12" aria-hidden="true" tabindex="-1"></a>            nn.Conv2d(<span class="dv">256</span> <span class="op">+</span> <span class="dv">128</span>, <span class="dv">128</span>, kernel_size<span class="op">=</span><span class="dv">3</span>, padding<span class="op">=</span><span class="dv">1</span>), nn.ReLU()</span>
<span id="e7a1a6f1-13"><a href="#e7a1a6f1-13" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="e7a1a6f1-14"><a href="#e7a1a6f1-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="e7a1a6f1-15"><a href="#e7a1a6f1-15" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Up 2: (B,128,32,32) -&gt; upsample -&gt; (B,128,64,64) + skip f2 -&gt; conv -&gt; (B,64,64,64)</span></span>
<span id="e7a1a6f1-16"><a href="#e7a1a6f1-16" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.up3 <span class="op">=</span> nn.ConvTranspose2d(<span class="dv">128</span>, <span class="dv">128</span>, kernel_size<span class="op">=</span><span class="dv">4</span>, stride<span class="op">=</span><span class="dv">2</span>, padding<span class="op">=</span><span class="dv">1</span>)</span>
<span id="e7a1a6f1-17"><a href="#e7a1a6f1-17" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.conv3 <span class="op">=</span> nn.Sequential(</span>
<span id="e7a1a6f1-18"><a href="#e7a1a6f1-18" aria-hidden="true" tabindex="-1"></a>            nn.Conv2d(<span class="dv">128</span> <span class="op">+</span> <span class="dv">64</span>, <span class="dv">64</span>, kernel_size<span class="op">=</span><span class="dv">3</span>, padding<span class="op">=</span><span class="dv">1</span>), nn.ReLU()</span>
<span id="e7a1a6f1-19"><a href="#e7a1a6f1-19" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="e7a1a6f1-20"><a href="#e7a1a6f1-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="e7a1a6f1-21"><a href="#e7a1a6f1-21" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Up 3: (B,64,64,64) -&gt; upsample -&gt; (B,64,128,128) + skip f1 -&gt; conv -&gt; (B,32,128,128)</span></span>
<span id="e7a1a6f1-22"><a href="#e7a1a6f1-22" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.up2 <span class="op">=</span> nn.ConvTranspose2d(<span class="dv">64</span>, <span class="dv">64</span>, kernel_size<span class="op">=</span><span class="dv">4</span>, stride<span class="op">=</span><span class="dv">2</span>, padding<span class="op">=</span><span class="dv">1</span>)</span>
<span id="e7a1a6f1-23"><a href="#e7a1a6f1-23" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.conv2 <span class="op">=</span> nn.Sequential(</span>
<span id="e7a1a6f1-24"><a href="#e7a1a6f1-24" aria-hidden="true" tabindex="-1"></a>            nn.Conv2d(<span class="dv">64</span> <span class="op">+</span> <span class="dv">32</span>, <span class="dv">32</span>, kernel_size<span class="op">=</span><span class="dv">3</span>, padding<span class="op">=</span><span class="dv">1</span>), nn.ReLU()</span>
<span id="e7a1a6f1-25"><a href="#e7a1a6f1-25" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="e7a1a6f1-26"><a href="#e7a1a6f1-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="e7a1a6f1-27"><a href="#e7a1a6f1-27" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Up 4: (B,32,128,128) -&gt; upsample -&gt; (B,32,256,256) -&gt; final -&gt; (B,3,256,256)</span></span>
<span id="e7a1a6f1-28"><a href="#e7a1a6f1-28" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.up1 <span class="op">=</span> nn.ConvTranspose2d(<span class="dv">32</span>, <span class="dv">32</span>, kernel_size<span class="op">=</span><span class="dv">4</span>, stride<span class="op">=</span><span class="dv">2</span>, padding<span class="op">=</span><span class="dv">1</span>)</span>
<span id="e7a1a6f1-29"><a href="#e7a1a6f1-29" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.conv1 <span class="op">=</span> nn.Sequential(</span>
<span id="e7a1a6f1-30"><a href="#e7a1a6f1-30" aria-hidden="true" tabindex="-1"></a>            nn.Conv2d(<span class="dv">32</span>, <span class="dv">3</span>, kernel_size<span class="op">=</span><span class="dv">3</span>, padding<span class="op">=</span><span class="dv">1</span>), nn.Sigmoid()</span>
<span id="e7a1a6f1-31"><a href="#e7a1a6f1-31" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="e7a1a6f1-32"><a href="#e7a1a6f1-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="e7a1a6f1-33"><a href="#e7a1a6f1-33" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> forward(<span class="va">self</span>, z, f1, f2, f3, f4):</span>
<span id="e7a1a6f1-34"><a href="#e7a1a6f1-34" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Expand latent to spatial</span></span>
<span id="e7a1a6f1-35"><a href="#e7a1a6f1-35" aria-hidden="true" tabindex="-1"></a>        x <span class="op">=</span> <span class="va">self</span>.fc_dec(z).view(<span class="op">-</span><span class="dv">1</span>, <span class="dv">256</span>, <span class="dv">16</span>, <span class="dv">16</span>)</span>
<span id="e7a1a6f1-36"><a href="#e7a1a6f1-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="e7a1a6f1-37"><a href="#e7a1a6f1-37" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Up 1 (skip f3)</span></span>
<span id="e7a1a6f1-38"><a href="#e7a1a6f1-38" aria-hidden="true" tabindex="-1"></a>        x <span class="op">=</span> <span class="va">self</span>.up4(x)  <span class="co"># -&gt; [B,256,32,32]</span></span>
<span id="e7a1a6f1-39"><a href="#e7a1a6f1-39" aria-hidden="true" tabindex="-1"></a>        x <span class="op">=</span> torch.cat([x, f3], dim<span class="op">=</span><span class="dv">1</span>)  <span class="co"># -&gt; [B,256+128=384,32,32]</span></span>
<span id="e7a1a6f1-40"><a href="#e7a1a6f1-40" aria-hidden="true" tabindex="-1"></a>        x <span class="op">=</span> <span class="va">self</span>.conv4(x)  <span class="co"># -&gt; [B,128,32,32]</span></span>
<span id="e7a1a6f1-41"><a href="#e7a1a6f1-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="e7a1a6f1-42"><a href="#e7a1a6f1-42" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Up 2 (skip f2)</span></span>
<span id="e7a1a6f1-43"><a href="#e7a1a6f1-43" aria-hidden="true" tabindex="-1"></a>        x <span class="op">=</span> <span class="va">self</span>.up3(x)  <span class="co"># -&gt; [B,128,64,64]</span></span>
<span id="e7a1a6f1-44"><a href="#e7a1a6f1-44" aria-hidden="true" tabindex="-1"></a>        x <span class="op">=</span> torch.cat([x, f2], dim<span class="op">=</span><span class="dv">1</span>)  <span class="co"># -&gt; [B,128+64=192,64,64]</span></span>
<span id="e7a1a6f1-45"><a href="#e7a1a6f1-45" aria-hidden="true" tabindex="-1"></a>        x <span class="op">=</span> <span class="va">self</span>.conv3(x)  <span class="co"># -&gt; [B,64,64,64]</span></span>
<span id="e7a1a6f1-46"><a href="#e7a1a6f1-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="e7a1a6f1-47"><a href="#e7a1a6f1-47" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Up 3 (skip f1)</span></span>
<span id="e7a1a6f1-48"><a href="#e7a1a6f1-48" aria-hidden="true" tabindex="-1"></a>        x <span class="op">=</span> <span class="va">self</span>.up2(x)  <span class="co"># -&gt; [B,64,128,128]</span></span>
<span id="e7a1a6f1-49"><a href="#e7a1a6f1-49" aria-hidden="true" tabindex="-1"></a>        x <span class="op">=</span> torch.cat([x, f1], dim<span class="op">=</span><span class="dv">1</span>)  <span class="co"># -&gt; [B,64+32=96,128,128]</span></span>
<span id="e7a1a6f1-50"><a href="#e7a1a6f1-50" aria-hidden="true" tabindex="-1"></a>        x <span class="op">=</span> <span class="va">self</span>.conv2(x)  <span class="co"># -&gt; [B,32,128,128]</span></span>
<span id="e7a1a6f1-51"><a href="#e7a1a6f1-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="e7a1a6f1-52"><a href="#e7a1a6f1-52" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Up 4 (no skip)</span></span>
<span id="e7a1a6f1-53"><a href="#e7a1a6f1-53" aria-hidden="true" tabindex="-1"></a>        x <span class="op">=</span> <span class="va">self</span>.up1(x)  <span class="co"># -&gt; [B,32,256,256]</span></span>
<span id="e7a1a6f1-54"><a href="#e7a1a6f1-54" aria-hidden="true" tabindex="-1"></a>        x <span class="op">=</span> <span class="va">self</span>.conv1(x)  <span class="co"># -&gt; [B,3,256,256]</span></span>
<span id="e7a1a6f1-55"><a href="#e7a1a6f1-55" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> x</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>During training, the decoder learns to generate images that are as close as possible to the original inputs, guided by a reconstruction loss. This means that the decoder doesn’t simply replicate the input image but instead creates a version that preserves the most important details. The smooth, continuous nature of the latent space ensures that small changes in the latent vector result in gradual, meaningful variations in the output. As a result, once trained, the decoder is not only capable of accurately reconstructing inputs but also of generating entirely new samples that share similar characteristics with the training data.</p>
<p>In this case, we have used a technique called a <a href="https://en.wikipedia.org/wiki/U-Net">:link U-NET architecture</a>, which enhances the basic encoder-decoder design with skip connections. These connections allow the model to carry over fine-grained spatial details from the encoder directly to the corresponding layers in the decoder. This means that while the encoder compresses the image into a latent space, U-NET helps preserve important features, ensuring that the reconstructed image retains higher fidelity to the original.</p>
<p>By incorporating it, we improve the quality of our reconstructions significantly. The architecture not only captures the global structure through the bottleneck (the latent space) but also reintroduces local details via the skip connections.</p>
<div class="cell" data-layout-align="default">
<div class="cell-output-display">
<div>
<p></p><figure class="figure"><p></p>
<div>
<svg width="672" height="480" viewbox="0.00 0.00 690.00 309.00" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" style="; max-width: none; max-height: none">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 305)">
<title>UNet_VAE</title>
<polygon fill="white" stroke="transparent" points="-4,4 -4,-305 686,-305 686,4 -4,4"></polygon>
<g id="clust1" class="cluster">
<title>cluster_encoder</title>
<polygon fill="none" stroke="gray" stroke-dasharray="5,2" points="137,-76 137,-282 276,-282 276,-76 137,-76"></polygon>
<text text-anchor="middle" x="206.5" y="-265.4" font-family="Times,serif" font-size="14.00">Encoder</text>
</g>
<g id="clust2" class="cluster">
<title>cluster_latent</title>
<polygon fill="none" stroke="gray" stroke-dasharray="5,2" points="297,-87 297,-293 385,-293 385,-87 297,-87"></polygon>
<text text-anchor="middle" x="341" y="-276.4" font-family="Times,serif" font-size="14.00">Latent Space</text>
</g>
<g id="clust3" class="cluster">
<title>cluster_decoder</title>
<polygon fill="none" stroke="gray" stroke-dasharray="5,2" points="406,-51 406,-257 545,-257 545,-51 406,-51"></polygon>
<text text-anchor="middle" x="475.5" y="-240.4" font-family="Times,serif" font-size="14.00">Decoder</text>
</g>
<!-- input -->
<g id="node1" class="node">
<title>input</title>
<polygon fill="white" stroke="black" points="108,-185 0,-185 0,-149 108,-149 108,-185"></polygon>
<text text-anchor="middle" x="54" y="-162.8" font-family="Times,serif" font-size="14.00">Original</text>
</g>
<!-- E1_1 -->
<g id="node3" class="node">
<title>E1_1</title>
<ellipse fill="#c8e6c9" stroke="#2e7d32" cx="166.5" cy="-228" rx="21.5" ry="21.5"></ellipse>
</g>
<!-- input&#45;&gt;E1_1 -->
<g id="edge1" class="edge">
<title>input-&gt;E1_1</title>
<path fill="none" stroke="black" d="M87.85,-185.14C103.98,-194.04 123.16,-204.63 138.42,-213.05"></path>
<polygon fill="black" stroke="black" points="136.91,-216.22 147.36,-217.99 140.3,-210.09 136.91,-216.22"></polygon>
</g>
<!-- E1_2 -->
<g id="node4" class="node">
<title>E1_2</title>
<ellipse fill="#c8e6c9" stroke="#2e7d32" cx="166.5" cy="-167" rx="21.5" ry="21.5"></ellipse>
</g>
<!-- input&#45;&gt;E1_2 -->
<g id="edge2" class="edge">
<title>input-&gt;E1_2</title>
<path fill="none" stroke="black" d="M108.31,-167C117.36,-167 126.49,-167 134.71,-167"></path>
<polygon fill="black" stroke="black" points="134.91,-170.5 144.91,-167 134.91,-163.5 134.91,-170.5"></polygon>
</g>
<!-- E1_3 -->
<g id="node5" class="node">
<title>E1_3</title>
<ellipse fill="#c8e6c9" stroke="#2e7d32" cx="166.5" cy="-106" rx="21.5" ry="21.5"></ellipse>
</g>
<!-- input&#45;&gt;E1_3 -->
<g id="edge3" class="edge">
<title>input-&gt;E1_3</title>
<path fill="none" stroke="black" d="M87.85,-148.86C103.98,-139.96 123.16,-129.37 138.42,-120.95"></path>
<polygon fill="black" stroke="black" points="140.3,-123.91 147.36,-116.01 136.91,-117.78 140.3,-123.91"></polygon>
</g>
<!-- output -->
<g id="node2" class="node">
<title>output</title>
<polygon fill="white" stroke="black" points="682,-160 574,-160 574,-124 682,-124 682,-160"></polygon>
<text text-anchor="middle" x="628" y="-137.8" font-family="Times,serif" font-size="14.00">Reconstructed</text>
</g>
<!-- E2_1 -->
<g id="node6" class="node">
<title>E2_1</title>
<ellipse fill="#c8e6c9" stroke="#2e7d32" cx="246.5" cy="-228" rx="21.5" ry="21.5"></ellipse>
</g>
<!-- E1_1&#45;&gt;E2_1 -->
<g id="edge4" class="edge">
<title>E1_1-&gt;E2_1</title>
<path fill="none" stroke="black" d="M188.4,-228C196.42,-228 205.76,-228 214.52,-228"></path>
<polygon fill="black" stroke="black" points="214.81,-231.5 224.81,-228 214.81,-224.5 214.81,-231.5"></polygon>
</g>
<!-- E2_2 -->
<g id="node7" class="node">
<title>E2_2</title>
<ellipse fill="#c8e6c9" stroke="#2e7d32" cx="246.5" cy="-167" rx="21.5" ry="21.5"></ellipse>
</g>
<!-- E1_1&#45;&gt;E2_2 -->
<g id="edge5" class="edge">
<title>E1_1-&gt;E2_2</title>
<path fill="none" stroke="black" d="M184.04,-215.06C194.8,-206.65 209.01,-195.54 221.06,-186.12"></path>
<polygon fill="black" stroke="black" points="223.26,-188.84 228.98,-179.92 218.95,-183.32 223.26,-188.84"></polygon>
</g>
<!-- E2_3 -->
<g id="node8" class="node">
<title>E2_3</title>
<ellipse fill="#c8e6c9" stroke="#2e7d32" cx="246.5" cy="-106" rx="21.5" ry="21.5"></ellipse>
</g>
<!-- E1_1&#45;&gt;E2_3 -->
<g id="edge6" class="edge">
<title>E1_1-&gt;E2_3</title>
<path fill="none" stroke="black" d="M178.84,-210.26C191.95,-189.75 213.66,-155.8 228.73,-132.23"></path>
<polygon fill="black" stroke="black" points="231.71,-134.07 234.14,-123.76 225.81,-130.3 231.71,-134.07"></polygon>
</g>
<!-- E1_2&#45;&gt;E2_1 -->
<g id="edge7" class="edge">
<title>E1_2-&gt;E2_1</title>
<path fill="none" stroke="black" d="M184.04,-179.94C194.8,-188.35 209.01,-199.46 221.06,-208.88"></path>
<polygon fill="black" stroke="black" points="218.95,-211.68 228.98,-215.08 223.26,-206.16 218.95,-211.68"></polygon>
</g>
<!-- E1_2&#45;&gt;E2_2 -->
<g id="edge8" class="edge">
<title>E1_2-&gt;E2_2</title>
<path fill="none" stroke="black" d="M188.4,-167C196.42,-167 205.76,-167 214.52,-167"></path>
<polygon fill="black" stroke="black" points="214.81,-170.5 224.81,-167 214.81,-163.5 214.81,-170.5"></polygon>
</g>
<!-- E1_2&#45;&gt;E2_3 -->
<g id="edge9" class="edge">
<title>E1_2-&gt;E2_3</title>
<path fill="none" stroke="black" d="M184.04,-154.06C194.8,-145.65 209.01,-134.54 221.06,-125.12"></path>
<polygon fill="black" stroke="black" points="223.26,-127.84 228.98,-118.92 218.95,-122.32 223.26,-127.84"></polygon>
</g>
<!-- E1_3&#45;&gt;E2_1 -->
<g id="edge10" class="edge">
<title>E1_3-&gt;E2_1</title>
<path fill="none" stroke="black" d="M178.84,-123.74C191.95,-144.25 213.66,-178.2 228.73,-201.77"></path>
<polygon fill="black" stroke="black" points="225.81,-203.7 234.14,-210.24 231.71,-199.93 225.81,-203.7"></polygon>
</g>
<!-- E1_3&#45;&gt;E2_2 -->
<g id="edge11" class="edge">
<title>E1_3-&gt;E2_2</title>
<path fill="none" stroke="black" d="M184.04,-118.94C194.8,-127.35 209.01,-138.46 221.06,-147.88"></path>
<polygon fill="black" stroke="black" points="218.95,-150.68 228.98,-154.08 223.26,-145.16 218.95,-150.68"></polygon>
</g>
<!-- E1_3&#45;&gt;E2_3 -->
<g id="edge12" class="edge">
<title>E1_3-&gt;E2_3</title>
<path fill="none" stroke="black" d="M188.4,-106C196.42,-106 205.76,-106 214.52,-106"></path>
<polygon fill="black" stroke="black" points="214.81,-109.5 224.81,-106 214.81,-102.5 214.81,-109.5"></polygon>
</g>
<!-- D2_3 -->
<g id="node17" class="node">
<title>D2_3</title>
<ellipse fill="#bbdefb" stroke="#1e88e5" cx="515.5" cy="-81" rx="21.5" ry="21.5"></ellipse>
</g>
<!-- E1_3&#45;&gt;D2_3 -->
<g id="edge43" class="edge">
<title>E1_3-&gt;D2_3</title>
<path fill="none" stroke="red" stroke-dasharray="1,5" d="M186.02,-96.62C233.69,-73.72 352.17,-16.8 352.17,-16.8 352.17,-16.8 439.06,-50.95 486.09,-69.44"></path>
<polygon fill="red" stroke="red" points="484.89,-72.73 495.47,-73.13 487.45,-66.21 484.89,-72.73"></polygon>
<text text-anchor="middle" x="340.5" y="-4.2" font-family="Times,serif" font-size="14.00">skip</text>
</g>
<!-- L1 -->
<g id="node9" class="node">
<title>L1</title>
<ellipse fill="#212121" stroke="#212121" cx="340.5" cy="-239" rx="21.5" ry="21.5"></ellipse>
</g>
<!-- E2_1&#45;&gt;L1 -->
<g id="edge13" class="edge">
<title>E2_1-&gt;L1</title>
<path fill="none" stroke="black" d="M267.92,-230.44C279.86,-231.87 295.19,-233.7 308.59,-235.3"></path>
<polygon fill="black" stroke="black" points="308.48,-238.82 318.82,-236.53 309.31,-231.87 308.48,-238.82"></polygon>
</g>
<!-- L2 -->
<g id="node10" class="node">
<title>L2</title>
<ellipse fill="#212121" stroke="#212121" cx="340.5" cy="-178" rx="21.5" ry="21.5"></ellipse>
</g>
<!-- E2_1&#45;&gt;L2 -->
<g id="edge14" class="edge">
<title>E2_1-&gt;L2</title>
<path fill="none" stroke="black" d="M265.68,-218.12C279.03,-210.86 297.4,-200.88 312.48,-192.69"></path>
<polygon fill="black" stroke="black" points="314.25,-195.71 321.36,-187.86 310.9,-189.56 314.25,-195.71"></polygon>
</g>
<!-- L3 -->
<g id="node11" class="node">
<title>L3</title>
<ellipse fill="#212121" stroke="#212121" cx="340.5" cy="-117" rx="21.5" ry="21.5"></ellipse>
</g>
<!-- E2_1&#45;&gt;L3 -->
<g id="edge15" class="edge">
<title>E2_1-&gt;L3</title>
<path fill="none" stroke="black" d="M261.07,-211.62C276.52,-192.99 301.88,-162.38 319.57,-141.04"></path>
<polygon fill="black" stroke="black" points="322.48,-143.02 326.17,-133.08 317.09,-138.55 322.48,-143.02"></polygon>
</g>
<!-- E2_2&#45;&gt;L1 -->
<g id="edge16" class="edge">
<title>E2_2-&gt;L1</title>
<path fill="none" stroke="black" d="M263.95,-179.87C278.21,-191.03 299.04,-207.33 315.22,-220"></path>
<polygon fill="black" stroke="black" points="313.16,-222.83 323.19,-226.24 317.48,-217.32 313.16,-222.83"></polygon>
</g>
<!-- E2_2&#45;&gt;L2 -->
<g id="edge17" class="edge">
<title>E2_2-&gt;L2</title>
<path fill="none" stroke="black" d="M267.92,-169.44C279.86,-170.87 295.19,-172.7 308.59,-174.3"></path>
<polygon fill="black" stroke="black" points="308.48,-177.82 318.82,-175.53 309.31,-170.87 308.48,-177.82"></polygon>
</g>
<!-- E2_2&#45;&gt;L3 -->
<g id="edge18" class="edge">
<title>E2_2-&gt;L3</title>
<path fill="none" stroke="black" d="M265.68,-157.12C279.03,-149.86 297.4,-139.88 312.48,-131.69"></path>
<polygon fill="black" stroke="black" points="314.25,-134.71 321.36,-126.86 310.9,-128.56 314.25,-134.71"></polygon>
</g>
<!-- E2_3&#45;&gt;L1 -->
<g id="edge19" class="edge">
<title>E2_3-&gt;L1</title>
<path fill="none" stroke="black" d="M259.53,-123.39C275.37,-146.29 303.35,-186.75 321.66,-213.21"></path>
<polygon fill="black" stroke="black" points="318.9,-215.38 327.47,-221.61 324.66,-211.39 318.9,-215.38"></polygon>
</g>
<!-- E2_3&#45;&gt;L2 -->
<g id="edge20" class="edge">
<title>E2_3-&gt;L2</title>
<path fill="none" stroke="black" d="M263.95,-118.87C278.21,-130.03 299.04,-146.33 315.22,-159"></path>
<polygon fill="black" stroke="black" points="313.16,-161.83 323.19,-165.24 317.48,-156.32 313.16,-161.83"></polygon>
</g>
<!-- E2_3&#45;&gt;L3 -->
<g id="edge21" class="edge">
<title>E2_3-&gt;L3</title>
<path fill="none" stroke="black" d="M267.92,-108.44C279.86,-109.87 295.19,-111.7 308.59,-113.3"></path>
<polygon fill="black" stroke="black" points="308.48,-116.82 318.82,-114.53 309.31,-109.87 308.48,-116.82"></polygon>
</g>
<!-- D1_3 -->
<g id="node14" class="node">
<title>D1_3</title>
<ellipse fill="#bbdefb" stroke="#1e88e5" cx="435.5" cy="-81" rx="21.5" ry="21.5"></ellipse>
</g>
<!-- E2_3&#45;&gt;D1_3 -->
<g id="edge44" class="edge">
<title>E2_3-&gt;D1_3</title>
<path fill="none" stroke="red" stroke-dasharray="1,5" d="M266.87,-99.02C297.58,-88.5 352.17,-69.8 352.17,-69.8 352.17,-69.8 380.38,-73.59 403.98,-76.76"></path>
<polygon fill="red" stroke="red" points="403.66,-80.25 414.04,-78.12 404.6,-73.31 403.66,-80.25"></polygon>
<text text-anchor="middle" x="340.5" y="-57.2" font-family="Times,serif" font-size="14.00">skip</text>
</g>
<!-- D1_1 -->
<g id="node12" class="node">
<title>D1_1</title>
<ellipse fill="#bbdefb" stroke="#1e88e5" cx="435.5" cy="-203" rx="21.5" ry="21.5"></ellipse>
</g>
<!-- L1&#45;&gt;D1_1 -->
<g id="edge22" class="edge">
<title>L1-&gt;D1_1</title>
<path fill="none" stroke="black" d="M360.77,-231.54C373.74,-226.52 391.07,-219.81 405.67,-214.16"></path>
<polygon fill="black" stroke="black" points="407.19,-217.32 415.26,-210.45 404.67,-210.8 407.19,-217.32"></polygon>
</g>
<!-- D1_2 -->
<g id="node13" class="node">
<title>D1_2</title>
<ellipse fill="#bbdefb" stroke="#1e88e5" cx="435.5" cy="-142" rx="21.5" ry="21.5"></ellipse>
</g>
<!-- L1&#45;&gt;D1_2 -->
<g id="edge23" class="edge">
<title>L1-&gt;D1_2</title>
<path fill="none" stroke="black" d="M356.03,-223.84C371.32,-207.9 395.54,-182.63 413.03,-164.39"></path>
<polygon fill="black" stroke="black" points="415.68,-166.69 420.07,-157.05 410.62,-161.85 415.68,-166.69"></polygon>
</g>
<!-- L1&#45;&gt;D1_3 -->
<g id="edge24" class="edge">
<title>L1-&gt;D1_3</title>
<path fill="none" stroke="black" d="M352.17,-220.88C368.41,-193.28 399.45,-140.55 418.43,-108.31"></path>
<polygon fill="black" stroke="black" points="421.61,-109.79 423.67,-99.4 415.58,-106.24 421.61,-109.79"></polygon>
</g>
<!-- L2&#45;&gt;D1_1 -->
<g id="edge25" class="edge">
<title>L2-&gt;D1_1</title>
<path fill="none" stroke="black" d="M361.68,-183.42C374.23,-186.8 390.6,-191.2 404.64,-194.97"></path>
<polygon fill="black" stroke="black" points="403.79,-198.37 414.36,-197.59 405.61,-191.61 403.79,-198.37"></polygon>
</g>
<!-- L2&#45;&gt;D1_2 -->
<g id="edge26" class="edge">
<title>L2-&gt;D1_2</title>
<path fill="none" stroke="black" d="M360.77,-170.54C373.74,-165.52 391.07,-158.81 405.67,-153.16"></path>
<polygon fill="black" stroke="black" points="407.19,-156.32 415.26,-149.45 404.67,-149.8 407.19,-156.32"></polygon>
</g>
<!-- L2&#45;&gt;D1_3 -->
<g id="edge27" class="edge">
<title>L2-&gt;D1_3</title>
<path fill="none" stroke="black" d="M356.03,-162.84C371.32,-146.9 395.54,-121.63 413.03,-103.39"></path>
<polygon fill="black" stroke="black" points="415.68,-105.69 420.07,-96.05 410.62,-100.85 415.68,-105.69"></polygon>
</g>
<!-- L3&#45;&gt;D1_1 -->
<g id="edge28" class="edge">
<title>L3-&gt;D1_1</title>
<path fill="none" stroke="black" d="M356.86,-131.2C371.8,-145.02 394.68,-166.18 411.74,-181.95"></path>
<polygon fill="black" stroke="black" points="409.4,-184.56 419.12,-188.78 414.15,-179.42 409.4,-184.56"></polygon>
</g>
<!-- L3&#45;&gt;D1_2 -->
<g id="edge29" class="edge">
<title>L3-&gt;D1_2</title>
<path fill="none" stroke="black" d="M361.68,-122.42C374.23,-125.8 390.6,-130.2 404.64,-133.97"></path>
<polygon fill="black" stroke="black" points="403.79,-137.37 414.36,-136.59 405.61,-130.61 403.79,-137.37"></polygon>
</g>
<!-- L3&#45;&gt;D1_3 -->
<g id="edge30" class="edge">
<title>L3-&gt;D1_3</title>
<path fill="none" stroke="black" d="M360.77,-109.54C373.74,-104.52 391.07,-97.81 405.67,-92.16"></path>
<polygon fill="black" stroke="black" points="407.19,-95.32 415.26,-88.45 404.67,-88.8 407.19,-95.32"></polygon>
</g>
<!-- D2_1 -->
<g id="node15" class="node">
<title>D2_1</title>
<ellipse fill="#bbdefb" stroke="#1e88e5" cx="515.5" cy="-203" rx="21.5" ry="21.5"></ellipse>
</g>
<!-- D1_1&#45;&gt;D2_1 -->
<g id="edge31" class="edge">
<title>D1_1-&gt;D2_1</title>
<path fill="none" stroke="black" d="M457.4,-203C465.42,-203 474.76,-203 483.52,-203"></path>
<polygon fill="black" stroke="black" points="483.81,-206.5 493.81,-203 483.81,-199.5 483.81,-206.5"></polygon>
</g>
<!-- D2_2 -->
<g id="node16" class="node">
<title>D2_2</title>
<ellipse fill="#bbdefb" stroke="#1e88e5" cx="515.5" cy="-142" rx="21.5" ry="21.5"></ellipse>
</g>
<!-- D1_1&#45;&gt;D2_2 -->
<g id="edge32" class="edge">
<title>D1_1-&gt;D2_2</title>
<path fill="none" stroke="black" d="M453.04,-190.06C463.8,-181.65 478.01,-170.54 490.06,-161.12"></path>
<polygon fill="black" stroke="black" points="492.26,-163.84 497.98,-154.92 487.95,-158.32 492.26,-163.84"></polygon>
</g>
<!-- D1_1&#45;&gt;D2_3 -->
<g id="edge33" class="edge">
<title>D1_1-&gt;D2_3</title>
<path fill="none" stroke="black" d="M447.84,-185.26C460.95,-164.75 482.66,-130.8 497.73,-107.23"></path>
<polygon fill="black" stroke="black" points="500.71,-109.07 503.14,-98.76 494.81,-105.3 500.71,-109.07"></polygon>
</g>
<!-- D1_2&#45;&gt;D2_1 -->
<g id="edge34" class="edge">
<title>D1_2-&gt;D2_1</title>
<path fill="none" stroke="black" d="M453.04,-154.94C463.8,-163.35 478.01,-174.46 490.06,-183.88"></path>
<polygon fill="black" stroke="black" points="487.95,-186.68 497.98,-190.08 492.26,-181.16 487.95,-186.68"></polygon>
</g>
<!-- D1_2&#45;&gt;D2_2 -->
<g id="edge35" class="edge">
<title>D1_2-&gt;D2_2</title>
<path fill="none" stroke="black" d="M457.4,-142C465.42,-142 474.76,-142 483.52,-142"></path>
<polygon fill="black" stroke="black" points="483.81,-145.5 493.81,-142 483.81,-138.5 483.81,-145.5"></polygon>
</g>
<!-- D1_2&#45;&gt;D2_3 -->
<g id="edge36" class="edge">
<title>D1_2-&gt;D2_3</title>
<path fill="none" stroke="black" d="M453.04,-129.06C463.8,-120.65 478.01,-109.54 490.06,-100.12"></path>
<polygon fill="black" stroke="black" points="492.26,-102.84 497.98,-93.92 487.95,-97.32 492.26,-102.84"></polygon>
</g>
<!-- D1_3&#45;&gt;D2_1 -->
<g id="edge37" class="edge">
<title>D1_3-&gt;D2_1</title>
<path fill="none" stroke="black" d="M447.84,-98.74C460.95,-119.25 482.66,-153.2 497.73,-176.77"></path>
<polygon fill="black" stroke="black" points="494.81,-178.7 503.14,-185.24 500.71,-174.93 494.81,-178.7"></polygon>
</g>
<!-- D1_3&#45;&gt;D2_2 -->
<g id="edge38" class="edge">
<title>D1_3-&gt;D2_2</title>
<path fill="none" stroke="black" d="M453.04,-93.94C463.8,-102.35 478.01,-113.46 490.06,-122.88"></path>
<polygon fill="black" stroke="black" points="487.95,-125.68 497.98,-129.08 492.26,-120.16 487.95,-125.68"></polygon>
</g>
<!-- D1_3&#45;&gt;D2_3 -->
<g id="edge39" class="edge">
<title>D1_3-&gt;D2_3</title>
<path fill="none" stroke="black" d="M457.4,-81C465.42,-81 474.76,-81 483.52,-81"></path>
<polygon fill="black" stroke="black" points="483.81,-84.5 493.81,-81 483.81,-77.5 483.81,-84.5"></polygon>
</g>
<!-- D2_1&#45;&gt;output -->
<g id="edge40" class="edge">
<title>D2_1-&gt;output</title>
<path fill="none" stroke="black" d="M534.75,-192.93C548.42,-185.38 567.7,-174.74 585.1,-165.13"></path>
<polygon fill="black" stroke="black" points="586.92,-168.12 593.98,-160.23 583.54,-162 586.92,-168.12"></polygon>
</g>
<!-- D2_2&#45;&gt;output -->
<g id="edge41" class="edge">
<title>D2_2-&gt;output</title>
<path fill="none" stroke="black" d="M537.03,-142C544.81,-142 554.14,-142 563.79,-142"></path>
<polygon fill="black" stroke="black" points="563.93,-145.5 573.93,-142 563.93,-138.5 563.93,-145.5"></polygon>
</g>
<!-- D2_3&#45;&gt;output -->
<g id="edge42" class="edge">
<title>D2_3-&gt;output</title>
<path fill="none" stroke="black" d="M534.75,-91.07C548.42,-98.62 567.7,-109.26 585.1,-118.87"></path>
<polygon fill="black" stroke="black" points="583.54,-122 593.98,-123.77 586.92,-115.88 583.54,-122"></polygon>
</g>
</g>
</svg>
</div>
<p></p></figure><p></p>
</div>
</div>
</div>
</section>
<section id="the-model" class="level2">
<h2 class="anchored" data-anchor-id="the-model">The model</h2>
<p>With the encoder and decoder in place, we can now define the full VAE model. The model combines the encoder and decoder components, along with a reparametrization function that samples from the latent distribution defined by the encoder’s output. The model’s forward pass takes the input image, encodes it into the latent space, samples a latent vector, and then decodes it back into the image space.</p>
<p>Note the forward pass returns the reconstructed image (<code>recon</code>), the mean (<code>mu</code>), and the log variance (<code>logvar</code>) of the latent distribution. The mean and log variance are used to compute the <a href="https://en.wikipedia.org/wiki/Kullback%E2%80%93Leibler_divergence">:link Kullback-Leibler (KL) divergence</a> loss, which helps regularize the latent space during training. The KL divergence ensures that the latent distribution remains close to a standard normal distribution, which aids in generating realistic samples and controlling the model’s capacity.</p>
<div id="0a6aee43" class="cell" data-execution_count="7">
<details class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="0a6aee43"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="0a6aee43-1"><a href="#0a6aee43-1" aria-hidden="true" tabindex="-1"></a><span class="co"># The VAE model</span></span>
<span id="0a6aee43-2"><a href="#0a6aee43-2" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> VAE_UNet(nn.Module):</span>
<span id="0a6aee43-3"><a href="#0a6aee43-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""U-Net style VAE that returns reconstruction, mu, logvar."""</span></span>
<span id="0a6aee43-4"><a href="#0a6aee43-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="0a6aee43-5"><a href="#0a6aee43-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, latent_dim<span class="op">=</span><span class="dv">128</span>):</span>
<span id="0a6aee43-6"><a href="#0a6aee43-6" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>(VAE_UNet, <span class="va">self</span>).<span class="fu">__init__</span>()</span>
<span id="0a6aee43-7"><a href="#0a6aee43-7" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.encoder <span class="op">=</span> Encoder(latent_dim)</span>
<span id="0a6aee43-8"><a href="#0a6aee43-8" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.decoder <span class="op">=</span> Decoder(latent_dim)</span>
<span id="0a6aee43-9"><a href="#0a6aee43-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="0a6aee43-10"><a href="#0a6aee43-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> reparameterize(<span class="va">self</span>, mu, logvar):</span>
<span id="0a6aee43-11"><a href="#0a6aee43-11" aria-hidden="true" tabindex="-1"></a>        std <span class="op">=</span> torch.exp(<span class="fl">0.5</span> <span class="op">*</span> logvar)</span>
<span id="0a6aee43-12"><a href="#0a6aee43-12" aria-hidden="true" tabindex="-1"></a>        eps <span class="op">=</span> torch.randn_like(std)</span>
<span id="0a6aee43-13"><a href="#0a6aee43-13" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> mu <span class="op">+</span> eps <span class="op">*</span> std</span>
<span id="0a6aee43-14"><a href="#0a6aee43-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="0a6aee43-15"><a href="#0a6aee43-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> forward(<span class="va">self</span>, x):</span>
<span id="0a6aee43-16"><a href="#0a6aee43-16" aria-hidden="true" tabindex="-1"></a>        f1, f2, f3, f4, mu, logvar <span class="op">=</span> <span class="va">self</span>.encoder(x)</span>
<span id="0a6aee43-17"><a href="#0a6aee43-17" aria-hidden="true" tabindex="-1"></a>        z <span class="op">=</span> <span class="va">self</span>.reparameterize(mu, logvar)</span>
<span id="0a6aee43-18"><a href="#0a6aee43-18" aria-hidden="true" tabindex="-1"></a>        recon <span class="op">=</span> <span class="va">self</span>.decoder(z, f1, f2, f3, f4)</span>
<span id="0a6aee43-19"><a href="#0a6aee43-19" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> recon, mu, logvar</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Try not to get too lost in the mathematics of the model. It is not an easy topic to grapple with, for now what matters is that you understand the high-level architecture of the model, the main parameters involved, and how the encoder and decoder work together to learn a compressed representation of the input data. If you are curious, you can read the <a href="https://www.google.com/url?sa=t&amp;source=web&amp;rct=j&amp;opi=89978449&amp;url=https://arxiv.org/abs/1312.6114&amp;ved=2ahUKEwj1lf6NoZGMAxX4WEEAHcmqGegQFnoECAkQAQ&amp;usg=AOvVaw0lcWUpG5O19Y_RMGqNMkr2">original paper</a> by Kingma and Welling that introduced the VAE concept, or a slightly <a href="https://arxiv.org/abs/1906.02691">gentler introduction</a>.</p>
</section>
<section id="annealing-the-kl-divergence" class="level2">
<h2 class="anchored" data-anchor-id="annealing-the-kl-divergence">Annealing the KL divergence</h2>
<p>During training, the VAE model minimizes a loss function that consists of two components: a reconstruction loss and a Kullback-Leibler (KL) divergence loss. The reconstruction loss measures the difference between the input and the reconstructed output, while the KL divergence loss ensures that the latent distribution remains close to a standard normal distribution.</p>
<p>The KL divergence loss is weighted by a parameter <code>kl_weight</code>, which controls the importance of the KL divergence term during training. An annealing schedule is often used to gradually increase the KL weight over the course of training. This helps the model first focus on learning a good reconstruction, before enforcing a more structured latent space.</p>
<p>Here we define a simple linear annealing function that scales the KL weight from <span class="math inline">\(0\)</span> to <span class="math inline">\(1\)</span> between a start and end epoch. This function will be used during training to adjust the KL weight over time.</p>
<div id="b2f14b96" class="cell" data-execution_count="8">
<details class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="b2f14b96"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="b2f14b96-1"><a href="#b2f14b96-1" aria-hidden="true" tabindex="-1"></a><span class="co"># The KL annealing function</span></span>
<span id="b2f14b96-2"><a href="#b2f14b96-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> kl_anneal_function(epoch, start_epoch<span class="op">=</span><span class="dv">0</span>, end_epoch<span class="op">=</span><span class="dv">10</span>):</span>
<span id="b2f14b96-3"><a href="#b2f14b96-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="b2f14b96-4"><a href="#b2f14b96-4" aria-hidden="true" tabindex="-1"></a><span class="co">    Linearly scales KL weight from 0.0 to 1.0 between start_epoch and end_epoch.</span></span>
<span id="b2f14b96-5"><a href="#b2f14b96-5" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="b2f14b96-6"><a href="#b2f14b96-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> epoch <span class="op">&lt;</span> start_epoch:</span>
<span id="b2f14b96-7"><a href="#b2f14b96-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="fl">0.0</span></span>
<span id="b2f14b96-8"><a href="#b2f14b96-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> epoch <span class="op">&gt;</span> end_epoch:</span>
<span id="b2f14b96-9"><a href="#b2f14b96-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="fl">1.0</span></span>
<span id="b2f14b96-10"><a href="#b2f14b96-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="b2f14b96-11"><a href="#b2f14b96-11" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> (epoch <span class="op">-</span> start_epoch) <span class="op">/</span> (end_epoch <span class="op">-</span> start_epoch)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Here’s what the KL annealing schedule looks like over the course of training for 100 epochs. The KL weight starts at <span class="math inline">\(0.0\)</span> and gradually increases to <span class="math inline">\(1.0\)</span> between epochs 0 and 50.</p>
<div id="bc694452" class="cell" data-execution_count="9">
<details class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="bc694452"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="bc694452-1"><a href="#bc694452-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the KL annealing schedule</span></span>
<span id="bc694452-2"><a href="#bc694452-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="bc694452-3"><a href="#bc694452-3" aria-hidden="true" tabindex="-1"></a>epochs <span class="op">=</span> <span class="dv">100</span></span>
<span id="bc694452-4"><a href="#bc694452-4" aria-hidden="true" tabindex="-1"></a>kl_weights <span class="op">=</span> [kl_anneal_function(epoch, <span class="dv">0</span>, epochs <span class="op">//</span> <span class="dv">2</span>) <span class="cf">for</span> epoch <span class="kw">in</span> <span class="bu">range</span>(epochs)]</span>
<span id="bc694452-5"><a href="#bc694452-5" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="dv">4</span>))</span>
<span id="bc694452-6"><a href="#bc694452-6" aria-hidden="true" tabindex="-1"></a>plt.plot(<span class="bu">range</span>(epochs), kl_weights, marker<span class="op">=</span><span class="st">"o"</span>)</span>
<span id="bc694452-7"><a href="#bc694452-7" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"Epoch"</span>)</span>
<span id="bc694452-8"><a href="#bc694452-8" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"KL Weight"</span>)</span>
<span id="bc694452-9"><a href="#bc694452-9" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"KL Annealing Schedule"</span>)</span>
<span id="bc694452-10"><a href="#bc694452-10" aria-hidden="true" tabindex="-1"></a>plt.grid(<span class="va">True</span>)</span>
<span id="bc694452-11"><a href="#bc694452-11" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><a href="index_files/figure-html/cell-9-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-2"><img src="index_files/figure-html/cell-9-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
</section>
<section id="the-loss-function" class="level2">
<h2 class="anchored" data-anchor-id="the-loss-function">The loss function</h2>
<p>The loss function of the VAE, as we have touched upon before, is composed of two main components: the reconstruction loss (<code>recon_loss</code>) and the KL divergence term (<code>KL_loss</code>). The reconstruction loss measures how close the reconstructed output is to the original input, but in our function is computed <em>only over the masked region</em> using Mean Squared Error (MSE). This ensures that the model focuses on accurately recreating the parts of the image that matter most.</p>
<p>By balancing these two components, the overall loss ensures that the model not only produces high-quality reconstructions but also learns a well-structured latent space. The <code>kl_weight</code> parameter lets you adjust the emphasis on the KL divergence term relative to the reconstruction loss. A higher <code>kl_weight</code> will force the latent space to be more closely aligned with a normal distribution, potentially at the expense of reconstruction accuracy, whereas a lower weight will prioritize accurate reconstructions. The annealing scheduler we defined earlier helps the model go from focusing on the broader structure of the latent space to the finer details as training progresses.</p>
<p>In this function, <code>recon_x</code> is the reconstructed output, <code>x</code> is the original input, <code>mu</code> is the mean of the latent distribution, <code>logvar</code> is the log variance (all of which are computed in the forward pass), and <code>mask</code> is the binary mask indicating the missing region.</p>
<div id="8ce77627" class="cell" data-execution_count="10">
<details class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="8ce77627"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="8ce77627-1"><a href="#8ce77627-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> loss_function(recon_x, x, mu, logvar, mask, kl_weight):</span>
<span id="8ce77627-2"><a href="#8ce77627-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># MSE only over the masked region</span></span>
<span id="8ce77627-3"><a href="#8ce77627-3" aria-hidden="true" tabindex="-1"></a>    recon_loss <span class="op">=</span> nn.functional.mse_loss(recon_x <span class="op">*</span> mask, x <span class="op">*</span> mask, reduction<span class="op">=</span><span class="st">"sum"</span>)</span>
<span id="8ce77627-4"><a href="#8ce77627-4" aria-hidden="true" tabindex="-1"></a>    <span class="co"># KL divergence</span></span>
<span id="8ce77627-5"><a href="#8ce77627-5" aria-hidden="true" tabindex="-1"></a>    KL_loss <span class="op">=</span> <span class="op">-</span><span class="fl">0.5</span> <span class="op">*</span> torch.<span class="bu">sum</span>(<span class="dv">1</span> <span class="op">+</span> logvar <span class="op">-</span> mu.<span class="bu">pow</span>(<span class="dv">2</span>) <span class="op">-</span> logvar.exp())</span>
<span id="8ce77627-6"><a href="#8ce77627-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> recon_loss <span class="op">+</span> kl_weight <span class="op">*</span> KL_loss</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="the-training-loop" class="level2">
<h2 class="anchored" data-anchor-id="the-training-loop">The training loop</h2>
<p>We now have all the components needed to train our VAE model for the inpainting task. The training loop consists of the following steps:</p>
<ol type="1">
<li>Iterate over the dataset in batches.</li>
<li>Compute the forward pass through the model to get the reconstructed output, mean, and log variance.</li>
<li>Compute the loss function using the reconstructed output, original input, mean, log variance, and mask.</li>
<li>Backpropagate the gradients and update the model parameters.</li>
<li>Periodically run an inference step to visualize the inpainting results.</li>
</ol>
<div id="062555d8" class="cell" data-execution_count="11">
<details class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="062555d8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="062555d8-1"><a href="#062555d8-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tqdm <span class="im">import</span> tqdm</span>
<span id="062555d8-2"><a href="#062555d8-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="062555d8-3"><a href="#062555d8-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="062555d8-4"><a href="#062555d8-4" aria-hidden="true" tabindex="-1"></a><span class="co"># A training loop with periodic inference</span></span>
<span id="062555d8-5"><a href="#062555d8-5" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> train_vae_unet(model, dataloader, optimizer, device, epochs<span class="op">=</span><span class="dv">20</span>, inferences<span class="op">=</span><span class="dv">10</span>):</span>
<span id="062555d8-6"><a href="#062555d8-6" aria-hidden="true" tabindex="-1"></a>    model.train()</span>
<span id="062555d8-7"><a href="#062555d8-7" aria-hidden="true" tabindex="-1"></a>    interval <span class="op">=</span> <span class="bu">max</span>(<span class="dv">1</span>, epochs <span class="op">//</span> inferences)</span>
<span id="062555d8-8"><a href="#062555d8-8" aria-hidden="true" tabindex="-1"></a>    losses <span class="op">=</span> []</span>
<span id="062555d8-9"><a href="#062555d8-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> epoch <span class="kw">in</span> <span class="bu">range</span>(epochs):</span>
<span id="062555d8-10"><a href="#062555d8-10" aria-hidden="true" tabindex="-1"></a>        kl_weight <span class="op">=</span> kl_anneal_function(epoch, <span class="dv">0</span>, epochs <span class="op">//</span> <span class="dv">2</span>)</span>
<span id="062555d8-11"><a href="#062555d8-11" aria-hidden="true" tabindex="-1"></a>        total_loss <span class="op">=</span> <span class="dv">0</span></span>
<span id="062555d8-12"><a href="#062555d8-12" aria-hidden="true" tabindex="-1"></a>        progress <span class="op">=</span> tqdm(dataloader, desc<span class="op">=</span><span class="ss">f"Epoch </span><span class="sc">{</span>epoch<span class="op">+</span><span class="dv">1</span><span class="sc">}</span><span class="ss">"</span>, leave<span class="op">=</span><span class="va">False</span>)</span>
<span id="062555d8-13"><a href="#062555d8-13" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> masked_img, mask, img <span class="kw">in</span> progress:</span>
<span id="062555d8-14"><a href="#062555d8-14" aria-hidden="true" tabindex="-1"></a>            masked_img, mask, img <span class="op">=</span> (</span>
<span id="062555d8-15"><a href="#062555d8-15" aria-hidden="true" tabindex="-1"></a>                masked_img.to(device),</span>
<span id="062555d8-16"><a href="#062555d8-16" aria-hidden="true" tabindex="-1"></a>                mask.to(device),</span>
<span id="062555d8-17"><a href="#062555d8-17" aria-hidden="true" tabindex="-1"></a>                img.to(device),</span>
<span id="062555d8-18"><a href="#062555d8-18" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="062555d8-19"><a href="#062555d8-19" aria-hidden="true" tabindex="-1"></a>            optimizer.zero_grad()</span>
<span id="062555d8-20"><a href="#062555d8-20" aria-hidden="true" tabindex="-1"></a>            recon, mu, logvar <span class="op">=</span> model(masked_img)</span>
<span id="062555d8-21"><a href="#062555d8-21" aria-hidden="true" tabindex="-1"></a>            loss <span class="op">=</span> loss_function(recon, img, mu, logvar, mask, kl_weight)</span>
<span id="062555d8-22"><a href="#062555d8-22" aria-hidden="true" tabindex="-1"></a>            loss.backward()</span>
<span id="062555d8-23"><a href="#062555d8-23" aria-hidden="true" tabindex="-1"></a>            optimizer.step()</span>
<span id="062555d8-24"><a href="#062555d8-24" aria-hidden="true" tabindex="-1"></a>            total_loss <span class="op">+=</span> loss.item()</span>
<span id="062555d8-25"><a href="#062555d8-25" aria-hidden="true" tabindex="-1"></a>            progress.set_postfix(</span>
<span id="062555d8-26"><a href="#062555d8-26" aria-hidden="true" tabindex="-1"></a>                loss<span class="op">=</span><span class="ss">f"</span><span class="sc">{</span>loss<span class="sc">.</span>item()<span class="sc">:.4f}</span><span class="ss">"</span>, KL_Weight<span class="op">=</span><span class="ss">f"</span><span class="sc">{</span>kl_weight<span class="sc">:.2f}</span><span class="ss">"</span></span>
<span id="062555d8-27"><a href="#062555d8-27" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="062555d8-28"><a href="#062555d8-28" aria-hidden="true" tabindex="-1"></a>        avg_loss <span class="op">=</span> total_loss <span class="op">/</span> <span class="bu">len</span>(dataloader.dataset)</span>
<span id="062555d8-29"><a href="#062555d8-29" aria-hidden="true" tabindex="-1"></a>        losses.append(avg_loss)</span>
<span id="062555d8-30"><a href="#062555d8-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="062555d8-31"><a href="#062555d8-31" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (epoch <span class="op">+</span> <span class="dv">1</span>) <span class="op">%</span> interval <span class="op">==</span> <span class="dv">0</span> <span class="kw">or</span> epoch <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="062555d8-32"><a href="#062555d8-32" aria-hidden="true" tabindex="-1"></a>            model.<span class="bu">eval</span>()  <span class="co"># Switch to evaluation mode</span></span>
<span id="062555d8-33"><a href="#062555d8-33" aria-hidden="true" tabindex="-1"></a>            inference(model, device, epoch)</span>
<span id="062555d8-34"><a href="#062555d8-34" aria-hidden="true" tabindex="-1"></a>            model.train()  <span class="co"># Switch back to training mode</span></span>
<span id="062555d8-35"><a href="#062555d8-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="062555d8-36"><a href="#062555d8-36" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> losses</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="inference" class="level2">
<h2 class="anchored" data-anchor-id="inference">Inference</h2>
<p>The training loop above calls an <code>inference</code> function at regular intervals to visualize the inpainting results so we can regularly look at how well the model is performing. The <code>inference</code> function generates a new Mondrian image, applies a random square mask to it, and inpaints the missing region using the model. It then plots the original image, the masked image, the inpainted image, and the reconstructed patch. Note that it is given a <em>whole new image</em> to inpaint, not one from the training set.</p>
<div id="b0eedcde" class="cell" data-execution_count="12">
<details class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="b0eedcde"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="b0eedcde-1"><a href="#b0eedcde-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Run an inference loop</span></span>
<span id="b0eedcde-2"><a href="#b0eedcde-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> inference(model, device, epoch<span class="op">=</span><span class="dv">0</span>):</span>
<span id="b0eedcde-3"><a href="#b0eedcde-3" aria-hidden="true" tabindex="-1"></a>    model.<span class="bu">eval</span>()</span>
<span id="b0eedcde-4"><a href="#b0eedcde-4" aria-hidden="true" tabindex="-1"></a>    width, height, mask_size <span class="op">=</span> <span class="dv">256</span>, <span class="dv">256</span>, <span class="dv">64</span></span>
<span id="b0eedcde-5"><a href="#b0eedcde-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Generate a new Mondrian image and mask it</span></span>
<span id="b0eedcde-6"><a href="#b0eedcde-6" aria-hidden="true" tabindex="-1"></a>    img <span class="op">=</span> generate_mondrian(width, height)</span>
<span id="b0eedcde-7"><a href="#b0eedcde-7" aria-hidden="true" tabindex="-1"></a>    img <span class="op">=</span> img.astype(np.float32) <span class="op">/</span> <span class="fl">255.0</span></span>
<span id="b0eedcde-8"><a href="#b0eedcde-8" aria-hidden="true" tabindex="-1"></a>    x <span class="op">=</span> random.randint(<span class="dv">0</span>, width <span class="op">-</span> mask_size)</span>
<span id="b0eedcde-9"><a href="#b0eedcde-9" aria-hidden="true" tabindex="-1"></a>    y <span class="op">=</span> random.randint(<span class="dv">0</span>, height <span class="op">-</span> mask_size)</span>
<span id="b0eedcde-10"><a href="#b0eedcde-10" aria-hidden="true" tabindex="-1"></a>    mask <span class="op">=</span> np.zeros((height, width, <span class="dv">1</span>), dtype<span class="op">=</span>np.float32)</span>
<span id="b0eedcde-11"><a href="#b0eedcde-11" aria-hidden="true" tabindex="-1"></a>    mask[y : y <span class="op">+</span> mask_size, x : x <span class="op">+</span> mask_size] <span class="op">=</span> <span class="fl">1.0</span></span>
<span id="b0eedcde-12"><a href="#b0eedcde-12" aria-hidden="true" tabindex="-1"></a>    masked_img <span class="op">=</span> np.copy(img)</span>
<span id="b0eedcde-13"><a href="#b0eedcde-13" aria-hidden="true" tabindex="-1"></a>    masked_img[y : y <span class="op">+</span> mask_size, x : x <span class="op">+</span> mask_size, :] <span class="op">=</span> <span class="fl">0.0</span></span>
<span id="b0eedcde-14"><a href="#b0eedcde-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="b0eedcde-15"><a href="#b0eedcde-15" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Convert to tensor</span></span>
<span id="b0eedcde-16"><a href="#b0eedcde-16" aria-hidden="true" tabindex="-1"></a>    masked_tensor <span class="op">=</span> (</span>
<span id="b0eedcde-17"><a href="#b0eedcde-17" aria-hidden="true" tabindex="-1"></a>        torch.from_numpy(masked_img).permute(<span class="dv">2</span>, <span class="dv">0</span>, <span class="dv">1</span>).unsqueeze(<span class="dv">0</span>).to(device)</span>
<span id="b0eedcde-18"><a href="#b0eedcde-18" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="b0eedcde-19"><a href="#b0eedcde-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> torch.no_grad():</span>
<span id="b0eedcde-20"><a href="#b0eedcde-20" aria-hidden="true" tabindex="-1"></a>        recon, _, _ <span class="op">=</span> model(masked_tensor)</span>
<span id="b0eedcde-21"><a href="#b0eedcde-21" aria-hidden="true" tabindex="-1"></a>    recon <span class="op">=</span> recon.squeeze(<span class="dv">0</span>).permute(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">0</span>).cpu().numpy()</span>
<span id="b0eedcde-22"><a href="#b0eedcde-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="b0eedcde-23"><a href="#b0eedcde-23" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Extract the reconstructed patch</span></span>
<span id="b0eedcde-24"><a href="#b0eedcde-24" aria-hidden="true" tabindex="-1"></a>    patch_recon <span class="op">=</span> recon[y : y <span class="op">+</span> mask_size, x : x <span class="op">+</span> mask_size, :]</span>
<span id="b0eedcde-25"><a href="#b0eedcde-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="b0eedcde-26"><a href="#b0eedcde-26" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Combine the reconstructed patch into the masked image</span></span>
<span id="b0eedcde-27"><a href="#b0eedcde-27" aria-hidden="true" tabindex="-1"></a>    inpainted <span class="op">=</span> np.copy(masked_img)</span>
<span id="b0eedcde-28"><a href="#b0eedcde-28" aria-hidden="true" tabindex="-1"></a>    inpainted[y : y <span class="op">+</span> mask_size, x : x <span class="op">+</span> mask_size, :] <span class="op">=</span> patch_recon</span>
<span id="b0eedcde-29"><a href="#b0eedcde-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="b0eedcde-30"><a href="#b0eedcde-30" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Compute the MSE loss between the original and inpainted regions</span></span>
<span id="b0eedcde-31"><a href="#b0eedcde-31" aria-hidden="true" tabindex="-1"></a>    mse_loss <span class="op">=</span> np.mean(</span>
<span id="b0eedcde-32"><a href="#b0eedcde-32" aria-hidden="true" tabindex="-1"></a>        (</span>
<span id="b0eedcde-33"><a href="#b0eedcde-33" aria-hidden="true" tabindex="-1"></a>            img[y : y <span class="op">+</span> mask_size, x : x <span class="op">+</span> mask_size]</span>
<span id="b0eedcde-34"><a href="#b0eedcde-34" aria-hidden="true" tabindex="-1"></a>            <span class="op">-</span> inpainted[y : y <span class="op">+</span> mask_size, x : x <span class="op">+</span> mask_size]</span>
<span id="b0eedcde-35"><a href="#b0eedcde-35" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="b0eedcde-36"><a href="#b0eedcde-36" aria-hidden="true" tabindex="-1"></a>        <span class="op">**</span> <span class="dv">2</span></span>
<span id="b0eedcde-37"><a href="#b0eedcde-37" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="b0eedcde-38"><a href="#b0eedcde-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="b0eedcde-39"><a href="#b0eedcde-39" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Plot</span></span>
<span id="b0eedcde-40"><a href="#b0eedcde-40" aria-hidden="true" tabindex="-1"></a>    fig, axs <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">4</span>, figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="dv">3</span>))</span>
<span id="b0eedcde-41"><a href="#b0eedcde-41" aria-hidden="true" tabindex="-1"></a>    fig.suptitle(</span>
<span id="b0eedcde-42"><a href="#b0eedcde-42" aria-hidden="true" tabindex="-1"></a>        <span class="ss">f"Epoch: </span><span class="sc">{</span>epoch<span class="sc">}</span><span class="ss">, MSE Loss: </span><span class="sc">{</span>mse_loss<span class="sc">}</span><span class="ss">"</span>, x<span class="op">=</span><span class="fl">0.0</span>, ha<span class="op">=</span><span class="st">"left"</span>, fontsize<span class="op">=</span><span class="dv">14</span></span>
<span id="b0eedcde-43"><a href="#b0eedcde-43" aria-hidden="true" tabindex="-1"></a>    )  <span class="co"># Left-aligned title</span></span>
<span id="b0eedcde-44"><a href="#b0eedcde-44" aria-hidden="true" tabindex="-1"></a>    axs[<span class="dv">0</span>].imshow(img)</span>
<span id="b0eedcde-45"><a href="#b0eedcde-45" aria-hidden="true" tabindex="-1"></a>    axs[<span class="dv">0</span>].set_title(<span class="st">"Original Image"</span>)</span>
<span id="b0eedcde-46"><a href="#b0eedcde-46" aria-hidden="true" tabindex="-1"></a>    axs[<span class="dv">0</span>].axis(<span class="st">"off"</span>)</span>
<span id="b0eedcde-47"><a href="#b0eedcde-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="b0eedcde-48"><a href="#b0eedcde-48" aria-hidden="true" tabindex="-1"></a>    axs[<span class="dv">1</span>].imshow(masked_img)</span>
<span id="b0eedcde-49"><a href="#b0eedcde-49" aria-hidden="true" tabindex="-1"></a>    axs[<span class="dv">1</span>].set_title(<span class="st">"Masked Image"</span>)</span>
<span id="b0eedcde-50"><a href="#b0eedcde-50" aria-hidden="true" tabindex="-1"></a>    axs[<span class="dv">1</span>].axis(<span class="st">"off"</span>)</span>
<span id="b0eedcde-51"><a href="#b0eedcde-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="b0eedcde-52"><a href="#b0eedcde-52" aria-hidden="true" tabindex="-1"></a>    axs[<span class="dv">2</span>].imshow(inpainted)</span>
<span id="b0eedcde-53"><a href="#b0eedcde-53" aria-hidden="true" tabindex="-1"></a>    axs[<span class="dv">2</span>].set_title(<span class="st">"Inpainted Image"</span>)</span>
<span id="b0eedcde-54"><a href="#b0eedcde-54" aria-hidden="true" tabindex="-1"></a>    axs[<span class="dv">2</span>].axis(<span class="st">"off"</span>)</span>
<span id="b0eedcde-55"><a href="#b0eedcde-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="b0eedcde-56"><a href="#b0eedcde-56" aria-hidden="true" tabindex="-1"></a>    axs[<span class="dv">3</span>].imshow(patch_recon)</span>
<span id="b0eedcde-57"><a href="#b0eedcde-57" aria-hidden="true" tabindex="-1"></a>    axs[<span class="dv">3</span>].set_title(<span class="st">"Reconstructed Patch"</span>)</span>
<span id="b0eedcde-58"><a href="#b0eedcde-58" aria-hidden="true" tabindex="-1"></a>    axs[<span class="dv">3</span>].axis(<span class="st">"off"</span>)</span>
<span id="b0eedcde-59"><a href="#b0eedcde-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="b0eedcde-60"><a href="#b0eedcde-60" aria-hidden="true" tabindex="-1"></a>    plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
</section>
<section id="putting-it-all-together" class="level1">
<h1>Putting it all together</h1>
<p>We now have all the necessary pieces and can put them together to train our VAE model on the Mondrian dataset. We will use the <a href="../../../posts/experiments/adam-optimisation/">Adam</a> optimiser to update the model parameters during training. Training will run for 150 epochs, with periodic inference steps to visualize the inpainting results. We will also plot the training loss over time to monitor the model’s progress.</p>
<div id="a02d6d51" class="cell" data-execution_count="13">
<details class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="a02d6d51"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="a02d6d51-1"><a href="#a02d6d51-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> torch <span class="im">import</span> optim</span>
<span id="a02d6d51-2"><a href="#a02d6d51-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="a02d6d51-3"><a href="#a02d6d51-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Initialize random seed for reproducibility</span></span>
<span id="a02d6d51-4"><a href="#a02d6d51-4" aria-hidden="true" tabindex="-1"></a>random.seed(<span class="dv">123</span>)</span>
<span id="a02d6d51-5"><a href="#a02d6d51-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="a02d6d51-6"><a href="#a02d6d51-6" aria-hidden="true" tabindex="-1"></a>device <span class="op">=</span> torch.device(<span class="st">"mps"</span> <span class="cf">if</span> torch.mps.is_available() <span class="cf">else</span> <span class="st">"cpu"</span>)</span>
<span id="a02d6d51-7"><a href="#a02d6d51-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="a02d6d51-8"><a href="#a02d6d51-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Create dataset &amp; dataloader</span></span>
<span id="a02d6d51-9"><a href="#a02d6d51-9" aria-hidden="true" tabindex="-1"></a>dataset <span class="op">=</span> MondrianDataset(num_samples<span class="op">=</span><span class="dv">10000</span>)</span>
<span id="a02d6d51-10"><a href="#a02d6d51-10" aria-hidden="true" tabindex="-1"></a>dataloader <span class="op">=</span> DataLoader(dataset, batch_size<span class="op">=</span><span class="dv">32</span>, shuffle<span class="op">=</span><span class="va">True</span>, num_workers<span class="op">=</span><span class="dv">0</span>)</span>
<span id="a02d6d51-11"><a href="#a02d6d51-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="a02d6d51-12"><a href="#a02d6d51-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Create U-Net style VAE model</span></span>
<span id="a02d6d51-13"><a href="#a02d6d51-13" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> VAE_UNet(latent_dim<span class="op">=</span><span class="dv">128</span>).to(device)</span>
<span id="a02d6d51-14"><a href="#a02d6d51-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="a02d6d51-15"><a href="#a02d6d51-15" aria-hidden="true" tabindex="-1"></a><span class="co"># The Adam optimizer</span></span>
<span id="a02d6d51-16"><a href="#a02d6d51-16" aria-hidden="true" tabindex="-1"></a>optimizer <span class="op">=</span> optim.Adam(model.parameters(), lr<span class="op">=</span><span class="fl">1e-4</span>)</span>
<span id="a02d6d51-17"><a href="#a02d6d51-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="a02d6d51-18"><a href="#a02d6d51-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Train (with periodic inference)</span></span>
<span id="a02d6d51-19"><a href="#a02d6d51-19" aria-hidden="true" tabindex="-1"></a>max_epoch <span class="op">=</span> <span class="dv">150</span></span>
<span id="a02d6d51-20"><a href="#a02d6d51-20" aria-hidden="true" tabindex="-1"></a>losses <span class="op">=</span> train_vae_unet(</span>
<span id="a02d6d51-21"><a href="#a02d6d51-21" aria-hidden="true" tabindex="-1"></a>    model, dataloader, optimizer, device, epochs<span class="op">=</span>max_epoch, inferences<span class="op">=</span><span class="dv">5</span></span>
<span id="a02d6d51-22"><a href="#a02d6d51-22" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><a href="index_files/figure-html/cell-13-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-3"><img src="index_files/figure-html/cell-13-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><a href="index_files/figure-html/cell-13-output-2.png" class="lightbox" data-gallery="quarto-lightbox-gallery-4"><img src="index_files/figure-html/cell-13-output-2.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><a href="index_files/figure-html/cell-13-output-3.png" class="lightbox" data-gallery="quarto-lightbox-gallery-5"><img src="index_files/figure-html/cell-13-output-3.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><a href="index_files/figure-html/cell-13-output-4.png" class="lightbox" data-gallery="quarto-lightbox-gallery-6"><img src="index_files/figure-html/cell-13-output-4.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><a href="index_files/figure-html/cell-13-output-5.png" class="lightbox" data-gallery="quarto-lightbox-gallery-7"><img src="index_files/figure-html/cell-13-output-5.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><a href="index_files/figure-html/cell-13-output-6.png" class="lightbox" data-gallery="quarto-lightbox-gallery-8"><img src="index_files/figure-html/cell-13-output-6.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<p>Notice how the model is learning and generalizing across epochs. By the end of epoch 0, it can very roughly interpret colours and colour boundaries, but not very accurately. At epoch 59 it has improved significantly, and it can now draw boundary lines, and is very confident with boundaries and colours. At epoch 89 it is nearly getting perfect boundary lines. At epoch 149 it pretty much mastered it.</p>
<p>At epoch 119, it threw a curveball with an edge case. The mask fell on a corner, and the model clearly wasn’t very confident with the inpainting. This is a good example of how it is learning to generalize, but is not perfect at this stage.</p>
<p>Finally let us run one last inference at the last training epoch.</p>
<div id="cfaa4472" class="cell" data-execution_count="14">
<details class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cfaa4472"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cfaa4472-1"><a href="#cfaa4472-1" aria-hidden="true" tabindex="-1"></a>inference(model, device, epoch<span class="op">=</span>max_epoch)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><a href="index_files/figure-html/cell-14-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-9"><img src="index_files/figure-html/cell-14-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<p>By now we can see that the VAE model has learned to inpaint the missing regions quite well. The reconstructed patch is very close to the original, including edge cases such as where border lines meet. The model has learned to capture the structure and colors of the Mondrian images.</p>
<p>Finally let us plot the training loss over time to see how the model’s performance improved during training.</p>
<div id="18990909" class="cell" data-execution_count="15">
<details class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="18990909"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="18990909-1"><a href="#18990909-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot losses</span></span>
<span id="18990909-2"><a href="#18990909-2" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="dv">4</span>))</span>
<span id="18990909-3"><a href="#18990909-3" aria-hidden="true" tabindex="-1"></a>plt.plot(losses)</span>
<span id="18990909-4"><a href="#18990909-4" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Training Loss"</span>)</span>
<span id="18990909-5"><a href="#18990909-5" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"Epoch"</span>)</span>
<span id="18990909-6"><a href="#18990909-6" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"Loss"</span>)</span>
<span id="18990909-7"><a href="#18990909-7" aria-hidden="true" tabindex="-1"></a>plt.grid(<span class="va">True</span>)</span>
<span id="18990909-8"><a href="#18990909-8" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><a href="index_files/figure-html/cell-15-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-10"><img src="index_files/figure-html/cell-15-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
</section>
<section id="producing-an-entirely-new-image" class="level1">
<h1>Producing an entirely new image</h1>
<p>We discussed before that the VAE produces a compressed representation of the input data in the latent space. This latent representation can be sampled to generate new images that are similar to the training data. By sampling from the latent space and passing the resulting vector through the decoder, we can create new Mondrian-style images that were not part of the training set.</p>
<p>Let us write a function which does precisely this. It will sample a latent vector from a standard normal distribution, pass it through the decoder, and return the generated image.</p>
<div id="ba55f3c1" class="cell" data-execution_count="16">
<details class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="ba55f3c1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="ba55f3c1-1"><a href="#ba55f3c1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate a new Mondrian-style image</span></span>
<span id="ba55f3c1-2"><a href="#ba55f3c1-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> generate_synthetic_mondrian(model, device):</span>
<span id="ba55f3c1-3"><a href="#ba55f3c1-3" aria-hidden="true" tabindex="-1"></a>    model.<span class="bu">eval</span>()</span>
<span id="ba55f3c1-4"><a href="#ba55f3c1-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> torch.no_grad():</span>
<span id="ba55f3c1-5"><a href="#ba55f3c1-5" aria-hidden="true" tabindex="-1"></a>        latent_dim <span class="op">=</span> <span class="dv">128</span>  <span class="co"># Adjust if your latent dimension differs</span></span>
<span id="ba55f3c1-6"><a href="#ba55f3c1-6" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Sample a latent vector from a standard normal distribution</span></span>
<span id="ba55f3c1-7"><a href="#ba55f3c1-7" aria-hidden="true" tabindex="-1"></a>        z <span class="op">=</span> torch.randn(<span class="dv">1</span>, latent_dim, device<span class="op">=</span>device)</span>
<span id="ba55f3c1-8"><a href="#ba55f3c1-8" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Create a dummy input (e.g., a tensor of zeros) with the same shape as a real input image</span></span>
<span id="ba55f3c1-9"><a href="#ba55f3c1-9" aria-hidden="true" tabindex="-1"></a>        dummy_input <span class="op">=</span> torch.zeros(<span class="dv">1</span>, <span class="dv">3</span>, <span class="dv">256</span>, <span class="dv">256</span>, device<span class="op">=</span>device)</span>
<span id="ba55f3c1-10"><a href="#ba55f3c1-10" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Obtain skip connections from the encoder using the dummy input</span></span>
<span id="ba55f3c1-11"><a href="#ba55f3c1-11" aria-hidden="true" tabindex="-1"></a>        f1, f2, f3, f4, _, _ <span class="op">=</span> model.encoder(dummy_input)</span>
<span id="ba55f3c1-12"><a href="#ba55f3c1-12" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Generate the image using the decoder with the sampled latent vector and the dummy skip connections</span></span>
<span id="ba55f3c1-13"><a href="#ba55f3c1-13" aria-hidden="true" tabindex="-1"></a>        img <span class="op">=</span> model.decoder(z, f1, f2, f3, f4)</span>
<span id="ba55f3c1-14"><a href="#ba55f3c1-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Rearrange from [C, H, W] to [H, W, C] for visualization and convert to NumPy</span></span>
<span id="ba55f3c1-15"><a href="#ba55f3c1-15" aria-hidden="true" tabindex="-1"></a>    img <span class="op">=</span> img.squeeze(<span class="dv">0</span>).permute(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">0</span>).cpu().numpy()</span>
<span id="ba55f3c1-16"><a href="#ba55f3c1-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> img</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>The function generates a random latent vector <span class="math inline">\(z\)</span> from a standard normal distribution and passes it through the decoder. The output should be a new, synthetic Mondrian style image that the model has learned to generate based on the training data.</p>
<div id="ad062eae" class="cell" data-execution_count="17">
<details class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="ad062eae"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="ad062eae-1"><a href="#ad062eae-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot a 2x2 grid of synthetic Mondrian images</span></span>
<span id="ad062eae-2"><a href="#ad062eae-2" aria-hidden="true" tabindex="-1"></a>fig, axs <span class="op">=</span> plt.subplots(<span class="dv">2</span>, <span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="dv">8</span>))</span>
<span id="ad062eae-3"><a href="#ad062eae-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">2</span>):</span>
<span id="ad062eae-4"><a href="#ad062eae-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> j <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">2</span>):</span>
<span id="ad062eae-5"><a href="#ad062eae-5" aria-hidden="true" tabindex="-1"></a>        img <span class="op">=</span> generate_synthetic_mondrian(model, device)</span>
<span id="ad062eae-6"><a href="#ad062eae-6" aria-hidden="true" tabindex="-1"></a>        axs[i, j].imshow(img)</span>
<span id="ad062eae-7"><a href="#ad062eae-7" aria-hidden="true" tabindex="-1"></a>        axs[i, j].axis(<span class="st">"off"</span>)</span>
<span id="ad062eae-8"><a href="#ad062eae-8" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><a href="index_files/figure-html/cell-17-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-11"><img src="index_files/figure-html/cell-17-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<p>If the model had been trained with a more complex dataset, such as photos of birds, trains or cars, the generated images would reflect the characteristics of that dataset. The VAE model learns to capture the underlying structure and patterns of the training data, allowing it to generate new samples that share similar features.</p>
<p>Notice how the synthetic images generated by the model lack detail. This is because we used a dummy input, which leads to a set of skip connections that are not based on any real input data. In practice, you would use a real input image to extract the skip connections, which would provide more meaningful features for generating new images.</p>
</section>
<section id="final-remarks" class="level1">
<h1>Final remarks</h1>
<p>We have explored the concept of Variational Autoencoders (VAEs) and how they can be used for image inpainting. A VAE is a type of generative model that learns a compressed representation of the input data, which can be used to generate new samples or reconstruct the original data. There are other generative models, such as Generative Adversarial Networks (GANs), which adopt a fundamentally different training paradigm. Unlike VAEs, which explicitly model the latent space by learning a probabilistic distribution, GANs consist of two networks, a generator and a discriminator, that are trained in an adversarial framework. The generator’s goal is to produce realistic images, while the discriminator’s task is to distinguish between real and generated images.</p>
<p>One major advantage of GANs is their ability to generate sharp, high-quality images. However, they do not naturally provide an interpretable latent space, which can be a limitation for tasks like image inpainting where controlling specific aspects of the generated content is beneficial. GANs can be more challenging to train due to issues such as mode collapse and unstable training dynamics. To address these challenges, researchers have explored hybrid approaches like VAE-GANs. These models combine the structured latent space of VAEs with the adversarial loss of GANs, aiming to achieve both meaningful representations and high-quality image generation.</p>
<p>We have implemented a VAE model with a U-NET architecture and trained it on a dataset of Mondrian images with masked regions. The model learned to inpaint the missing regions by reconstructing the original image from the compressed latent space representation.</p>
<p>As an exercise, we can further train the model on a more complex dataset, for example the <a href="https://celeba.org/">CelebA</a>. We will leave it to another time.</p>


</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" id="quarto-reuse"><h2 class="anchored quarto-appendix-heading">Reuse</h2><div class="quarto-appendix-contents"><div>This work is licensed under CC BY <a rel="license" href="https://creativecommons.org/licenses/by/4.0/">(View License)</a></div></div></section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/pedroleitao\.nl");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
<p>Written with love, take time to think and ponder.</p>
</div>   
    <div class="nav-footer-center">
      &nbsp;
    </div>
    <div class="nav-footer-right">
      <ul class="footer-items list-unstyled">
    <li class="nav-item compact">
    <a class="nav-link" href="https://quarto.org">
      <i class="bi bi-arrow-through-heart" role="img">
</i> 
    </a>
  </li>  
    <li class="nav-item compact">
    <a class="nav-link" href="http://www.frankscanteen.com">
      <i class="bi bi-cup-hot" role="img">
</i> 
    </a>
  </li>  
    <li class="nav-item compact">
    <a class="nav-link" href="https://www.instagram.com/bilhanovarestaurante">
      <i class="bi bi-egg-fried" role="img">
</i> 
    </a>
  </li>  
</ul>
    </div>
  </div>
</footer>
<script>var lightboxQuarto = GLightbox({"closeEffect":"zoom","descPosition":"bottom","loop":false,"openEffect":"zoom","selector":".lightbox"});
(function() {
  let previousOnload = window.onload;
  window.onload = () => {
    if (previousOnload) {
      previousOnload();
    }
    lightboxQuarto.on('slide_before_load', (data) => {
      const { slideIndex, slideNode, slideConfig, player, trigger } = data;
      const href = trigger.getAttribute('href');
      if (href !== null) {
        const imgEl = window.document.querySelector(`a[href="${href}"] img`);
        if (imgEl !== null) {
          const srcAttr = imgEl.getAttribute("src");
          if (srcAttr && srcAttr.startsWith("data:")) {
            slideConfig.href = srcAttr;
          }
        }
      } 
    });
  
    lightboxQuarto.on('slide_after_load', (data) => {
      const { slideIndex, slideNode, slideConfig, player, trigger } = data;
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(slideNode);
      }
    });
  
  };
  
})();
          </script>




</body></html>